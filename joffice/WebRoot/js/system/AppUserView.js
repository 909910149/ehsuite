AppUserView=Ext.extend(Ext.Panel,{constructor:function(b){Ext.applyIf(this,b);this.initUIComponents();AppUserView.superclass.constructor.call(this,{id:"AppUserView",title:"账号信息",iconCls:"menu-appuser",layout:"border",autoScroll:true});},initUIComponents:function(){this.initSearchPanel();this.initGridPanel();this.items=[this.searchPanel,this.gridPanel];},onSearch:function(f){var e=Ext.getCmp("AppUserSearchForm");var d=Ext.getCmp("AppUserGrid");if(e.getForm().isValid()){$search({searchPanel:e,gridPanel:d});}}});AppUserView.prototype.initSearchPanel=function(){this.searchPanel=new Ext.FormPanel({region:"north",height:35,frame:false,border:false,id:"AppUserSearchForm",layout:"hbox",layoutConfig:{padding:"5",align:"middle"},defaults:{xtype:"label",border:false,margins:{top:0,right:4,bottom:4,left:4}},items:[{text:"用户账号"},{xtype:"textfield",name:"Q_username_S_LK"},{text:"用户姓名"},{xtype:"textfield",name:"Q_fullname_S_LK"},{text:"入职时间:从"},{xtype:"datefield",format:"Y-m-d",name:"Q_accessionTime_D_GT"},{text:"至"},{xtype:"datefield",format:"Y-m-d",name:"Q_accessionTime_D_LT"},{xtype:"button",text:"查询",iconCls:"search",scope:this,handler:this.onSearch.createCallback(this)}]});};AppUserView.prototype.initGridPanel=function(){this.toolbar=new Ext.Toolbar({height:30,items:[]});if(isGranted("_AppUserAdd")){this.toolbar.add(new Ext.Button({text:"添加账号",iconCls:"add-user",handler:function(){var b=Ext.getCmp("centerTabPanel");var a=Ext.getCmp("AppUserForm");if(a==null){a=new AppUserForm("增加账号");b.add(a);}else{b.remove(a);a=new AppUserForm("增加账号");b.add(a);}b.activate(a);}}));}if(isGranted("_AppUserDel")){this.toolbar.add(new Ext.Button({iconCls:"btn-del",text:"删除账号",handler:function(){var c=Ext.getCmp("AppUserGrid");var e=c.getSelectionModel().getSelections();if(e.length==0){Ext.ux.Toast.msg("信息","请选择要删除的记录！");return;}var b=Array();var a="";for(var d=0;d<e.length;d++){if(e[d].data.userId!=1){b.push(e[d].data.userId);}else{a+=e[d].data.fullname+",";}}if(a==""){AppUserView.remove(b);}else{Ext.ux.Toast.msg("信息",a+"不能被删除！");}}}));}var f=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:__ctxPath+"/system/listAppUser.do"}),reader:new Ext.data.JsonReader({root:"result",totalProperty:"totalCounts",fields:[{name:"userId",type:"int"},"username","password","fullname","address","email","department","title","position","dynamicPwd","dyPwdStatus",{name:"accessionTime"},{name:"status",type:"int"}]}),remoteSort:true});f.setDefaultSort("userId","desc");f.load({params:{start:0,limit:25}});var h=new Ext.grid.CheckboxSelectionModel();var g=new Ext.grid.ColumnModel({columns:[h,new Ext.grid.RowNumberer(),{header:"userId",dataIndex:"userId",hidden:true},{header:"状态",dataIndex:"status",width:30,renderer:function(b){var a="";if(b=="1"){a+='<img title="激活" src="'+__ctxPath+'/images/flag/customer/effective.png"/>';}else{a+='<img title="禁用" src="'+__ctxPath+'/images/flag/customer/invalid.png"/>';}return a;}},{header:"账号",dataIndex:"username",width:60},{header:"地址",dataIndex:"address",hidden:true,exprint:true},{header:"用户名",dataIndex:"fullname",width:60},{header:"邮箱",dataIndex:"email",width:120},{header:"所属部门",dataIndex:"department",renderer:function(a){if(a==null){return"";}else{return a.depName;}},width:60},{header:"所在职位",dataIndex:"position",width:60},{header:"入职时间",dataIndex:"accessionTime",width:100},{header:"令牌序列",dataIndex:"dynamicPwd",width:100},{header:"令牌绑定",dataIndex:"dyPwdStatus",width:60,renderer:function(a){if(a!=null&&a==0){return'<font color="red">未绑定</font>';}else{if(a!=null&&a==1){return'<font color="green">已绑定</font>';}}}},{header:"管理",dataIndex:"userId",sortable:false,width:60,renderer:function(d,e,o,a,n){var b=o.data.userId;var p=o.data.username;var c="";if(b!=1){if(isGranted("_AppUserDel")){c+='<button title="删除" value=" " class="btn-del" onclick="AppUserView.remove('+b+')"></button>';}if(isGranted("_AppUserEdit")){c+='&nbsp;<button title="编辑" value=" " class="btn-edit" onclick="AppUserView.edit('+b+",'"+p+"')\"></button>";}if(isGranted("_AppUserReset")){c+='&nbsp;<button title="重置" value=" " class="btn-password" onclick="AppUserView.reset('+b+')"></button>';}}return c;}}],defaults:{sortable:true,menuDisabled:true,width:100}});this.gridPanel=new Ext.grid.GridPanel({id:"AppUserGrid",tbar:this.toolbar,store:f,region:"center",shim:true,trackMouseOver:true,disableSelection:false,loadMask:true,cm:g,sm:h,viewConfig:{forceFit:true,enableRowBody:false,showPreview:false},bbar:new HT.PagingBar({store:f})});AppUtil.addPrintExport(this.gridPanel);this.gridPanel.addListener("rowdblclick",i);var j=this.gridPanel;function i(b,c,a){b.getSelectionModel().each(function(d){var e=d.data.userId;if(isGranted("_AppUserEdit")&&e!=1){AppUserView.edit(e,d.data.username);}});}};AppUserView.remove=function(b){Ext.Msg.confirm("删除操作","你确定要删除该用户吗?",function(a){if(a=="yes"){Ext.Ajax.request({url:__ctxPath+"/system/multiDelAppUser.do",method:"post",params:{ids:b},success:function(e){var f=Ext.util.JSON.decode(e.responseText);if(f.msg==""){Ext.ux.Toast.msg("操作信息","用户删除成功");}else{Ext.ux.Toast.msg("操作信息",f.msg);}Ext.getCmp("AppUserGrid").getStore().reload();},failure:function(){Ext.ux.Toast.msg("操作信息","用户删除失败");}});}});};AppUserView.reset=function(b){new setPasswordForm(b);};AppUserView.edit=function(l,i){var g=Ext.getCmp("centerTabPanel");var k=Ext.getCmp("AppUserForm");if(k==null){k=new AppUserForm(i+"-详细信息",l);g.add(k);}else{g.remove("AppUserForm");k=new AppUserForm(i+"-详细信息",l);g.add(k);}g.activate(k);var j=Ext.getCmp("AppUserMustInfo");j.remove("appUser.password");Ext.getCmp("appUser.username").getEl().dom.readOnly=true;j.doLayout(true);var h=Ext.getCmp("AppUserFormToolbar");Ext.getCmp("resetPassword").show();h.doLayout(true);k.form.load({url:__ctxPath+"/system/getAppUser.do",params:{userId:l},method:"post",waitMsg:"正在载入数据...",success:function(c,a){var f=Ext.getCmp("appUser.photo");var b=Ext.getCmp("displayUserPhoto");var d=Ext.getCmp("appUserTitle");if(f.value!=""&&f.value!=null&&f.value!="undefined"){b.body.update('<img src="'+__ctxPath+"/attachFiles/"+f.value+'" width="100%" height="100%"/>');}else{if(d.value=="0"){b.body.update('<img src="'+__ctxPath+'/images/default_image_female.jpg" />');}}var n=Ext.util.JSON.decode(a.response.responseText).data[0];var e=getDateFromFormat(n.accessionTime,"yyyy-MM-dd HH:mm:ss");Ext.getCmp("appUser.accessionTime").setValue(new Date(e));Ext.getCmp("appUser.depId").setValue(n.department.depId);Ext.getCmp("depTreeSelector").setValue(n.department.depName);Ext.getCmp("appUser.jobId").setValue(n.jobId);Ext.Ajax.request({url:__ctxPath+"/hrm/getJob.do?jobId="+n.jobId,method:"get",async:false,success:function(r,q){var m=Ext.decode(r.responseText);Ext.getCmp("jobTreeSelector").setValue(m.data.jobName);},failure:function(p,m){}});},failure:function(){Ext.ux.Toast.msg("编辑","载入失败");}});};