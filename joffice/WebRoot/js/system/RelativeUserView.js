RelativeUserView=Ext.extend(Ext.Window,{constructor:function(b){Ext.applyIf(this,b);this.initUIComponents();RelativeUserView.superclass.constructor.call(this,{id:"RelativeUserView",title:"该用户["+this.username+"]添加上下级管理",iconCls:"menu-relativeJob",region:"center",layout:"border",width:850,height:600,modal:true,maximizable:true,items:[this.treePanel,this.gridPanel]});},initUIComponents:function(){this.topbar=new Ext.Toolbar({defaultType:"button",items:[{iconCls:"btn-superior",text:"添加上级",scope:this,handler:this.addRelativeUser.createCallback(1,this.userId)},"-",{iconCls:"btn-sibling",text:"添加同级",scope:this,handler:this.addRelativeUser.createCallback(2,this.userId)},"-",{iconCls:"btn-subordinate",text:"添加下级",scope:this,handler:this.addRelativeUser.createCallback(0,this.userId)},"-",{iconCls:"btn-del",text:"删除",scope:this,handler:this.removeSelRs}]});this.treePanel=new Ext.tree.TreePanel({id:"RelativeUserViewTreePanel",region:"west",collapsible:true,autoScroll:true,split:true,width:150,title:"相对岗位列表",tbar:new Ext.Toolbar({items:[{xtype:"button",iconCls:"btn-refresh",text:"刷新",handler:function(){Ext.getCmp("RelativeUserViewTreePanel").root.reload();}},{xtype:"button",text:"展开",iconCls:"btn-expand",handler:function(){Ext.getCmp("RelativeUserViewTreePanel").expandAll();}},{xtype:"button",text:"收起",iconCls:"btn-collapse",handler:function(){Ext.getCmp("RelativeUserViewTreePanel").collapseAll();}}]}),loader:new Ext.tree.TreeLoader({url:__ctxPath+"/system/treeLoadRelativeJob.do"}),root:new Ext.tree.AsyncTreeNode({expanded:true}),rootVisible:false,listeners:{"click":function(a){if(a!=null){var b=Ext.getCmp("RelativeUserView").gridPanel.getStore();b.baseParams={reJobId:a.id};b.reload({params:{start:0,limit:25}});}}}});this.treePanel.on("contextmenu",h,this.treePanel);this.treeMenu=new Ext.menu.Menu({id:"RelativeUserMenu",items:[{iconCls:"btn-add",text:"新增岗位",scope:this,handler:e},{text:"修改岗位信息",iconCls:"btn-edit",scope:this,handler:f},{text:"删除岗位信息",iconCls:"btn-del",scope:this,handler:g}]});function h(b,a){selected=new Ext.tree.TreeNode({id:b.id,text:b.text});Ext.getCmp("RelativeUserMenu").showAt(a.getXY());}function e(){var a=selected.id;var b=Ext.getCmp("RelativeJobForm");if(b==null){if(a>0){new RelativeJobForm({nodeId:a}).show();}else{new RelativeJobForm({nodeId:0}).show();}}}function f(){var a=selected.id;if(a>0){var b=Ext.getCmp("RelativeJobForm");if(b==null){new RelativeJobForm().show();b=Ext.getCmp("RelativeJobForm");}b.form.load({url:__ctxPath+"/system/getRelativeJob.do",params:{reJobId:a},method:"post",deferredRender:true,layoutOnTabChange:true,failure:function(){Ext.ux.Toast.msg("操作提示","载入岗位信息失败!");}});}else{Ext.ux.Toast.msg("操作提示","对不起，公司名称不能修改，请原谅！");}}function g(){var a=selected.id;if(a>0){Ext.Msg.confirm("操作提示","你真的要删除该岗位信息吗？",function(b){if(b=="yes"){Ext.Ajax.request({url:__ctxPath+"/system/deleteRelativeJob.do?reJobId="+a,method:"post",success:function(j,c){var d=Ext.util.JSON.decode(j.responseText);if(d.success){Ext.ux.Toast.msg("操作提示","删除该岗位信息成功！");Ext.getCmp("RelativeUserViewTreePanel").root.reload();}else{Ext.ux.Toast.msg("操作提示","对不起，删除该岗位信息失败！");}},failure:function(){}});}});}else{Ext.ux.Toast.msg("操作提示","对不起，公司名称不能删除，请原谅！");}}this.gridPanel=new HT.GridPanel({region:"center",tbar:this.topbar,rowActions:true,id:"RelativeUserGrid",url:__ctxPath+"/system/listRelativeUser.do?userId="+this.userId,fields:[{name:"relativeUserId",type:"int"},"appUser","jobUser","isSuper","relativeJob"],columns:[{header:"relativeUserId",dataIndex:"relativeUserId",hidden:true},{header:"岗位员工",dataIndex:"jobUser",renderer:function(a){return a.username;}},{header:"上下级标识 ",dataIndex:"isSuper",renderer:function(a){if(a==0){return'<button class="btn-subordinate" title="下级"/>';}else{if(a==1){return'<button class="btn-superior" title="上级" />';}else{if(a==2){return'<button class="btn-sibling" title="同级" />';}else{return"";}}}}},new Ext.ux.grid.RowActions({header:"管理",width:100,actions:[{iconCls:"btn-del",qtip:"删除",style:"margin:0 3px 0 3px"}],listeners:{scope:this,"action":this.onRowAction}})]});},createRs:function(){new RelativeUserForm().show();},removeRs:function(b){$postDel({url:__ctxPath+"/system/multiDelRelativeUser.do",ids:b,grid:this.gridPanel});},removeSelRs:function(){$delGridRs({url:__ctxPath+"/system/multiDelRelativeUser.do",grid:this.gridPanel,idName:"relativeUserId"});},onRowAction:function(j,g,i,h,f){switch(i){case"btn-del":this.removeRs.call(this,g.data.relativeUserId);break;default:break;}},addRelativeUser:function(m,n){var i="";if(m==1){i="上级";}else{if(m==2){i="同级";}else{i="下级";}}var k=Ext.getCmp("RelativeUserViewTreePanel").getSelectionModel().getSelectedNode();if(k!=null&&k.id>0){var l=Ext.getCmp("RelativeUserView").gridPanel.getStore();var j=new Array();for(var o=0;o<l.getCount();o++){var p=l.getAt(o).data.jobUser;j.push({userId:p.userId,fullname:p.fullname});}UserSelector.getView(function(a,b){if(a!=""){Ext.Ajax.request({url:__ctxPath+"/system/mutliAddRelativeUser.do",method:"post",params:{"userId":n,"reJobId":k.id,"jobUserIds":a,"relativeUser.isSuper":m},success:function(e,c){var d=Ext.util.JSON.decode(e.responseText);Ext.ux.Toast.msg("操作提示",d.msg);l.reload();},failure:function(){Ext.ux.Toast.msg("操作提示","对不起，添加"+i+"用户信息失败！");}});}},false,false,j).show();}else{Ext.ux.Toast.msg("操作提示","请选择岗位名称！");}}});