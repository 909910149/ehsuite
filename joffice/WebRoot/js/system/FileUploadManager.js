FileUploadManager=Ext.extend(Ext.Window,{constructor:function(b){Ext.applyIf(this,b);this.initUIComponent();FileUploadManager.superclass.constructor.call(this,{id:"fileUploadManager",layout:"fit",title:"附件分类管理",iconCls:"menu-file",width:720,minWidth:720,height:550,minHeight:550,maximizable:true,border:false,modal:true,items:[this.panel],buttonAlign:"center",buttons:[{text:"确定",iconCls:"btn-ok",scope:this,handler:this.upLoad},{text:"取消",iconCls:"btn-cancel",scope:this,handler:this.close}]});},initUIComponent:function(){fileType=this.permitted_extensions;var c=FileUploadManager.judgeImage(fileType);if(c){this.imageTreePanel=new Ext.tree.TreePanel({layout:"form",region:"west",id:"fileUploadManagerImageTreePanel",title:"图片分类",collapsible:true,autoScroll:true,split:true,width:180,tbar:new Ext.Toolbar({}),loader:new Ext.tree.TreeLoader({url:__ctxPath+"/system/treeLoadFileAttach.do?type=image"}),root:new Ext.tree.AsyncTreeNode({expanded:true}),rootVisible:false,listeners:{"click":this.imageNodeClick}});}this.treePanel=new Ext.tree.TreePanel({layout:"form",region:"west",id:"fileUploadManagerFilesTreePanel",title:"附件分类",collapsible:true,autoScroll:true,split:true,width:180,tbar:new Ext.Toolbar({items:[{xtype:"button",iconCls:"btn-refresh",text:"刷新",scope:this,handler:function(){this.treePanel.root.reload();}},"-",{xtype:"button",text:"展开",iconCls:"btn-expand",handler:function(){this.treePanel.expandAll();}},"-",{xtype:"button",text:"收起",iconCls:"btn-collapse",handler:function(){this.treePanel.collapseAll();}}]}),loader:new Ext.tree.TreeLoader({url:__ctxPath+"/system/treeLoadFileAttach.do"}),root:new Ext.tree.AsyncTreeNode({expanded:true}),rootVisible:false,listeners:{"click":this.nodeClick}});var d=new Ext.Toolbar({height:30,defaultType:"button",items:[{text:"上传",iconCls:"btn-upload",handler:this.upLoadFile,scope:this}]});this.gridPanel=new HT.GridPanel({id:"fileUploadManagerGridPanel",region:"center",tbar:d,rowActions:true,url:__ctxPath+"/system/listFileAttach.do",fields:[{name:"fileId",type:"int"},{name:"fileName",mapping:"fileName"},"ext","note","fileType","filePath","createtime","totalBytes"],columns:[{header:"fileId",dataIndex:"fileId",hidden:true},{header:"附件名称",dataIndex:"fileName"},{header:"上传时间",dataIndex:"createtime",format:"y-m-d"},{header:"大小",dataIndex:"note"},new Ext.ux.grid.RowActions({header:"管理",width:80,actions:[{iconCls:"btn-showDetail",qtip:"查看",style:"margin:0 3px 0 3px"},{iconCls:"btn-downLoad",qtip:"下载",style:"margin:0 3px 0 3px"}],listeners:{scope:this,"action":this.onRowAction}})]});this.gridPanel.addListener("rowdblclick",function(e,a,b){e.getSelectionModel().each(function(f){FileAttachDetail.show(f.data.fileId);});});this.panel=new Ext.Panel({iconCls:"menu-find-doc",layout:"border",region:"center",border:false});if(!c){this.panel.add(this.treePanel);this.panel.add(this.gridPanel);}else{this.imageStore=new Ext.data.JsonStore({url:__ctxPath+"/system/listFileAttach.do?type=image",root:"result",totalProperty:"totalCounts",id:"id",fields:[{name:"fileId",type:"int"},{name:"fileName",mapping:"fileName"},{name:"filePath",mapping:"filePath"}]});this.imageStore.load({params:{start:0,limit:8}});this.tpl=new Ext.XTemplate('<tpl for=".">','<div style="width:105px; height : 105px;" class="thumb-wrap" id="{fileId}">','<img align="middle" src="'+__ctxPath+'/attachFiles/{filePath}" style="width:90px;height:90px;margin-left:7px;" title="{fileName}"/>','<center><span style="margin-top:3px;">{fileName}</span><center>',"</div>","</tpl>"),this.dataView=new Ext.DataView({layout:"form",region:"center",store:this.imageStore,tpl:this.tpl,multiSelect:true,overClass:"x-view-over",itemSelector:"div.thumb-wrap",bodyStyle:"padding:4px",emptyText:"目前尚无记录",listeners:{"dblclick":{fn:this.imageDbClick.createCallback(this),scope:this}}});this.dataPanel=new Ext.Panel({layout:"form",region:"center",tbar:d,layout:"fit",defaults:{anchor:"100%,100%"},items:this.dataView,bbar:new Ext.PagingToolbar({pageSize:15,store:this.imageStore,displayInfo:true,displayMsg:"当前显示从{0}至{1}， 共{2}条记录",emptyMsg:"当前没有记录"})});this.panel.add(this.imageTreePanel);this.panel.add(this.dataPanel);}this.panel.doLayout();},onRowAction:function(j,g,i,h,f){switch(i){case"btn-showDetail":this.showdetail(g.data.fileId);break;case"btn-downLoad":this.downLoad(g.data.fileId);break;}},showdetail:function(b){FileAttachDetail.show(b);},downLoad:function(b){window.open(__ctxPath+"/file-downLoad?fileId="+b);},upLoadFile:function(){var c=this.callback;var d=new Ext.ux.UploadDialog.Dialog({file_cat:this.file_cat,url:this.url,scope:this,callback:function(a){if(a!=null&&a.length>0){var b=Ext.getCmp("fileUploadManagerGridPanel");b.getStore().baseParams={Q_fileType_S_LK:this.file_cat};b.getStore().reload({params:{start:0,limit:10}});if(c!=null){c.call(this,a);}}Ext.getCmp("fileUploadManager").close();}});d.show("queryWindow");},upLoadImage:function(){var b=App.createUploadDialog2({file_cat:this.file_cat,callback:function(d){if(d!=null&&d.length>0){var a=Ext.getCmp("fileUploadManager").dataView.getStore();a.url=__ctxPath+"/system/listFileAttach.do?type=image";a.baseParams={Q_fileType_S_LK:this.file_cat};a.reload({params:{start:0,limit:8}});}Ext.getCmp("fileUploadManager").close();}});b.show("image");},upLoad:function(){var i=Ext.getCmp("fileUploadMangerTabPanel");var j=Ext.getCmp("fileUploadManagerGridPanel");var g=j.getSelectionModel().getSelections();var k=this.permitted_extensions;if(FileUploadManager.judgeImage(k)){g=Ext.getCmp("fileUploadManager").dataView.getSelectedRecords();}var h=new Array();for(var l=0;l<g.length;l++){h.push(g[l].data);}if(this.callback!=null){this.callback.call(this,h);}Ext.getCmp("fileUploadManager").close();},nodeClick:function(d){if(d!=null){var f="";if(d.getDepth()>1){d.bubble(function(a){f=a.id+"/"+f;});f=f.substring(12,f.length-1);}var e=Ext.getCmp("fileUploadManagerGridPanel").getStore();e.url=__ctxPath+"/system/listFileAttach.do";e.reload({params:{start:0,limit:20,type:"file",fileType:f}});}},imageNodeClick:function(d){if(d!=null){var f="";if(d.getDepth()>1){d.bubble(function(a){f=a.id+"/"+f;});f=f.substring(12,f.length-1);}var e=Ext.getCmp("fileUploadManager").dataView.getStore();e.url=__ctxPath+"/system/listFileAttach.do?type=image";e.reload({params:{start:0,limit:20,type:"image",fileType:f}});}},imageDbClick:function(c){var d=c.dataView.getSelectedNodes();if(d!=""&&d!=null&&d!="undefined"){FileUploadImageDetailForm.show(d[0].id);}}});FileUploadManager.judgeImage=function(d){if(d!=null&&d!="undefined"){for(var e=0;e<d.length;e++){var f=d[e].toLowerCase();if(f=="bmp"||f=="png"||f=="jpeg"||f=="jpg"||f=="tiff"||f=="gif"){return true;}}}return false;};