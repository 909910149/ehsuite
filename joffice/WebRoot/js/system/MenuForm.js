MenuForm=Ext.extend(Ext.Window,{constructor:function(b){Ext.applyIf(this,b);this.initUIComponent(this.id,this.text,this.isChild);MenuForm.superclass.constructor.call(this,{id:"menuFormWin",title:this.text!=null?"新增/编辑菜单["+this.text+"]信息":"新增编辑菜单信息",iconCls:"menu-m",layout:"fit",modal:true,plain:false,maximizable:true,width:650,height:500,style:"padding: 5px 5px 5px 5px;",buttonAlign:"center",keys:{key:Ext.EventObject.ENTER,fn:this.submit,scope:this},buttons:[{text:"确定",iconCls:"btn-ok",handler:this.submit},{text:"取消",iconCls:"btn-cancel",handler:function(){Ext.getCmp("menuFormWin").close();}}],items:[this.formPanel]});},initUIComponent:function(j,l,h){var m=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:__ctxPath+"/menu/getMenu.do"}),reader:new Ext.data.JsonReader({root:"fn",totalProperty:"totalCounts",id:"id",fields:["fId","fText","fIconCls"]}),remoteSort:false});if(j!=null&&j!="undefined"){m.load({params:{id:j}});}var k=new Ext.grid.CheckboxSelectionModel();var i=new Ext.grid.ColumnModel({columns:[k,new Ext.grid.RowNumberer(),{header:"fId",dataIndex:"fId",hidden:true,sortable:true,menuDisabled:true},{header:"权限名称",dataIndex:"fText",sortable:true,menuDisabled:true},{header:"图标",dataIndex:"fIconCls",renderer:function(a){return a!=null?'<button style="width:13px;height:13px;" class="'+a+'"/>':"";},sortable:true,menuDisabled:true}]});var n=new Ext.grid.GridPanel({id:"MenuFormEditGrid",title:"菜单权限列表",autoHeight:true,autoScroll:true,sm:k,trackMouseOver:true,tbar:new Ext.Toolbar({height:30,items:[{text:"添加",iconCls:"btn-add",scope:this,handler:this.addFn.createCallback(j,l,h)},"-",{text:"删除",iconCls:"btn-del",scope:this,handler:this.del.createCallback(j)}]}),store:m,cm:i,viewConfig:{forceFit:true,enableRowBody:false,showPreview:false}});n.addListener("rowdblclick",function(c,a,b){c.getSelectionModel().each(function(d){new MenuFunctionForm({fId:d.data.fId,fText:d.data.fText,menuId:j,menuText:l}).show();});});this.formPanel=new Ext.FormPanel({id:"MenuFormPanel",layout:"form",region:"center",border:false,anchor:"98% 98%",url:__ctxPath+"/system/saveMenu.do",defaultType:"textfield",style:"padding: 5px 5px 5px 5px;margins: 5px 5px 5px 5px;",autoScroll:true,items:[{xtype:"fieldset",title:"基本信息",layout:"form",defaultType:"textfield",items:[{xtype:"hidden",name:"parentId",value:this.parentId!=null?this.parentId:""},{name:"id",width:"93%",fieldLabel:"编号",maxLength:125,allowBlank:false,readOnly:this.id!=null?true:false},{xtype:"hidden",name:"type",value:this.text!=null?"edit":"add"},{name:"text",width:"93%",fieldLabel:"显示文本",maxLength:125,allowBlank:false},{xtype:"container",height:30,layout:"column",defaultType:"textfield",items:[{xtype:"label",text:"图标:",width:105},{columnWidth:0.93,name:"iconCls",fieldLabel:"图标"},{width:100,xtype:"button",iconCls:"menu-m",text:"请选择",handler:function(){IconSelector.getView(function(a){var b=Ext.getCmp("MenuFormPanel");b.getCmpByName("iconCls").setValue(a);}).show();}}]}]},{xtype:"fieldset",title:"权限设置",layout:"form",autoScroll:true,items:[n]}]});if(this.id!=null&&this.id!="undefined"){this.formPanel.getForm().load({deferredRender:true,url:__ctxPath+"/menu/getMenu.do",params:{id:j},waitMsg:"数据正在加载，请稍后...",success:function(b,a){}});}},submit:function(){var d=Ext.getCmp("MenuFormPanel");var c=d.getCmpByName("type").getValue()=="add"?"/menu/addMenu.do":"/menu/editMenu.do";if(d.getForm().isValid()){d.getForm().submit({deferredRender:false,url:__ctxPath+c,waitMsg:"数据正在提交，请稍后...",success:function(){Ext.ux.Toast.msg("操作提示","数据操作成功！");Ext.getCmp("menuViewTreePanel").root.reload();if(curUserInfo.username=="admin"){loadWestMenu("true");}else{Ext.ux.Toast.msg("操作提示","仅对开发用户开放刷新菜单功能!");}Ext.getCmp("menuFormWin").close();},failure:function(f,a){var b=Ext.util.JSON.decode(a.response.responseText);Ext.ux.Toast.msg("操作提示",b.msg);}});}},del:function(h){var j=Ext.getCmp("MenuFormEditGrid");var i=j.getSelectionModel().getSelections();if(i!=null&&i.length>0){var g="";for(var f=0;f<i.length;f++){g+=i[f].data.fId;if(f!=i.length-1){g+=",";}}Ext.Msg.confirm("操作提示","你真的要删除吗？",function(a){if(a=="yes"){Ext.Ajax.request({url:__ctxPath+"/menu/delFnMenu.do",params:{id:h,fId:g},method:"post",waitMsg:"数据正在提交，请稍后...",success:function(){j.getStore().reload();},failure:function(){Ext.ux.Toast.msg("操作提示","删除权限信息失败！");}});}});}else{Ext.ux.Toast.msg("操作提示","请选择要删除的数据！");}},addFn:function(f,d,e){if(e){new MenuFunctionForm({menuId:f,menuText:d}).show();}else{Ext.ux.Toast.msg("操作提示","对不起，该菜单存在子项，不能添加权限！");}}});