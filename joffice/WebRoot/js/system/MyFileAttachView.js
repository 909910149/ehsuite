Ext.ns("MyFileAttachView");MyFileAttachView=Ext.extend(Ext.Panel,{treePanel:null,searchPanel:null,gridPanel:null,constructor:function(b){Ext.applyIf(this,b);this.initUIComponent();MyFileAttachView.superclass.constructor.call(this,{id:"1MyFileAttachView",title:"我的附件",iconCls:"menu-attachment",layout:"border",region:"center",autoScroll:true,items:[this.searchPanel,this.treePanel,this.gridPanel]});},initUIComponent:function(){this.treePanel=new Ext.tree.TreePanel({layout:"form",region:"west",id:"myFileAttachViewTreePanel",title:"附件分类",collapsible:true,autoScroll:true,split:true,width:180,tbar:new Ext.Toolbar({items:[{xtype:"button",iconCls:"btn-refresh",text:"刷新",handler:function(){Ext.getCmp("myFileAttachViewTreePanel").root.reload();}},"-",{xtype:"button",text:"展开",iconCls:"btn-expand",handler:function(){Ext.getCmp("myFileAttachViewTreePanel").expandAll();}},"-",{xtype:"button",text:"收起",iconCls:"btn-collapse",handler:function(){Ext.getCmp("myFileAttachViewTreePanel").collapseAll();}}]}),loader:new Ext.tree.TreeLoader({url:__ctxPath+"/system/treeLoadFileAttach.do"}),root:new Ext.tree.AsyncTreeNode({expanded:true}),rootVisible:false,listeners:{"click":this.nodeClick}});var i=new Ext.Toolbar({id:"myFileAttachViewToolbar",height:30,bodyStyle:"text-align:left",defaultType:"button",items:[{text:"删除",iconCls:"btn-del",handler:this.removeAll,scope:this}]});this.searchPanel=new Ext.FormPanel({region:"north",height:35,frame:false,border:false,id:"MyFileAttachSearchForm",layout:"hbox",keys:{key:Ext.EventObject.ENTER,fn:this.search,scope:this},layoutConfig:{padding:"5",align:"middle"},defaults:{xtype:"label",margins:{top:0,right:4,bottom:4,left:4}},items:[{text:"请输入查询条件:"},{text:"文件名"},{xtype:"textfield",width:80,name:"Q_fileName_S_LK"},{text:"创建时间"},{xtype:"datefield",format:"Y-m-d H:i:s",width:80,name:"Q_createtime_D_GE"},{text:"扩展名"},{xtype:"textfield",width:60,name:"Q_ext_S_LK"},{text:"上传者"},{xtype:"textfield",width:80,name:"Q_creator_S_LK"},{xtype:"button",text:"查询",iconCls:"search",handler:this.search},{xtype:"button",text:"清空",iconCls:"reset",handler:this.reset}]});var j=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:__ctxPath+"/system/listAllFileAttach.do"}),baseParams:{"Q_delFlag_N_EQ":0,"Q_creatorId_L_EQ":curUserInfo.userId},reader:new Ext.data.JsonReader({root:"result",totalProperty:"totalCounts",id:"id",fields:[{name:"fileId",type:"int"},"fileName","filePath","createtime","ext","type","note","creator","fileType"]}),remoteSort:true});j.setDefaultSort("fileId","desc");var f=new Ext.ux.grid.RowActions({header:"管理",width:80,actions:[{iconCls:"btn-del",qtip:"删除",style:"margin:0 3px 0 3px"},{iconCls:"btn-detail",qtip:"查看",style:"margin:0 3px 0 3px"}]});var h=new Ext.grid.CheckboxSelectionModel();var g=new Ext.grid.ColumnModel({columns:[h,new Ext.grid.RowNumberer(),{header:"fileId",dataIndex:"fileId",hidden:true},{header:"文件名",dataIndex:"fileName"},{header:"文件路径",dataIndex:"filePath"},{header:"创建时间",dataIndex:"createtime"},{header:"扩展名",dataIndex:"ext"},{header:"附件类型",dataIndex:"fileType"},{header:"说明",dataIndex:"note"},{header:"上传者",dataIndex:"creator"},f],defaults:{sortable:true,menuDisabled:true,width:100}});j.load({params:{start:0,limit:25}});this.gridPanel=new Ext.grid.GridPanel({id:"MyFileAttachGrid",layout:"border",region:"center",tbar:i,store:j,trackMouseOver:true,disableSelection:false,loadMask:true,cm:g,sm:h,plugins:f,viewConfig:{forceFit:true,enableRowBody:false,showPreview:false},bbar:new HT.PagingBar({store:j})});this.gridPanel.addListener("rowdblclick",function(b,c,a){b.getSelectionModel().each(function(d){if(isGranted("_FileAttachEdit")){FileAttachDetail.show(d.data.fileId);}});});f.on("action",this.onRowAction,this);},detail:function(b){if(b!=null&&b!=""&&b!="undefined"){FileAttachDetail.show(b);}},search:function(){var d=Ext.getCmp("MyFileAttachSearchForm");var c=Ext.getCmp("MyFileAttachGrid");if(d.getForm().isValid()){$search({searchPanel:d,gridPanel:c});}},reset:function(){var b=Ext.getCmp("MyFileAttachSearchForm");b.getForm().reset();},removeAll:function(){var h=Ext.getCmp("MyFileAttachGrid");var f=h.getSelectionModel().getSelections();if(f.length==0){Ext.ux.Toast.msg("操作提示","请选择要删除的记录！");return;}var g=Array();for(var e=0;e<f.length;e++){g.push(f[e].data.fileId);}this.remove(g);},remove:function(c){var d=Ext.getCmp("MyFileAttachGrid");Ext.Msg.confirm("信息确认","您确认要删除该记录吗？",function(a){if(a=="yes"){Ext.Ajax.request({url:__ctxPath+"/system/multiDelFileAttach.do",params:{ids:c},method:"post",success:function(){Ext.ux.Toast.msg("信息提示","成功删除所选记录！");d.getStore().reload({params:{start:0,limit:25}});}});}});},nodeClick:function(d){if(d!=null){var f="";if(d.getDepth()>1){d.bubble(function(a){f=a.id+"/"+f;});f=f.substring(12,f.length-1);}var e=Ext.getCmp("MyFileAttachGrid").getStore();e.url=__ctxPath+"/system/listFileAttach.do";e.reload({params:{start:0,limit:25,"Q_fileType_S_LK":f,"Q_delFlag_N_EQ":0}});}},onRowAction:function(j,g,i,h,f){switch(i){case"btn-detail":this.detail(g.data.fileId);break;case"btn-del":this.remove(g.data.fileId);break;default:break;}}});