DocumentForm=Ext.extend(Ext.Window,{formPanel:null,constructor:function(b){Ext.applyIf(this,b);this.initUI();DocumentForm.superclass.constructor.call(this,{id:"DocumentFormWin",title:"文档详细信息",iconCls:"menu-personal-doc",width:700,height:500,modal:true,maximizable:true,layout:"fit",items:this.formPanel,buttonAlign:"center",buttons:this.buttons});},initUI:function(){var d=__ctxPath+"/document/listDocFolder.do?method=1";var c=new TreeSelector("folderSelect",d,"文件夹*","folderId");this.formPanel=new HT.FormPanel({url:__ctxPath+"/document/saveDocument.do",id:"DocumentForm",formId:"DocumentFormId",defaults:{anchor:"98%,98%",margins:{top:4,right:4,bottom:4,left:4}},items:[{name:"folderId",id:"DocumentForm.folderId",xtype:"hidden"},{name:"document.docId",xtype:"hidden",value:this.docId==null?"":this.docId},c,{xtype:"textfield",fieldLabel:"文档名称",name:"document.docName",anchor:"98%",allowBlank:false},{height:280,anchor:"98%",xtype:"fckeditor",fieldLabel:"内容",name:"document.content",allowBlank:false},{xtype:"hidden",name:"document.docType",value:"文档"},{xtype:"container",layout:"column",border:false,defaults:{border:false},items:[{columnWidth:0.7,layout:"form",border:false,items:[{fieldLabel:"附件",xtype:"panel",id:"personFilePanel",frame:false,border:true,bodyStyle:"padding:4px 4px 4px 4px",height:80,autoScroll:true,html:""}]},{columnWidth:0.3,items:[{border:false,xtype:"button",text:"添加附件",iconCls:"menu-attachment",handler:function(){var a=App.createUploadDialog({file_cat:"document/privateDocument",callback:function(b){var j=Ext.getCmp("DocumentForm.fileIds");var h=Ext.getCmp("personFilePanel");for(var i=0;i<b.length;i++){if(j.getValue()!=""){j.setValue(j.getValue()+",");}j.setValue(j.getValue()+b[i].fileId);Ext.DomHelper.append(h.body,'<span><a href="#" onclick="FileAttachDetail.show('+b[i].fileId+')">'+b[i].fileName+'</a> <img class="img-delete" src="'+__ctxPath+'/images/system/delete.gif" onclick="removeFile(this,'+b[i].fileId+')"/>&nbsp;|&nbsp;</span>');}}});a.show(this);}},{xtype:"button",text:"清除附件",iconCls:"reset",handler:function(){var a=Ext.getCmp("DocumentForm.fileIds");var b=Ext.getCmp("personFilePanel");b.body.update("");a.setValue("");}},{xtype:"hidden",id:"DocumentForm.fileIds",name:"fileIds"}]}]}]});if(this.folderId!=null&&this.folderId!=undefined&&this.folderName!=null&&this.folderName!=undefined){Ext.getCmp("DocumentForm.folderId").setValue(this.folderId);Ext.getCmp("folderSelect").setValue(this.folderName);}if(this.docId!=null&&this.docId!="undefined"){this.formPanel.loadData({url:__ctxPath+"/document/getDocument.do?docId="+this.docId,waitMsg:"正在载入数据...",preName:"document",root:"data",success:function(p,a){var m=Ext.util.JSON.decode(p.responseText).data;var r=m.docFolder.folderId;var q=m.docFolder.folderName;Ext.getCmp("DocumentForm.folderId").setValue(r);Ext.getCmp("folderSelect").setValue(q);var i=m.attachFiles;var n=Ext.getCmp("personFilePanel");var b=Ext.getCmp("DocumentForm.fileIds");for(var o=0;o<i.length;o++){if(b.getValue()!=""){b.setValue(b.getValue()+",");}b.setValue(b.getValue()+i[o].fileId);Ext.DomHelper.append(n.body,'<span><a href="#" onclick="FileAttachDetail.show('+i[o].fileId+')">'+i[o].fileName+'</a><img class="img-delete" src="'+__ctxPath+'/images/system/delete.gif" onclick="removeFile(this,'+i[o].fileId+')"/>&nbsp;|&nbsp;</span>');}},failure:function(b,a){Ext.MessageBox.show({title:"操作信息",msg:"载入信息失败，请联系管理员！",buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});}});}this.buttons=[{xtype:"button",text:"保存",iconCls:"btn-save",handler:this.saveRecord,scope:this},{xtype:"button",text:"关闭",iconCls:"btn-cancel",scope:this,handler:function(){this.close();}}];},saveRecord:function(){var e=this.formPanel;var f=this;var d=Ext.getCmp("folderSelect").getValue();if(d!=null&&d!=""&&d!="undefined"){if(e.getForm().isValid()){e.getForm().submit({method:"post",waitMsg:"正在提交数据...",success:function(c,a){Ext.ux.Toast.msg("操作信息","成功信息保存！");var b=Ext.getCmp("DocumentGrid");if(b!=null&&b!=undefined){b.getStore().reload();}var h=Ext.getCmp("PrivateDocumentView");if(h!=null){h.dataView.getStore().reload();}f.close();},failure:function(b,a){Ext.MessageBox.show({title:"操作信息",msg:"信息保存出错，请联系管理员！",buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});f.close();}});}}else{Ext.MessageBox.show({title:"操作信息",msg:"请选择文件夹！",buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});}}});function removeFile(h,g){var f=Ext.getCmp("DocumentForm.fileIds");var i=f.getValue();if(i.indexOf(",")<0){f.setValue("");}else{i=i.replace(","+g,"").replace(g+",","");f.setValue(i);}var j=Ext.get(h.parentNode);j.remove();}