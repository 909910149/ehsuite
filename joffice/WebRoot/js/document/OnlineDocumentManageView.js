Ext.ns("OnlineDocumentManageView");OnlineDocumentManageView=Ext.extend(Ext.Panel,{searchFormPanel:null,showPanel:null,gridPanel:null,treePanel:null,fileId:0,fileName:null,store:null,selectNode:null,isSearching:false,constructor:function(b){Ext.applyIf(this,b);this.initUI();OnlineDocumentManageView.superclass.constructor.call(this,{id:"OnlineDocumentManageView",layout:"border",title:"在线文档管理",iconCls:"menu-onlinedoc",region:"center",items:[this.showPanel]});},initUI:function(){this.searchFormPanel=new Ext.FormPanel({height:35,region:"north",frame:false,border:false,layout:"hbox",layoutConfig:{padding:"5",align:"middle"},defaults:{style:"padding:0px 5px 0px 5px;",border:false,anchor:"98%,98%",labelWidth:75,xtype:"label"},items:[{text:"文件名："},{xtype:"textfield",name:"fileName"},{xtype:"button",text:"查询",scope:this,iconCls:"btn-search",handler:this.search},{xtype:"button",text:"重置",scope:this,iconCls:"btn-reset",handler:function(){this.searchFormPanel.getForm().reset();}}]});this.treePanel=new Ext.tree.TreePanel({region:"west",id:"OnlineTreePanel",title:"知识目录",collapsible:true,split:true,autoScroll:true,width:200,height:800,tbar:new Ext.Toolbar({items:[{xtype:"button",iconCls:"btn-refresh",text:"刷新",scope:this,handler:function(){this.treePanel.root.reload();}},{xtype:"button",text:"展开",scope:this,iconCls:"btn-expand",handler:function(){this.treePanel.expandAll();}},{xtype:"button",text:"收起",scope:this,iconCls:"btn-collapse",handler:function(){this.treePanel.collapseAll();}}]}),loader:new Ext.tree.TreeLoader({url:__ctxPath+"/document/onlineTreeDocFolder.do",listeners:{scope:this,"load":function(){this.store.load({folderId:0});}}}),root:new Ext.tree.AsyncTreeNode({expanded:true}),rootVisible:false,listeners:{scope:this,"click":this.clickNode,"contextmenu":this.treeContextMenu}});var c=new Ext.grid.CheckboxSelectionModel();var d=new Ext.grid.ColumnModel({columns:[new Ext.grid.RowNumberer(),{header:"fileId",dataIndex:"fileId",hidden:true},{header:"文件名",dataIndex:"fileName",width:120,renderer:function(b,h,j){var i=j.data.isFolder;var a=j.data.fileType;if(i==1){return'<img width="16" height="16" src="'+__ctxPath+'/images/flag/document/folder.png"/>'+b+"</img>";}else{return'<img width="16" height="16" src="'+__ctxPath+"/images/flag/document/"+a+'.png"/>'+b+"."+a+"</img>";}}},{header:"类型",dataIndex:"fileType",width:60},{header:"文件大小",dataIndex:"fileSize",renderer:function(a){return'<span ext:qtip="文件大小：'+a+'">'+a+"</span>";}},{header:"作者",dataIndex:"author",width:80},{header:"更新时间",dataIndex:"updateTime"},{header:"管理",dataIndex:"docId",width:120,renderer:function(o,r,v,s,b){var w=v.data.fileId;var q=v.data.isFolder;var u=v.data.rightMod;var p=v.data.rightDel;var x=v.data.fileName;var a=v.data.fileType;var t='<a title="属性" value="" href="#" onclick="OnlineDocumentManageView.pro('+w+","+q+')">属性</a>';if(u==1&&q==0){t+='<a title="编辑" value="" class="" href="#" onclick="OnlineDocumentManageView.edit('+w+","+q+",'"+a+"')\">&nbsp;编辑</a>";}if(p==1&&q==0){t+='<a title="删除" value="" class="" href="#" onclick="OnlineDocumentManageView.deleteDocument('+w+')">&nbsp;删除</a>';}if(q==1){t+='<a title="编辑" value="" class="" href="#" onclick="OnlineDocumentManageView.edit('+w+","+q+')">&nbsp;编辑</a>';t+='<a title="删除" value="" class="" href="#" onclick="OnlineDocumentManageView.deleteFolder('+w+')">&nbsp;删除</a>';t+='<a title="授权" value="" class="" href="#" onclick="OnlineDocumentManageView.privilege('+w+",'"+x+"')\">&nbsp;授权</a>";}if(q==0){t+='<a title="查看" value="" class="" href="#" onclick="OnlineDocumentManageView.detail('+w+')">&nbsp;查看</a>';}return t;}}],defaults:{menuDisabled:true,width:100}});this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:__ctxPath+"/document/onlineListDocFolder.do"}),reader:new Ext.data.JsonReader({root:"result",id:"id",fields:["fileId","fileName","fileSize","fileType","isFolder",{name:"parentId",type:"int"},"parentName","isShared","rightRead","rightMod","rightDel","author","keywords","updateTime"]}),remoteSort:true,listeners:{scope:this,"load":this.loadAction}});this.toolbar=new Ext.Toolbar({border:false,items:[{xtype:"button",text:"新建文件夹",scope:this,iconCls:"btn-add",id:"newOnlineFolderButton",handler:this.newFolder},{xtype:"button",text:"新建DOC文档",id:"newOnlineDocumentButton",scope:this,iconCls:"btn-add",handler:function(){if(this.fileId!=0&&this.fileName!=""){new OnlineDocumentForm({docType:"doc",folderId:this.fileId,folderName:this.fileName}).show();}else{new OnlineDocumentForm({docType:"doc"}).show();}}},{xtype:"button",text:"新建EXL文档",id:"newOnlineEXCELButton",scope:this,iconCls:"btn-add",handler:function(){if(this.fileId!=0&&this.fileName!=""){new OnlineDocumentForm({docType:"xls",folderId:this.fileId,folderName:this.fileName}).show();}else{new OnlineDocumentForm({docType:"xls"}).show();}}},{xtype:"button",text:"新建PPT文档",id:"newOnlinePPTButton",scope:this,iconCls:"btn-add",handler:function(){if(this.fileId!=0&&this.fileName!=""){new OnlineDocumentForm({docType:"ppt",folderId:this.fileId,folderName:this.fileName}).show();}else{new OnlineDocumentForm({docType:"ppt"}).show();}}},{xtype:"button",text:"上一层",id:"upOnlineLevelButton",iconCls:"btn-up",scope:this,handler:this.upLevel},{xtype:"button",text:"目录",iconCls:"btn-up",scope:this,handler:this.firstLevel},{xtype:"button",text:"刷新",iconCls:"btn-refresh",id:"refreshOnlineButton",scope:this,handler:function(){this.store.reload();this.selectNode=this.treePanel.getNodeById(this.fileId);this.selectNode.select();this.changPath();}}]});this.gridPanel=new Ext.grid.GridPanel({region:"center",tbar:this.toolbar,id:"OnlineDocumentGrid",store:this.store,trackMouseOver:true,disableSelection:false,loadMask:true,cm:d,sm:c,viewConfig:{forceFit:true,enableRowBody:false,showPreview:false}});this.gridPanel.addListener("rowdblclick",function(b,e,a){b.getSelectionModel().each(function(f){if(f.data.isFolder==1){this.fileId=f.data.fileId;this.fileName=f.data.fileName;var h=b.getStore();h.baseParams={folderId:f.data.fileId};h.reload();this.getTitle().setTitle("["+f.data.fileName+"]在线文档列表");this.selectNode=this.treePanel.getNodeById(this.fileId);this.selectNode.select();this.changPath();this.searchEnable();}else{new OnlineDocumentDetail({docId:f.data.fileId,docType:f.data.fileType}).show();}},this);},this);this.showPanel=new Ext.Panel({region:"center",border:false,layout:"border",items:[this.treePanel,{layout:"border",border:false,region:"center",items:[{xtype:"panel",height:28,region:"north",layout:"fit",items:[{xtype:"textfield",readOnly:true,style:"padding-left:15px;",cls:"text-file",name:"FilePathDisplayField",id:"OnlineDocumentPathDisplayField",value:"/在线文档目录"}]},{layout:"border",id:"TitleOnlineShowPanel",region:"center",title:"在线文档列表",border:false,items:[this.searchFormPanel,this.gridPanel]}]}]});},treeContextMenu:function(e,g){this.clickNode(e);var f=new Array();f.push({text:"新建",scope:this,iconCls:"btn-add",handler:this.newFolder});if(e.id!=0){f.push({text:"修改",scope:this,iconCls:"btn-edit",handler:this.editFolder});f.push({text:"删除",scope:this,iconCls:"btn-delete",handler:this.delFolder});f.push({text:"属性",scope:this,iconCls:"btn-detail",handler:this.proFolder});}var h=new Ext.menu.Menu({items:f});h.showAt(g.getXY());},search:function(){this.isSearching=true;this.searchDisable();var e=this.searchFormPanel;if(e.getForm().isValid()){var f=Ext.Ajax.serializeForm(e.getForm().getEl());var d=Ext.urlDecode(f);d.isSearch=true;this.store.baseParams=d;this.store.reload();}},searchDisable:function(){Ext.getCmp("upOnlineLevelButton").disable();Ext.getCmp("newOnlineFolderButton").disable();Ext.getCmp("newOnlineDocumentButton").disable();Ext.getCmp("newOnlineEXCELButton").disable();Ext.getCmp("newOnlinePPTButton").disable();Ext.getCmp("refreshOnlineButton").disable();this.treePanel.getNodeById(0).select();Ext.getCmp("OnlineDocumentPathDisplayField").setValue("/在线文档目录");},searchEnable:function(){this.isSearching=false;Ext.getCmp("upOnlineLevelButton").enable();Ext.getCmp("newOnlineFolderButton").enable();Ext.getCmp("newOnlineDocumentButton").enable();Ext.getCmp("newOnlineEXCELButton").enable();Ext.getCmp("newOnlinePPTButton").enable();Ext.getCmp("refreshOnlineButton").enable();},newFolder:function(){var b=this.treePanel;new DocFolderForm({folderId:null,parentId:this.fileId,isShared:2,callback:function(){b.root.reload();}}).show();},editFolder:function(){var b=this.treePanel;new DocFolderForm({folderId:this.fileId,callback:function(){b.root.reload();}}).show();},delFolder:function(){var g=this.treePanel;var f=this.fileId;var e=this;var h=this.selectNode.parentNode;Ext.Msg.confirm("删除操作","你确定删除该目录吗?",function(a){if(a=="yes"){Ext.Ajax.request({url:__ctxPath+"/document/removeDocFolder.do",params:{folderId:f},method:"post",success:function(d,b){var c=Ext.util.JSON.decode(d.responseText);if(c.success==false){Ext.ux.Toast.msg("操作信息",c.message);}else{Ext.ux.Toast.msg("操作信息","成功删除目录！");g.root.reload();e.clickNode(h);}},failure:function(c,b){Ext.MessageBox.show({title:"操作信息",msg:"信息保存出错，请联系管理员！",buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});}});}});},getTitle:function(){var b=Ext.getCmp("TitleOnlineShowPanel");if(b!=null){return b;}return null;},loadAction:function(l){if(!this.isSearching){var g=l.getAt(0);if(g!=null){var k=g.get("isFolder");if(k==1){var i=g.get("parentId");var j=g.get("parentName");if(i==0){this.getTitle().setTitle("在线文档列表");}else{this.fileName=j;this.getTitle().setTitle("["+j+"]在线文档列表");}this.fileId=i;}}var h=this.treePanel.getNodeById(this.fileId);if(h){this.selectNode=h;this.selectNode.select();this.changPath();if(h.id==0){this.getTitle().setTitle("在线文档列表");}else{this.fileId=h.id;this.fileName=h.text;this.getTitle().setTitle("["+h.text+"]在线文档列表");}}}else{this.getTitle().setTitle("查询结果列表");}},clickNode:function(d){if(d!=null){this.selectNode=d;this.changPath();var f=this.gridPanel;if(d.id==0){this.getTitle().setTitle("在线文档列表");}else{this.fileName=d.text;this.getTitle().setTitle("["+d.text+"]在线文档列表");}this.fileId=d.id;var e=f.getStore();e.baseParams={folderId:d.id};e.reload();this.searchEnable();}},changPath:function(){var d=this.selectNode;var c="";while(d!=null&&d.text!=undefined){c="/"+d.text+c;d=d.parentNode;}Ext.getCmp("OnlineDocumentPathDisplayField").setValue(c);},upLevel:function(){if(this.fileId==0||this.fileId==null){Ext.ux.Toast.msg("提示信息","已是最顶层!");return;}this.store.baseParams={folderId:this.fileId,isUp:true};this.store.reload();},firstLevel:function(){this.store.baseParams={folderId:0};this.store.reload();this.getTitle().setTitle("在线文档列表");this.searchEnable();}});OnlineDocumentManageView.pro=function(e,d){var f=Ext.getCmp("OnlineDocumentPathDisplayField").getValue();if(d==1){new FileDetailShowWin({isOnline:true,fileId:e,filePath:f,isFolder:true}).show();}else{new FileDetailShowWin({isOnline:true,fileId:e,filePath:f,isFolder:false}).show();}};OnlineDocumentManageView.edit=function(e,h,f){if(h==1){var g=Ext.getCmp("OnlineTreePanel");new DocFolderForm({folderId:e,callback:function(){g.root.reload();}}).show();}else{new OnlineDocumentForm({docId:e,docType:f}).show();}};OnlineDocumentManageView.detail=function(b){new OnlineDocumentDetail({docId:b}).show();};OnlineDocumentManageView.privilege=function(d,c){new KnowledgePrivilegeWin({folderId:d,folderName:c}).show();};OnlineDocumentManageView.deleteFolder=function(b){Ext.Msg.confirm("删除操作","你确定删除该目录吗?",function(a){if(a=="yes"){Ext.Ajax.request({url:__ctxPath+"/document/removeDocFolder.do",params:{folderId:b},method:"post",success:function(j,g){var i=Ext.util.JSON.decode(j.responseText);if(i.success==false){Ext.ux.Toast.msg("操作信息",i.message);}else{Ext.ux.Toast.msg("操作信息","成功删除目录！");var h=Ext.getCmp("OnlineTreePanel");h.root.reload();}},failure:function(f,e){Ext.MessageBox.show({title:"操作信息",msg:"信息保存出错，请联系管理员！",buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});}});}});};OnlineDocumentManageView.deleteDocument=function(b){Ext.Msg.confirm("信息确认","您确认要删除该文档吗？",function(a){if(a=="yes"){Ext.Ajax.request({url:__ctxPath+"/document/multiDelDocument.do",params:{ids:b},method:"post",success:function(){var d=Ext.getCmp("OnlineDocumentGrid");d.getStore().reload();}});}});};