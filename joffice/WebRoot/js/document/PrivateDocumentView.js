PrivateDocumentView=Ext.extend(Ext.Panel,{searchPanel:null,showPanel:null,store:null,dataView:null,selectNode:null,constructor:function(b){Ext.applyIf(this,b);this.initUI();PrivateDocumentView.superclass.constructor.call(this,{title:"我的文档",iconCls:"menu-personal-doc",layout:"border",region:"center",id:"PrivateDocumentView",height:800,width:800,items:[this.treePanel,{region:"center",layout:"border",items:[this.searchPanel,this.showPanel]}]});},initUI:function(){this.searchPanel=new Ext.FormPanel({height:35,region:"north",frame:false,border:false,layout:"hbox",layoutConfig:{padding:"5",align:"middle"},defaults:{style:"padding:0px 5px 0px 5px;",border:false,anchor:"98%,98%",labelWidth:75,xtype:"label"},items:[{text:"文件名："},{xtype:"textfield",name:"fileName"},{xtype:"button",text:"查询",scope:this,iconCls:"btn-search",handler:this.search},{xtype:"button",text:"重置",scope:this,iconCls:"btn-reset",handler:function(){this.searchPanel.getForm().reset();}}]});this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:__ctxPath+"/document/folderDocFolder.do"}),reader:new Ext.data.JsonReader({root:"result",id:"id",fields:["fileId","fileName","fileSize","fileType","isFolder",{name:"parentId",type:"int"},"parentName","isShared"]}),remoteSort:true});this.store.setDefaultSort("isFolder","desc");this.store.load();this.dataView=new Ext.DataView({region:"center",border:false,store:this.store,tpl:new Ext.XTemplate("<ul>",'<tpl for=".">','<li class="phone" id="{fileId}" name="{fileName}" type="{isFolder}" ext:qtip="<div>{fileName}</div><div>{fileType}</div>" onselect= "document.selection.empty()">','<img width="64" height="64" src="'+__ctxPath+'/images/flag/document/{[(values.isFolder==0?(values.isShared==0?"file.png":"share.png"):"folder.png")]}" />','<strong style="font-size:15px;overflow:hidden;">{fileName}</strong>',"</li>","</tpl>","</ul>"),id:"phones",itemSelector:"li.phone",overClass:"phone-hover",multiSelect:true,autoScroll:true,listeners:{"render":{fn:this.bodyRender,scope:this},"dblclick":{fn:this.openFile,scope:this},"contextmenu":{fn:this.dbclickNode,scope:this}}});this.toolbar=new Ext.Toolbar({items:[{xtype:"button",text:"新建文件夹",scope:this,iconCls:"btn-add",id:"NewPrivateFolderButton",handler:this.newFolder},{xtype:"button",text:"新建文档",scope:this,id:"NewPrivateDocumentButton",iconCls:"btn-add",handler:this.newDocument},{xtype:"button",text:"向上",iconCls:"btn-up",id:"UpPrivateFolderButton",scope:this,handler:this.upLevel},{xtype:"button",text:"刷新",iconCls:"btn-refresh",scope:this,handler:this.refresh}]});this.treePanel=new Ext.tree.TreePanel({region:"west",title:"目录",collapsible:true,split:true,autoScroll:true,width:200,height:800,animate:true,enableDD:true,tbar:new Ext.Toolbar({items:[{xtype:"button",iconCls:"btn-refresh",text:"刷新",scope:this,handler:function(){this.treePanel.root.reload();}},{xtype:"button",text:"展开",scope:this,iconCls:"btn-expand",handler:function(){this.treePanel.expandAll();}},{xtype:"button",text:"收起",scope:this,iconCls:"btn-collapse",handler:function(){this.treePanel.collapseAll();}}]}),loader:new Ext.tree.TreeLoader({url:__ctxPath+"/document/listDocFolder.do",listeners:{scope:this,"load":function(){if(!this.selectNode){this.selectNode=this.treePanel.getNodeById(0);this.selectNode.select();}else{this.selectNodeMethod(this.selectNode);}this.changePath();}}}),root:new Ext.tree.AsyncTreeNode({expanded:true,draggable:true}),rootVisible:false,listeners:{scope:this,"click":this.clickNode,"contextmenu":this.treeContextMenu,"beforemovenode":this.moveNode}});this.showPanel=new Ext.Panel({region:"center",tbar:this.toolbar,layout:"border",items:[{xtype:"panel",height:28,region:"north",layout:"fit",items:[{xtype:"textfield",readOnly:true,style:"padding-left:15px;",cls:"text-file",name:"FilePathDisplayField",id:"FilePathDisplayField",value:"/我的文件夹"}]},this.dataView]});},treeContextMenu:function(e,g){this.clickNode(e);var f=new Array();f.push({text:"新建",scope:this,iconCls:"btn-add",handler:this.newFolder});if(e.id!=0){f.push({text:"修改",scope:this,iconCls:"btn-edit",handler:this.editFile.createCallback(this,true)});f.push({text:"删除",scope:this,iconCls:"btn-delete",handler:this.delFolder.createCallback(this,this.dataView,this.selectNode.id,this.treePanel,true)});}f.push({text:"属性",scope:this,iconCls:"btn-detail",handler:this.folderDetail});var h=new Ext.menu.Menu({items:f});h.showAt(g.getXY());},newDocument:function(){if(this.selectNode&&this.selectNode.id!=0){new DocumentForm({folderId:this.selectNode.id,folderName:this.selectNode.text}).show();}else{new DocumentForm().show();}},moveNode:function(i,k,m,l,n){if(m.id==l.id){return false;}var j=this.dataView;var h=this;Ext.Msg.confirm("操作提示","你确定移动该目录吗?",function(a){if(a=="yes"){Ext.Ajax.request({url:__ctxPath+"/document/moveDocFolder.do",params:{folderIdOld:k.id,folderIdNew:l.id},method:"post",success:function(c,b){i.root.reload();j.getStore().reload();},failure:function(c,b){}});return;}});return false;},refresh:function(){var b=this.dataView.getStore();this.treePanel.root.reload();b.reload();},folderDetail:function(){if(!this.selectNode){return;}new FileDetailShowWin({isPersonal:true,fileId:this.selectNode.id,isFolder:true}).show();},bodyRender:function(b){b.getEl().on("contextmenu",this.bodyContextClick,this);},bodyContextClick:function(j,e,i){var k=e;if(k.id!="phones"){return;}var h=new Array();h.push({text:"上一目录",scope:this,disabled:this.isSearching?true:false,iconCls:"btn-up",handler:this.upLevel});h.push({text:"新建文件",scope:this,iconCls:"btn-add",disabled:this.isSearching?true:false,handler:this.newFolder});h.push({text:"新建文档",scope:this,iconCls:"btn-add",disabled:this.isSearching?true:false,handler:this.newDocument});h.push({text:"刷新",scope:this,iconCls:"btn-refresh",handler:this.refresh});h.push({text:"属性",scope:this,iconCls:"btn-detail",disabled:this.isSearching?true:false,handler:this.folderDetail});var l=new Ext.menu.Menu({items:h});l.showAt(j.getXY());},search:function(){this.isSearching=true;this.searchDisable();var e=this.searchPanel;if(e.getForm().isValid()){var f=Ext.Ajax.serializeForm(e.getForm().getEl());var d=Ext.urlDecode(f);d.isSearch=true;d.limit=10000;this.store.baseParams=d;this.store.reload();}},searchDisable:function(){Ext.getCmp("NewPrivateFolderButton").disable();Ext.getCmp("NewPrivateDocumentButton").disable();Ext.getCmp("UpPrivateFolderButton").disable();this.isSearching=true;},searchEnable:function(){Ext.getCmp("NewPrivateFolderButton").enable();Ext.getCmp("NewPrivateDocumentButton").enable();Ext.getCmp("UpPrivateFolderButton").enable();this.isSearching=false;},changePath:function(){var d=this.selectNode;var c="";while(d!=null&&d.text!=undefined){c="/"+d.text+c;d=d.parentNode;}Ext.getCmp("FilePathDisplayField").setValue(c);},newFolder:function(){var f=0;var d=this.selectNode;if(d){f=this.selectNode.id;}var e=this.treePanel;new DocFolderForm({folderId:null,parentId:f,isShared:null,callback:function(){e.root.reload();}}).show();},upLevel:function(){this.isSearching=false;var f=this.selectNode;var e=f.parentNode;if(f&&f.id==0){Ext.ux.Toast.msg("提示信息","已是最顶层!");return;}var d=this.dataView.getStore();d.baseParams.isSearch=false;d.reload({params:{folderId:e.id}});this.selectNode=e;this.selectNodeMethod(e);},selectNodeMethod:function(){if(this.selectNode){this.selectNode=this.treePanel.getNodeById(this.selectNode.id);this.selectNode.select();}},dbclickNode:function(n,m,q,l){n.all.each(function(a){n.deselect(a);});n.select(m,true);var o=this.treePanel;var s=n.getSelectedNodes();if(s!=""&&s!=null&&s!="undefined"){var t=new Array();var e=s[0].type;var r=s[0].id;t.push({text:"打开",scope:this,iconCls:"btn-add",handler:this.openFile});if(e==1){t.push({text:"修改",scope:this,iconCls:"btn-edit",handler:this.editFile.createCallback(this)});t.push({text:"删除",scope:this,iconCls:"btn-delete",handler:this.delFolder.createCallback(this,n,r,o,false)});}else{t.push({text:"共享",scope:this,iconCls:"btn-shared",handler:this.shareDocument});t.push({text:"删除",scope:this,iconCls:"btn-delete",handler:this.delDocument.createCallback(n,r)});}t.push({text:"属性",scope:this,iconCls:"btn-detail",handler:this.fileDetail});var p=new Ext.menu.Menu({items:t});p.showAt(l.getXY());}},cutFile:function(){this.cuting=true;},moveFile:function(){this.cuting=false;},fileDetail:function(){var h=this.dataView;var g=h.getSelectedNodes();var j=g[0];var i=Ext.getCmp("FilePathDisplayField");var k=g[0].type;var l=false;if(k==1){l=true;}new FileDetailShowWin({isPersonal:true,fileId:j.id,filePath:i.getValue(),isFolder:l}).show();},openFile:function(){var f=this.dataView;var h=f.getSelectedNodes();if(h[0].type==1){var e=f.getStore();e.baseParams.isSearch=false;e.reload({params:{folderId:h[0].id}});var g=this.treePanel.getNodeById(h[0].id);g.select();this.selectNode=g;this.changePath();this.searchEnable();}else{new DocumentForm({docId:h[0].id}).show();}},clickNode:function(f){this.selectNode=f;this.changePath();var e=this.dataView;var d=e.getStore();d.baseParams.isSearch=false;d.reload({params:{folderId:f.id}});this.searchEnable();},editFile:function(k,i){var g=k.dataView;var l=g.getSelectedNodes();if((l[0]&&l[0].type==1)||i==true){var j=k.treePanel;var h;if(i){h=k.selectNode.id;}else{h=l[0].id;}new DocFolderForm({folderId:h,parentId:null,isShared:null,callback:function(){j.root.reload();}}).show();}else{new DocumentForm({docId:l[0].id}).show();}},shareDocument:function(){var d=this.dataView;var c=d.getSelectedNodes();if(c[0].type!=1){new DocumentSharedForm({docId:c[0].id}).show();}},delFolder:function(l,g,h,k,i){var j=l.selectNode;Ext.Msg.confirm("删除操作","你确定删除该目录吗?",function(a){if(a=="yes"){Ext.Ajax.request({url:__ctxPath+"/document/removeDocFolder.do",params:{folderId:h},method:"post",success:function(d,b){var c=Ext.util.JSON.decode(d.responseText);if(c.success==false){Ext.ux.Toast.msg("操作信息",c.message);}else{k.root.reload();if(i&&j.parentNode){l.clickNode(j.parentNode);}else{l.clickNode(j);}Ext.ux.Toast.msg("操作信息","成功删除目录！");}},failure:function(c,b){Ext.MessageBox.show({title:"操作信息",msg:"信息保存出错，请联系管理员！",buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});}});}});},delDocument:function(c,d){Ext.Msg.confirm("信息确认","您确认要删除该文档吗？",function(a){if(a=="yes"){Ext.Ajax.request({url:__ctxPath+"/document/multiDelDocument.do",params:{ids:d},method:"post",success:function(){c.getStore().reload({params:{}});Ext.ux.Toast.msg("信息提示","成功删除所选文档！");}});}});}});