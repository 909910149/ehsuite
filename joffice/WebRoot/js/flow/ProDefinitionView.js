Ext.ns("ProDefinitionView");var ProDefinitionView=function(b){this.isManager=b;};ProDefinitionView.prototype.setTypeId=function(b){this.typeId=b;ProDefinitionView.typeId=b;};ProDefinitionView.prototype.getView=function(){var c=this.typeId;var d=new Ext.FormPanel({height:40,frame:false,border:false,region:"north",layout:"hbox",layoutConfig:{padding:"5",align:"middle"},defaults:{margins:"4 4 4 4"},items:[{xtype:"label",text:"请输入查询条件:"},{text:"流程的名称",xtype:"label"},{xtype:"textfield",name:"proDefinition.name",width:160},{xtype:"button",text:"查询",iconCls:"search",scope:this,handler:function(){if(d.getForm().isValid()){$search({searchPanel:d,gridPanel:this.gridPanel});}}}]});this.gridPanel=this.setup();return new Ext.Panel({title:"流程列表",layout:"border",region:"center",autoScroll:true,items:[d,this.gridPanel]});};ProDefinitionView.prototype.setup=function(){var m=this.isManager;var l=0;var j=new Ext.grid.CheckboxSelectionModel();var i=new Ext.grid.ColumnModel({columns:[j,new Ext.grid.RowNumberer(),{header:"defId",dataIndex:"defId",hidden:true},{header:"分类名称",dataIndex:"proType",renderer:function(a){if(a!=null){return a.typeName;}else{return"<font color='red'>未定义</font>";}}},{header:"流程的名称",dataIndex:"name"},{header:"描述",dataIndex:"description"},{header:"创建时间",dataIndex:"createtime"},{header:"工作流id",dataIndex:"deployId",hidden:"true"},{header:"状态",dataIndex:"status",renderer:function(a){if(a!=null&&a==1){return'<font color="green">激活</font>';}else{return'<font color="red">禁用</font>';}},editor:m?new Ext.form.ComboBox({allowBlank:false,editable:false,mode:"local",triggerAction:"all",store:[["0","禁用"],["1","激活"]],listeners:{"change":function(a,b,d){var c=Ext.getCmp("ProDefinitionGrid"+(m?"":"0"));var e=c.getStore().getAt(l);Ext.Ajax.request({url:__ctxPath+"/flow/updateProDefinition.do",params:{"proDefinition.defId":e.get("defId"),"proDefinition.status":b},method:"POST",success:function(f,g){Ext.ux.Toast.msg("操作信息","修改成功！");},failure:function(f,g){Ext.ux.Toast.msg("操作信息","操作出错，请联系管理员！");}});}}}):null},{header:"管理",dataIndex:"defId",renderer:function(b,c,f,d,a){var s=f.data.defId;var t=f.data.name;var g=f.data.deployId;var r=f.data.drawDefXml;var e="";if(m){if(isGranted("_FlowDel")){e='<button title="删除" value=" " class="btn-del" onclick="ProDefinitionView.remove('+s+')"></button>';}if(isGranted("_FlowEdit")&&r!=null){e+='&nbsp;<button title="编辑在线" value=" " class="btn-flow-design" onclick=" ProDefinitionView.reDesign('+s+')"></button>';}if(isGranted("_FlowEdit")){e+='&nbsp;<button title="编辑" value=" " class="btn-edit" onclick="ProDefinitionView.edit('+s+",'"+t+"')\"></button>";}}if(g!=null){e+='&nbsp;<button title="查看" class="btn-preview" onclick="ProDefinitionView.view('+s+",'"+t+"')\"></button>";if(m){if(isGranted("_FlowSetting")){e+='&nbsp;<button title="流程设置" class="btn-setting" onclick="ProDefinitionView.setting('+""+s+",'"+t+"')\"></button>";}}e+='&nbsp;<button title="新建流程" class="btn-newFlow" onclick="ProDefinitionView.newFlow('+""+s+",'"+t+"')\"></button>";}if(m){e+='&nbsp;<button title="设置权限" class="btn-shared" onclick="ProDefinitionView.rights('+s+')"></button>';}return e;}}],defaults:{sortable:true,menuDisabled:false}});var k=m?this.topbar():null;var h=this.store();h.load({params:{start:0,limit:25}});var n=new Ext.grid.EditorGridPanel({clicksToEdit:1,region:"center",id:"ProDefinitionGrid"+(m?"":"0"),tbar:k,store:h,trackMouseOver:true,disableSelection:false,loadMask:true,cm:i,sm:j,viewConfig:{forceFit:true,enableRowBody:false,showPreview:false},bbar:new HT.PagingBar({store:h})});n.addListener("rowdblclick",function(b,c,a){l=c;b.getSelectionModel().each(function(d){if(m){if(isGranted("_FlowEdit")){ProDefinitionView.reDesign(d.data.defId);}}});});return n;};ProDefinitionView.prototype.store=function(){var c=null;if(this.isManager){c={typeId:this.typeId==null?0:this.typeId};}else{c={typeId:this.typeId==null?0:this.typeId,"Q_deployId_S_NEQ":"null","Q_status_SN_EQ":1};}var d=new Ext.data.Store({baseParams:c,proxy:new Ext.data.HttpProxy({url:__ctxPath+"/flow/listProDefinition.do"}),reader:new Ext.data.JsonReader({root:"result",totalProperty:"totalCounts",id:"id",fields:[{name:"defId",type:"int"},"proType","name","description","createtime","deployId","status","drawDefXml"]}),remoteSort:true});d.setDefaultSort("defId","desc");return d;};ProDefinitionView.prototype.topbar=function(){var b=new Ext.Toolbar({height:30,items:[]});b.add(new Ext.Button({iconCls:"btn-flow-design",text:"在线流程设计",handler:function(){window.open(__ctxPath+"/bpm/bpmDesign.do","_blank");}}));if(isGranted("_FlowAdd")){b.add(new Ext.Button({iconCls:"btn-add",text:"发布JBPM4流程",handler:function(){new ProDefinitionForm(null,ProDefinitionView.typeId);}}));}if(isGranted("_FlowDel")){b.add(new Ext.Button({iconCls:"btn-del",text:"删除流程",handler:function(){var g=Ext.getCmp("ProDefinitionGrid");var a=g.getSelectionModel().getSelections();if(a.length==0){Ext.ux.Toast.msg("信息","请选择要删除的记录！");return;}var f=Array();for(var h=0;h<a.length;h++){f.push(a[h].data.defId);}ProDefinitionView.remove(f);}}));}return b;};ProDefinitionView.remove=function(c){var d=Ext.getCmp("ProDefinitionGrid");Ext.Msg.confirm("信息确认","注意：删除该流程定义，该流程下的所有相关数据也一并删除，\n并不能恢复，您确认要删除该记录吗？",function(a){if(a=="yes"){Ext.Ajax.request({url:__ctxPath+"/flow/multiDelProDefinition.do",params:{ids:c},method:"post",success:function(){Ext.ux.Toast.msg("信息提示","成功删除所选记录！");d.getStore().reload({params:{start:0,limit:25}});}});}});};ProDefinitionView.edit=function(b){new ProDefinitionForm(b);};ProDefinitionView.view=function(f,e){var g=App.getContentPanel();var h=g.getItem("ProDefinitionDetail"+f);if(h==null){h=new ProDefinitionDetail(f,e);g.add(h);}g.activate(h);};ProDefinitionView.setting=function(f,h){var g=App.getContentPanel();var e=g.getItem("ProDefinitionSetting"+f);if(!e){e=new ProDefinitionSetting({defId:f,name:h});g.add(e);}g.activate(e);};ProDefinitionView.newFlow=function(f,h){var g=App.getContentPanel();var e=g.getItem("ProcessRunStart"+f);if(!e){e=new ProcessRunStart({id:"ProcessRunStart"+f,defId:f,flowName:h});g.add(e);}g.activate(e);};ProDefinitionView.rights=function(b){new ProDefRightsForm({defId:b}).show();};ProDefinitionView.reDesign=function(b){window.open(__ctxPath+"/bpm/bpmDesign.do?defId="+b,"flowDesign"+b);};ProDefinitionView.edit=function(b){new ProDefinitionForm(b);};