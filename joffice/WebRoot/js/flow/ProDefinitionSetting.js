Ext.ns("ProDefinitionSetting");ProDefinitionSetting=Ext.extend(Ext.Panel,{constructor:function(b){Ext.applyIf(this,b);this.initUIs();ProDefinitionSetting.superclass.constructor.call(this,{id:"ProDefinitionSetting"+this.defId,title:"流程设置－"+this.name,layout:"form",autoScroll:true,border:false,iconCls:"btn-setting",items:[this.gridPanel,this.flowImagePanel,this.formSetPanel]});},initUIs:function(){this.gridPanel=this.usersPanel(this.defId);this.flowImagePanel=new Ext.Panel({title:"流程干预设置",layout:"form",width:"100%",split:true,border:false,region:"center",autoScroll:true,collapsible:true,margin:"5 5 5 5",autoLoad:{nocache:true,url:__ctxPath+"/flow/processImage.do?defId="+this.defId}});this.useTemplateCheckbox=new Ext.form.Checkbox({boxLabel:"使用EXT表单模板",scope:this,handler:this.setExtTemplate});this.formSetPanel=new Ext.Panel({title:"表单设置",border:false,autoScroll:true,layout:"form",tbar:[this.useTemplateCheckbox,"-",{text:"设置流程表单",iconCls:"btn-setting",scope:this,handler:this.setting.createCallback(this)},{text:"设置表单字段权限",scope:this,iconCls:"btn-setting",handler:this.setRights}],items:[]});Ext.Ajax.request({url:__ctxPath+"/flow/formTempProDefinition.do",params:{defId:this.defId},scope:this,success:function(f,d){var e=Ext.decode(f.responseText);this.mappingId=e.mappingId;this.formSetPanel.removeAll();if(e!=null&&e.isUseTemplate==1){this.useTemplateCheckbox.setValue(true);}else{this.formSetPanel.add(this.getFormPanel.call(this));}this.formSetPanel.doLayout();},failure:function(c,d){}});},getFormPanel:function(){this.formPanel=new Ext.FormPanel({autoLoad:{url:__ctxPath+"/flow/getProcessActivity.do?defId="+this.defId,scope:this,callback:this.getFormHtmlCallback}});return this.formPanel;},getFormTemplateGrid:function(){this.formTempGridPanel=new HT.EditorGridPanel({autoHeight:true,showPaging:false,rowActions:true,isShowTbar:false,url:__ctxPath+"/flow/mappingsFormTemplate.do?mappingId="+this.mappingId,fields:["templateId","mappingId","nodeName"],columns:[{header:"templateId",dataIndex:"templateId",hidden:true},{header:"表单名称",dataIndex:"nodeName",width:300},new Ext.ux.grid.RowActions({header:"管理",width:100,actions:[{iconCls:"btn-form-design",qtip:"设计表单",style:"margin:0 3px 0 3px",fn:function(b){if(b.data.templateId!=null){return true;}return false;}},{iconCls:"btn-form-tag",qtip:"设置表单源码",style:"margin:0 3px 0 3px",fn:function(b){if(b.data.templateId!=null){return true;}return false;}}],listeners:{scope:this,"action":this.onRowAction}})]});return this.formTempGridPanel;},onRowAction:function(k,g,j,h,f){switch(j){case"btn-form-design":this.taskFormDesigner.call(this,g);break;case"btn-form-tag":this.vmEditor.call(this,g);break;default:break;}},taskFormDesigner:function(c){var d=new FormDesignWindow({defId:this.defId,templateId:c.data.templateId,activityName:c.data.nodeName});d.show();},vmEditor:function(d){var c=new FormEditorWindow({defId:this.defId,activityName:d.data.nodeName});c.show();},setExtTemplate:function(f,h){var g=this.formSetPanel.getTopToolbar().items;for(var k=0;k<g.getCount();k++){if(k>0){var j=g.get(k);if(h&&j.hide){j.hide();}else{if(j.show){j.show();}}}}Ext.Ajax.request({url:__ctxPath+"/flow/saveFmProDefinition.do?defId="+this.defId,params:{useTemplate:h},scope:this,success:function(a,b){var c=Ext.decode(a.responseText);this.mappingId=c.mappingId;this.formSetPanel.removeAll();if(h){this.formSetPanel.add(this.getFormTemplateGrid.call(this));}else{this.formSetPanel.add(this.getFormPanel.call(this));}this.formSetPanel.doLayout();}});},setRights:function(){var b=this.defId;Ext.Ajax.request({url:__ctxPath+"/flow/checkFieldRights.do",method:"post",params:{defId:b},success:function(a,e){var f=Ext.util.JSON.decode(a.responseText);if(f.success){new FieldRightsForm({defId:b}).show();}else{Ext.ux.Toast.msg("操作提示",f.msg==null?"未绑定表单！":f.msg);}},failure:function(){}});},setting:function(b){FormDefSelector.getView(function(d,a){if(d!=null){b.save(b,b.defId,d);}},b.defId).show();},save:function(d,e,f){Ext.Ajax.request({url:__ctxPath+"/flow/addFormDef.do?defId="+e+"&formDefId="+f,method:"post",waitMsg:"数据正在提交，请稍后...",success:function(c,b){var a=Ext.util.JSON.decode(c.responseText);if(a.success){Ext.ux.Toast.msg("操作提示","设置流程表单操作成功！");var h=d.formPanel;h.getUpdater().update({url:__ctxPath+"/flow/getProcessActivity.do?defId="+e,scope:d,callback:d.getFormHtmlCallback});}else{Ext.ux.Toast.msg("操作提示",a.msg);}}});},getFormHtmlCallback:function(){var h=this.formPanel.getForm().getEl().dom;var f=this.formPanel;var e=h.elements||(document.forms[h]||Ext.getDom(h)).elements;try{$converDetail.call(this,null);}catch(g){}}});ProDefinitionSetting.prototype.usersPanel=function(r){var p=new Ext.Toolbar({items:[{text:"保存",iconCls:"btn-save",handler:function(){var a=[];for(i=0,cnt=n.getCount();i<cnt;i+=1){var b=n.getAt(i);if(b.data.assignId==""||b.data.assignId==null){b.set("assignId",-1);}if(b.data.isSigned==""||b.data.isSigned==null){b.set("isSigned",0);}if(b.dirty){a.push(b.data);}}if(a.length==0){Ext.ux.Toast.msg("信息","没有对数据进行任何更改");return;}Ext.Ajax.request({method:"post",url:__ctxPath+"/flow/saveProUserAssign.do",success:function(c){Ext.ux.Toast.msg("操作信息","成功设置流程表单");n.reload();u.getView().refresh();},failure:function(c){Ext.MessageBox.show({title:"操作信息",msg:"信息保存出错，请联系管理员！",buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});},params:{data:Ext.encode(a)}});}}]});var n=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:__ctxPath+"/flow/listProUserAssign.do?defId="+this.defId}),reader:new Ext.data.JsonReader({root:"result",id:"id",fields:["assignId","deployId","activityName","reJobId","reJobName","userId","username","roleId","roleName","jobId","jobName","isSigned"]})});n.load();var l=0;var s=0;var t=new Ext.form.TriggerField({triggerClass:"x-form-browse-trigger",onTriggerClick:function(a){UserSelector.getView(function(d,c){var e=u.getStore();var b=e.getAt(l);b.set("userId",d);b.set("username",c);},false,true).show();u.stopEditing();}});var m=new Ext.form.TriggerField({triggerClass:"x-form-browse-trigger",onTriggerClick:function(a){RoleSelector.getView(function(d,c){var e=u.getStore();var b=e.getAt(l);b.set("roleId",d);b.set("roleName",c);},true).show();u.stopEditing();}});var q=new Ext.form.TriggerField({triggerClass:"x-form-browse-trigger",onTriggerClick:function(c){var a=u.getStore();var b=a.getAt(l);RelativeJobSelector.getView(function(e,d){b.set("reJobId",e);b.set("reJobName",d);},false).show();u.stopEditing();}});var o=new Ext.form.TriggerField({triggerClass:"x-form-browse-trigger",onTriggerClick:function(a){JobSelector.getView(function(d,c){var e=u.getStore();var b=e.getAt(l);b.set("jobId",d);b.set("jobName",c);},false).show();u.stopEditing();}});var u=new Ext.grid.EditorGridPanel({title:"人员设置",id:"ProDefinitionSettingGrid"+this.defId,autoHeight:true,clicksToEdit:1,store:n,tbar:p,columns:[new Ext.grid.RowNumberer(),{header:"assignId",dataIndex:"assignId",hidden:true},{header:"deployId",dataIndex:"deployId",hidden:true},{header:"流程任务",dataIndex:"activityName",width:100,sortable:true},{dataIndex:"userId",header:"userId",hidden:true},{header:"用户",dataIndex:"username",width:150,sortable:true,editor:t},{dataIndex:"roleId",hidden:true},{header:"角色",dataIndex:"roleName",width:150,editor:m},{header:"岗位",dataIndex:"jobName",width:150,editor:o},{header:"jobId",dataIndex:"jobId",hidden:true},{header:"上下级",dataIndex:"reJobName",width:150,editor:q},{header:"reJobId",dataIndex:"reJobId",hidden:true},{header:"是否会签",dataIndex:"isSigned",width:150,renderer:function(a){return a==1?"是":"否";},editor:new Ext.form.ComboBox({valueField:"id",displayField:"name",store:[["0","否"],["1","是"]],triggerAction:"all",editable:false})},{header:"会签设置",dataIndex:"isSigned",width:150,renderer:function(e,f,b,c,g){var a=b.get("assignId");var d=b.get("activityName");return e==1?'<button class="btn-setting" title ="会签设置" onclick="ProDefinitionSetting.setTaskAssign('+a+",'"+d+"')\"/>":"";}}]});u.on("cellclick",function(b,c,a,d){l=c;});return u;};ProDefinitionSetting.clickNode=function(e,f,d){$ImportSimpleJs([__ctxPath+"/js/flow/ProcessNodeSetting.js"],function(){new ProcessNodeSetting({defId:e,activityName:f,nodeType:d}).show();},this);};ProDefinitionSetting.roleSelect=function(h,k,g){var j=Ext.getCmp("ProDefinitionSettingGrid"+g);var f=j.getStore().getAt(h);j.getStore().reload();j.doLayout();};ProDefinitionSetting.setTaskAssign=function(d,c){new TaskSignForm({assignId:d,activityName:c}).show();};