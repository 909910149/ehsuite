ProcessRunStart=Ext.extend(Ext.Panel,{constructor:function(b){this.useTemplate=false;this.assignTasks=new Array();this.assignUserIds=new Array();Ext.applyIf(this,b);this.buttonsArr=[{text:"提交并启动流程",iconCls:"btn-ok",scope:this,handler:this.saveAndStart},"-",{xtype:"checkbox",boxLabel:"发送邮件",scope:this,handler:function(a,d){if(d){this.sendMail=true;}else{this.sendMail=false;}}},{xtype:"checkbox",boxLabel:"发送短信",scope:this,handler:function(a,d){if(d){this.sendMsg=true;}else{this.sendMsg=false;}}},"-",{text:"流程示意图",iconCls:"btn-flow-chart",scope:this,handler:this.showFlowImage}];this.userJumpPanel=new Ext.form.FieldSet({title:"选择执行人",collapsed:true,autoHeight:true,collapsed:false,collapsible:true});this.jumpPanel=new Ext.Panel({bodyStyle:"padding:16px 4px 4px 20px",autoHeight:true,layout:"form",border:false,items:[this.userJumpPanel]});Ext.Ajax.request({url:__ctxPath+"/flow/startTransProcessActivity.do",params:{defId:this.defId},scope:this,success:function(g,j){var a=Ext.decode(g.responseText);var h=[];for(var i=0;i<a.data.length;i++){h.push({boxLabel:a.data[i].destination,name:"jumpPath_"+this.defId,inputValue:a.data[i].name,destType:a.data[i].destType,destName:a.data[i].destination,checked:i==0?true:false});}this.jumpRadioGroup=new Ext.form.RadioGroup({listeners:{scope:this,"change":this.jumpRadioCheck},fieldLabel:"执行路径",items:h});this.jumpPanel.insert(0,this.jumpRadioGroup);this.jumpPanel.doLayout();this.jumpRadioCheck.call(this);}});this.formPanel=new Ext.form.FormPanel({region:"center",border:false,bodyStyle:"padding:20px",autoScroll:true,autoLoad:{url:__ctxPath+"/flow/getProcessActivity.do?defId="+this.defId,nocache:true,scope:this,callback:this.convertHtml}});ProcessRunStart.superclass.constructor.call(this,{title:"流程启动-"+this.flowName,iconCls:"btn-flow-start",autoScroll:true,layout:"form",id:"ProcessRunStart"+this.defId,tbar:new Ext.Toolbar({height:26,items:this.buttonsArr}),layoutConfig:{padding:"5",pack:"center",align:"middle"},defaults:{margins:"0 5 10 0"},items:[this.jumpPanel,this.formPanel]});},jumpRadioCheck:function(){var b=this.jumpRadioGroup.getValue();this.getTaskUsers.call(this,b.destName,b.destType);},getTaskUsers:function(d,c){if("decision"==c||"fork"==c){this.userJumpPanel.removeAll();this.userJumpPanel.show();this.genForkDecUserAssign.call(this,d);}else{if(c.indexOf("end")!=-1){this.userJumpPanel.removeAll();this.userJumpPanel.hide();}else{this.userJumpPanel.removeAll();this.userJumpPanel.show();this.userJumpPanel.add(this.getSingleUserPanel.call(this,d));}}this.jumpPanel.doLayout();},getSingleUserPanel:function(d){this.flowAssignName=new Ext.form.TextArea({width:400,height:40,name:"flowAssignName"});var c=new Ext.form.CompositeField({xtype:"compositefield",fieldLabel:"执行人",anchor:"92%,92%",items:[this.flowAssignName,{xtype:"button",scope:this,text:"...",iconCls:"btn-users",handler:function(){var a=this.flowUserFieldPanel;UserSelector.getView({callback:function(b,f){this.flowAssignName.setValue(f);this.assignTasks=[d];this.assignUserIds=[b];},scope:this}).show();}}]});Ext.Ajax.request({url:__ctxPath+"/flow/usersProcessActivity.do",scope:this,params:{defId:this.defId,activityName:d},success:function(b,a){var f=Ext.decode(b.responseText);this.flowAssignName.setValue(f.userNames);this.assignTasks=[d];this.assignUserIds=[f.userIds];}});return c;},genForkDecUserAssign:function(b){Ext.Ajax.request({url:__ctxPath+"/flow/outerTransProcessActivity.do",params:{defId:this.defId,nodeName:b},scope:this,success:function(f,a){var g=Ext.decode(f.responseText);for(var h=0;h<g.length;h++){this.userJumpPanel.add(this.genUserFieldSel.call(this,g[h],h));}this.userJumpPanel.doLayout();}});},genUserFieldSel:function(i,f){var j=i[1];this.assignTasks[f]=j;this.assignUserIds[f]=i[3];var g=new Ext.form.TextArea({allowBlank:false,width:400,height:40,value:i[4]});var h=new Ext.form.CompositeField({border:false,fieldLabel:j,items:[g,{xtype:"button",text:"...",iconCls:"btn-users",scope:this,handler:function(){UserSelector.getView({scope:this,callback:function(d,a){g.setValue(a);var c=this.assignTasks.length;for(var b=c-1;b>=0;b--){if(this.assignTasks[b]==j){c=b;break;}}this.assignTasks[c]=j;this.assignUserIds[c]=d;}}).show();}}]});return h;},getFlowAssignId:function(){var f="";var g="";var h="";for(var e=0;e<this.assignTasks.length;e++){if(e>0){g+=":";h+=":";}g+=this.assignTasks[e];h+=this.assignUserIds[e];}if(g!=""){f=g+"|"+h;}return f;},convertHtml:function(){var formExt=document.getElementById("formExt"+this.defId);if(formExt!=null){this.useTemplate=true;var valExt=formExt.value;valExt=valExt.replace("Ext.form.FormPanel","Ext.Panel");this.formExtPanel=eval("new ("+valExt+")("+this.vmParams+");");this.formPanel.add(this.formExtPanel);this.formPanel.doLayout();return;}this.formPanel.doLayout();try{var json=document.getElementById("rightsdef_"+this.defId);if(json!=null){var callback=function(){var rightsJson=Ext.decode(json.value);$converDetail.call(this,null,rightsJson);};$ImportSimpleJs([__ctxPath+"/js/core/ntkoffice/NtkOfficePanel.js",__ctxPath+"/js/selector/SealSelector.js",__ctxPath+"/js/selector/PaintTemplateSelector.js"],callback,this);}}catch(e){}},saveAndStart:function(){var J=true;if(this.formExtPanel!=null&&this.formExtPanel.validate){J=this.formExtPanel.validate.call(this.formExtPanel,this);}J=$validForm.call(this);if(!J){return;}var d=this.jumpRadioGroup.getValue().destName;var W=this.getFlowAssignId.call(this);var X=this.formPanel;var T={useTemplate:this.useTemplate,defId:this.defId,startFlow:true,destName:d,sendMsg:this.sendMsg,sendMail:this.sendMail,flowAssignId:W};if(this.detailGrids){var Y=this.detailGrids.keys;for(var H=0;H<Y.length;H++){var i=[];var P=this.detailGrids.get(Y[H]);var V=P.getStore();for(var G=0;G<V.getCount();G++){var ac=V.getAt(G);var O=HT.encode(ac.data);i.push(O);}T[Y[H]+"details"]=Ext.encode(i);}}var Z=this.officePanel;if(Z){var R=null;if(this.fileId!=""&&this.fileId!=undefined){R=Z.saveDoc({docName:"ProcessDocument",fileId:this.fileId,doctype:"doc"});}else{R=Z.saveDoc({docName:"ProcessDocument",doctype:"doc"});}if(R&&R.success){var L=R.fileId;this.hiddenF.setValue(L);}}var F=X.getForm().getEl().dom;var aa=F.getElementsByTagName("form");var N=[];var S=new Ext.util.MixedCollection();for(var G=0;G<aa.length;G++){var ab=aa[G].getAttribute("belongName");var I=aa[G].getAttribute("pkName");var j=aa[G].getAttribute("pkValue");var Q=Ext.Ajax.serializeForm(aa[G]);var K=Ext.urlDecode(Q);if(I&&j){K[I]=j;}var M=HT.encode(K);var ad=S.get(ab);if(!ad){var i=[];i.push(M);S.add(ab,i);}else{ad.push(M);}}for(var G=0;G<S.keys.length;G++){var U=S.keys[G];T[U+"details"]=Ext.encode(S.get(U));}if(X.getForm().isValid()){X.getForm().submit({url:__ctxPath+"/flow/saveProcessActivity.do",waitMsg:"正在提交流程表单信息...",scope:this,params:T,success:function(b,a){Ext.ux.Toast.msg("操作信息","成功保存信息！");if(Z){Z.closeDoc();}AppUtil.removeTab(this.getId());}});}},reset:function(){this.formPanel.getForm().reset();},showFlowImage:function(){var b=new Ext.Window({autoScroll:true,iconCls:"btn-flow-chart",bodyStyle:"background-color:white",maximizable:true,title:"流程示意图",width:600,height:500,modal:true,html:'<img src="'+__ctxPath+"/jbpmImage?defId="+this.defId+"&rand="+Math.random()+'"/>'});b.show();}});