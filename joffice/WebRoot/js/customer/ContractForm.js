ContractForm=Ext.extend(Ext.Window,{formPanel:null,constructor:function(b){Ext.applyIf(this,b);this.initUIComponents();ContractForm.superclass.constructor.call(this,{layout:"fit",id:"ContractFormWin",title:"合同详细信息",iconCls:"menu-contract",width:822,height:530,minWidth:821,minHeight:529,items:this.formPanel,border:false,modal:true,plain:true,buttonAlign:"center",buttons:this.buttons});},initUIComponents:function(){var d=__ctxPath+"/system/listDepartment.do";var e=new TreeSelector("serviceDepSelector",d,"维护部门",null);e.addListener("change",function(){Ext.getCmp("serviceDep").setValue(e.getValue());});var f=new ContractConfigView();this.formPanel=new Ext.FormPanel({url:__ctxPath+"/customer/saveContract.do",layout:"hbox",frame:false,layoutConfig:{padding:"5",pack:"start",align:"middle"},defaults:{margins:"0 5 0 0"},id:"ContractForm",frame:false,formId:"ContractFormId",defaultType:"textfield",items:[{xtype:"fieldset",title:"合同信息(带 * 号为必填)",layout:"form",rowspan:2,labelWidth:60,defaultType:"textfield",width:400,defaults:{width:280},items:[{name:"contract.contractId",id:"contractId",xtype:"hidden",value:this.contractId==null?"":this.contractId},{fieldLabel:"合同编号*",name:"contract.contractNo",id:"contractNo",allowBlank:false,blankText:"合同编号不可为空!"},{fieldLabel:"合同标题*",name:"contract.subject",id:"subject",allowBlank:false,blankText:"合同标题不可为空!"},{xtype:"compositefield",fieldLabel:"合同金额*",items:[{xtype:"numberfield",width:250,name:"contract.contractAmount",id:"contractAmount",allowBlank:false,blankText:"合同金额不可为空!"},{text:"元",width:10,style:"padding-left:0px;padding-top:3px;"}]},{fieldLabel:"主要条款",xtype:"textarea",name:"contract.mainItem",id:"mainItem"},{fieldLabel:"售后条款",xtype:"textarea",name:"contract.salesAfterItem",id:"salesAfterItem"},{xtype:"compositefield",fieldLabel:"有效日期*",items:[{xtype:"datefield",width:110,format:"Y-m-d",editable:false,name:"contract.validDate",id:"validDate",allowBlank:false,blankText:"合同生效日期不可为空!"},{value:"至",xtype:"displayfield",width:10,style:"padding-left:0px;padding-top:3px;"},{xtype:"datefield",width:110,format:"Y-m-d",editable:false,name:"contract.expireDate",id:"expireDate",allowBlank:false,blankText:"合同到期日期不可为空!"}]},{xtype:"compositefield",fieldLabel:"签约人*",items:[{xtype:"textfield",width:180,readOnly:true,name:"contract.signupUser",id:"signupUser",allowBlank:false,blankText:"签约人不可为空!"},{xtype:"button",text:"签约人",iconCls:"btn-mail_recipient",handler:function(){UserSelector.getView(function(a,b){Ext.getCmp("signupUser").setValue(b);},true).show();}}]},{fieldLabel:"签约时间",xtype:"datefield",format:"Y-m-d",editable:false,name:"contract.signupTime",id:"signupTime",allowBlank:false,blankText:"签约时间不可为空!"},{fieldLabel:"维护部门",name:"contract.serviceDep",xtype:"hidden",id:"serviceDep"},e,{xtype:"compositefield",fieldLabel:"维护人*",items:[{xtype:"textfield",width:180,readOnly:true,name:"contract.serviceMan",id:"serviceMan"},{xtype:"button",text:"维护人",iconCls:"btn-mail_recipient",handler:function(){UserSelector.getView(function(a,b){Ext.getCmp("serviceMan").setValue(b);},true).show();}}]},{xtype:"compositefield",fieldLabel:"合同附件",items:[{xtype:"panel",id:"displayContractAttach",width:215,height:65,frame:false,autoScroll:true,style:"padding-left:0px;padding-top:0px;",html:""},{xtype:"button",iconCls:"btn-upload",text:"上传",handler:function(){var a=App.createUploadDialog({file_cat:"customer/contract",callback:uploadContractAttach});a.show("queryBtn");}},{xtype:"hidden",name:"contractAttachIDs",id:"contractAttachIDs"}]}]},{xtype:"container",style:"padding:5px 0px 0px 0px;",items:[{xtype:"fieldset",title:"项目信息",layout:"form",labelWidth:55,width:380,autoHeight:true,style:"padding-bottom:0px;bottom:0px;",defaultType:"textfield",items:[{fieldLabel:"所属项目",xtype:"hidden",name:"contract.projectId",id:"projectId"},{xtype:"button",iconCls:"menu-project",text:"选择项目",handler:function(){ProjectSelector.getView(function(a,b,c){Ext.getCmp("projectId").setValue(a);ContractForm.getProject(a);},true).show();}},{xtype:"panel",id:"ProjectDisplay",autoWidth:true,height:130,autoScroll:true,html:"项目编号: <br> 项目名称: <br> 所属客户: <br>"+"联系人员: <br> 项目描述: <br>"}]},{xtype:"fieldset",title:"配置单",layout:"form",width:380,style:"padding-top:0px;top:0px;",autoHeight:true,labelWidth:58,defaultType:"textfield",items:[{fieldLabel:"收货地址",name:"contract.consignAddress",id:"consignAddress",width:280},{fieldLabel:"收货人",name:"contract.consignee",id:"consignee",width:280},f]}]}]});if(this.contractId!=null&&this.contractId!="undefined"){this.formPanel.getForm().load({deferredRender:false,url:__ctxPath+"/customer/getContract.do?contractId="+this.contractId,waitMsg:"正在载入数据...",success:function(x,v){var a=v.result.data;var u=getDateFromFormat(a.validDate,"yyyy-MM-dd HH:mm:ss");var y=getDateFromFormat(a.expireDate,"yyyy-MM-dd HH:mm:ss");var s=getDateFromFormat(a.signupTime,"yyyy-MM-dd HH:mm:ss");Ext.getCmp("validDate").setValue(new Date(u));Ext.getCmp("expireDate").setValue(new Date(y));Ext.getCmp("signupTime").setValue(new Date(s));Ext.getCmp("serviceDepSelector").setValue(a.serviceDep);Ext.getCmp("projectId").setValue(v.result.projectId);ContractForm.getProject(v.result.projectId);var w=Ext.getCmp("contractId").value;if(w!=null&&w!=""&&w!="undefined"){var c=Ext.getCmp("ContractConfigGrid").getStore();c.reload({params:{"Q_contract.contractId_L_EQ":w}});}var q=v.result.data.contractFiles;var r=Ext.getCmp("displayContractAttach");var b=Ext.getCmp("contractAttachIDs");for(var t=0;t<q.length;t++){if(b.getValue()!=""){b.setValue(b.getValue()+",");}b.setValue(b.getValue()+q[t].fileId);Ext.DomHelper.append(r.body,'<span><a href="#" onclick="FileAttachDetail.show('+q[t].fileId+')">'+q[t].fileName+'</a><img class="img-delete" src="'+__ctxPath+'/images/system/delete.gif" onclick="removeContractAttach(this,'+q[t].fileId+')"/>&nbsp;|&nbsp;</span>');}},failure:function(b,a){Ext.ux.Toast.msg("编辑","载入失败");}});}this.buttons=[{text:"保存",iconCls:"btn-save",handler:function(){ContractForm.saveContract();}},{text:"取消",iconCls:"btn-cancel",handler:function(){Ext.getCmp("ContractFormWin").close();}}];}});ContractForm.getProject=function(b){if(b!=null&&b!=""&&b!="undefined"){Ext.Ajax.request({url:__ctxPath+"/customer/getProject.do",params:{projectId:b},method:"post",success:function(d){var a=Ext.util.JSON.decode(d.responseText);Ext.getCmp("ProjectDisplay").body.update("项目编号: "+a.data.projectNo+"<br> 项目名称: "+a.data.projectName+"<br> 所属客户: "+a.customerName+"<br> 联系人员: "+a.data.fullname+"<br> 项目描述: "+a.data.reqDesc);}});}};ContractForm.saveContract=function(){var h=Ext.getCmp("ContractForm");var e=Ext.getCmp("ContractConfigGrid").getStore();var g=[];for(i=0,cnt=e.getCount();i<cnt;i+=1){var f=e.getAt(i);if(f.data.itemName==null||f.data.itemName==""||f.data.itemName=="undefined"){Ext.ux.Toast.msg("提示信息","设备名称为必填!");return;}if(f.data.itemSpec==null||f.data.itemSpec==""||f.data.itemSpec=="undefined"){Ext.ux.Toast.msg("提示信息","设备规格为必填!");return;}if(f.data.amount==null||f.data.amount==""||f.data.amount=="undefined"){Ext.ux.Toast.msg("提示信息","设备数量为必填!");return;}if(f.data.assignId==""||f.data.assignId==null){f.set("configId",-1);}if(f.dirty){g.push(f.data);}}if(h.getForm().isValid()){h.getForm().submit({method:"post",params:{data:Ext.encode(g)},waitMsg:"正在提交数据...",success:function(b,a){Ext.ux.Toast.msg("操作信息","成功保存信息！");Ext.getCmp("ContractGrid").getStore().reload();Ext.getCmp("ContractFormWin").close();},failure:function(b,a){Ext.MessageBox.show({title:"操作信息",msg:a.result.msg,buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});}});}};function uploadContractAttach(h){var f=Ext.getCmp("contractAttachIDs");var g=Ext.getCmp("displayContractAttach");for(var e=0;e<h.length;e++){if(f.getValue()!=""){f.setValue(f.getValue()+",");}f.setValue(f.getValue()+h[e].fileId);Ext.DomHelper.append(g.body,'<span><a href="#" onclick="FileAttachDetail.show('+h[e].fileId+')">'+h[e].fileName+'</a><img class="img-delete" src="'+__ctxPath+'/images/system/delete.gif" onclick="removeContractAttach(this,'+h[e].fileId+')"/>&nbsp;|&nbsp;</span>');}}function removeContractAttach(j,l){var g=Ext.getCmp("contractAttachIDs");var k=g.getValue();if(k.indexOf(",")<0){g.setValue("");}else{k=k.replace(","+l,"").replace(l+",","");g.setValue(k);}var m=Ext.get(j.parentNode);m.remove();var h=Ext.getCmp("contractId").value;if(h!=null&&h!=""&&h!="undefined"){Ext.Ajax.request({url:__ctxPath+"/customer/removeFileContract.do",params:{contractId:h,contractAttachIDs:l},method:"post",success:function(){Ext.Ajax.request({url:__ctxPath+"/system/multiDelFileAttach.do",params:{ids:l},method:"post",success:function(){Ext.ux.Toast.msg("信息提示","成功删除所选记录！");}});}});}else{Ext.Ajax.request({url:__ctxPath+"/system/multiDelFileAttach.do",params:{ids:l},method:"post",success:function(){Ext.ux.Toast.msg("信息提示","成功删除所选记录！");}});}}