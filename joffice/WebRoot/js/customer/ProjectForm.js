Ext.ns("ProjectForm");ProjectForm=Ext.extend(Ext.Window,{formPanel:null,constructor:function(b){Ext.applyIf(this,b);this.initUIComponents();ProjectForm.superclass.constructor.call(this,{layout:"fit",id:"ProjectFormWin",title:"项目详细信息",iconCls:"menu-project",items:this.formPanel,maximizable:true,border:false,width:873,height:485,minWidth:872,minHeight:484,modal:true,plain:true,bodyStyle:"padding:5px;",buttonAlign:"center",buttons:this.buttons});},initUIComponents:function(){this.formPanel=new Ext.FormPanel({url:__ctxPath+"/customer/saveProject.do",layout:"hbox",layoutConfig:{padding:"5",align:"middle"},defaults:{margins:"0 5 0 0"},id:"ProjectForm",frame:false,formId:"ProjectFormId",defaultType:"textfield",items:[{xtype:"fieldset",title:"项目信息",layout:"form",width:420,defaultType:"textfield",labelWidth:80,defaults:{width:295},items:[{xtype:"compositefield",fieldLabel:"项目编号*",items:[{xtype:"textfield",width:150,name:"project.projectNo",id:"projectNo",allowBlank:false,blankText:"项目编号不能为空!",listeners:{change:function(e,d,f){ProjectForm.checkProjectNo(d);}}},{id:"getNoButton",xtype:"button",text:"系统生成",iconCls:"btn-system-setting",handler:function(){Ext.Ajax.request({url:__ctxPath+"/customer/numberProject.do",success:function(c){var d=Ext.util.JSON.decode(c.responseText);Ext.getCmp("projectNo").setValue(d.projectNo);Ext.getCmp("CheckMessage").body.update("");}});}},{id:"CheckMessage",xtype:"panel",border:false,style:"padding-top:3px"},{name:"project.projectId",id:"projectId",xtype:"hidden",value:this.projectId==null?"":this.projectId}]},{fieldLabel:"项目名称*",name:"project.projectName",id:"projectName",allowBlank:false,blankText:"项目名称不能为空!"},{fieldLabel:"需求描述",name:"project.reqDesc",xtype:"htmleditor",autoHeight:true,id:"reqDesc"},{fieldLabel:"是否签订合同",hiddenName:"project.isContract",id:"isContract",xtype:"combo",mode:"local",editable:true,triggerAction:"all",store:[["0","无"],["1","有"]],value:0},{fieldLabel:"业务人员",name:"project.userId",id:"userId",xtype:"hidden"},{xtype:"compositefield",fieldLabel:"业务人员*",items:[{xtype:"textfield",width:180,readOnly:true,allowBlank:false,blankText:"业务人员不能为空!",name:"salesman",id:"salesman"},{xtype:"button",width:60,text:"业务人员",iconCls:"btn-mail_recipient",handler:function(){UserSelector.getView(function(c,d){Ext.getCmp("salesman").setValue(d);Ext.getCmp("userId").setValue(c);},true).show();}}]},{xtype:"compositefield",fieldLabel:"项目附件",items:[{xtype:"panel",id:"displayProjectAttach",width:215,height:65,frame:false,autoScroll:true,style:"padding-left:0px;padding-top:0px;",html:""},{xtype:"button",iconCls:"btn-upload",text:"上传",handler:function(){var b=App.createUploadDialog({file_cat:"customer/project",callback:uploadProjectAttach});b.show("queryBtn");}},{xtype:"hidden",name:"projectAttachIDs",id:"projectAttachIDs"}]}]},{xtype:"fieldset",title:"负责人信息",layout:"form",width:420,labelWidth:80,defaultType:"textfield",defaults:{width:295},items:[{fieldLabel:"所属客户",name:"project.customerId",id:"customerId",xtype:"hidden"},{xtype:"compositefield",fieldLabel:"所属客户*",items:[{xtype:"textfield",width:180,readOnly:true,allowBlank:false,blankText:"所属客户为必选!",name:"customerName",id:"customerName"},{xtype:"button",text:"选择客户",iconCls:"menu-customerView",handler:function(){CustomerSelector.getView(function(c,d){Ext.getCmp("customerId").setValue(c);Ext.getCmp("customerName").setValue(d);Ext.getCmp("fullname").getStore().reload({params:{"Q_customer.customerId_L_EQ":c}});},true).show();}}]},{fieldLabel:"联系人姓名",allowBlank:false,blankText:"联系人不能为空!",name:"project.fullname",id:"fullname",xtype:"combo",mode:"local",editable:true,triggerAction:"all",store:new Ext.data.SimpleStore({method:"post",url:__ctxPath+"/customer/findCusLinkman.do",fields:["linkmanId","fullname"]}),displayField:"fullname",valueField:"linkmanId",enableKeyEvent:true,listeners:{select:function(f,e,d){ProjectForm.selectLinkman(f.value);}}},{fieldLabel:"手机",name:"project.mobile",id:"mobile"},{fieldLabel:"电话",name:"project.phone",id:"phone"},{fieldLabel:"传真",name:"project.fax",id:"fax"},{fieldLabel:"其他联系方式",xtype:"htmleditor",height:219,name:"project.otherContacts",id:"otherContacts"}]}]});if(this.projectId!=null&&this.projectId!="undefined"){this.formPanel.getForm().load({deferredRender:false,url:__ctxPath+"/customer/getProject.do?projectId="+this.projectId,waitMsg:"正在载入数据...",success:function(j,i){Ext.getCmp("userId").setValue(i.result.userId);Ext.getCmp("customerName").setValue(i.result.customerName);Ext.getCmp("salesman").setValue(i.result.salesman);Ext.getCmp("customerId").setValue(i.result.customerId);var g=i.result.data.projectFiles;var k=Ext.getCmp("displayProjectAttach");var h=Ext.getCmp("projectAttachIDs");for(var l=0;l<g.length;l++){if(h.getValue()!=""){h.setValue(h.getValue()+",");}h.setValue(h.getValue()+g[l].fileId);Ext.DomHelper.append(k.body,'<span><a href="#" onclick="FileAttachDetail.show('+g[l].fileId+')">'+g[l].fileName+'</a><img class="img-delete" src="'+__ctxPath+'/images/system/delete.gif" onclick="removeProjectAttach(this,'+g[l].fileId+')"/>&nbsp;|&nbsp;</span>');}},failure:function(d,c){Ext.ux.Toast.msg("编辑","载入失败");}});}this.buttons=[{text:"保存",iconCls:"btn-save",handler:function(){var b=Ext.getCmp("ProjectForm");if(b.getForm().isValid()){b.getForm().submit({method:"post",waitMsg:"正在提交数据...",success:function(a,e){var f=Ext.getCmp("isContract").value;if(f==0){Ext.ux.Toast.msg("操作信息","成功保存信息！");}else{if(Ext.getCmp("projectId").getValue()==null||Ext.getCmp("projectId").getValue()==""){Ext.Msg.confirm("操作信息","信息保存成功,是否现在录入合同信息？",function(c){if(c=="yes"){new ContractForm().show();Ext.getCmp("projectId").setValue(e.result.projectId);ContractForm.getProject(e.result.projectId);}});}}Ext.getCmp("ProjectGrid").getStore().reload();Ext.getCmp("ProjectFormWin").close();},failure:function(a,d){Ext.MessageBox.show({title:"操作信息",msg:d.result.msg,buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});}});}}},{text:"取消",iconCls:"btn-cancel",handler:function(){Ext.getCmp("ProjectFormWin").close();}}];}});ProjectForm.checkProjectNo=function(b){if(b!=null&&b!=""&&b!="undefined"){Ext.Ajax.request({url:__ctxPath+"/customer/checkProject.do",params:{projectNo:b},method:"post",success:function(d){var a=Ext.util.JSON.decode(d.responseText);if(a.pass){Ext.getCmp("CheckMessage").body.update('<img src="'+__ctxPath+'/images/flag/customer/passcheck.png" />可用');}else{Ext.getCmp("CheckMessage").body.update('<img src="'+__ctxPath+'/images/flag/customer/invalid.png" />不可用');}},failure:function(){}});}};ProjectForm.selectLinkman=function(b){Ext.Ajax.request({url:__ctxPath+"/customer/getCusLinkman.do",method:"post",params:{linkmanId:b},success:function(d){var a=Ext.util.JSON.decode(d.responseText).data;Ext.getCmp("mobile").setValue(a.mobile);Ext.getCmp("phone").setValue(a.phone);Ext.getCmp("fax").setValue(a.fax);Ext.getCmp("otherContacts").setValue("E-mail:"+a.email+"<br/>MSN:"+a.msn+"<br/>QQ:"+a.qq+"<br/>联系地址:"+a.homeAddress+"<br/>邮编:"+a.homeZip);},failure:function(){Ext.ux.Toast.msg("错误信息","载入出错!");}});};function uploadProjectAttach(h){var f=Ext.getCmp("projectAttachIDs");var g=Ext.getCmp("displayProjectAttach");for(var e=0;e<h.length;e++){if(f.getValue()!=""){f.setValue(f.getValue()+",");}f.setValue(f.getValue()+h[e].fileId);Ext.DomHelper.append(g.body,'<span><a href="#" onclick="FileAttachDetail.show('+h[e].fileId+')">'+h[e].fileName+'</a><img class="img-delete" src="'+__ctxPath+'/images/system/delete.gif" onclick="removeProjectAttach(this,'+h[e].fileId+')"/>&nbsp;|&nbsp;</span>');}}function removeProjectAttach(i,k){var g=Ext.getCmp("projectAttachIDs");var j=g.getValue();if(j.indexOf(",")<0){g.setValue("");}else{j=j.replace(","+k,"").replace(k+",","");g.setValue(j);}var l=Ext.get(i.parentNode);l.remove();var h=Ext.getCmp("projectId").value;if(h!=null&&h!=""&&h!="undefined"){Ext.Ajax.request({url:__ctxPath+"/customer/removeFileProject.do",params:{projectId:h,projectAttachIDs:k},method:"post",success:function(){Ext.Ajax.request({url:__ctxPath+"/system/multiDelFileAttach.do",params:{ids:k},method:"post",success:function(){Ext.ux.Toast.msg("信息提示","成功删除所选记录！");}});}});}else{Ext.Ajax.request({url:__ctxPath+"/system/multiDelFileAttach.do",params:{ids:k},method:"post",success:function(){Ext.ux.Toast.msg("信息提示","成功删除所选记录！");}});}}