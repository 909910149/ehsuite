Ext.ns("Ht");Ht.detailGrid=Ext.extend(Ext.grid.EditorGridPanel,{constructor:function(b){Ext.applyIf(this,b);this.parentConf=this.parentConf;this.initUI();Ht.detailGrid.superclass.constructor.call(this,{stripeRows:true,tbar:this.toolbar,store:this.store,width:800,trackMouseOver:true,disableSelection:false,loadMask:true,clicksToEdit:1,anchor:"100% -53",autoScroll:true,cm:this.cm,sm:this.sm,viewConfig:{autoFill:true},listeners:{scope:this,"render":function(a){a.dragZone=new Ext.ux.dd.GridDragZone(a,{});a.dropZone=new Ext.ux.dd.GridDropZone(a,{});},"rowclick":function(f,a,e){this.clickRow=a;},"beforeedit":function(d){var a=d.record;if(a.data.isDesignShow!=3){if(d.field=="fieldName"||d.field=="fieldLabel"||d.field=="fieldSize"||d.field=="fieldType"||d.field=="isRequired"||d.field=="showFormat"||d.field=="isPrimary"){return false;}}}}});},initUI:function(){var d=[{name:"fieldId",type:"int"},"fieldName","fieldType","fieldLabel","isRequired","fieldSize","fieldDscp","isPrimary","foreignKey","foreignTable","isList","isQuery","isFlowTitle","showFormat","isDesignShow"];if(this.isMainTable){d=[{name:"fieldId",type:"int"},"fieldName","fieldType","fieldLabel","isRequired","fieldSize","fieldDscp","isPrimary","isList","isQuery","isFlowTitle","showFormat","isDesignShow"];}this.store=new Ext.data.JsonStore({fields:d,remoteSort:false});this.store.setDefaultSort("fieldId","asc");this.toolbar=new Ext.Toolbar({items:[{xtype:"button",text:"添加字段",iconCls:"btn-add",handler:this.addField,scope:this},{xtype:"button",text:"删除字段",iconCls:"btn-del",handler:this.delField,scope:this}]});this.sm=new Ext.grid.CheckboxSelectionModel();var c=[this.sm,new Ext.grid.RowNumberer(),{header:"fieldId",dataIndex:"fieldId",hidden:true},{header:"字段KEY",width:100,dataIndex:"fieldName",editor:new Ext.form.TextField({listeners:{scope:this,"change":this.changeForeignKey}})},{header:"字段标签",width:100,dataIndex:"fieldLabel",editor:new Ext.form.TextField()},{header:"字段长度",width:100,dataIndex:"fieldSize",xtype:"numbercolumn",format:"0",editor:new Ext.form.TextField()},{header:"字段类型",width:100,dataIndex:"fieldType",editor:new Ext.form.ComboBox({typeAhead:true,triggerAction:"all",lazyRender:true,mode:"local",store:["varchar","bigint","smallint","int","text","date","datetime","double","float","char","decimal","file"],listeners:{scope:this,"change":this.changeMainTablePrimaryKey}})},{header:"显示格式",width:100,dataIndex:"showFormat",editor:new Ext.form.TextField()},{header:"是否主键",width:100,dataIndex:"isPrimary",xtype:"templatecolumn",tpl:new Ext.XTemplate('<p><input type="checkbox" <tpl if="isPrimary ==1">checked="checked"</tpl> onclick="return false;" class="x-form-checkbox x-form-field"/></p>'),editor:{xtype:"checkbox",listeners:{scope:this,"change":function(b,a){this.fireEvent("clickPrimary",{isMainTable:this.isMainTable==true?true:false,curGrid:this,clickIndex:this.clickRow,checked:a});}}}}];if(this.isMainTable==true){c.push({header:"是否为节点标题",width:100,dataIndex:"isFlowTitle",xtype:"templatecolumn",tpl:new Ext.XTemplate('<p><input type="checkbox" <tpl if="isFlowTitle ==1">checked="checked"</tpl> onclick="return false;" class="x-form-checkbox x-form-field"/></p>'),editor:{xtype:"checkbox",listeners:{scope:this,"change":this.changeTitle}}});}c.push({header:"是否必填",width:100,dataIndex:"isRequired",xtype:"templatecolumn",tpl:new Ext.XTemplate('<p><input type="checkbox" <tpl if="isRequired ==1">checked="checked"</tpl> onclick="return false;" class="x-form-checkbox x-form-field"/></p>'),editor:{xtype:"checkbox",inputValue:1}});c.push({header:"是否显示",width:100,dataIndex:"isList",xtype:"templatecolumn",tpl:new Ext.XTemplate('<p><input type="checkbox" <tpl if="isList ==1">checked="checked"</tpl> onclick="return false;" class="x-form-checkbox x-form-field"/></p>'),editor:{xtype:"checkbox",inputValue:1}});c.push({header:"是否查询",width:100,dataIndex:"isQuery",xtype:"templatecolumn",tpl:new Ext.XTemplate('<p><input type="checkbox" <tpl if="isQuery ==1">checked="checked"</tpl> onclick="return false;" class="x-form-checkbox x-form-field"/></p>'),editor:{xtype:"checkbox",inputValue:1}});if(this.isMainTable!=true){c.push({header:"外键字段",width:100,dataIndex:"foreignKey",editor:new Ext.form.ComboBox({typeAhead:true,triggerAction:"all",mode:"local",store:new Ext.data.JsonStore({fields:["fieldName"]}),valueField:"fieldName",displayField:"fieldName",listeners:{scope:this,"focus":function(b){var l=this.parentConf.editGrid1.getStore();var n=this.getStore();var m=[];for(var k=0;k<l.getCount();k++){var a=l.getAt(k);var i=n.getAt(this.clickRow);if(a.data.fieldType==i.data.fieldType){m.push(a.data);}}b.getStore().loadData(m);},"select":function(b,l,j){var k=this.getStore();var a=k.getAt(this.clickRow);if(a){var i=this.configPanel.getCmpByName("formTable.tableKey").getValue();a.set("foreignTable",i);}}}})});c.push({header:"关联表",width:100,dataIndex:"foreignTable",editor:new Ext.form.TextField()});}this.cm=new Ext.grid.ColumnModel({columns:c,defaults:{sortable:false,width:100,fixed:true,menuDisabled:true}});},changeTitle:function(g,j){if(this.isMainTable){var k=this.clickRow;var h=this.getStore();if(j){for(var l=0;l<h.getCount();l++){var i=h.getAt(l);if(l!=k){if(i.data.isFlowTitle==1||i.data.isFlowTitle==true||i.data.isFlowTitle=="1"||i.data.isFlowTitle=="true"){i.set("isFlowTitle",0);}}else{i.set("isFlowTitle",1);}}}else{var i=h.getAt(k);i.set("isFlowTitle",0);}}},changeMainTablePrimaryKey:function(j){if(this.isMainTable==true&&this.parentConf){var i=this.parentConf.primarykeyRecord;if(i){for(var l=0;l<this.parentConf.SubTables.keys.length;l++){var m=this.parentConf.SubTables.keys[l];var n=this.parentConf.dataStore.get(m+"-grid");var h=n.getStore();var k=this.parentConf.findForeignKey(h,i.data.fieldName);if(k){k.set("fieldType",j.getValue());k.commit();}}}}},changeForeignKey:function(k,l,i){if(this.isMainTable==true&&this.parentConf){for(var n=0;n<this.parentConf.SubTables.keys.length;n++){var o=this.parentConf.SubTables.keys[n];var p=this.parentConf.dataStore.get(o+"-grid");var j=p.getStore();var m=this.parentConf.findForeignKey(j,i);if(m){m.set("foreignKey",l);m.commit();}}}},addField:function(){var f=this.store;var d=f.recordType;var e=new d();e.set("isPrimary",0);e.set("isList",0);e.set("isQuery",0);e.set("isRequired",0);e.set("isDesignShow",3);e.set("isFlowTitle",0);f.insert(f.getCount(),e);this.getView().refresh();},delField:function(){var h=this.getSelectionModel().getSelections();if(h.length==0){Ext.ux.Toast.msg("操作信息","请选择要删除的字段！");return;}var e=this.getStore();for(var g=0;g<h.length;g++){var f=h[g];if(this.isMainTable&&f.data.isPrimary==1){this.primarykeyRecord=null;e.fireEvent("removePrimaryKey",{grid:this,record:f});}e.remove(f);}this.getView().refresh();}});Ht.DetailFormPanel=Ext.extend(Ext.form.FieldSet,{constructor:function(b){Ext.applyIf(this,b);this.initUI();Ht.DetailFormPanel.superclass.constructor.call(this,{layout:"form",collapsible:true,collapsed:false,title:this.title,flex:1,items:[{xtype:"hidden",name:this.paramRoot+".isMain",value:0},{xtype:"hidden",name:this.paramRoot+".tableId"},{xtype:"textfield",name:this.paramRoot+".tableName",anchor:"100%",allowBlank:false,fieldLabel:"表名"},{xtype:"textfield",name:this.paramRoot+".tableKey",anchor:"100%",value:this.paramRoot,readOnly:true,allowBlank:false,fieldLabel:"表KEY"},this.editGrid]});},initUI:function(){if(this.defaultGrid){this.editGrid=this.defaultGrid;}else{this.editGrid=new Ht.detailGrid({parentConf:this.parentConf});}this.editGrid.on("render",function(b){b.dragZone=new Ext.ux.dd.GridDragZone(b,{});b.dropZone=new Ext.ux.dd.GridDropZone(b,{});},this);},getEditGrid:function(){return this.editGrid;}});FormDesignPanelForm=Ext.extend(Ext.Window,{designPanel:null,showPanel:null,step:0,activePanel:null,SubTables:new Ext.util.MixedCollection(),MainTable:null,editGrid1:null,clickRow:-1,havadetailNo:0,formTables:[],primarykeyRecord:null,caStore:null,cacheTable:[],haveSub:false,subTableKeys:[],isOldPublish:"",constructor:function(b){Ext.applyIf(this,b);this.initUI();FormDesignPanelForm.superclass.constructor.call(this,{id:"FormDesignPanelForm",title:"表单设计",iconCls:"menu-form",width:850,height:500,modal:true,maximizable:true,layout:"vbox",defaults:{padding:"6"},layoutConfig:{align:"stretch"},items:[this.designPanel,this.configPanel],buttonAlign:"center",buttons:this.buttons});},initUI:function(){this.caStore=new Ext.util.MixedCollection();this.dataStore=new Ext.util.MixedCollection();this.radioGroup=new Ext.form.RadioGroup({fieldLabel:"表模式",allowBlank:false,anchor:"94%",name:"formDef.formType",items:[{name:"formDef.formType",boxLabel:"单表",inputValue:0},{name:"formDef.formType",boxLabel:"一对多表",inputValue:1}]});this.designPanel=new Ext.FormPanel({url:__ctxPath+"/flow/saveFormDef.do",layout:"form",region:"north",defaults:{},flex:1,autoScroll:true,items:[{xtype:"hidden",name:"formDef.formDefId",value:this.formDefId?this.formDefId:""},{xtype:"textfield",name:"formDef.formTitle",allowBlank:false,fieldLabel:"表单名称",anchor:"96%"},{xtype:"textarea",name:"formDef.formDesp",fieldLabel:"表单描述",anchor:"96%"},{xtype:"hidden",name:"formDef.status",fieldLabel:"表单状态",value:0},{xtype:"hidden",name:"formDef.isGen",value:0},this.radioGroup,{hideLabel:true,anchor:"96%",height:496,xtype:"fckdesigner",allowBlank:false,blankText:"请设计好表单!",name:"formDef.defHtml"}]});this.activePanel=this.designPanel;this.editGrid2=new Ht.detailGrid({parentConf:this});this.editGrid1=new Ht.detailGrid({isMainTable:true,parentConf:this});this.editGrid1.on("clickPrimary",this.addPrimaryKey,this);this.mainTable=new Ext.form.FieldSet({layout:"form",title:"主表",border:true,flex:1,items:[{xtype:"hidden",name:"formTable.isMain",value:1},{xtype:"hidden",name:"formTable.tableId"},{xtype:"textfield",allowBlank:false,name:"formTable.tableName",anchor:"100%",fieldLabel:"表名"},{xtype:"textfield",name:"formTable.tableKey",anchor:"100%",allowBlank:false,fieldLabel:"表KEY",listeners:{"change":this.changeForeignTable,scope:this}},this.editGrid1]});this.belongTable=new Ext.form.FieldSet({flex:1,title:"子表",layout:"form",defaults:{anchor:"96% 100%"},autoScroll:true,items:[]});this.configPanel=new Ext.FormPanel({hidden:true,flex:1,region:"center",layout:"hbox",layoutConfig:{padding:"3 3 3 3",align:"stretch"},items:[this.mainTable,this.belongTable]});this.seebutton=new Ext.Button({text:"预览",iconCls:"btn-detail",handler:this.checkDesign,scope:this});this.savebutton=new Ext.Button({hidden:true,text:"保存",iconCls:"btn-save",handler:this.saveDrafRecord,scope:this});this.publishbutton=new Ext.Button({hidden:true,text:"发布",iconCls:"btn-save",handler:this.publishRecord,scope:this});this.upbutton=new Ext.Button({hidden:true,text:"上一步",iconCls:"btn-save",handler:this.upStep,scope:this});this.nextbutton=new Ext.Button({text:"下一步",iconCls:"btn-save",handler:this.nextStep,scope:this});this.buttons=[this.seebutton,this.savebutton,this.publishbutton,this.upbutton,this.nextbutton,{xtype:"button",text:"关闭",iconCls:"btn-cancel",scope:this,handler:function(){this.close();}}];this.dataStore.add("mainGrid",this.editGrid1);var f=this.editGrid1.getStore();this.dataStore.add("mainGrid-store",f);if(this.formDefId!=null&&this.formDefId!="undefined"){var e=this.designPanel;var d=this;this.designPanel.loadData({url:__ctxPath+"/flow/getFormDef.do?formDefId="+this.formDefId,root:"data",preName:"formDef",success:function(c,b){var a=Ext.util.JSON.decode(c.responseText).data;e.getCmpByName("formDef.defHtml").setValue(a.defHtml);d.formTables=a.formTables;}});}else{this.radioGroup.setValue(0);}},changeForeignTable:function(k,l,i){for(var n=0;n<this.SubTables.keys.length;n++){var o=this.SubTables.keys[n];var p=this.dataStore.get(o+"-grid");var j=p.getStore();var m=this.findForeignKey(j,this.primarykeyRecord.data.fieldName);if(m){m.set("foreignTable",l);m.commit();}}},checkDesign:function(){var b=this.designPanel.getCmpByName("formDef.defHtml").getValue();new DesignerWin({defHtml:b}).show();},findForeignKey:function(f,h){if(h){for(var e=0;e<f.getCount();e++){var g=f.getAt(e);if(g.data.foreignKey==h){return g;}}}return null;},findPrimaryKey:function(e){for(var d=0;d<e.getCount();d++){var f=e.getAt(d);if(f.data.isPrimary==1){return f;}}return null;},addPrimaryKey:function(m){var t=m.curGrid;var i=t.getStore();var n=m.clickIndex;var r,l;if(m.checked){for(var o=0;o<i.getCount();o++){var p=i.getAt(o);if(o!=n){if(p.data.isPrimary==1||p.data.isPrimary==true||p.data.isPrimary=="1"||p.data.isPrimary=="true"){p.set("isPrimary",0);r=p;}}else{p.set("isPrimary",1);l=p;this.primarykeyRecord=p;}}}else{r=i.getAt(n);r.set("isPrimary",0);}if(this.haveSub&&m.isMainTable){for(var o=0;o<this.subTableKeys.length;o++){var s=this.subTableKeys[o];var q=this.dataStore.get(s+"-grid");this.addForeignKey(q,l,r);}}},addForeignKey:function(k,j,m){var n=k.getStore();var i=this.configPanel.getCmpByName("formTable.tableKey").getValue();for(var l=0;l<n.getCount();l++){var h=n.getAt(l);if(m&&h.data.foreignKey&&h.data.foreignKey==m.data.fieldName){if(h.data.foreignTable==i||h.data.foreignTable==""||h.data.foreignTable==null){if(j){h.set("fieldType",j.data.fieldType);h.set("foreignKey",j.data.fieldName);h.set("fieldLabel","Foreign_Key");if(i!=h.data.foreignTable){h.set("foreignTable",i);}return;}else{n.remove(h);k.getView().refresh();return;}}}}if(!m&&j){this.addForeignKeyRecord(k,j);return;}},addForeignKeyRecord:function(e,i){var g=e.getStore();g.commitChanges();var h=i.data.fieldName;i=i.copy();i.store=null;Ext.data.Record.id(i);i.set("fieldId",null);i.set("fieldName","f"+h);i.set("foreignKey",h);i.set("fieldLabel","Foreign_Key");i.set("isPrimary",0);i.set("foreignTable",this.configPanel.getCmpByName("formTable.tableKey").getValue());i.commit();try{g.add(i);}catch(j){}try{e.getView().refresh();}catch(j){}},addPrimaryKeyRecord:function(k,i){var l=k.getStore();var e=l.recordType;var h=new e();h.set("fieldName",i);h.set("fieldType","bigint");h.set("fieldLabel","Primary_Key");h.set("isPrimary",1);h.set("isList",0);h.set("isQuery",0);h.set("isRequired",0);h.set("isDesignShow",3);h.set("isFlowTitle",0);l.insert(l.getCount(),h);try{k.getView().refresh();}catch(j){}return h;},upStep:function(){this.activePanel.hide();this.activePanel=this.designPanel;this.activePanel.show();this.upbutton.hide();this.doLayout(true);this.step=0;this.nextbutton.show();this.publishbutton.hide();this.savebutton.hide();},nextStep:function(){var e=this.designPanel.getCmpByName("formDef.defHtml").getValue();if(this.checkIfHasSameElement(this.getFormElements(this.getHtmlForm(e)))){Ext.ux.Toast.msg("信息提示","字段名称不能重复,请检查重新命名！");return;}if(this.step==0&&this.activePanel.getForm().isValid()){var d=this.radioGroup.getValue();if(d.inputValue==0){this.haveSub=false;this.belongTable.hide();if(e){var f=this.loadFields(e,true);if(f!=false){Ext.ux.Toast.msg("信息提示",f);return;}}}else{this.haveSub=true;if(e){var f=this.loadFields(e,false);if(f!=false){Ext.ux.Toast.msg("信息提示",f);return;}}this.belongTable.show();}this.activePanel.hide();this.activePanel=this.configPanel;this.activePanel.show();this.upbutton.show();this.savebutton.show();this.publishbutton.show();this.nextbutton.hide();this.configPanel.doLayout(true);this.doLayout(true);this.step=1;}else{Ext.ux.Toast.msg("信息提示","没填写表单信息或未设计表单！");return;}},getHtmlForm:function(i){var g=document.createElement("form");var h=document.createElement("p");var j=document.createElement("div");var f=Ext.DomHelper.insertHtml("afterBegin",j,i);h.appendChild(j);g.appendChild(h);return g;},getFormElements:function(b){return b.elements;},checkIfHasSameElement:function(f){for(var d=0;d<f.length;d++){for(var e=d+1;e<f.length;e++){if(f[d].name==f[e].name&&f[d].type!="radio"&&f[d].type!="checkbox"){return true;}}}return false;},enHtml:function(E){var i=function(a){var h=new Object();h.fieldName=a.name;var b=a.getAttribute("txtvaluetype");h.fieldType=b?b:"varchar";var g=a.getAttribute("txtisprimary");h.isPrimary=g==1?1:0;var f=a.getAttribute("txtlabel");h.fieldLabel=f?f:a.name;var d=a.getAttribute("txtisnotnull");h.isRequired=d==1?1:0;var e=a.getAttribute("txtsize");h.fieldSize=e?e:null;var c=a.getAttribute("dataformat");h.showFormat=c?c:"";h.isList=1;h.isQuery=1;h.isDesignShow=a.type=="hidden"?2:1;h.isisFlowTitle=0;return h;};var A=function(f){var d=[];for(var a=0;a<f.length;a++){var e=f[a];var c=true;for(var b=0;b<d.length;b++){if(d[b].name==e.name){c=false;}}if(c){d.push(e);}}return d;};var J=function(e){var c=[];var a=[];Ext.each(e,function(f){if(f.type=="button"){return;}if(f.type=="radio"||f.type=="checkbox"){a.push(f);return;}c.push(i(f));});var d=A(a);for(var b=0;b<d.length;b++){c.push(i(d[b]));}return c;};var B=this.getHtmlForm(E);var I=B.getElementsByTagName("TABLE");this.havadetailNo=0;this.SubTables.clear();this.MainTable=null;var x=new Ext.util.MixedCollection();var G=[];var y=[];if(this.haveSub){for(var v=0;v<I.length;v++){if(I[v]&&I[v].getAttribute("isdetail")){var D=I[v].getAttribute("txtname");if(!D){return"明细表格未填写名字!";}for(var w=0;w<y.length;w++){if(y[w]==D){return"子表存在重复表名，请保证表名不相同！";}}x.add(D,I[v]);y.push(D);this.subTableKeys.push(D);G.push(I[v]);this.havadetailNo++;}}if(G&&G.length>0){for(var v=0;v<G.length;v++){var H=G[v].parentNode;if(H){H.removeChild(G[v]);}}}}var j=J(B.elements);if(j.length>0){this.MainTable=j;}if(y&&y.length>0){for(var z=0;z<y.length;z++){var C=document.createElement("form");var F=x.get(y[z]);C.appendChild(F);var k=J(C.elements);if(k.length>0){this.SubTables.add(y[z],k);}}}return true;},loaddata:function(d){if(!d.data){d.data=new Array();}var n=this.dataStore.get(d.gridKey+"-store");var k=this.caStore.get(d.gridKey);if(k&&k.length>0){for(var m=0;m<k.length;m++){d.data.push(k[m]);}}var l=[];if(d.isMainTable){var i=this.dataStore.get("mainTable-database");if(i){this.setValue(this.mainTable,"formTable",i);l=i.formFields;}}var j=this.mergeDate(d.data,l);n.loadData(j);n.fireEvent("checkloadevent",{gridKey:d.gridKey,isMainTable:d.isMainTable});this.loadsubtabledata();},mergeDate:function(j,n){var q=0;var k=[];if(n&&n.length>0){for(var o=0;o<j.length;o++){var m=false;for(var p=0;p<n.length;p++){if(j[o].fieldName==n[p].fieldName){var i=n[p];var r=j[o];r.fieldId=i.fieldId;r.isPrimary=i.isPrimary;r.isFlowTitle=i.isFlowTitle;r.isQuery=i.isQuery;r.isList=i.isList;r.foreignKey=i.foreignKey;r.foreignTable=i.foreignTable;k.push(r);m=true;}else{if(q==0&&n[p].isDesignShow==3){k.push(n[p]);m=true;}}}if(!m){k.push(j[o]);}q++;}}else{k=j;}return k;},loadsubtabledata:function(){for(var k=0;k<this.subTableKeys.length;k++){var l=this.SubTables.get(this.subTableKeys[k]);var j=this.caStore.get(this.subTableKeys[k]);if(j&&j.length>0){for(var k=0;k<j.length;k++){l.push(j[k]);}}var n=this.dataStore.get(this.subTableKeys[k]+"-database");var d=[];if(n){this.setValue(this.belongTable,this.subTableKeys[k],n);d=n.formFields;}var i=this.mergeDate(l,d);var m=this.dataStore.get(this.subTableKeys[k]+"-store");m.loadData(i);this.checkdata({gridKey:this.subTableKeys[k],isMainTable:false});}},checkdata:function(h){var g=this.dataStore.get(h.gridKey+"-store");if(h.isMainTable){this.primarykeyRecord=this.findPrimaryKey(g);}else{var j=this.findPrimaryKey(g);var d=this.dataStore.get(h.gridKey+"-grid");if(d){if(this.haveSub&&j==null){this.addPrimaryKeyRecord(d,"subId");var i=this.findForeignKey(this.dataStore.get(h.gridKey+"-store"),this.primarykeyRecord.data.fieldName);this.addForeignKey(d,this.primarykeyRecord,i,true);}}}if(!this.primarykeyRecord){this.primarykeyRecord=this.addPrimaryKeyRecord(this.dataStore.get(h.gridKey),"mainId");}},setCacheFields:function(d){var c=[d];Ext.each(c,function(b){var j=new Array();var h=this.dataStore.get(b+"-store");if(h){for(var a=0;a<h.getCount();a++){var i=h.getAt(a);if(i.data.isDesignShow==3&&(i.data.fieldId==null||i.data.fieldId==undefined||i.data.fieldId=="")){j.push(i.data);}}if(j.length>0){this.caStore.add(b,j);}h.on("loaddataevent",this.loaddata,this);h.on("checkloadevent",this.checkdata,this);h.on("removePrimaryKey",this.removePrimaryKey,this);}},this);},removePrimaryKey:function(h){this.primarykeyRecord=null;for(var k=0;k<this.subTableKeys.length;k++){var l=this.subTableKeys[k];var j=this.dataStore.get(l+"-grid");if(j){var g=j.getStore();var i=this.findForeignKey(g,h.record.data.fieldName);if(i!=null){g.remove(i);}}}},loadFields:function(F,I){var H=this.formTables;var D=this.editGrid1;var J=D.getStore();this.caStore.clear();var C=[];for(var G=0;G<this.subTableKeys.length;G++){C.push(this.subTableKeys[G]);}this.setCacheFields("mainGrid",C);this.subTableKeys.length=0;if(H){var y=this.enHtml(F);if(y!=true){return y;}for(var G=0;G<this.subTableKeys.length;G++){var f=this.subTableKeys[G];C.remove(f);var L=this.dataStore.get(f+"-grid");if(L==null||L==undefined){var v=new Ht.DetailFormPanel({height:300,padding:"16 16 16 16",title:f+"-表",paramRoot:f,parentConf:this});var x=v.getEditGrid();if(x){this.dataStore.add(f+"-grid",x);x.on("clickPrimary",this.addPrimaryKey,this);this.dataStore.add(f+"-store",x.getStore());}this.dataStore.add(f+"-fieldset",v);this.belongTable.add(v);}}for(var E=0;E<C.length;E++){var i=C[E];var v=this.dataStore.get(i+"-fieldset");if(v){this.dataStore.removeKey(i+"-fieldset");this.dataStore.removeKey(i+"-grid");this.dataStore.removeKey(i+"-store");this.subTableKeys.remove(i);v.disable();v.hide();}}this.belongTable.doLayout(true);this.configPanel.doLayout(true);this.doLayout(true);if(H.length>0){var B,g,K,A;for(var z=0;z<H.length;z++){if(H[z].isMain==1){B=H[z];this.dataStore.add("mainTable-database",B);}else{if(!I){g=H[z];for(var G=0;G<this.subTableKeys.length;G++){if(g.tableKey==this.subTableKeys[G]){this.dataStore.add(this.subTableKeys[G]+"-database",g);}}}}}}J.fireEvent("loaddataevent",{gridKey:"mainGrid",data:this.MainTable,isMainTable:true});}return false;},setValue:function(tablePanel,preName,data){var items=tablePanel.items;if(items!=null){for(var i=0;i<items.getCount();i++){var comp=items.get(i);var xtype=comp.getXType();try{if(xtype=="hidden"||xtype=="textfield"){var name=comp.getName();if(name){if(preName){if(name.indexOf(preName)!=-1){name=name.substring(preName.length+1);}}var val=eval("data."+name);if(val!=null&&val!=undefined){comp.setValue(val);if(name.indexOf("Key")!=-1){comp.setReadOnly(true);}}}}else{if(comp.items){this.setValue(comp,preName,data);continue;}}}catch(e){}}}},validRecord:function(g,h,j,k){if(h.data.fieldType==""||h.data.fieldType==null){Ext.ux.Toast.msg("信息提示","字段数据类型不能为空！");return null;}if(h.data.fieldName==""||h.data.fieldName==null){Ext.ux.Toast.msg("信息提示","字段KEY不能为空！");return null;}for(var l=k+1;l<j;l++){var i=g.getAt(l);if(h.data.fieldName==i.data.fieldName){Ext.ux.Toast.msg("信息提示","字段KEY不能重复！");return null;}}return h;},saveRecord:function(){try{if(this.activePanel.getForm().isValid()){this.storeParam1=[];this.storeParam2=new Ext.util.MixedCollection();var t=this.editGrid1.getStore();var w=0;var F=0;var i;for(var z=0,C=t.getCount();z<C;z+=1){var D=t.getAt(z);if(D){if(D.data.isFlowTitle==1){w++;}D=this.validRecord(t,D,C,z);if(!D){return;}D=this.changeData(D);this.storeParam1.push(D.data);}if(D.data.isPrimary==1){F++;i=D.data.fieldName;}}if(t.getCount()==0){Ext.ux.Toast.msg("信息提示","主表不能没有字段！");return;}if(F==0){Ext.ux.Toast.msg("信息提示","主表缺少主键，请选择主键！");return;}if(F>1){Ext.ux.Toast.msg("信息提示","主表只能有一个主键！");return;}if(w==0){Ext.ux.Toast.msg("信息提示","必需有一个字段用于显示任务节点名称！");return;}if(w>1){Ext.ux.Toast.msg("信息提示","只能有一个字段用于显示任务节点名称！");return;}for(var z=0;z<this.subTableKeys.length;z++){var e=this.subTableKeys[z];var E=this.dataStore.get(e+"-grid");var j=E.getStore();if(!this.validStore(j,e,i)){return;}}var u=Ext.Ajax.serializeForm(this.configPanel.getForm().getEl());var x=Ext.urlDecode(u);var y=[];y.push(this.convertObj(x,"formTable",Ext.encode(this.storeParam1)));for(var B=0;B<this.subTableKeys.length;B++){var e=this.subTableKeys[B];y.push(this.convertObj(x,e,this.storeParam2.get(e+"ad")));}var A=this;this.designPanel.getForm().submit({params:{"objs":Ext.encode(y)},method:"post",waitMsg:"正在提交数据...",success:function(c,a){var b=a.result;if(!b.success){alert(b.msg);Ext.ux.Toast.msg("信息提示","已经存在相同的表名"+b.msg+"！");}else{if(A.callback){A.callback.call(A);}A.close();}},failure:function(c,a){var b=a.result;if(!b.success){Ext.ux.Toast.msg("信息提示","已经存在相同的表名"+b.msg+"！");}else{Ext.MessageBox.show({title:"操作信息",msg:"信息保存出错，请联系管理员！",buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});}}});}}catch(v){alert(v);}},convertObj:function(e,h,f){var g={};g.tableId=e[h+".tableId"]?e[h+".tableId"]:null;g.tableName=e[h+".tableName"]?e[h+".tableName"]:null;g.tableKey=e[h+".tableKey"]?e[h+".tableKey"]:null;g.isMain=e[h+".isMain"]?e[h+".isMain"]:null;g.fields=f?f:null;return g;},validStore:function(n,m,i){var r=[];var o=0;var p=0;for(var q=0,s=n.getCount();q<s;q+=1){var t=n.getAt(q);if(t){t=this.validRecord(n,t,s,q);if(!t){return false;}if(t.data.foreignKey!=""&&t.data.foreignKey!=undefined){if(t.data.foreignKey!=i){Ext.ux.Toast.msg("信息提示","从表的外键所对应主表的主键不一致，请重新选择！");return false;}o++;if(t.data.foreignTable==""||t.data.foreignTable==null){Ext.ux.Toast.msg("信息提示","从表的关联表不能为空！");return false;}var e=this.configPanel.getCmpByName("formTable.tableKey").getValue();if(t.data.foreignTable!=e){Ext.ux.Toast.msg("信息提示","从表的关联表与主表名不同，请修改！");return false;}}t=this.changeData(t);r.push(t.data);}if(t.data.isPrimary==1){p++;}}if(o>1){Ext.ux.Toast.msg("信息提示","从表只能有一个外键！");return false;}if(p==0&&this.haveSub){Ext.ux.Toast.msg("信息提示","从表缺少主键，请选择主键！");return false;}if(p>1){Ext.ux.Toast.msg("信息提示","从表只能有一个主键！");return false;}if(this.haveSub){if(n.getCount()==0){Ext.ux.Toast.msg("信息提示","从表不能没有字段！");return false;}}this.storeParam2.add(m+"ad",Ext.encode(r));return true;},publishRecord:function(){this.designPanel.getCmpByName("formDef.status").setValue(1);this.saveRecord();},saveDrafRecord:function(){this.designPanel.getCmpByName("formDef.status").setValue(0);this.saveRecord();},changeData:function(b){if(b.data.isPrimary){b.set("isPrimary",1);}else{b.set("isPrimary",0);}if(b.data.isList){b.set("isList",1);}else{b.set("isList",0);}if(b.data.isQuery){b.set("isQuery",1);}else{b.set("isQuery",0);}if(b.data.isRequired){b.set("isRequired",1);}else{b.set("isRequired",0);}if(b.data.isFlowTitle){b.set("isFlowTitle",1);}else{b.set("isFlowTitle",0);}if(isNaN(b.data.fieldSize)||b.data.fieldSize==""){b.set("fieldSize",null);}if(b.data.fieldId==0){b.set("fieldId",null);}b.commit();return b;}});DesignerWin=Ext.extend(Ext.Window,{constructor:function(b){Ext.applyIf(this,b);this.initUI();DesignerWin.superclass.constructor.call(this,{title:"表单预览",iconCls:"menu-find-doc",width:800,height:430,modal:true,autoScroll:true,maximizable:true,layout:"vbox",defaults:{padding:"6"},layoutConfig:{align:"stretch"},items:[this.formPanel],buttonAlign:"center",buttons:this.buttons});},initUI:function(){this.formTable=new Ext.form.FieldSet({title:"业务表单",html:this.defHtml});this.formPanel=new Ext.FormPanel({layout:"table",border:false,frame:false,flex:1,autoScroll:true,defaults:{anchor:"98%,98%"},items:this.formTable});this.formTable.on("afterrender",this.getFormHtmlCallback,this);this.buttons=[{xtype:"button",text:"关闭",iconCls:"btn-close",scope:this,handler:function(){try{if(this.officePanel){this.officePanel.closeDoc();}}catch(b){}this.close();}}];},getFormHtmlCallback:function(){try{$ImportSimpleJs([__ctxPath+"/js/core/ntkoffice/NtkOfficePanel.js",__ctxPath+"/js/selector/SealSelector.js",__ctxPath+"/js/selector/PaintTemplateSelector.js"],function(){$converDetail.call(this,null,null);},this);}catch(b){alert(b);}}});Ext.ns("Ext.ux.dd");Ext.ux.dd.GridDragZone=function(c,d){this.view=c.getView();Ext.ux.dd.GridDragZone.superclass.constructor.call(this,this.view.mainBody.dom,d);this.scroll=false;this.grid=c;this.ddel=document.createElement("div");this.ddel.className="x-grid-dd-wrap";};Ext.extend(Ext.ux.dd.GridDragZone,Ext.dd.DragZone,{getDragData:function(e){var g=this.grid.selModel;var f=Ext.lib.Event.getTarget(e);var h=this.view.findRowIndex(f);if(h!==false){if(!g.isSelected(h)||e.hasModifier()){g.handleMouseDown(this.grid,h,e);}}if(g.getSelections().length>0){return{grid:this.grid,ddel:this.ddel,selections:g.getSelections()};}return false;},onInitDrag:function(c){var d=this.dragData;this.ddel.innerHTML=this.grid.getDragDropText();this.proxy.update(this.ddel);},getRepairXY:function(){return this.dragData.repairXY;}});Ext.ux.dd.GridDropZone=function(c,d){this.view=c.getView();Ext.ux.dd.GridDropZone.superclass.constructor.call(this,this.view.scroller,d);this.scroll=false;this.grid=c;};Ext.extend(Ext.ux.dd.GridDropZone,Ext.dd.DropZone,{getTargetFromEvent:function(b){return this.view.scroller;},onNodeEnter:function(g,f,h,e){Ext.fly(g).addClass("my-row-highlight-class");},onNodeOut:function(g,f,h,e){Ext.fly(g).removeClass("my-row-highlight-class");},onNodeOver:function(g,f,h,e){return Ext.dd.DropZone.prototype.dropAllowed;},onNodeDrop:function(p,e,o,r){var v=r.grid;var u=this.grid;var t=r.selections;var i=v.getStore();for(var s=0;s<t.length;s++){i.remove(t[s]);}v.getView().refresh();var n=this.grid.getStore();var q=n.getCount();n.insert(q,t);this.grid.getView().refresh();return true;}});