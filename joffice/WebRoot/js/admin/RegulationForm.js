RegulationForm=Ext.extend(Ext.Window,{constructor:function(b){Ext.applyIf(this,b);this.initUIComponents();RegulationForm.superclass.constructor.call(this,{id:"RegulationFormWin",layout:"fit",items:this.formPanel,modal:true,iconCls:"menu-regulation",height:577,width:1000,maximizable:true,title:"规章制度详细信息",buttonAlign:"center",buttons:[{text:"草稿",iconCls:"btn-save",scope:this,handler:this.save.createCallback(0,this.formPanel,this)},{text:"生效",iconCls:"btn-save",scope:this,handler:this.save.createCallback(1,this.formPanel,this)},{text:"重置",iconCls:"btn-reset",scope:this,handler:this.reset},{text:"取消",iconCls:"btn-cancel",scope:this,handler:this.cancel}]});},initUIComponents:function(){this.formPanel=new Ext.FormPanel({layout:"form",bodyStyle:"padding:10px",border:false,autoScroll:true,defaults:{anchor:"98%,96%"},defaultType:"textfield",items:[{name:"regulation.regId",xtype:"hidden",value:this.regId==null?"":this.regId},{fieldLabel:"状态",name:"regulation.status",xtype:"hidden"},{name:"regulation.proTypeId",xtype:"hidden"},{name:"regulation.issueUserId",xtype:"hidden",value:curUserInfo.userId},{name:"regulation.issueDepId",xtype:"hidden",value:curUserInfo.depId},{name:"regulation.recDepIds",xtype:"hidden",maxLength:1024},{name:"regulation.recUserIds",xtype:"hidden",maxLength:1024},{name:"regAttachsFileIds",id:"regAttachsFileIds",xtype:"hidden"},{xtype:"compositefield",fieldLabel:"制度类型",items:[{name:"regulation.proTypeName",xtype:"textfield",width:250,readOnly:true,allowBlank:false},{xtype:"button",text:"选择类型",iconCls:"btn-select",scope:this,handler:function(){var a=this.formPanel;new GlobalTypeSelector({catKey:"REGULATION",isSingle:true,callback:function(e,f){a.getCmpByName("regulation.proTypeId").setValue(e);a.getCmpByName("regulation.proTypeName").setValue(f);}}).show();}},{xtype:"displayfield",value:"关键字",width:60},{xtype:"textfield",name:"regulation.keywords",maxLength:256,width:250},{xtype:"displayfield",value:"发布日期",width:60},{fieldLabel:"",name:"regulation.issueDate",xtype:"datefield",format:"Y-m-d",value:new Date()}]},{xtype:"compositefield",fieldLabel:"发布人",items:[{value:curUserInfo.fullname,width:250,xtype:"textfield",readOnly:true,name:"regulation.issueFullname",maxLength:64},{xtype:"button",iconCls:"btn-select",text:"选择人员",scope:this,handler:function(){var a=this.formPanel;UserSelector.getView(function(e,f){a.getCmpByName("regulation.issueFullname").setValue(f);a.getCmpByName("regulation.issueUserId").setValue(e);},true).show();}},{xtype:"displayfield",value:"发布部门",width:60},{xtype:"textfield",name:"regulation.issueDep",maxLength:64,width:250,readOnly:true,value:curUserInfo.depName},{xtype:"button",iconCls:"btn-select",text:"选择部门",scope:this,handler:function(){var a=this.formPanel;DepSelector.getView(function(f,e){a.getCmpByName("regulation.issueDep").setValue(e);a.getCmpByName("regulation.issueDepId").setValue(f);},true).show();}}]},{xtype:"compositefield",fieldLabel:"接收部门范围",items:[{name:"regulation.recDeps",xtype:"textarea",readOnly:true,width:650,maxLength:1024},{xtype:"button",text:"选择部门",iconCls:"btn-select",scope:this,handler:function(){var a=this.formPanel;DepSelector.getView(function(f,e){a.getCmpByName("regulation.recDeps").setValue(e);a.getCmpByName("regulation.recDepIds").setValue(f);}).show();}}]},{xtype:"compositefield",fieldLabel:"接收人范围",items:[{width:650,name:"regulation.recUsers",readOnly:true,xtype:"textarea",maxLength:1024},{xtype:"button",iconCls:"btn-select",text:"选择人员",scope:this,handler:function(){b=this.formPanel;UserSelector.getView(function(d,a){b.getCmpByName("regulation.recUsers").setValue(a);b.getCmpByName("regulation.recUserIds").setValue(d);}).show();}}]},{fieldLabel:"标题",name:"regulation.subject",allowBlank:false,maxLength:256},{fieldLabel:"内容",name:"regulation.content",xtype:"fckeditor",maxLength:65535},{xtype:"container",layout:"column",border:false,defaults:{border:false},items:[{columnWidth:0.7,layout:"form",border:false,items:[{fieldLabel:"附件",xtype:"panel",name:"regAttachs",frame:false,border:true,bodyStyle:"padding:4px 4px 4px 4px",height:70,autoScroll:true,html:""}]},{columnWidth:0.3,items:[{border:false,xtype:"button",text:"添加附件",scope:this,iconCls:"menu-attachment",handler:function(){var d=this.formPanel;var a=App.createUploadDialog({file_cat:"admin/regulation",callback:function(c){var j=d.getCmpByName("regAttachsFileIds");var h=d.getCmpByName("regAttachs");for(var i=0;i<c.length;i++){if(j.getValue()!=""){j.setValue(j.getValue()+",");}j.setValue(j.getValue()+c[i].fileId);Ext.DomHelper.append(h.body,'<span><a href="#" onclick="FileAttachDetail.show('+c[i].fileId+')">'+c[i].fileName+'</a> <img class="img-delete" src="'+__ctxPath+'/images/system/delete.gif" onclick="removeFile(this,'+c[i].fileId+')"/>&nbsp;|&nbsp;</span>');}}});a.show(this);}},{xtype:"button",text:"清除附件",scope:this,iconCls:"reset",handler:function(){var e=this.formPanel;var a=e.getCmpByName("regAttachsFileIds");var f=e.getCmpByName("regAttachs");f.body.update("");a.setValue("");}}]}]}]});if(this.regId!=null&&this.regId!="undefined"){var b=this.formPanel;this.formPanel.loadData({url:__ctxPath+"/admin/getRegulation.do?regId="+this.regId,root:"data",preName:"regulation",success:function(n,k){var a=Ext.util.JSON.decode(n.responseText).data;var l=a.regAttachs;var i=b.getCmpByName("regAttachs");var m=b.getCmpByName("regAttachsFileIds");for(var j=0;j<l.length;j++){if(m.getValue()!=""){m.setValue(m.getValue()+",");}m.setValue(m.getValue()+l[j].fileId);Ext.DomHelper.append(i.body,'<span><a href="#" onclick="FileAttachDetail.show('+l[j].fileId+')">'+l[j].fileName+'</a><img class="img-delete" src="'+__ctxPath+'/images/system/delete.gif" onclick="removeFile(this,'+l[j].fileId+')"/>&nbsp;|&nbsp;</span>');}},failure:function(a,d){Ext.ux.Toast.msg("编辑","载入失败");}});}},reset:function(){this.formPanel.getForm().reset();},cancel:function(){this.close();},save:function(d,e,f){e.getCmpByName("regulation.status").setValue(d);$postForm({formPanel:e,scope:this,url:__ctxPath+"/admin/saveRegulation.do",callback:function(c,a){var b=Ext.getCmp("RegulationGrid");if(b!=null){b.getStore().reload();}f.close();}});}});function removeFile(h,g){var f=Ext.getCmp("regAttachsFileIds");var i=f.getValue();if(i.indexOf(",")<0){f.setValue("");}else{i=i.replace(","+g,"").replace(g+",","");f.setValue(i);}var j=Ext.get(h.parentNode);j.remove();}