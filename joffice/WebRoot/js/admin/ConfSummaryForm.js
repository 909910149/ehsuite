ConfSummaryForm=Ext.extend(Ext.Window,{formPanel:null,constructor:function(b){Ext.applyIf(this,b);this.initUIComponents();ConfSummaryForm.superclass.constructor.call(this,{id:"ConfSummaryFormWin",iconCls:"menu-confSummary",layout:"fit",items:this.formPanel,modal:true,height:350,minHeight:350,width:420,minWidth:420,maximizable:true,title:"编辑会议纪要",buttonAlign:"center",buttons:this.buttons,keys:{key:Ext.EventObject.ENTER,fn:this.save.createCallback(this.formPanel,this,0),scope:this}});},initUIComponents:function(){this.formPanel=new Ext.FormPanel({layout:"form",bodyStyle:"padding:10px 10px 10px 10px",border:false,id:"ConfSummaryForm",defaults:{anchor:"98%,98%"},items:[{name:"confSummary.sumId",xtype:"hidden",value:this.sumId==null?"":this.sumId},{anchor:"99%",fieldLabel:"会议议题",name:"confSummary.confId.confTopic",xtype:"textfield",readOnly:true},{xtype:"hidden",name:"confSummary.confId.confId"},{anchor:"99%",fieldLabel:"纪要创建时间",name:"confSummary.createtime",xtype:"textfield",readOnly:true},{anchor:"99%",xtype:"container",layout:"column",fieldLabel:"纪要人",items:[{columnWidth:1,anchor:"100%",xtype:"textfield",name:"confSummary.creator",readOnly:true,allowBlank:false,maxLength:256},{xtype:"button",text:"请选择",iconCls:"btn-user-sel",handler:function(){UserSelector.getView(function(d,c){Ext.getCmp("ConfSummaryForm").getCmpByName("confSummary.creator").setValue(c);}).show();}}]},{anchor:"99%",xtype:"textarea",fieldLabel:"纪要内容",name:"confSummary.sumContent",allowBlank:false,maxLength:4000},{anchor:"99%",fieldLabel:"状态",hiddenName:"confSummary.status",xtype:"combo",mode:"local",readOnly:true,editable:false,triggerAction:"all",store:[["0","未发送"],["1","发送"]]},{anchor:"99%",fieldLabel:"附件",xtype:"container",layout:"column",border:false,defaults:{border:false},items:[{columnWidth:1,layout:"form",border:false,items:[{anchor:"100%",xtype:"panel",id:"confSummaryFormFilePanel",frame:false,border:true,bodyStyle:"padding:4px 4px 4px 4px",height:50,autoScroll:true,html:""},{xtype:"hidden",name:"fileIds"}]},{items:[{xtype:"button",text:"添加附件",iconCls:"menu-attachment",handler:this.upLoadFile},{xtype:"button",text:"清除附件",iconCls:"reset",handler:this.delLoadFile}]}]}]});if(this.sumId!=null&&this.sumId!="undefined"){this.formPanel.loadData({url:__ctxPath+"/admin/getConfSummary.do?sumId="+this.sumId,root:"data",preName:"confSummary",success:function(e,f){var d=Ext.util.JSON.decode(e.responseText);ConfSummaryForm.setFilePanel(d.data.attachFiles);},failure:function(d,c){Ext.ux.Toast.msg("操作提示","对不起，数据加载有误！");}});}this.buttons=[{text:"发送",iconCls:"btn-mail_send",handler:this.save.createCallback(this.formPanel,this,1)},{text:"保存",iconCls:"btn-save",handler:this.save.createCallback(this.formPanel,this,0)},{text:"取消",iconCls:"btn-cancel",handler:this.cancel.createCallback(this)}];},cancel:function(b){b.close();},save:function(f,g,h){var e=h==0?__ctxPath+"/admin/editConfSummary.do":__ctxPath+"/admin/sendConfSummary.do";if(f.getForm().isValid()){f.getForm().submit({url:e,method:"post",waitMsg:"正在提交数据，请稍后...",success:function(c,a){Ext.ux.Toast.msg("操作信息",h==0?"会议纪要保存成功！":"会议纪要发送成功！");var b=Ext.getCmp("ConfSummaryGrid");if(b!=null){b.getStore().reload();}g.close();},failure:function(b,a){Ext.MessageBox.show({title:"操作信息",msg:"信息发送出错，请联系管理员！",buttons:Ext.MessageBox.OK,icon:Ext.MessageBox.ERROR});g.close();}});}},upLoadFile:function(){var b=App.createUploadDialog({url:__ctxPath+"/file-upload",file_cat:"admin/confSummary",callback:function(a){var h="";var k="";for(var l=0;l<a.length;l++){h+=a[l].fileId+",";k+='<span><a href="#" onclick="FileAttachDetail.show('+a[l].fileId+')">'+a[l].fileName+'</a> <img class="img-delete" src="'+__ctxPath+'/images/system/delete.gif" onclick="removeContractAttach(this,'+a[l].fileId+')"/>&nbsp;|&nbsp;</span>';}h=h.substring(0,h.length-1);var j=Ext.getCmp("ConfSummaryForm");j.getCmpByName("fileIds").setValue(h);var i=Ext.getCmp("confSummaryFormFilePanel");Ext.DomHelper.append(i.body,k);}});b.show("querybtn");},delLoadFile:function(){var c=Ext.getCmp("ConfSummaryForm");var d=c.getCmpByName("fileIds").value;if(d!=null&&d!=""&&d!="undefined"){Ext.Msg.confirm("确认信息","您真的要删除上传文件吗？",function(a){if(a=="yes"){Ext.Ajax.request({url:__ctxPath+"/system/multiDelFileAttach.do",method:"post",params:{ids:d},success:function(){Ext.ux.Toast.msg("操作提示","上传文件删除成功！");c.getCmpByName("fileIds").setValue("");Ext.getCmp("confSummaryFormFilePanel").update();},failure:function(){Ext.ux.Toast.msg("操作提示","对不起，您上传文件删除失败！");}});}});}else{Ext.ux.Toast.msg("操作提示","对不起，你还没有上传文件！");}}});function removeResumeFile(h,g){var f=Ext.getCmp("ConfSummaryForm").getCmpByName("fileIds");var i=f.getValue();if(i.indexOf(",")<0){f.setValue("");}else{i=i.replace(","+g,"").replace(g+",","");f.setValue(i);}alert(f);var j=Ext.get(h.parentNode);j.remove();}ConfSummaryForm.setFilePanel=function(f){var j="";var h=Ext.getCmp("confSummaryFormFilePanel");for(var i=0;i<f.length;i++){j+=f[i].fileId+",";var g='<img class="img-delete" src="'+__ctxPath+'/images/system/delete.gif" onclick="removeResumeFile(this,'+f[i].fileId+')"/>';Ext.DomHelper.append(h.body,'<span><a href="#" onclick="FileAttachDetail.show('+f[i].fileId+')">'+f[i].fileName+"</a>"+g+"&nbsp;|&nbsp;</span>");}Ext.getCmp("ConfSummaryForm").getCmpByName("fileIds").setValue(j.substring(0,j.length-1));};