var BookForm=function(f){this.bookId=f;var e=this.setup();var d=new Ext.Window({id:"BookFormWin",title:"图书详细信息",iconCls:"menu-book-manage",width:500,height:320,modal:true,layout:"fit",buttonAlign:"center",items:[this.setup()],buttons:[{text:"保存",iconCls:"btn-save",handler:function(){var a=Ext.getCmp("BookForm");if(a.getForm().isValid()){a.getForm().submit({method:"post",waitMsg:"正在提交数据...",success:function(c,b){Ext.ux.Toast.msg("操作信息","成功保存信息！");Ext.getCmp("BookGrid").getStore().reload();d.close();},failure:function(c,b){Ext.MessageBox.show({title:"操作信息",msg:"信息保存出错，请联系管理员！",buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});d.close();}});}}},{text:"取消",iconCls:"btn-cancel",handler:function(){d.close();}}]});d.show();};BookForm.prototype.setup=function(){var d=__ctxPath+"/admin/treeBookType.do?method=1";var f=new TreeSelector("bookTypeSelect",d,"图书类别","typeId");var e=new Ext.FormPanel({url:__ctxPath+"/admin/saveBook.do",layout:"form",id:"BookForm",border:false,defaults:{anchor:"100%,100%"},bodyStyle:"padding:5px;",defaultType:"textfield",items:[{name:"book.bookId",id:"bookId",xtype:"hidden",value:this.bookId==null?"":this.bookId},{name:"book.typeId",id:"typeId",xtype:"hidden"},{name:"book.leftAmount",id:"leftAmount",xtype:"hidden"},{xtype:"label"},f,{fieldLabel:"书名",name:"book.bookName",id:"bookName",allowBlank:false,blankText:"书名不能为空"},{fieldLabel:"作者",name:"book.author",id:"author",allowBlank:false,blankText:"作者不能为空"},{fieldLabel:"ISBN号",name:"book.isbn",id:"isbn",allowBlank:false,blankText:"ISBN号不能为空"},{fieldLabel:"出版社",name:"book.publisher",id:"publisher"},{fieldLabel:"图书价格",name:"book.price",id:"price",xtype:"numberfield",nanText:"只能输入数字",allowBlank:false,blankText:"价格不能为空"},{fieldLabel:"存放地点",name:"book.location",id:"location",allowBlank:false,blankText:"存放地点不能为空"},{xtype:"container",layout:"hbox",layoutConfigs:{align:"middle"},defaults:{margins:"0 2 0 0"},id:"amoutContainer",defaultType:"textfield",height:26,items:[{xtype:"label",text:"数量:",width:105},{name:"book.amount",id:"amount",xtype:"numberfield",allowDecimals:false,nanText:"只能输入数字",allowBlank:false,blankText:"数量不能为空",minValue:1,minText:"图书数量必须大于0"},{xtype:"button",id:"bookAmoutButton",text:"增加数量",iconCls:"btn-select",width:80,handler:function(){var a=Ext.getCmp("bookId").getValue();new BookAmountForm(a);}}]},{xtype:"container",layout:"hbox",layoutConfigs:{align:"middle"},defaults:{margins:"0 2 0 0"},defaultType:"textfield",height:26,items:[{xtype:"label",text:"所属部门:",width:105},{name:"book.department",id:"department",allowBlank:false,blankText:"所属部门不能为空"},{xtype:"button",text:"选择",iconCls:"btn-select",width:80,handler:function(){DepSelector.getView(function(b,a){var c=Ext.getCmp("department");c.setValue(a);},true).show();}}]},{xtype:"container",id:"bookSnContainer",layout:"form",items:[{id:"bookSnPanel",fieldLabel:"图书标签",xtype:"panel",frame:false,height:80,autoScroll:true,html:""}]}]});if(this.bookId!=null&&this.bookId!="undefined"){e.getForm().load({deferredRender:false,url:__ctxPath+"/admin/getBook.do?bookId="+this.bookId,waitMsg:"正在载入数据...",success:function(c,b){var l=Ext.getCmp("typeId");var o=b.result.data.bookType.typeName;var m=Ext.getCmp("bookTypeSelect");m.setValue(o);var a=b.result.data.bookId;var p=b.result.data.leftAmount;var n=Ext.getCmp("leftAmount");n.setValue(p);Ext.Ajax.request({url:__ctxPath+"/admin/getSnBookSn.do?bookId="+a,method:"post",success:function(g){var h=Ext.util.JSON.decode(g.responseText);var i=Ext.getCmp("bookSnPanel");for(var j=0;j<h.length;j++){Ext.DomHelper.append(i.body,"<div>"+h[j][1]+'&nbsp;<img class="img-delete" src="'+__ctxPath+'/images/system/delete.gif" alt="删除该本图书" onclick="removeBookSn(this,'+h[j][0]+","+a+')"/></div>');}}});},failure:function(b,a){}});}return e;};function removeBookSn(f,e,d){Ext.Msg.confirm("信息确认","把借阅归还记录一起删除，您确认要删除该书吗？",function(b){if(b=="yes"){var a=Ext.get(f.parentNode);a.remove();Ext.Ajax.request({url:__ctxPath+"/admin/multiDelBookSn.do",params:{ids:e},method:"post",success:function(){Ext.ux.Toast.msg("信息提示","成功删除所选记录！");Ext.Ajax.request({url:__ctxPath+"/admin/updateAmountAndLeftAmountBook.do?bookId="+d,method:"post",success:function(c){var h=Ext.util.JSON.decode(c.responseText);Ext.getCmp("amount").setValue(h.data.amount);Ext.getCmp("leftAmount").setValue(h.data.leftAmount);}});}});}});}