Ext.DataView.LabelEditor=Ext.extend(Ext.Editor,{alignment:"tl-tl",hideEl:false,cls:"x-small-editor",shim:false,completeOnEnter:true,cancelOnEsc:true,labelSelector:"div.thumb-wrap",constructor:function(d,c){Ext.DataView.LabelEditor.superclass.constructor.call(this,c||new Ext.form.TextArea({allowBlank:false,growMin:90,growMax:240,grow:true,selectOnFocus:true}),d);},init:function(b){this.view=b;b.on("afterrender",this.initEditor,this);this.on("complete",this.onSave,this);},initEditor:function(){this.view.on({scope:this,containerclick:this.doBlur,click:this.doBlur});var b=this.view.getEl();b.on("dblclick",this.onMouseDown,this,{delegate:this.labelSelector});},doBlur:function(){if(this.editing){this.field.blur();}},onMouseDown:function(l,m){if(!l.ctrlKey&&!l.shiftKey){var n=this.view.findItemFromChild(m);l.stopEvent();var k=this.view.indexOf(n);var e=this.view.store.getAt(k);this.startEdit(m,e.data[this.dataIndex]);var j=n.scrollHeight;var o=n.scrollWidth;if(Ext.isIE){o=o+2;if(Ext.isIE6||Ext.isIE7){var p=n.parentNode;j=p.scrollHeight;}else{j=j+2;}}this.setSize(o,j);this.activeRecord=e;}else{l.preventDefault();}},onSave:function(d,c){this.activeRecord.set(this.dataIndex,c);this.view.store.fireEvent("recordchange",this.view.store);}});Ext.ns("PersonalTipsView");PersonalTipsView=Ext.extend(Ext.Panel,{maxLevel:1,topbar:null,dataView:null,store:null,curRecord:null,curLevel:null,constructor:function(b){Ext.applyIf(this,b);this.initUI();PersonalTipsView.superclass.constructor.call(this,{id:"PersonalTipsView",title:"个人便签",iconCls:"tipsTile",layout:"fit",tbar:this.topbar,autoScroll:false,items:[this.dataView]});},initUI:function(){this.store=new Ext.data.JsonStore({url:__ctxPath+"/info/listAppTips.do",root:"result",totalProperty:"totalCounts",remoteSort:true,fields:[{name:"tipsId",type:"int"},"userId","tipsName","content","disheight","diswidth","disleft","distop","dislevel","createTime"]});this.store.setDefaultSort("tipsId","asc");this.store.load({params:{start:0,limit:1000}});this.store.on("load",this.loadAction,this);this.store.on("recordchange",this.recordChange,this);this.dataView=new Ext.DataView({id:"dataView",autoScroll:false,store:this.store,itemSelector:"div.thumb-wrap",multiSelect:false,singleSelect:true,overClass:"setDiv",plugins:[new Ext.DataView.LabelEditor({dataIndex:"content"})],tpl:new Ext.XTemplate('<div id="basicDiv" style="width:100%;overflow:hidden;height:100%;">','<div id="inputDiv" style="position: absolute;width:100%;height:100%;"></div>','<tpl for=".">','<div id={tipsName} class="thumb-wrap tipDiv" style="width:{diswidth}px;height:{disheight}px;left:{disleft}px;top:{distop}px;z-index:{dislevel};"><span id={tipsName}a class="x-linkdel"><button class="tipsClose" value="" onclick="PersonalTipsView.deleteTips({tipsId},\'{tipsName}\');" title="删除"></button></span><span class="x-editable">{content}</span><span class="x-timelabel">{createTime}</span></div>',"</tpl>","</div>"),scope:this,emptyText:'<div id="basicDiv" style="width:100%;overflow:hidden;height:100%;"><div id="inputDiv" style="position: absolute;width:100%;height:100%;"></div></div>',listeners:{scope:this,"afterrender":{fn:this.bodyRender,scope:this},"mouseenter":{fn:this.mouseenter,scope:this},"mouseleave":{fn:this.mouseleave,scope:this},"click":{fn:this.clickView,scope:this}}});this.topbar=new Ext.Toolbar({items:['<font color="red">提示：在空白面板双击输入！</font>',"->",{xtype:"button",text:"一键清除",iconCls:"btn-delete",scope:this,handler:function(){if(this.store.getCount()>0){PersonalTipsView.deleteTips("all");}else{Ext.ux.Toast.msg("信息","没有记录可删除!");}}}]});},loadAction:function(e){if(e.getCount()>0){for(var d=0;d<e.getCount();d++){var f=e.getAt(d).get("tipsName");this.resizable(f);}}},recordChange:function(b){this.saveRecord(b);},saveAction:function(b){this.saveRecord(b);},bodyContextClick:function(p,e,q){if(!p.ctrlKey&&!p.shiftKey){var r=Ext.get("basicDiv");var k=this.getInputCmp();var l=this.dataView.findItemFromChild(e);if(l==null){var n=p.getPageX();var o=p.getPageY();k.setStyle("top",p.getPageY()-r.getTop()+"px");k.setStyle("left",p.getPageX()-r.getLeft()+"px");var m=new Ext.DataView.LabelEditor();m.setSize(200,100);m.on("complete",function(b,a){if(l==null){var g=b.el.getBox();var f={tipsId:-1,tipsName:"tips"+new Date().format("YmdHisu"),content:a,diswidth:g.width,disheight:g.height,disleft:n-r.getLeft(),distop:o-r.getTop(),dislevel:this.maxLevel+1,createTime:new Date().format("Y-m-d H:i:s")};var h=new this.store.recordType(f);this.store.add(h);this.dataView.refresh();if(this.store.getCount()>0){for(var c=0;c<this.store.getCount();c++){var d=this.store.getAt(c).get("tipsName");this.resizable(d);}}this.store.fireEvent("recordchange",this.store);}},this);m.startEdit(e,"");k.setStyle("top","0px");k.setStyle("left","0px");}}},bodyRender:function(b){b.getEl().on("dblclick",this.bodyContextClick,this);},saveRecord:function(f){var h=[];for(var j=0;j<f.getCount();j++){var g=f.getAt(j);var i=g.data.tipsId;if(g.dirty||i==-1){if(i>0){g.set("tipsId",-2);}h.push(g.data);g.dirty=false;}}if(h.length==0){return;}Ext.Ajax.request({method:"post",url:__ctxPath+"/info/saveAppTips.do",success:function(b){for(var c=0;c<f.getCount();c++){var d=f.getAt(c);var a=d.data.tipsId;if(a==-1){d.set("tipsId",-2);d.dirty=false;}}},failure:function(a){f.reload({params:{start:0,limit:1000}});Ext.MessageBox.show({title:"操作信息",msg:"信息保存出错，请联系管理员！",buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});},params:{data:Ext.encode(h)}});},getInputCmp:function(){return Ext.get("inputDiv");},resizable:function(c){var d=new Ext.Resizable(c,{wrap:true,pinned:false,dynamic:true,minWidth:200,minHeight:100,draggable:true});d.el.setStyle("position","absolute");d.on("resize",this.resizeAction,this);},resizeAction:function(n,p,e,l){var q=Ext.get("basicDiv");var r=n.el.getBox();var k=n.resizeChild.id;var m=this.dataView.indexOf(k);var o=this.dataView.store.getAt(m);o.set("disleft",r.x-q.getLeft());o.set("distop",r.y-q.getTop());o.set("diswidth",p-3);o.set("disheight",e-3);this.store.fireEvent("recordchange",this.store);},clickView:function(n,m,l,k){var j=l.id;var e=Ext.get(j+"-rzwrap");var i=n.store.getAt(m);this.maxLevel=this.maxLevel+1;e.setStyle("z-index",this.maxLevel);this.curRecord=i;this.curLevel=this.maxLevel;},mouseenter:function(h,e,k,j){var i=k.id;var l=Ext.get(i+"a");l.setStyle("visibility","visible");},mouseleave:function(t,r,x,q){if(this.curLevel!=null&&this.curRecord!=null){var s=this.curRecord;var B=this.curLevel;s.set("dislevel",B);this.curLevel=null;this.curRecord=null;}var A=Ext.get("basicDiv");var e=x.id;var z=Ext.get(e+"a");if(z){z.setStyle("visibility","hidden");var u=Ext.get(e+"-rzwrap").getBox();var r=t.indexOf(e);var s=t.store.getAt(r);var y=u.x-A.getLeft();var p=u.y-A.getTop();var w=s.data.disleft;var v=s.data.distop;if((y!=w)&&(p!=v)){s.set("disleft",u.x-A.getLeft());s.set("distop",u.y-A.getTop());this.store.fireEvent("recordchange",this.store);}}}});PersonalTipsView.deleteTips=function(f,e){var d="您确认要删除所选记录吗？";if("all"==f){d="您确认要清除所有便签吗?";}Ext.Msg.confirm("信息确认",d,function(a){if(a=="yes"){Ext.Ajax.request({url:__ctxPath+"/info/multiDelAppTips.do",params:{ids:f,names:e},method:"POST",success:function(j,b){Ext.ux.Toast.msg("操作信息","成功删除便签！");if(f!="all"){var k=Ext.getCmp("dataView");var c=k.indexOf(e);var l=Ext.get(e+"-rzwrap");Ext.destroy(l);k.store.removeAt(c);return;}Ext.getCmp("PersonalTipsView").store.reload({params:{start:0,limit:1000}});},failure:function(c,b){Ext.ux.Toast.msg("操作信息","操作出错，请联系管理员！");}});}});};