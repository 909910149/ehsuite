var dialog=window.parent;var oEditor=dialog.InnerDialogLoaded();var FCK=oEditor.FCK;var FCKLang=oEditor.FCKLang;var FCKConfig=oEditor.FCKConfig;var FCKRegexLib=oEditor.FCKRegexLib;var FCKTools=oEditor.FCKTools;dialog.AddTab("Info",FCKLang.DlgLnkInfoTab);if(!FCKConfig.LinkDlgHideTarget){dialog.AddTab("Target",FCKLang.DlgLnkTargetTab,true);}if(FCKConfig.LinkUpload){dialog.AddTab("Upload",FCKLang.DlgLnkUpload,true);}if(!FCKConfig.LinkDlgHideAdvanced){dialog.AddTab("Advanced",FCKLang.DlgAdvancedTag);}function OnDialogTabChange(b){ShowE("divInfo",(b=="Info"));ShowE("divTarget",(b=="Target"));ShowE("divUpload",(b=="Upload"));ShowE("divAttribs",(b=="Advanced"));dialog.SetAutoSize(true);}var oRegex=new Object();oRegex.UriProtocol=/^(((http|https|ftp|news):\/\/)|mailto:)/gi;oRegex.UrlOnChangeProtocol=/^(http|https|ftp|news):\/\/(?=.)/gi;oRegex.UrlOnChangeTestOther=/^((javascript:)|[#\/\.])/gi;oRegex.ReserveTarget=/^_(blank|self|top|parent)$/i;oRegex.PopupUri=/^javascript:void\(\s*window.open\(\s*'([^']+)'\s*,\s*(?:'([^']*)'|null)\s*,\s*'([^']*)'\s*\)\s*\)\s*$/;oRegex.OnClickPopup=/^\s*on[cC]lick="\s*window.open\(\s*this\.href\s*,\s*(?:'([^']*)'|null)\s*,\s*'([^']*)'\s*\)\s*;\s*return\s*false;*\s*"$/;oRegex.PopupFeatures=/(?:^|,)([^=]+)=(\d+|yes|no)/gi;var oParser=new Object();oParser.SortNumerical=function(a,b){return parseInt(a,10)-parseInt(b,10);};oParser.ParseEMailParams=function(f){var e=new Object();e.Subject="";e.Body="";var d=f.match(/(^|^\?|&)subject=([^&]+)/i);if(d){e.Subject=decodeURIComponent(d[2]);}d=f.match(/(^|^\?|&)body=([^&]+)/i);if(d){e.Body=decodeURIComponent(d[2]);}return e;};oParser.ParseEMailUri=function(sUrl){var oEMailInfo=new Object();oEMailInfo.Address="";oEMailInfo.Subject="";oEMailInfo.Body="";var aLinkInfo=sUrl.match(/^(\w+):(.*)$/);if(aLinkInfo&&aLinkInfo[1]=="mailto"){var aParts=aLinkInfo[2].match(/^([^\?]+)\??(.+)?/);if(aParts){oEMailInfo.Address=aParts[1];if(aParts[2]){var oEMailParams=oParser.ParseEMailParams(aParts[2]);oEMailInfo.Subject=oEMailParams.Subject;oEMailInfo.Body=oEMailParams.Body;}}return oEMailInfo;}else{if(aLinkInfo&&aLinkInfo[1]=="javascript"){var func=FCKConfig.EMailProtectionFunction;if(func!=null){try{func=func.replace(/([\/^$*+.?()\[\]])/g,"\\$1");var keys=new Array("NAME","DOMAIN","SUBJECT","BODY");var sFunc=func;var pos=new Array();for(var i=0;i<keys.length;i++){var rexp=new RegExp(keys[i]);var p=func.search(rexp);if(p>=0){sFunc=sFunc.replace(rexp,"'([^']*)'");pos[pos.length]=p+":"+keys[i];}}pos.sort(oParser.SortNumerical);aLinkInfo[2]=aLinkInfo[2].replace(/\\'/g,"###SINGLE_QUOTE###");var rFunc=new RegExp("^"+sFunc+"$");var aMatch=rFunc.exec(aLinkInfo[2]);if(aMatch){var aInfo=new Array();for(var i=1;i<aMatch.length;i++){var k=pos[i-1].match(/^\d+:(.+)$/);aInfo[k[1]]=aMatch[i].replace(/###SINGLE_QUOTE###/g,"'");}oEMailInfo.Address=aInfo["NAME"]+"@"+aInfo["DOMAIN"];oEMailInfo.Subject=decodeURIComponent(aInfo["SUBJECT"]);oEMailInfo.Body=decodeURIComponent(aInfo["BODY"]);return oEMailInfo;}}catch(e){}}var aMatch=aLinkInfo[2].match(/^(?:void\()?location\.href='mailto:'\+(String\.fromCharCode\([\d,]+\))\+'(.*)'\)?$/);if(aMatch){oEMailInfo.Address=eval(aMatch[1]);if(aMatch[2]){var oEMailParams=oParser.ParseEMailParams(aMatch[2]);oEMailInfo.Subject=oEMailParams.Subject;oEMailInfo.Body=oEMailParams.Body;}return oEMailInfo;}}}return false;};oParser.CreateEMailUri=function(l,m,o){switch(FCKConfig.EMailProtection){case"function":var r=FCKConfig.EMailProtectionFunction;if(r==null){if(FCKConfig.Debug){alert('EMailProtection alert!\nNo function defined. Please set "FCKConfig.EMailProtectionFunction"');}return"";}var q=l.split("@",2);if(q[1]==undefined){q[1]="";}r=r.replace(/NAME/g,"'"+q[0].replace(/'/g,"\\'")+"'");r=r.replace(/DOMAIN/g,"'"+q[1].replace(/'/g,"\\'")+"'");r=r.replace(/SUBJECT/g,"'"+encodeURIComponent(m).replace(/'/g,"\\'")+"'");r=r.replace(/BODY/g,"'"+encodeURIComponent(o).replace(/'/g,"\\'")+"'");return"javascript:"+r;case"encode":var s=[];var t=[];if(m.length>0){s.push("subject="+encodeURIComponent(m));}if(o.length>0){s.push("body="+encodeURIComponent(o));}for(var p=0;p<l.length;p++){t.push(l.charCodeAt(p));}return"javascript:void(location.href='mailto:'+String.fromCharCode("+t.join(",")+")+'?"+s.join("&")+"')";}var n="mailto:"+l;var i="";if(m.length>0){i="?subject="+encodeURIComponent(m);}if(o.length>0){i+=(i.length==0?"?":"&");i+="body="+encodeURIComponent(o);}return n+i;};var oLink=dialog.Selection.GetSelection().MoveToAncestorNode("A");if(oLink){FCK.Selection.SelectNode(oLink);}window.onload=function(){oEditor.FCKLanguageManager.TranslatePage(document);LoadAnchorNamesAndIds();LoadSelection();SetLinkType(GetE("cmbLinkType").value);GetE("divBrowseServer").style.display=FCKConfig.LinkBrowser?"":"none";GetE("divInfo").style.display="";if(FCKConfig.LinkUpload){GetE("frmUpload").action=FCKConfig.LinkUploadURL;}SetDefaultTarget();dialog.SetOkButton(true);switch(GetE("cmbLinkType").value){case"url":SelectField("txtUrl");break;case"email":SelectField("txtEMailAddress");break;case"anchor":if(GetE("divSelAnchor").style.display!="none"){SelectField("cmbAnchorName");}else{SelectField("cmbLinkType");}}};var bHasAnchors;function LoadAnchorNamesAndIds(){var h=new Array();var l;var g=oEditor.FCK.EditorDocument.getElementsByTagName("IMG");for(l=0;l<g.length;l++){if(g[l].getAttribute("_fckanchor")){h[h.length]=oEditor.FCK.GetRealElement(g[l]);}}var i=oEditor.FCK.EditorDocument.getElementsByTagName("A");for(l=0;l<i.length;l++){if(i[l].name&&(i[l].name.length>0)){h[h.length]=i[l];}}var k=FCKTools.GetAllChildrenIds(oEditor.FCK.EditorDocument.body);bHasAnchors=(h.length>0||k.length>0);for(l=0;l<h.length;l++){var j=h[l].name;if(j&&j.length>0){FCKTools.AddSelectOption(GetE("cmbAnchorName"),j,j);}}for(l=0;l<k.length;l++){FCKTools.AddSelectOption(GetE("cmbAnchorId"),k[l],k[l]);}ShowE("divSelAnchor",bHasAnchors);ShowE("divNoAnchor",!bHasAnchors);}function LoadSelection(){if(!oLink){return;}var r="url";var m=oLink.getAttribute("_fcksavedurl");if(m==null){m=oLink.getAttribute("href",2)||"";}var k=oRegex.PopupUri.exec(m);if(k){GetE("cmbTarget").value="popup";m=k[1];FillPopupFields(k[2],k[3]);SetTarget("popup");}if(!k){var j=oLink.getAttribute("onclick_fckprotectedatt");if(j){j=decodeURIComponent(j);k=oRegex.OnClickPopup.exec(j);if(k){GetE("cmbTarget").value="popup";FillPopupFields(k[1],k[2]);SetTarget("popup");}}}var n=oRegex.UriProtocol.exec(m);var l=oParser.ParseEMailUri(m);if(l){r="email";GetE("txtEMailAddress").value=l.Address;GetE("txtEMailSubject").value=l.Subject;GetE("txtEMailBody").value=l.Body;}else{if(n){n=n[0].toLowerCase();GetE("cmbLinkProtocol").value=n;var q=m.replace(oRegex.UriProtocol,"");r="url";GetE("txtUrl").value=q;}else{if(m.substr(0,1)=="#"&&m.length>1){r="anchor";GetE("cmbAnchorName").value=GetE("cmbAnchorId").value=m.substr(1);}else{r="url";GetE("cmbLinkProtocol").value="";GetE("txtUrl").value=m;}}}if(!k){var p=oLink.target;if(p&&p.length>0){if(oRegex.ReserveTarget.test(p)){p=p.toLowerCase();GetE("cmbTarget").value=p;}else{GetE("cmbTarget").value="frame";}GetE("txtTargetFrame").value=p;}}GetE("txtAttId").value=oLink.id;GetE("txtAttName").value=oLink.name;GetE("cmbAttLangDir").value=oLink.dir;GetE("txtAttLangCode").value=oLink.lang;GetE("txtAttAccessKey").value=oLink.accessKey;GetE("txtAttTabIndex").value=oLink.tabIndex<=0?"":oLink.tabIndex;GetE("txtAttTitle").value=oLink.title;GetE("txtAttContentType").value=oLink.type;GetE("txtAttCharSet").value=oLink.charset;var o;if(oEditor.FCKBrowserInfo.IsIE){o=oLink.getAttribute("className",2)||"";o=o.replace(FCKRegexLib.FCK_Class,"");GetE("txtAttStyle").value=oLink.style.cssText;}else{o=oLink.getAttribute("class",2)||"";GetE("txtAttStyle").value=oLink.getAttribute("style",2)||"";}GetE("txtAttClasses").value=o;GetE("cmbLinkType").value=r;}function SetLinkType(b){ShowE("divLinkTypeUrl",(b=="url"));ShowE("divLinkTypeAnchor",(b=="anchor"));ShowE("divLinkTypeEMail",(b=="email"));if(!FCKConfig.LinkDlgHideTarget){dialog.SetTabVisibility("Target",(b=="url"));}if(FCKConfig.LinkUpload){dialog.SetTabVisibility("Upload",(b=="url"));}if(!FCKConfig.LinkDlgHideAdvanced){dialog.SetTabVisibility("Advanced",(b!="anchor"||bHasAnchors));}if(b=="email"){dialog.SetAutoSize(true);}}function SetTarget(b){GetE("tdTargetFrame").style.display=(b=="popup"?"none":"");GetE("tdPopupName").style.display=GetE("tablePopupFeatures").style.display=(b=="popup"?"":"none");switch(b){case"_blank":case"_self":case"_parent":case"_top":GetE("txtTargetFrame").value=b;break;case"":GetE("txtTargetFrame").value="";break;}if(b=="popup"){dialog.SetAutoSize(true);}}function OnUrlChange(){var d=GetE("txtUrl").value;var c=oRegex.UrlOnChangeProtocol.exec(d);if(c){d=d.substr(c[0].length);GetE("txtUrl").value=d;GetE("cmbLinkProtocol").value=c[0].toLowerCase();}else{if(oRegex.UrlOnChangeTestOther.test(d)){GetE("cmbLinkProtocol").value="";}}}function OnTargetNameChange(){var b=GetE("txtTargetFrame").value;if(b.length==0){GetE("cmbTarget").value="";}else{if(oRegex.ReserveTarget.test(b)){GetE("cmbTarget").value=b.toLowerCase();}else{GetE("cmbTarget").value="frame";}}}function BuildOnClickPopup(){var g="'"+GetE("txtPopupName").value.replace(/\W/gi,"")+"'";var h="";var e=document.getElementsByName("chkFeature");for(var f=0;f<e.length;f++){if(f>0){h+=",";}h+=e[f].value+"="+(e[f].checked?"yes":"no");}if(GetE("txtPopupWidth").value.length>0){h+=",width="+GetE("txtPopupWidth").value;}if(GetE("txtPopupHeight").value.length>0){h+=",height="+GetE("txtPopupHeight").value;}if(GetE("txtPopupLeft").value.length>0){h+=",left="+GetE("txtPopupLeft").value;}if(GetE("txtPopupTop").value.length>0){h+=",top="+GetE("txtPopupTop").value;}if(h!=""){h=h+",status";}return("window.open(this.href,"+g+",'"+h+"'); return false");}function FillPopupFields(h,l){if(h){GetE("txtPopupName").value=h;}var k=new Object();var i;while((i=oRegex.PopupFeatures.exec(l))!=null){var j=i[2];if(j==("yes"||"1")){k[i[1]]=true;}else{if(!isNaN(j)&&j!=0){k[i[1]]=j;}}}var m=document.getElementsByName("chkFeature");for(var n=0;n<m.length;n++){if(k[m[n].value]){m[n].checked=true;}}if(k["width"]){GetE("txtPopupWidth").value=k["width"];}if(k["height"]){GetE("txtPopupHeight").value=k["height"];}if(k["left"]){GetE("txtPopupLeft").value=k["left"];}if(k["top"]){GetE("txtPopupTop").value=k["top"];}}function Ok(){var v,n;oEditor.FCKUndo.SaveUndoStep();switch(GetE("cmbLinkType").value){case"url":v=GetE("txtUrl").value;if(v.length==0){alert(FCKLang.DlnLnkMsgNoUrl);return false;}v=GetE("cmbLinkProtocol").value+v;break;case"email":v=GetE("txtEMailAddress").value;if(v.length==0){alert(FCKLang.DlnLnkMsgNoEMail);return false;}v=oParser.CreateEMailUri(v,GetE("txtEMailSubject").value,GetE("txtEMailBody").value);break;case"anchor":var i=GetE("cmbAnchorName").value;if(i.length==0){i=GetE("cmbAnchorId").value;}if(i.length==0){alert(FCKLang.DlnLnkMsgNoAnchor);return false;}v="#"+i;break;}var p=oLink?[oLink]:oEditor.FCK.CreateLink(v,true);var r=(p.length>0);if(!r){n=v;switch(GetE("cmbLinkType").value){case"anchor":n=n.replace(/^#/,"");break;case"url":var t=GetE("txtFileName").value;if(t){n=t;break;}var q=new RegExp("//?([^?\"']+)([?].*)?$");var o=q.exec(v);if(o!=null){n=o[1];}break;case"email":n=GetE("txtEMailAddress").value;break;}p=[oEditor.FCK.InsertElement("a")];}for(var s=0;s<p.length;s++){oLink=p[s];if(r){n=oLink.innerHTML;}oLink.href=v;SetAttribute(oLink,"_fcksavedurl",v);var m;if(GetE("cmbTarget").value=="popup"){m=BuildOnClickPopup();m=encodeURIComponent(' onclick="'+m+'"');SetAttribute(oLink,"onclick_fckprotectedatt",m);}else{m=oLink.getAttribute("onclick_fckprotectedatt");if(m){m=decodeURIComponent(m);if(oRegex.OnClickPopup.test(m)){SetAttribute(oLink,"onclick_fckprotectedatt","");}}}oLink.innerHTML=n;if(GetE("cmbTarget").value!="popup"){SetAttribute(oLink,"target",GetE("txtTargetFrame").value);}else{SetAttribute(oLink,"target",null);}if(s==0){SetAttribute(oLink,"id",GetE("txtAttId").value);}SetAttribute(oLink,"name",GetE("txtAttName").value);SetAttribute(oLink,"dir",GetE("cmbAttLangDir").value);SetAttribute(oLink,"lang",GetE("txtAttLangCode").value);SetAttribute(oLink,"accesskey",GetE("txtAttAccessKey").value);SetAttribute(oLink,"tabindex",(GetE("txtAttTabIndex").value>0?GetE("txtAttTabIndex").value:null));SetAttribute(oLink,"title",GetE("txtAttTitle").value);SetAttribute(oLink,"type",GetE("txtAttContentType").value);SetAttribute(oLink,"charset",GetE("txtAttCharSet").value);if(oEditor.FCKBrowserInfo.IsIE){var u=GetE("txtAttClasses").value;if(GetE("txtAttName").value.length!=0){u+=" FCK__AnchorC";}SetAttribute(oLink,"className",u);oLink.style.cssText=GetE("txtAttStyle").value;}else{SetAttribute(oLink,"class",GetE("txtAttClasses").value);SetAttribute(oLink,"style",GetE("txtAttStyle").value);}}oEditor.FCKSelection.SelectNode(p[0]);return true;}function BrowseServer(){OpenFileBrowser(FCKConfig.LinkBrowserURL,FCKConfig.LinkBrowserWindowWidth,FCKConfig.LinkBrowserWindowHeight);}function SetUrl(d,c){GetE("txtUrl").value=d;GetE("txtFileName").value=c;OnUrlChange();dialog.SetSelectedTab("Info");}function OnUploadCompleted(h,f,g,e){window.parent.Throbber.Hide();GetE("divUpload").style.display="";switch(h){case 0:alert("Your file has been successfully uploaded");break;case 1:alert(e);return;case 101:alert(e);break;case 201:alert('A file with the same name is already available. The uploaded file has been renamed to "'+g+'"');break;case 202:alert("Invalid file type");return;case 203:alert("Security error. You probably don't have enough permissions to upload. Please check your server.");return;case 500:alert("The connector is disabled");break;default:alert("Error on file upload. Error number: "+h);return;}SetUrl(f,g);GetE("frmUpload").reset();}var oUploadAllowedExtRegex=new RegExp(FCKConfig.LinkUploadAllowedExtensions,"i");var oUploadDeniedExtRegex=new RegExp(FCKConfig.LinkUploadDeniedExtensions,"i");function CheckUpload(){var b=GetE("txtUploadFile").value;if(b.length==0){alert("Please select a file to upload");return false;}if((FCKConfig.LinkUploadAllowedExtensions.length>0&&!oUploadAllowedExtRegex.test(b))||(FCKConfig.LinkUploadDeniedExtensions.length>0&&oUploadDeniedExtRegex.test(b))){OnUploadCompleted(202);return false;}window.parent.Throbber.Show(100);GetE("divUpload").style.display="none";return true;}function SetDefaultTarget(){var b=FCKConfig.DefaultLinkTarget||"";if(oLink||b.length==0){return;}switch(b){case"_blank":case"_self":case"_parent":case"_top":GetE("cmbTarget").value=b;break;default:GetE("cmbTarget").value="frame";break;}GetE("txtTargetFrame").value=b;}