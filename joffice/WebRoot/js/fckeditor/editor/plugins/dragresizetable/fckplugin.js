var FCKDragTableHandler={"_DragState":0,"_LeftCell":null,"_RightCell":null,"_MouseMoveMode":0,"_ResizeBar":null,"_OriginalX":null,"_MinimumX":null,"_MaximumX":null,"_LastX":null,"_TableMap":null,"_doc":document,"_IsInsideNode":function(i,o,k){var m=FCKTools.GetWindowPosition(i,o);var p=m.x;var j=m.y;var l=parseInt(p,10)+parseInt(o.offsetWidth,10);var n=parseInt(j,10)+parseInt(o.offsetHeight,10);if(k.x>=p&&k.x<=l&&k.y>=j&&k.y<=n){return true;}return false;},"_GetBorderCells":function(E,j,A,D){var J=[];for(var w=0;w<j.rows.length;w++){var z=j.rows[w];for(var y=0;y<z.cells.length;y++){J.push(z.cells[y]);}}if(J.length<1){return null;}var L=null;var K=null;var F=null;var r=null;var N=null;for(var w=0;w<J.length;w++){var H=FCKTools.GetWindowPosition(E,J[w]);var I=H.x+parseInt(J[w].clientWidth,10);var i=D.x-I;var B=D.y-(H.y+(J[w].clientHeight/2));if(L==null||(Math.abs(i)<=Math.abs(L)&&(F==null||Math.abs(B)<=Math.abs(F)))){L=i;F=B;r=J[w];}}var M=r.parentNode.rowIndex;var C=FCKTableHandler._GetCellIndexSpan(A,M,r);var G=isNaN(r.colSpan)?1:r.colSpan;N=A[M][C+G];if(!N){return null;}K=D.x-FCKTools.GetWindowPosition(E,N).x;if(K<0&&L<0&&L<-2){return null;}if(K>0&&L>0&&K>3){return null;}return{"leftCell":r,"rightCell":N};},"_GetResizeBarPosition":function(){var b=FCKTools.GetElementAscensor(this._RightCell,"tr");return FCKTableHandler._GetCellIndexSpan(this._TableMap,b.rowIndex,this._RightCell);},"_ResizeBarMouseDownListener":function(o){if(FCKDragTableHandler._LeftCell){FCKDragTableHandler._MouseMoveMode=1;}if(FCKBrowserInfo.IsIE){FCKDragTableHandler._ResizeBar.filters.item("DXImageTransform.Microsoft.Alpha").opacity=50;}else{FCKDragTableHandler._ResizeBar.style.opacity=0.5;}FCKDragTableHandler._OriginalX=o.clientX;var q=FCKDragTableHandler._GetResizeBarPosition();var u=FCKDragTableHandler._GetIframeOffset();var n=FCKTools.GetElementAscensor(FCKDragTableHandler._LeftCell,"table");var w=null;var x=null;for(var z=0;z<FCKDragTableHandler._TableMap.length;z++){var p=FCKDragTableHandler._TableMap[z][q-1];var t=FCKDragTableHandler._TableMap[z][q];var r=FCKTools.GetWindowPosition(FCK.EditorWindow,p);var s=FCKTools.GetWindowPosition(FCK.EditorWindow,t);var y=FCKDragTableHandler._GetCellPadding(n,p);var v=FCKDragTableHandler._GetCellPadding(n,t);if(w==null||r.x+y>w){w=r.x+y;}if(x==null||s.x+t.clientWidth-v<x){x=s.x+t.clientWidth-v;}}FCKDragTableHandler._MinimumX=w+u.x;FCKDragTableHandler._MaximumX=x+u.x;FCKDragTableHandler._LastX=null;if(o.preventDefault){o.preventDefault();}else{o.returnValue=false;}},"_ResizeBarMouseUpListener":function(r){FCKDragTableHandler._MouseMoveMode=0;FCKDragTableHandler._HideResizeBar();if(FCKDragTableHandler._LastX==null){return;}var z=FCKDragTableHandler._LastX-FCKDragTableHandler._OriginalX;var F=FCKTools.GetElementAscensor(FCKDragTableHandler._LeftCell,"table");var c=[];var B=FCKDragTableHandler._TableMap;for(var w=0;w<B.length;w++){for(var A=0;A<B[w].length;A++){var j=B[w][A];var C=FCKDragTableHandler._GetCellWidth(F,j);var v=isNaN(j.colSpan)?1:j.colSpan;if(c.length<=A){c.push({width:C/v,colSpan:v});}else{var i=c[A];if(i.colSpan>v){i.width=C/v;i.colSpan=v;}}}}colIndex=FCKDragTableHandler._GetResizeBarPosition();colIndex--;c[colIndex].width+=z;c[colIndex+1].width-=z;for(var D=0;D<F.rows.length;D++){var E=F.rows.item(D);for(var u=0;u<E.cells.length;u++){var j=E.cells.item(u);j.width="";j.style.width="";}}var x=F.getElementsByTagName("col");for(var w=x.length-1;w>=0;w--){x[w].parentNode.removeChild(x[w]);}var y=[];for(var w=0;w<B.length;w++){for(var A=0;A<B[w].length;A++){var j=B[w][A];if(j._Processed){continue;}if(B[w][A-1]!=j){j.width=c[A].width;}else{j.width=parseInt(j.width,10)+parseInt(c[A].width,10);}if(B[w][A+1]!=j){y.push(j);j._Processed=true;}}}for(var w=0;w<y.length;w++){if(FCKBrowserInfo.IsIE){y[w].removeAttribute("_Processed");}else{delete y[w]._Processed;}}FCKDragTableHandler._LastX=null;},"_ResizeBarMouseMoveListener":function(b){if(FCKDragTableHandler._MouseMoveMode==0){return FCKDragTableHandler._MouseFindHandler(FCK,b);}else{return FCKDragTableHandler._MouseDragHandler(FCK,b);}},"_GetCellPadding":function(j,g){var h=parseInt(j.cellPadding,10)*2;var l=null;if(typeof(window.getComputedStyle)=="function"){var i=window.getComputedStyle(g,null);l=parseInt(i.getPropertyValue("padding-left"),10)+parseInt(i.getPropertyValue("padding-right"),10);}else{l=parseInt(g.currentStyle.paddingLeft,10)+parseInt(g.currentStyle.paddingRight,10);}var k=g.style.padding;if(isFinite(k)){l=parseInt(k,10)*2;}else{k=g.style.paddingLeft;if(isFinite(k)){l=parseInt(k,10);}k=g.style.paddingRight;if(isFinite(k)){l+=parseInt(k,10);}}h=parseInt(h,10);l=parseInt(l,10);if(isNaN(h)){h=0;}if(isNaN(l)){l=0;}return Math.max(h,l);},"_GetCellWidth":function(d,e){var f=e.clientWidth;if(isNaN(f)){f=0;}return f-this._GetCellPadding(d,e);},"MouseMoveListener":function(c,d){if(FCKDragTableHandler._MouseMoveMode==0){return FCKDragTableHandler._MouseFindHandler(c,d);}else{return FCKDragTableHandler._MouseDragHandler(c,d);}},"_MouseFindHandler":function(s,q){if(s.MouseDownFlag){return;}var A=q.srcElement||q.target;try{if(!A||A.nodeType!=1){this._HideResizeBar();return;}}catch(t){this._HideResizeBar();return;}var y=q.clientX;var z=q.clientY;if(FCKTools.GetElementDocument(A)==document){var w=this._GetIframeOffset();y-=w.x;z-=w.y;}if(this._ResizeBar&&this._LeftCell){var x=FCKTools.GetWindowPosition(s.EditorWindow,this._LeftCell);var u=FCKTools.GetWindowPosition(s.EditorWindow,this._RightCell);var v=y-(x.x+this._LeftCell.clientWidth);var r=y-u.x;var B=false;if(r>=0&&v<=0){B=true;}else{if(v>0&&r<=3){B=true;}else{if(r<0&&v>=-2){B=true;}}}if(B){this._ShowResizeBar(s.EditorWindow,FCKTools.GetElementAscensor(this._LeftCell,"table"),{"x":y,"y":z});return;}}var C=A.tagName.toLowerCase();if(C!="table"&&C!="td"&&C!="th"){if(this._LeftCell){this._LeftCell=this._RightCell=this._TableMap=null;}this._HideResizeBar();return;}A=FCKTools.GetElementAscensor(A,"table");var D=FCKTableHandler._CreateTableMap(A);var e=this._GetBorderCells(s.EditorWindow,A,D,{"x":y,"y":z});if(e==null){if(this._LeftCell){this._LeftCell=this._RightCell=this._TableMap=null;}this._HideResizeBar();}else{this._LeftCell=e["leftCell"];this._RightCell=e["rightCell"];this._TableMap=D;this._ShowResizeBar(s.EditorWindow,FCKTools.GetElementAscensor(this._LeftCell,"table"),{"x":y,"y":z});}},"_MouseDragHandler":function(i,h){var l={"x":h.clientX,"y":h.clientY};var k=h.srcElement||h.target;if(FCKTools.GetElementDocument(k)==i.EditorDocument){var j=this._GetIframeOffset();l.x+=j.x;l.y+=j.y;}if(l.x>=this._MaximumX-5){l.x=this._MaximumX-5;}if(l.x<=this._MinimumX+5){l.x=this._MinimumX+5;}var g=l.x+FCKTools.GetScrollPosition(window).X;this._ResizeBar.style.left=(g-this._ResizeBar.offsetWidth/2)+"px";this._LastX=l.x;},"_ShowResizeBar":function(t,q,x){if(this._ResizeBar==null){this._ResizeBar=this._doc.createElement("div");var u=this._ResizeBar;var C={"position":"absolute","cursor":"e-resize"};if(FCKBrowserInfo.IsIE){C.filter="progid:DXImageTransform.Microsoft.Alpha(opacity=10,enabled=true)";}else{C.opacity=0.1;}FCKDomTools.SetElementStyles(u,C);this._avoidStyles(u);u.setAttribute("_fcktemp",true);this._doc.body.appendChild(u);FCKTools.AddEventListener(u,"mousemove",this._ResizeBarMouseMoveListener);FCKTools.AddEventListener(u,"mousedown",this._ResizeBarMouseDownListener);FCKTools.AddEventListener(document,"mouseup",this._ResizeBarMouseUpListener);FCKTools.AddEventListener(FCK.EditorDocument,"mouseup",this._ResizeBarMouseUpListener);var A=this._doc.createElement("img");A.setAttribute("_fcktemp",true);A.border=0;A.src=FCKConfig.BasePath+"images/spacer.gif";A.style.position="absolute";u.appendChild(A);var z=function(a){if(a.preventDefault){a.preventDefault();}else{a.returnValue=false;}};FCKTools.AddEventListener(A,"dragstart",z);FCKTools.AddEventListener(A,"selectstart",z);}var u=this._ResizeBar;var B=this._GetIframeOffset();var s=this._GetTablePosition(t,q);var r=q.offsetHeight;var w=B.y+s.y;if(s.y<0){r+=s.y;w-=s.y;}var v=parseInt(q.border,10);if(isNaN(v)){v=0;}var y=parseInt(q.cellSpacing,10);if(isNaN(y)){y=0;}var p=Math.max(v+100,y+100);var C={"top":w+"px","height":r+"px","width":p+"px","left":(B.x+x.x+FCKTools.GetScrollPosition(t).X-p/2)+"px"};if(FCKBrowserInfo.IsIE){u.filters.item("DXImageTransform.Microsoft.Alpha").opacity=10;}else{C.opacity=0.1;}FCKDomTools.SetElementStyles(u,C);var A=u.getElementsByTagName("img")[0];FCKDomTools.SetElementStyles(A,{width:u.offsetWidth+"px",height:r+"px"});p=Math.max(v,y,3);var D=null;if(u.getElementsByTagName("div").length<1){D=this._doc.createElement("div");this._avoidStyles(D);D.setAttribute("_fcktemp",true);u.appendChild(D);}else{D=u.getElementsByTagName("div")[0];}FCKDomTools.SetElementStyles(D,{position:"absolute",backgroundColor:"blue",width:p+"px",height:r+"px",left:"50px",top:"0px"});},"_HideResizeBar":function(){if(this._ResizeBar){FCKDomTools.SetElementStyles(this._ResizeBar,{top:"-100000px",left:"-100000px"});}},"_GetIframeOffset":function(){return FCKTools.GetDocumentPosition(window,FCK.EditingArea.IFrame);},"_GetTablePosition":function(d,c){return FCKTools.GetWindowPosition(d,c);},"_avoidStyles":function(b){FCKDomTools.SetElementStyles(b,{padding:"0",backgroundImage:"none",border:"0"});},"Reset":function(){FCKDragTableHandler._LeftCell=FCKDragTableHandler._RightCell=FCKDragTableHandler._TableMap=null;}};FCK.Events.AttachEvent("OnMouseMove",FCKDragTableHandler.MouseMoveListener);FCK.Events.AttachEvent("OnAfterSetHTML",FCKDragTableHandler.Reset);