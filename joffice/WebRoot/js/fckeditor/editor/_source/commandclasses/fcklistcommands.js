var FCKListCommand=function(d,c){this.Name=d;this.TagName=c;};FCKListCommand.prototype={GetState:function(){if(FCK.EditMode!=FCK_EDITMODE_WYSIWYG||!FCK.EditorWindow){return FCK_TRISTATE_DISABLED;}var c=FCKSelection.GetBoundaryParentElement(true);var d=c;while(d){if(d.nodeName.IEquals(["ul","ol"])){break;}d=d.parentNode;}if(d&&d.nodeName.IEquals(this.TagName)){return FCK_TRISTATE_ON;}else{return FCK_TRISTATE_OFF;}},Execute:function(){FCKUndo.SaveUndoStep();var i=FCK.EditorDocument;var K=new FCKDomRange(FCK.EditorWindow);K.MoveToSelection();var T=this.GetState();if(T==FCK_TRISTATE_OFF){FCKDomTools.TrimNode(i.body);if(!i.body.firstChild){var z=i.createElement("p");i.body.appendChild(z);K.MoveToNodeContents(z);}}var N=K.CreateBookmark();var A=[];var D={};var H=new FCKDomRangeIterator(K);var L;H.ForceBrBreak=(T==FCK_TRISTATE_OFF);var B=true;var M=null;while(B){while((L=H.GetNextParagraph())){var I=new FCKElementPath(L);var S=null;var O=false;var R=I.BlockLimit;for(var C=I.Elements.length-1;C>=0;C--){var V=I.Elements[C];if(V.nodeName.IEquals(["ol","ul"])){if(R._FCK_ListGroupObject){R._FCK_ListGroupObject=null;}var P=V._FCK_ListGroupObject;if(P){P.contents.push(L);}else{P={"root":V,"contents":[L]};A.push(P);FCKDomTools.SetElementMarker(D,V,"_FCK_ListGroupObject",P);}O=true;break;}}if(O){continue;}var F=R;if(F._FCK_ListGroupObject){F._FCK_ListGroupObject.contents.push(L);}else{var P={"root":F,"contents":[L]};FCKDomTools.SetElementMarker(D,F,"_FCK_ListGroupObject",P);A.push(P);}}if(FCKBrowserInfo.IsIE){B=false;}else{if(M==null){M=[];var E=FCKSelection.GetSelection();if(E&&A.length==0){M.push(E.getRangeAt(0));}for(var C=1;E&&C<E.rangeCount;C++){M.push(E.getRangeAt(C));}}if(M.length<1){B=false;}else{var J=FCKW3CRange.CreateFromRange(i,M.shift());K._Range=J;K._UpdateElementInfo();if(K.StartNode.nodeName.IEquals("td")){K.SetStart(K.StartNode,1);}if(K.EndNode.nodeName.IEquals("td")){K.SetEnd(K.EndNode,2);}H=new FCKDomRangeIterator(K);H.ForceBrBreak=(T==FCK_TRISTATE_OFF);}}}var Q=[];while(A.length>0){var P=A.shift();if(T==FCK_TRISTATE_OFF){if(P.root.nodeName.IEquals(["ul","ol"])){this._ChangeListType(P,D,Q);}else{this._CreateList(P,Q);}}else{if(T==FCK_TRISTATE_ON&&P.root.nodeName.IEquals(["ul","ol"])){this._RemoveList(P,D);}}}for(var C=0;C<Q.length;C++){var S=Q[C];var G=false;var U=S;while(!G){U=U.nextSibling;if(U&&U.nodeType==3&&U.nodeValue.search(/^[\n\r\t ]*$/)==0){continue;}G=true;}if(U&&U.nodeName.IEquals(this.TagName)){U.parentNode.removeChild(U);while(U.firstChild){S.appendChild(U.removeChild(U.firstChild));}}G=false;U=S;while(!G){U=U.previousSibling;if(U&&U.nodeType==3&&U.nodeValue.search(/^[\n\r\t ]*$/)==0){continue;}G=true;}if(U&&U.nodeName.IEquals(this.TagName)){U.parentNode.removeChild(U);while(U.lastChild){S.insertBefore(U.removeChild(U.lastChild),S.firstChild);}}}FCKDomTools.ClearAllMarkers(D);K.MoveToBookmark(N);K.Select();FCK.Focus();FCK.Events.FireEvent("OnSelectionChange");},_ChangeListType:function(m,p,i){var q=FCKDomTools.ListToArray(m.root,p);var l=[];for(var n=0;n<m.contents.length;n++){var s=m.contents[n];s=FCKTools.GetElementAscensor(s,"li");if(!s||s._FCK_ListItem_Processed){continue;}l.push(s);FCKDomTools.SetElementMarker(p,s,"_FCK_ListItem_Processed",true);}var o=FCKTools.GetElementDocument(m.root).createElement(this.TagName);for(var n=0;n<l.length;n++){var r=l[n]._FCK_ListArray_Index;q[r].parent=o;}var t=FCKDomTools.ArrayToList(q,p);for(var n=0;n<t.listNode.childNodes.length;n++){if(t.listNode.childNodes[n].nodeName.IEquals(this.TagName)){i.push(t.listNode.childNodes[n]);}}m.root.parentNode.replaceChild(t.listNode,m.root);},_CreateList:function(s,i){var y=s.contents;var q=FCKTools.GetElementDocument(s.root);var r=[];if(y.length==1&&y[0]==s.root){var u=q.createElement("div");while(y[0].firstChild){u.appendChild(y[0].removeChild(y[0].firstChild));}y[0].appendChild(u);y[0]=u;}var w=s.contents[0].parentNode;for(var t=0;t<y.length;t++){w=FCKDomTools.GetCommonParents(w,y[t].parentNode).pop();}for(var t=0;t<y.length;t++){var v=y[t];while(v.parentNode){if(v.parentNode==w){r.push(v);break;}v=v.parentNode;}}if(r.length<1){return;}var A=r[r.length-1].nextSibling;var x=q.createElement(this.TagName);i.push(x);while(r.length){var z=r.shift();var p=q.createDocumentFragment();while(z.firstChild){p.appendChild(z.removeChild(z.firstChild));}z.parentNode.removeChild(z);var B=q.createElement("li");B.appendChild(p);x.appendChild(B);}w.insertBefore(x,A);},_RemoveList:function(o,q){var r=FCKDomTools.ListToArray(o.root,q);var i=[];for(var p=0;p<o.contents.length;p++){var u=o.contents[p];u=FCKTools.GetElementAscensor(u,"li");if(!u||u._FCK_ListItem_Processed){continue;}i.push(u);FCKDomTools.SetElementMarker(q,u,"_FCK_ListItem_Processed",true);}var n=null;for(var p=0;p<i.length;p++){var s=i[p]._FCK_ListArray_Index;r[s].indent=-1;n=s;}for(var p=n+1;p<r.length;p++){if(r[p].indent>r[p-1].indent+1){var m=r[p-1].indent+1-r[p].indent;var t=r[p].indent;while(r[p]&&r[p].indent>=t){r[p].indent+=m;p++;}p--;}}var v=FCKDomTools.ArrayToList(r,q);if(o.root.nextSibling==null||o.root.nextSibling.nodeName.IEquals("br")){if(v.listNode.lastChild.nodeName.IEquals("br")){v.listNode.removeChild(v.listNode.lastChild);}}o.root.parentNode.replaceChild(v.listNode,o.root);}};