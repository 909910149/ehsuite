var FCKDomRange=function(b){this.Window=b;this._Cache={};};FCKDomRange.prototype={_UpdateElementInfo:function(){var h=this._Range;if(!h){this.Release(true);}else{var i=h.startContainer;var j=new FCKElementPath(i);this.StartNode=i.nodeType==3?i:i.childNodes[h.startOffset];this.StartContainer=i;this.StartBlock=j.Block;this.StartBlockLimit=j.BlockLimit;if(h.collapsed){this.EndNode=this.StartNode;this.EndContainer=this.StartContainer;this.EndBlock=this.StartBlock;this.EndBlockLimit=this.StartBlockLimit;}else{var f=h.endContainer;if(i!=f){j=new FCKElementPath(f);}var g=f;if(h.endOffset==0){while(g&&!g.previousSibling){g=g.parentNode;}if(g){g=g.previousSibling;}}else{if(g.nodeType==1){g=g.childNodes[h.endOffset-1];}}this.EndNode=g;this.EndContainer=f;this.EndBlock=j.Block;this.EndBlockLimit=j.BlockLimit;}}this._Cache={};},CreateRange:function(){return new FCKW3CRange(this.Window.document);},DeleteContents:function(){if(this._Range){this._Range.deleteContents();this._UpdateElementInfo();}},ExtractContents:function(){if(this._Range){var b=this._Range.extractContents();this._UpdateElementInfo();return b;}return null;},CheckIsCollapsed:function(){if(this._Range){return this._Range.collapsed;}return false;},Collapse:function(b){if(this._Range){this._Range.collapse(b);}this._UpdateElementInfo();},Clone:function(){var b=FCKTools.CloneObject(this);if(this._Range){b._Range=this._Range.cloneRange();}return b;},MoveToNodeContents:function(b){if(!this._Range){this._Range=this.CreateRange();}this._Range.selectNodeContents(b);this._UpdateElementInfo();},MoveToElementStart:function(b){this.SetStart(b,1);this.SetEnd(b,1);},MoveToElementEditStart:function(d){var c;while(d&&d.nodeType==1){if(FCKDomTools.CheckIsEditable(d)){c=d;}else{if(c){break;}}d=d.firstChild;}if(c){this.MoveToElementStart(c);}},InsertNode:function(b){if(this._Range){this._Range.insertNode(b);}},CheckIsEmpty:function(){if(this.CheckIsCollapsed()){return true;}var b=this.Window.document.createElement("div");this._Range.cloneContents().AppendTo(b);FCKDomTools.TrimNode(b);return(b.innerHTML.length==0);},CheckStartOfBlock:function(){var m=this._Cache;var n=m.IsStartOfBlock;if(n!=undefined){return n;}var j=this.StartBlock||this.StartBlockLimit;var h=this._Range.startContainer;var k=this._Range.startOffset;var l;if(k>0){if(h.nodeType==3){var i=h.nodeValue.substr(0,k).Trim();if(i.length!=0){return m.IsStartOfBlock=false;}}else{l=h.childNodes[k-1];}}if(!l){l=FCKDomTools.GetPreviousSourceNode(h,true,null,j);}while(l){switch(l.nodeType){case 1:if(!FCKListsLib.InlineChildReqElements[l.nodeName.toLowerCase()]){return m.IsStartOfBlock=false;}break;case 3:if(l.nodeValue.Trim().length>0){return m.IsStartOfBlock=false;}}l=FCKDomTools.GetPreviousSourceNode(l,false,null,j);}return m.IsStartOfBlock=true;},CheckEndOfBlock:function(j){var q=this._Cache.IsEndOfBlock;if(q!=undefined){return q;}var o=this.EndBlock||this.EndBlockLimit;var r=this._Range.endContainer;var m=this._Range.endOffset;var p;if(r.nodeType==3){var n=r.nodeValue;if(m<n.length){n=n.substr(m);if(n.Trim().length!=0){return this._Cache.IsEndOfBlock=false;}}}else{p=r.childNodes[m];}if(!p){p=FCKDomTools.GetNextSourceNode(r,true,null,o);}var l=false;while(p){switch(p.nodeType){case 1:var k=p.nodeName.toLowerCase();if(FCKListsLib.InlineChildReqElements[k]){break;}if(k=="br"&&!l){l=true;break;}return this._Cache.IsEndOfBlock=false;case 3:if(p.nodeValue.Trim().length>0){return this._Cache.IsEndOfBlock=false;}}p=FCKDomTools.GetNextSourceNode(p,false,null,o);}if(j){this.Select();}return this._Cache.IsEndOfBlock=true;},CreateBookmark:function(j){var i={StartId:(new Date()).valueOf()+Math.floor(Math.random()*1000)+"S",EndId:(new Date()).valueOf()+Math.floor(Math.random()*1000)+"E"};var g=this.Window.document;var k;var h;var l;if(!this.CheckIsCollapsed()){h=g.createElement("span");h.style.display="none";h.id=i.EndId;h.setAttribute("_fck_bookmark",true);h.innerHTML="&nbsp;";l=this.Clone();l.Collapse(false);l.InsertNode(h);}k=g.createElement("span");k.style.display="none";k.id=i.StartId;k.setAttribute("_fck_bookmark",true);k.innerHTML="&nbsp;";l=this.Clone();l.Collapse(true);l.InsertNode(k);if(j){i.StartNode=k;i.EndNode=h;}if(h){this.SetStart(k,4);this.SetEnd(h,3);}else{this.MoveToPosition(k,4);}return i;},GetBookmarkNode:function(e,f){var d=this.Window.document;if(f){return e.StartNode||d.getElementById(e.StartId);}else{return e.EndNode||d.getElementById(e.EndId);}},MoveToBookmark:function(h,e){var g=this.GetBookmarkNode(h,true);var f=this.GetBookmarkNode(h,false);this.SetStart(g,3);if(!e){FCKDomTools.RemoveNode(g);}if(f){this.SetEnd(f,3);if(!e){FCKDomTools.RemoveNode(f);}}else{this.Collapse(true);}this._UpdateElementInfo();},CreateBookmark2:function(){if(!this._Range){return{"Start":0,"End":0};}var m={"Start":[this._Range.startOffset],"End":[this._Range.endOffset]};var i=this._Range.startContainer.previousSibling;var k=this._Range.endContainer.previousSibling;var l=this._Range.startContainer;var h=this._Range.endContainer;while(i&&i.nodeType==3&&l.nodeType==3){m.Start[0]+=i.length;l=i;i=i.previousSibling;}while(k&&k.nodeType==3&&h.nodeType==3){m.End[0]+=k.length;h=k;k=k.previousSibling;}if(l.nodeType==1&&l.childNodes[m.Start[0]]&&l.childNodes[m.Start[0]].nodeType==3){var n=l.childNodes[m.Start[0]];var j=0;while(n.previousSibling&&n.previousSibling.nodeType==3){n=n.previousSibling;j+=n.length;}l=n;m.Start[0]=j;}if(h.nodeType==1&&h.childNodes[m.End[0]]&&h.childNodes[m.End[0]].nodeType==3){var n=h.childNodes[m.End[0]];var j=0;while(n.previousSibling&&n.previousSibling.nodeType==3){n=n.previousSibling;j+=n.length;}h=n;m.End[0]=j;}m.Start=FCKDomTools.GetNodeAddress(l,true).concat(m.Start);m.End=FCKDomTools.GetNodeAddress(h,true).concat(m.End);return m;},MoveToBookmark2:function(i){var f=FCKDomTools.GetNodeFromAddress(this.Window.document,i.Start.slice(0,-1),true);var h=FCKDomTools.GetNodeFromAddress(this.Window.document,i.End.slice(0,-1),true);this.Release(true);this._Range=new FCKW3CRange(this.Window.document);var g=i.Start[i.Start.length-1];var j=i.End[i.End.length-1];while(f.nodeType==3&&g>f.length){if(!f.nextSibling||f.nextSibling.nodeType!=3){break;}g-=f.length;f=f.nextSibling;}while(h.nodeType==3&&j>h.length){if(!h.nextSibling||h.nextSibling.nodeType!=3){break;}j-=h.length;h=h.nextSibling;}this._Range.setStart(f,g);this._Range.setEnd(h,j);this._UpdateElementInfo();},MoveToPosition:function(c,d){this.SetStart(c,d);this.Collapse(true);},SetStart:function(h,f,e){var g=this._Range;if(!g){g=this._Range=this.CreateRange();}switch(f){case 1:g.setStart(h,0);break;case 2:g.setStart(h,h.childNodes.length);break;case 3:g.setStartBefore(h);break;case 4:g.setStartAfter(h);}if(!e){this._UpdateElementInfo();}},SetEnd:function(h,f,e){var g=this._Range;if(!g){g=this._Range=this.CreateRange();}switch(f){case 1:g.setEnd(h,0);break;case 2:g.setEnd(h,h.childNodes.length);break;case 3:g.setEndBefore(h);break;case 4:g.setEndAfter(h);}if(!e){this._UpdateElementInfo();}},Expand:function(l){var i,h;switch(l){case"inline_elements":if(this._Range.startOffset==0){i=this._Range.startContainer;if(i.nodeType!=1){i=i.previousSibling?null:i.parentNode;}if(i){while(FCKListsLib.InlineNonEmptyElements[i.nodeName.toLowerCase()]){this._Range.setStartBefore(i);if(i!=i.parentNode.firstChild){break;}i=i.parentNode;}}}i=this._Range.endContainer;var j=this._Range.endOffset;if((i.nodeType==3&&j>=i.nodeValue.length)||(i.nodeType==1&&j>=i.childNodes.length)||(i.nodeType!=1&&i.nodeType!=3)){if(i.nodeType!=1){i=i.nextSibling?null:i.parentNode;}if(i){while(FCKListsLib.InlineNonEmptyElements[i.nodeName.toLowerCase()]){this._Range.setEndAfter(i);if(i!=i.parentNode.lastChild){break;}i=i.parentNode;}}}break;case"block_contents":case"list_contents":var k=FCKListsLib.BlockBoundaries;if(l=="list_contents"||FCKConfig.EnterMode=="br"){k=FCKListsLib.ListBoundaries;}if(this.StartBlock&&FCKConfig.EnterMode!="br"&&l=="block_contents"){this.SetStart(this.StartBlock,1);}else{i=this._Range.startContainer;if(i.nodeType==1){var g=i.childNodes[this._Range.startOffset];if(g){i=FCKDomTools.GetPreviousSourceNode(g,true);}else{i=i.lastChild||i;}}while(i&&(i.nodeType!=1||(i!=this.StartBlockLimit&&!k[i.nodeName.toLowerCase()]))){this._Range.setStartBefore(i);i=i.previousSibling||i.parentNode;}}if(this.EndBlock&&FCKConfig.EnterMode!="br"&&l=="block_contents"&&this.EndBlock.nodeName.toLowerCase()!="li"){this.SetEnd(this.EndBlock,2);}else{i=this._Range.endContainer;if(i.nodeType==1){i=i.childNodes[this._Range.endOffset]||i.lastChild;}while(i&&(i.nodeType!=1||(i!=this.StartBlockLimit&&!k[i.nodeName.toLowerCase()]))){this._Range.setEndAfter(i);i=i.nextSibling||i.parentNode;}if(i&&i.nodeName.toLowerCase()=="br"){this._Range.setEndAfter(i);}}this._UpdateElementInfo();}},SplitBlock:function(n){var k=n||FCKConfig.EnterMode;if(!this._Range){this.MoveToSelection();}if(this.StartBlockLimit==this.EndBlockLimit){var o=this.StartBlock;var j=this.EndBlock;var p=null;if(k!="br"){if(!o){o=this.FixBlock(true,k);j=this.EndBlock;}if(!j){j=this.FixBlock(false,k);}}var i=(o!=null&&this.CheckStartOfBlock());var m=(j!=null&&this.CheckEndOfBlock());if(!this.CheckIsEmpty()){this.DeleteContents();}if(o&&j&&o==j){if(m){p=new FCKElementPath(this.StartContainer);this.MoveToPosition(j,4);j=null;}else{if(i){p=new FCKElementPath(this.StartContainer);this.MoveToPosition(o,3);o=null;}else{this.SetEnd(o,2);var l=this.ExtractContents();j=o.cloneNode(false);j.removeAttribute("id",false);l.AppendTo(j);FCKDomTools.InsertAfterNode(o,j);this.MoveToPosition(o,4);if(FCKBrowserInfo.IsGecko&&!o.nodeName.IEquals(["ul","ol"])){FCKTools.AppendBogusBr(o);}}}}return{PreviousBlock:o,NextBlock:j,WasStartOfBlock:i,WasEndOfBlock:m,ElementPath:p};}return null;},FixBlock:function(f,g){var h=this.CreateBookmark();this.Collapse(f);this.Expand("block_contents");var e=this.Window.document.createElement(g);this.ExtractContents().AppendTo(e);FCKDomTools.TrimNode(e);if(FCKDomTools.CheckIsEmptyElement(e,function(a){return a.getAttribute("_fck_bookmark")!="true";})&&FCKBrowserInfo.IsGeckoLike){FCKTools.AppendBogusBr(e);}this.InsertNode(e);this.MoveToBookmark(h);return e;},Release:function(b){if(!b){this.Window=null;}this.StartNode=null;this.StartContainer=null;this.StartBlock=null;this.StartBlockLimit=null;this.EndNode=null;this.EndContainer=null;this.EndBlock=null;this.EndBlockLimit=null;this._Range=null;this._Cache=null;},CheckHasRange:function(){return !!this._Range;},GetTouchedStartNode:function(){var c=this._Range;var d=c.startContainer;if(c.collapsed||d.nodeType!=1){return d;}return d.childNodes[c.startOffset]||d;},GetTouchedEndNode:function(){var c=this._Range;var d=c.endContainer;if(c.collapsed||d.nodeType!=1){return d;}return d.childNodes[c.endOffset-1]||d;}};