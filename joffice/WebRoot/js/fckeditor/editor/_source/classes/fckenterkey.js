var FCKEnterKey=function(f,g,h,j){this.Window=f;this.EnterMode=g||"p";this.ShiftEnterMode=h||"br";var i=new FCKKeystrokeHandler(false);i._EnterKey=this;i.OnKeystroke=FCKEnterKey_OnKeystroke;i.SetKeystrokes([[13,"Enter"],[SHIFT+13,"ShiftEnter"],[8,"Backspace"],[CTRL+8,"CtrlBackspace"],[46,"Delete"]]);this.TabText="";if(j>0||FCKBrowserInfo.IsSafari){while(j--){this.TabText+="\xa0";}i.SetKeystrokes([9,"Tab"]);}i.AttachToElement(f.document);};function FCKEnterKey_OnKeystroke(f,g){var e=this._EnterKey;try{switch(g){case"Enter":return e.DoEnter();break;case"ShiftEnter":return e.DoShiftEnter();break;case"Backspace":return e.DoBackspace();break;case"Delete":return e.DoDelete();break;case"Tab":return e.DoTab();break;case"CtrlBackspace":return e.DoCtrlBackspace();break;}}catch(h){}return false;}FCKEnterKey.prototype.DoEnter=function(h,i){FCKUndo.SaveUndoStep();this._HasShift=(i===true);var g=FCKSelection.GetParentElement();var f=new FCKElementPath(g);var j=h||this.EnterMode;if(j=="br"||f.Block&&f.Block.tagName.toLowerCase()=="pre"){return this._ExecuteEnterBr();}else{return this._ExecuteEnterBlock(j);}};FCKEnterKey.prototype.DoShiftEnter=function(){return this.DoEnter(this.ShiftEnterMode,true);};FCKEnterKey.prototype.DoBackspace=function(){var t=false;var w=new FCKDomRange(this.Window);w.MoveToSelection();if(FCKBrowserInfo.IsIE&&this._CheckIsAllContentsIncluded(w,this.Window.document.body)){this._FixIESelectAllBug(w);return true;}var q=w.CheckIsCollapsed();if(!q){if(FCKBrowserInfo.IsIE&&this.Window.document.selection.type.toLowerCase()=="control"){var o=this.Window.document.selection.createRange();for(var r=o.length-1;r>=0;r--){var y=o.item(r);y.parentNode.removeChild(y);}return true;}return false;}if(FCKBrowserInfo.IsIE){var u=FCKDomTools.GetPreviousSourceElement(w.StartNode,true);if(u&&u.nodeName.toLowerCase()=="br"){var v=w.Clone();v.SetStart(u,4);if(v.CheckIsEmpty()){u.parentNode.removeChild(u);return true;}}}var s=w.StartBlock;var z=w.EndBlock;if(w.StartBlockLimit==w.EndBlockLimit&&s&&z){if(!q){var p=w.CheckEndOfBlock();w.DeleteContents();if(s!=z){w.SetStart(z,1);w.SetEnd(z,1);}w.Select();t=(s==z);}if(w.CheckStartOfBlock()){var x=w.StartBlock;var i=FCKDomTools.GetPreviousSourceElement(x,true,["BODY",w.StartBlockLimit.nodeName],["UL","OL"]);t=this._ExecuteBackspace(w,i,x);}else{if(FCKBrowserInfo.IsGeckoLike){w.Select();}}}w.Release();return t;};FCKEnterKey.prototype.DoCtrlBackspace=function(){FCKUndo.SaveUndoStep();var b=new FCKDomRange(this.Window);b.MoveToSelection();if(FCKBrowserInfo.IsIE&&this._CheckIsAllContentsIncluded(b,this.Window.document.body)){this._FixIESelectAllBug(b);return true;}return false;};FCKEnterKey.prototype._ExecuteBackspace=function(k,j,n){var m=false;if(!j&&n&&n.nodeName.IEquals("LI")&&n.parentNode.parentNode.nodeName.IEquals("LI")){this._OutdentWithSelection(n,k);return true;}if(j&&j.nodeName.IEquals("LI")){var p=FCKDomTools.GetLastChild(j,["UL","OL"]);while(p){j=FCKDomTools.GetLastChild(p,"LI");p=FCKDomTools.GetLastChild(j,["UL","OL"]);}}if(j&&n){if(n.nodeName.IEquals("LI")&&!j.nodeName.IEquals("LI")){this._OutdentWithSelection(n,k);return true;}var o=n.parentNode;var r=j.nodeName.toLowerCase();if(FCKListsLib.EmptyElements[r]!=null||r=="table"){FCKDomTools.RemoveNode(j);m=true;}else{FCKDomTools.RemoveNode(n);while(o.innerHTML.Trim().length==0){var q=o.parentNode;q.removeChild(o);o=q;}FCKDomTools.LTrimNode(n);FCKDomTools.RTrimNode(j);k.SetStart(j,2,true);k.Collapse(true);var l=k.CreateBookmark(true);if(!n.tagName.IEquals(["TABLE"])){FCKDomTools.MoveChildren(n,j);}k.SelectBookmark(l);m=true;}}return m;};FCKEnterKey.prototype.DoDelete=function(){FCKUndo.SaveUndoStep();var j=false;var i=new FCKDomRange(this.Window);i.MoveToSelection();if(FCKBrowserInfo.IsIE&&this._CheckIsAllContentsIncluded(i,this.Window.document.body)){this._FixIESelectAllBug(i);return true;}if(i.CheckIsCollapsed()&&i.CheckEndOfBlock(FCKBrowserInfo.IsGeckoLike)){var k=i.StartBlock;var h=FCKTools.GetElementAscensor(k,"td");var l=FCKDomTools.GetNextSourceElement(k,true,[i.StartBlockLimit.nodeName],["UL","OL","TR"],true);if(h){var g=FCKTools.GetElementAscensor(l,"td");if(g!=h){return true;}}j=this._ExecuteBackspace(i,k,l);}i.Release();return j;};FCKEnterKey.prototype.DoTab=function(){var f=new FCKDomRange(this.Window);f.MoveToSelection();var d=f._Range.startContainer;while(d){if(d.nodeType==1){var e=d.tagName.toLowerCase();if(e=="tr"||e=="td"||e=="th"||e=="tbody"||e=="table"){return false;}else{break;}}d=d.parentNode;}if(this.TabText){f.DeleteContents();f.InsertNode(this.Window.document.createTextNode(this.TabText));f.Collapse(false);f.Select();}return true;};FCKEnterKey.prototype._ExecuteEnterBlock=function(u,v){var z=v||new FCKDomRange(this.Window);var s=z.SplitBlock(u);if(s){var r=s.PreviousBlock;var i=s.NextBlock;var y=s.WasStartOfBlock;var A=s.WasEndOfBlock;if(i){if(i.parentNode.nodeName.IEquals("li")){FCKDomTools.BreakParent(i,i.parentNode);FCKDomTools.MoveNode(i,i.nextSibling,true);}}else{if(r&&r.parentNode.nodeName.IEquals("li")){FCKDomTools.BreakParent(r,r.parentNode);z.MoveToElementEditStart(r.nextSibling);FCKDomTools.MoveNode(r,r.previousSibling);}}if(!y&&!A){if(i.nodeName.IEquals("li")&&i.firstChild&&i.firstChild.nodeName.IEquals(["ul","ol"])){i.insertBefore(FCKTools.GetElementDocument(i).createTextNode("\xa0"),i.firstChild);}if(i){z.MoveToElementEditStart(i);}}else{if(y&&A&&r.tagName.toUpperCase()=="LI"){z.MoveToElementStart(r);this._OutdentWithSelection(r,z);z.Release();return true;}var D;if(r){var B=r.tagName.toUpperCase();if(!this._HasShift&&!(/^H[1-6]$/).test(B)){D=FCKDomTools.CloneElement(r);}}else{if(i){D=FCKDomTools.CloneElement(i);}}if(!D){D=this.Window.document.createElement(u);}var q=s.ElementPath;if(q){for(var w=0,t=q.Elements.length;w<t;w++){var x=q.Elements[w];if(x==q.Block||x==q.BlockLimit){break;}if(FCKListsLib.InlineChildReqElements[x.nodeName.toLowerCase()]){x=FCKDomTools.CloneElement(x);FCKDomTools.MoveChildren(D,x);D.appendChild(x);}}}if(FCKBrowserInfo.IsGeckoLike){FCKTools.AppendBogusBr(D);}z.InsertNode(D);if(FCKBrowserInfo.IsIE){z.MoveToElementEditStart(D);z.Select();}z.MoveToElementEditStart(y&&!A?i:D);}if(FCKBrowserInfo.IsGeckoLike){if(i){var C=this.Window.document.createElement("span");C.innerHTML="&nbsp;";z.InsertNode(C);FCKDomTools.ScrollIntoView(C,false);z.DeleteContents();}else{FCKDomTools.ScrollIntoView(i||D,false);}}z.Select();}z.Release();return true;};FCKEnterKey.prototype._ExecuteEnterBr=function(j){var n=new FCKDomRange(this.Window);n.MoveToSelection();if(n.StartBlockLimit==n.EndBlockLimit){n.DeleteContents();n.MoveToSelection();var l=n.CheckStartOfBlock();var p=n.CheckEndOfBlock();var k=n.StartBlock?n.StartBlock.tagName.toUpperCase():"";var m=this._HasShift;var r=false;if(!m&&k=="LI"){return this._ExecuteEnterBlock(null,n);}if(!m&&p&&(/^H[1-6]$/).test(k)){FCKDomTools.InsertAfterNode(n.StartBlock,this.Window.document.createElement("br"));if(FCKBrowserInfo.IsGecko){FCKDomTools.InsertAfterNode(n.StartBlock,this.Window.document.createTextNode(""));}n.SetStart(n.StartBlock.nextSibling,FCKBrowserInfo.IsIE?3:1);}else{var q;r=k.IEquals("pre");if(r){q=this.Window.document.createTextNode(FCKBrowserInfo.IsIE?"\r":"\n");}else{q=this.Window.document.createElement("br");}n.InsertNode(q);if(FCKBrowserInfo.IsGecko){FCKDomTools.InsertAfterNode(q,this.Window.document.createTextNode(""));}if(p&&FCKBrowserInfo.IsGeckoLike){FCKTools.AppendBogusBr(q.parentNode);}if(FCKBrowserInfo.IsIE){n.SetStart(q,4);}else{n.SetStart(q.nextSibling,1);}if(!FCKBrowserInfo.IsIE){var o=null;if(FCKBrowserInfo.IsOpera){o=this.Window.document.createElement("span");}else{o=this.Window.document.createElement("br");}q.parentNode.insertBefore(o,q.nextSibling);FCKDomTools.ScrollIntoView(o,false);o.parentNode.removeChild(o);}}n.Collapse(true);n.Select(r);}n.Release();return true;};FCKEnterKey.prototype._OutdentWithSelection=function(e,d){var f=d.CreateBookmark();FCKListHandler.OutdentListItem(e);d.MoveToBookmark(f);d.Select();};FCKEnterKey.prototype._CheckIsAllContentsIncluded=function(f,h){var i=false;var j=false;if(f.StartContainer==h||f.StartContainer==h.firstChild){i=(f._Range.startOffset==0);}if(f.EndContainer==h||f.EndContainer==h.lastChild){var g=f.EndContainer.nodeType==3?f.EndContainer.length:f.EndContainer.childNodes.length;j=(f._Range.endOffset==g);}return i&&j;};FCKEnterKey.prototype._FixIESelectAllBug=function(e){var f=this.Window.document;f.body.innerHTML="";var d;if(FCKConfig.EnterMode.IEquals(["div","p"])){d=f.createElement(FCKConfig.EnterMode);f.body.appendChild(d);}else{d=f.body;}e.MoveToNodeContents(d);e.Collapse(true);e.Select();e.Release();};