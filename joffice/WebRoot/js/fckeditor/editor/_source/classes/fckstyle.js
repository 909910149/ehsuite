var FCKStyle=function(b){this.Element=(b.Element||"span").toLowerCase();this._StyleDesc=b;};FCKStyle.prototype={GetType:function(){var c=this.GetType_$;if(c!=undefined){return c;}var d=this.Element;if(d=="#"||FCKListsLib.StyleBlockElements[d]){c=FCK_STYLE_BLOCK;}else{if(FCKListsLib.StyleObjectElements[d]){c=FCK_STYLE_OBJECT;}else{c=FCK_STYLE_INLINE;}}return(this.GetType_$=c);},ApplyToSelection:function(c){var d=new FCKDomRange(c);d.MoveToSelection();this.ApplyToRange(d,true);},ApplyToRange:function(e,f,d){switch(this.GetType()){case FCK_STYLE_BLOCK:this.ApplyToRange=this._ApplyBlockStyle;break;case FCK_STYLE_INLINE:this.ApplyToRange=this._ApplyInlineStyle;break;default:return;}this.ApplyToRange(e,f,d);},ApplyToObject:function(b){if(!b){return;}this.BuildElement(null,b);},RemoveFromSelection:function(c){var d=new FCKDomRange(c);d.MoveToSelection();this.RemoveFromRange(d,true);},RemoveFromRange:function(O,E,Q){var S;var i=this._GetAttribsForComparison();var G=this._GetOverridesForComparison();if(O.CheckIsCollapsed()){var S=O.CreateBookmark(true);var ab=O.GetBookmarkNode(S,true);var I=new FCKElementPath(ab.parentNode);var K=[];var U=!FCKDomTools.GetNextSibling(ab);var Z=U||!FCKDomTools.GetPreviousSibling(ab);var aa;var j=-1;for(var D=0;D<I.Elements.length;D++){var M=I.Elements[D];if(this.CheckElementRemovable(M)){if(Z&&!FCKDomTools.CheckIsEmptyElement(M,function(a){return(a!=ab);})){aa=M;j=K.length-1;}else{var T=M.nodeName.toLowerCase();if(T==this.Element){for(var H in i){if(FCKDomTools.HasAttribute(M,H)){switch(H){case"style":this._RemoveStylesFromElement(M);break;case"class":if(FCKDomTools.GetAttributeValue(M,H)!=this.GetFinalAttributeValue(H)){continue;}default:FCKDomTools.RemoveAttribute(M,H);}}}}this._RemoveOverrides(M,G[T]);if(this.GetType()==FCK_STYLE_INLINE){this._RemoveNoAttribElement(M);}}}else{if(Z){K.push(M);}}Z=Z&&((U&&!FCKDomTools.GetNextSibling(M))||(!U&&!FCKDomTools.GetPreviousSibling(M)));if(aa&&(!Z||(D==I.Elements.length-1))){var W=FCKDomTools.RemoveNode(ab);for(var F=0;F<=j;F++){var V=FCKDomTools.CloneElement(K[F]);V.appendChild(W);W=V;}if(U){FCKDomTools.InsertAfterNode(aa,W);}else{aa.parentNode.insertBefore(W,aa);}Z=false;aa=null;}}if(E){O.SelectBookmark(S);}if(Q){O.MoveToBookmark(S);}return;}O.Expand("inline_elements");S=O.CreateBookmark(true);var L=O.GetBookmarkNode(S,true);var J=O.GetBookmarkNode(S,false);O.Release(true);var I=new FCKElementPath(L);var N=I.Elements;var M;for(var D=1;D<N.length;D++){M=N[D];if(M==I.Block||M==I.BlockLimit){break;}if(this.CheckElementRemovable(M)){FCKDomTools.BreakParent(L,M,O);}}I=new FCKElementPath(J);N=I.Elements;for(var D=1;D<N.length;D++){M=N[D];if(M==I.Block||M==I.BlockLimit){break;}R=M.nodeName.toLowerCase();if(this.CheckElementRemovable(M)){FCKDomTools.BreakParent(J,M,O);}}var X=FCKDomTools.GetNextSourceNode(L,true);while(X){var Y=FCKDomTools.GetNextSourceNode(X);if(X.nodeType==1){var R=X.nodeName.toLowerCase();var P=(R==this.Element);if(P){for(var H in i){if(FCKDomTools.HasAttribute(X,H)){switch(H){case"style":this._RemoveStylesFromElement(X);break;case"class":if(FCKDomTools.GetAttributeValue(X,H)!=this.GetFinalAttributeValue(H)){continue;}default:FCKDomTools.RemoveAttribute(X,H);}}}}else{P=!!G[R];}if(P){this._RemoveOverrides(X,G[R]);this._RemoveNoAttribElement(X);}}if(Y==J){break;}X=Y;}this._FixBookmarkStart(L);if(E){O.SelectBookmark(S);}if(Q){O.MoveToBookmark(S);}},CheckElementRemovable:function(p,q){if(!p){return false;}var i=p.nodeName.toLowerCase();if(i==this.Element){if(!q&&!FCKDomTools.HasAttributes(p)){return true;}var s=this._GetAttribsForComparison();var t=(s._length==0);for(var m in s){if(m=="_length"){continue;}if(this._CompareAttributeValues(m,FCKDomTools.GetAttributeValue(p,m),(this.GetFinalAttributeValue(m)||""))){t=true;if(!q){break;}}else{t=false;if(q){return false;}}}if(t){return true;}}var r=this._GetOverridesForComparison()[i];if(r){if(!(s=r.Attributes)){return true;}for(var o=0;o<s.length;o++){var n=s[o][0];if(FCKDomTools.HasAttribute(p,n)){var l=s[o][1];if(l==null||(typeof l=="string"&&FCKDomTools.GetAttributeValue(p,n)==l)||l.test(FCKDomTools.GetAttributeValue(p,n))){return true;}}}}return false;},CheckActive:function(h){switch(this.GetType()){case FCK_STYLE_BLOCK:return this.CheckElementRemovable(h.Block||h.BlockLimit,true);case FCK_STYLE_INLINE:var g=h.Elements;for(var e=0;e<g.length;e++){var f=g[e];if(f==h.Block||f==h.BlockLimit){continue;}if(this.CheckElementRemovable(f,true)){return true;}}}return false;},RemoveFromElement:function(o){var k=this._GetAttribsForComparison();var l=this._GetOverridesForComparison();var j=o.getElementsByTagName(this.Element);for(var p=j.length-1;p>=0;p--){var n=j[p];for(var i in k){if(FCKDomTools.HasAttribute(n,i)){switch(i){case"style":this._RemoveStylesFromElement(n);break;case"class":if(FCKDomTools.GetAttributeValue(n,i)!=this.GetFinalAttributeValue(i)){continue;}default:FCKDomTools.RemoveAttribute(n,i);}}}this._RemoveOverrides(n,l[this.Element]);this._RemoveNoAttribElement(n);}for(var m in l){if(m!=this.Element){j=o.getElementsByTagName(m);for(var p=j.length-1;p>=0;p--){var n=j[p];this._RemoveOverrides(n,l[m]);this._RemoveNoAttribElement(n);}}}},_RemoveStylesFromElement:function(f){var g=f.style.cssText;var h=this.GetFinalStyleValue();if(g.length>0&&h.length==0){return;}h="(^|;)\\s*("+h.replace(/\s*([^ ]+):.*?(;|$)/g,"$1|").replace(/\|$/,"")+"):[^;]+";var e=new RegExp(h,"gi");g=g.replace(e,"").Trim();if(g.length==0||g==";"){FCKDomTools.RemoveAttribute(f,"style");}else{f.style.cssText=g.replace(e,"");}},_RemoveOverrides:function(j,k){var h=k&&k.Attributes;if(h){for(var l=0;l<h.length;l++){var i=h[l][0];if(FCKDomTools.HasAttribute(j,i)){var g=h[l][1];if(g==null||(g.test&&g.test(FCKDomTools.GetAttributeValue(j,i)))||(typeof g=="string"&&FCKDomTools.GetAttributeValue(j,i)==g)){FCKDomTools.RemoveAttribute(j,i);}}}}},_RemoveNoAttribElement:function(e){if(!FCKDomTools.HasAttributes(e)){var f=e.firstChild;var d=e.lastChild;FCKDomTools.RemoveNode(e,true);this._MergeSiblings(f);if(f!=d){this._MergeSiblings(d);}}},BuildElement:function(k,l){var j=l||k.createElement(this.Element);var i=this._StyleDesc.Attributes;var g;if(i){for(var h in i){g=this.GetFinalAttributeValue(h);if(h.toLowerCase()=="class"){j.className=g;}else{j.setAttribute(h,g);}}}if(this._GetStyleText().length>0){j.style.cssText=this.GetFinalStyleValue();}return j;},_CompareAttributeValues:function(f,d,e){if(f=="style"&&d&&e){d=d.replace(/;$/,"").toLowerCase();e=e.replace(/;$/,"").toLowerCase();}return(d==e||((d===null||d==="")&&(e===null||e==="")));},GetFinalAttributeValue:function(c){var d=this._StyleDesc.Attributes;var d=d?d[c]:null;if(!d&&c=="style"){return this.GetFinalStyleValue();}if(d&&this._Variables){d=d.Replace(FCKRegexLib.StyleVariableAttName,this._GetVariableReplace,this);}return d;},GetFinalStyleValue:function(){var b=this._GetStyleText();if(b.length>0&&this._Variables){b=b.Replace(FCKRegexLib.StyleVariableAttName,this._GetVariableReplace,this);b=FCKTools.NormalizeCssText(b);}return b;},_GetVariableReplace:function(){return this._Variables[arguments[2]]||arguments[0];},SetVariable:function(e,d){var f=this._Variables;if(!f){f=this._Variables={};}this._Variables[e]=d;},_FromPre:function(g,l,i){var j=l.innerHTML;j=j.replace(/(\r\n|\r)/g,"\n");j=j.replace(/^[ \t]*\n/,"");j=j.replace(/\n$/,"");j=j.replace(/^[ \t]+|[ \t]+$/g,function(c,a,b){if(c.length==1){return"&nbsp;";}else{if(a==0){return new Array(c.length).join("&nbsp;")+" ";}else{return" "+new Array(c.length).join("&nbsp;");}}});var k=new FCKHtmlIterator(j);var h=[];k.Each(function(b,a){if(!b){a=a.replace(/\n/g,"<br>");a=a.replace(/[ \t]{2,}/g,function(c){return new Array(c.length).join("&nbsp;")+" ";});}h.push(a);});i.innerHTML=h.join("");return i;},_ToPre:function(n,m,j){var k=m.innerHTML.Trim();k=k.replace(/[ \t\r\n]*(<br[^>]*>)[ \t\r\n]*/gi,"<br />");var l=new FCKHtmlIterator(k);var h=[];l.Each(function(b,a){if(!b){a=a.replace(/([ \t\n\r]+|&nbsp;)/g," ");}else{if(b&&a=="<br />"){a="\n";}}h.push(a);});if(FCKBrowserInfo.IsIE){var i=n.createElement("div");i.appendChild(j);j.outerHTML="<pre>\n"+h.join("")+"</pre>";j=i.removeChild(i.firstChild);}else{j.innerHTML=h.join("");}return j;},_CheckAndMergePre:function(e,d){if(e!=FCKDomTools.GetPreviousSourceElement(d,true)){return;}var f=e.innerHTML.replace(/\n$/,"")+"\n\n"+d.innerHTML.replace(/^\n/,"");if(FCKBrowserInfo.IsIE){d.outerHTML="<pre>"+f+"</pre>";}else{d.innerHTML=f;}FCKDomTools.RemoveNode(e);},_CheckAndSplitPre:function(g){var f;var h=g.firstChild;h=h&&h.nextSibling;while(h){var e=h.nextSibling;if(e&&e.nextSibling&&h.nodeName.IEquals("br")&&e.nodeName.IEquals("br")){FCKDomTools.RemoveNode(h);h=e.nextSibling;FCKDomTools.RemoveNode(e);f=FCKDomTools.InsertAfterNode(f||g,FCKDomTools.CloneElement(g));continue;}if(f){h=h.previousSibling;FCKDomTools.MoveNode(h.nextSibling,f);}h=h.nextSibling;}},_ApplyBlockStyle:function(t,v,w){var q;if(v){q=t.CreateBookmark();}var u=new FCKDomRangeIterator(t);u.EnforceRealBlocks=true;var x;var n=t.Window.document;var o;while((x=u.GetNextParagraph())){var p=this.BuildElement(n);var z=p.nodeName.IEquals("pre");var r=x.nodeName.IEquals("pre");var y=z&&!r;var s=!z&&r;if(y){p=this._ToPre(n,x,p);}else{if(s){p=this._FromPre(n,x,p);}else{FCKDomTools.MoveChildren(x,p);}}x.parentNode.insertBefore(p,x);FCKDomTools.RemoveNode(x);if(z){if(o){this._CheckAndMergePre(o,p);}o=p;}else{if(s){this._CheckAndSplitPre(p);}}}if(v){t.SelectBookmark(q);}if(w){t.MoveToBookmark(q);}},_ApplyInlineStyle:function(A,y,C){var s=A.Window.document;if(A.CheckIsCollapsed()){var I=this.BuildElement(s);A.InsertNode(I);A.MoveToPosition(I,2);A.Select();return;}var D=this.Element;var u=FCK.DTD[D]||FCK.DTD.span;var x=this._GetAttribsForComparison();var v;A.Expand("inline_elements");var F=A.CreateBookmark(true);var t=A.GetBookmarkNode(F,true);var z=A.GetBookmarkNode(F,false);A.Release(true);var H=FCKDomTools.GetNextSourceNode(t,true);while(H){var w=false;var G=H.nodeType;var J=G==1?H.nodeName.toLowerCase():null;if(!J||u[J]){if((FCK.DTD[H.parentNode.nodeName.toLowerCase()]||FCK.DTD.span)[D]||!FCK.DTD[D]){if(!A.CheckHasRange()){A.SetStart(H,3);}if(G!=1||H.childNodes.length==0){var B=H;var E=B.parentNode;while(B==E.lastChild&&u[E.nodeName.toLowerCase()]){B=E;}A.SetEnd(B,4);if(B==B.parentNode.lastChild&&!u[B.parentNode.nodeName.toLowerCase()]){w=true;}}else{A.SetEnd(H,3);}}else{w=true;}}else{w=true;}H=FCKDomTools.GetNextSourceNode(H);if(H==z){H=null;w=true;}if(w&&A.CheckHasRange()&&!A.CheckIsCollapsed()){v=this.BuildElement(s);A.ExtractContents().AppendTo(v);if(v.innerHTML.RTrim().length>0){A.InsertNode(v);this.RemoveFromElement(v);this._MergeSiblings(v,this._GetAttribsForComparison());if(!FCKBrowserInfo.IsIE){v.normalize();}}A.Release(true);}}this._FixBookmarkStart(t);if(y){A.SelectBookmark(F);}if(C){A.MoveToBookmark(F);}},_FixBookmarkStart:function(d){var c;while((c=d.nextSibling)){if(c.nodeType==1&&FCKListsLib.InlineNonEmptyElements[c.nodeName.toLowerCase()]){if(!c.firstChild){FCKDomTools.RemoveNode(c);}else{FCKDomTools.MoveNode(d,c,true);}continue;}if(c.nodeType==3&&c.length==0){FCKDomTools.RemoveNode(c);continue;}break;}},_MergeSiblings:function(d,c){if(!d||d.nodeType!=1||!FCKListsLib.InlineNonEmptyElements[d.nodeName.toLowerCase()]){return;}this._MergeNextSibling(d,c);this._MergePreviousSibling(d,c);},_MergeNextSibling:function(f,i){var j=f.nextSibling;var g=(j&&j.nodeType==1&&j.getAttribute("_fck_bookmark"));if(g){j=j.nextSibling;}if(j&&j.nodeType==1&&j.nodeName==f.nodeName){if(!i){i=this._CreateElementAttribsForComparison(f);}if(this._CheckAttributesMatch(j,i)){var h=f.lastChild;if(g){FCKDomTools.MoveNode(f.nextSibling,f);}FCKDomTools.MoveChildren(j,f);FCKDomTools.RemoveNode(j);if(h){this._MergeNextSibling(h);}}}},_MergePreviousSibling:function(f,i){var j=f.previousSibling;var g=(j&&j.nodeType==1&&j.getAttribute("_fck_bookmark"));if(g){j=j.previousSibling;}if(j&&j.nodeType==1&&j.nodeName==f.nodeName){if(!i){i=this._CreateElementAttribsForComparison(f);}if(this._CheckAttributesMatch(j,i)){var h=f.firstChild;if(g){FCKDomTools.MoveNode(f.previousSibling,f,true);}FCKDomTools.MoveChildren(j,f,true);FCKDomTools.RemoveNode(j);if(h){this._MergePreviousSibling(h);}}}},_GetStyleText:function(){var d=this._StyleDesc.Styles;var e=(this._StyleDesc.Attributes?this._StyleDesc.Attributes["style"]||"":"");if(e.length>0){e+=";";}for(var f in d){e+=f+":"+d[f]+";";}if(e.length>0&&!(/#\(/.test(e))){e=FCKTools.NormalizeCssText(e);}return(this._GetStyleText=function(){return e;})();},_GetAttribsForComparison:function(){var f=this._GetAttribsForComparison_$;if(f){return f;}f=new Object();var d=this._StyleDesc.Attributes;if(d){for(var e in d){f[e.toLowerCase()]=d[e].toLowerCase();}}if(this._GetStyleText().length>0){f["style"]=this._GetStyleText().toLowerCase();}FCKTools.AppendLengthProperty(f,"_length");return(this._GetAttribsForComparison_$=f);},_GetOverridesForComparison:function(){var l=this._GetOverridesForComparison_$;if(l){return l;}l=new Object();var n=this._StyleDesc.Overrides;if(n){if(!FCKTools.IsArray(n)){n=[n];}for(var p=0;p<n.length;p++){var r=n[p];var i;var o;var k;if(typeof r=="string"){i=r.toLowerCase();}else{i=r.Element?r.Element.toLowerCase():this.Element;k=r.Attributes;}o=l[i]||(l[i]={});if(k){var q=(o.Attributes=o.Attributes||new Array());for(var m in k){q.push([m.toLowerCase(),k[m]]);}}}}return(this._GetOverridesForComparison_$=l);},_CreateElementAttribsForComparison:function(i){var h=new Object();var j=0;for(var f=0;f<i.attributes.length;f++){var g=i.attributes[f];if(g.specified){h[g.nodeName.toLowerCase()]=FCKDomTools.GetAttributeValue(i,g).toLowerCase();j++;}}h._length=j;return h;},_CheckAttributesMatch:function(m,l){var o=m.attributes;var p=0;for(var n=0;n<o.length;n++){var i=o[n];if(i.specified){var k=i.nodeName.toLowerCase();var j=l[k];if(!j){break;}if(j!=FCKDomTools.GetAttributeValue(m,i).toLowerCase()){break;}p++;}}return(p==l._length);}};