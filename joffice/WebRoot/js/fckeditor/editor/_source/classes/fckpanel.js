var FCKPanel=function(i){this.IsRTL=(FCKLang.Dir=="rtl");this.IsContextMenu=false;this._LockCounter=0;this._Window=i||window;var l;if(FCKBrowserInfo.IsIE){this._Popup=this._Window.createPopup();var j=this._Window.document;if(FCK_IS_CUSTOM_DOMAIN&&!FCKBrowserInfo.IsIE7){j.domain=FCK_ORIGINAL_DOMAIN;document.domain=FCK_ORIGINAL_DOMAIN;}l=this.Document=this._Popup.document;if(FCK_IS_CUSTOM_DOMAIN){l.domain=FCK_RUNTIME_DOMAIN;j.domain=FCK_RUNTIME_DOMAIN;document.domain=FCK_RUNTIME_DOMAIN;}FCK.IECleanup.AddItem(this,FCKPanel_Cleanup);}else{var g=this._IFrame=this._Window.document.createElement("iframe");FCKTools.ResetStyles(g);g.src="javascript:void(0)";g.allowTransparency=true;g.frameBorder="0";g.scrolling="no";g.style.width=g.style.height="0px";FCKDomTools.SetElementStyles(g,{position:"absolute",zIndex:FCKConfig.FloatingPanelsZIndex});this._Window.document.body.appendChild(g);var k=g.contentWindow;l=this.Document=k.document;var h="";if(FCKBrowserInfo.IsSafari){h='<base href="'+window.document.location+'">';}l.open();l.write("<html><head>"+h+'</head><body style="margin:0px;padding:0px;"></body></html>');l.close();if(FCKBrowserInfo.IsAIR){FCKAdobeAIR.Panel_Contructor(l,window.document.location);}FCKTools.AddEventListenerEx(k,"focus",FCKPanel_Window_OnFocus,this);FCKTools.AddEventListenerEx(k,"blur",FCKPanel_Window_OnBlur,this);}l.dir=FCKLang.Dir;FCKTools.AddEventListener(l,"contextmenu",FCKTools.CancelEvent);this.MainNode=l.body.appendChild(l.createElement("DIV"));this.MainNode.style.cssFloat=this.IsRTL?"right":"left";};FCKPanel.prototype.AppendStyleSheet=function(b){FCKTools.AppendStyleSheet(this.Document,b);};FCKPanel.prototype.Preload=function(e,f,d){if(this._Popup){this._Popup.show(e,f,0,0,d);}};FCKPanel.prototype.ResizeForSubpanel=function(l,k,n){if(!FCKBrowserInfo.IsIE7){return false;}if(!this._Popup.isOpen){this.Subpanel=null;return false;}if(k==0&&n==0){if(this.Subpanel!==l){return false;}this.Subpanel=null;this.IncreasedX=0;}else{this.Subpanel=l;if((this.IncreasedX>=k)&&(this.IncreasedY>=n)){return false;}this.IncreasedX=Math.max(this.IncreasedX,k);this.IncreasedY=Math.max(this.IncreasedY,n);}var h=this.ShowRect.x;var m=this.IncreasedX;if(this.IsRTL){h=h-m;}var j=this.ShowRect.w+m;var i=Math.max(this.ShowRect.h,this.IncreasedY);if(this.ParentPanel){this.ParentPanel.ResizeForSubpanel(this,j,i);}this._Popup.show(h,this.ShowRect.y,j,i,this.RelativeElement);return this.IsRTL;};FCKPanel.prototype.Show=function(t,v,z,B,p){var u;var r=this.MainNode;if(this._Popup){this._Popup.show(t,v,0,0,z);FCKDomTools.SetElementStyles(r,{width:B?B+"px":"",height:p?p+"px":""});u=r.offsetWidth;if(FCKBrowserInfo.IsIE7){if(this.ParentPanel&&this.ParentPanel.ResizeForSubpanel(this,u,r.offsetHeight)){FCKTools.RunFunction(this.Show,this,[t,v,z]);return;}}if(this.IsRTL){if(this.IsContextMenu){t=t-u+1;}else{if(z){t=(t*-1)+z.offsetWidth-u;}}}if(FCKBrowserInfo.IsIE7){this.ShowRect={x:t,y:v,w:u,h:r.offsetHeight};this.IncreasedX=0;this.IncreasedY=0;this.RelativeElement=z;}this._PopupArgs=[t,v,u,r.offsetHeight,z];this._Popup.show(t,v,u,r.offsetHeight,z);if(this.OnHide){if(this._Timer){CheckPopupOnHide.call(this,true);}this._Timer=FCKTools.SetInterval(CheckPopupOnHide,100,this);}}else{if(typeof(FCK.ToolbarSet.CurrentInstance.FocusManager)!="undefined"){FCK.ToolbarSet.CurrentInstance.FocusManager.Lock();}if(this.ParentPanel){this.ParentPanel.Lock();FCKPanel_Window_OnBlur(null,this.ParentPanel);}if(FCKBrowserInfo.IsGecko&&FCKBrowserInfo.IsMac){this._IFrame.scrolling="";FCKTools.RunFunction(function(){this._IFrame.scrolling="no";},this);}if(FCK.ToolbarSet.CurrentInstance.GetInstanceObject("FCKPanel")._OpenedPanel&&FCK.ToolbarSet.CurrentInstance.GetInstanceObject("FCKPanel")._OpenedPanel!=this){FCK.ToolbarSet.CurrentInstance.GetInstanceObject("FCKPanel")._OpenedPanel.Hide(false,true);}FCKDomTools.SetElementStyles(r,{width:B?B+"px":"",height:p?p+"px":""});u=r.offsetWidth;if(!B){this._IFrame.width=1;}if(!p){this._IFrame.height=1;}u=r.offsetWidth||r.firstChild.offsetWidth;var s=FCKTools.GetDocumentPosition(this._Window,z.nodeType==9?(FCKTools.IsStrictMode(z)?z.documentElement:z.body):z);var A=FCKDomTools.GetPositionedAncestor(this._IFrame.parentNode);if(A){var D=FCKTools.GetDocumentPosition(FCKTools.GetElementWindow(A),A);s.x-=D.x;s.y-=D.y;}if(this.IsRTL&&!this.IsContextMenu){t=(t*-1);}t+=s.x;v+=s.y;if(this.IsRTL){if(this.IsContextMenu){t=t-u+1;}else{if(z){t=t+z.offsetWidth-u;}}}else{var y=FCKTools.GetViewPaneSize(this._Window);var x=FCKTools.GetScrollPosition(this._Window);var C=y.Height+x.Y;var q=y.Width+x.X;if((t+u)>q){t-=t+u-q;}if((v+r.offsetHeight)>C){v-=v+r.offsetHeight-C;}}FCKDomTools.SetElementStyles(this._IFrame,{left:t+"px",top:v+"px"});this._IFrame.contentWindow.focus();this._IsOpened=true;var w=this;this._resizeTimer=setTimeout(function(){var b=r.offsetWidth||r.firstChild.offsetWidth;var a=r.offsetHeight;w._IFrame.style.width=b+"px";w._IFrame.style.height=a+"px";},0);FCK.ToolbarSet.CurrentInstance.GetInstanceObject("FCKPanel")._OpenedPanel=this;}FCKTools.RunFunction(this.OnShow,this);};FCKPanel.prototype.Hide=function(d,c){if(this._Popup){this._Popup.hide();}else{if(!this._IsOpened||this._LockCounter>0){return;}if(typeof(FCKFocusManager)!="undefined"&&!c){FCKFocusManager.Unlock();}this._IFrame.style.width=this._IFrame.style.height="0px";this._IsOpened=false;if(this._resizeTimer){clearTimeout(this._resizeTimer);this._resizeTimer=null;}if(this.ParentPanel){this.ParentPanel.Unlock();}if(!d){FCKTools.RunFunction(this.OnHide,this);}}};FCKPanel.prototype.CheckIsOpened=function(){if(this._Popup){return this._Popup.isOpen;}else{return this._IsOpened;}};FCKPanel.prototype.CreateChildPanel=function(){var d=this._Popup?FCKTools.GetDocumentWindow(this.Document):this._Window;var c=new FCKPanel(d);c.ParentPanel=this;return c;};FCKPanel.prototype.Lock=function(){this._LockCounter++;};FCKPanel.prototype.Unlock=function(){if(--this._LockCounter==0&&!this.HasFocus){this.Hide();}};function FCKPanel_Window_OnFocus(c,d){d.HasFocus=true;}function FCKPanel_Window_OnBlur(c,d){d.HasFocus=false;if(d._LockCounter==0){FCKTools.RunFunction(d.Hide,d);}}function CheckPopupOnHide(b){if(b||!this._Popup.isOpen){window.clearInterval(this._Timer);this._Timer=null;if(this._Popup&&this.ParentPanel&&!b){this.ParentPanel.ResizeForSubpanel(this,0,0);}FCKTools.RunFunction(this.OnHide,this);}}function FCKPanel_Cleanup(){this._Popup=null;this._Window=null;this.Document=null;this.MainNode=null;this.RelativeElement=null;}