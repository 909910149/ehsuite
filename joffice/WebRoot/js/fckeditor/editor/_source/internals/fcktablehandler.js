var FCKTableHandler=new Object();FCKTableHandler.InsertRow=function(d){var e=FCKSelection.MoveToAncestorNode("TR");if(!e){return;}var f=e.cloneNode(true);e.parentNode.insertBefore(f,e);FCKTableHandler.ClearRow(d?f:e);};FCKTableHandler.DeleteRows=function(i){if(!i){var l=FCKTableHandler.GetSelectedCells();var j=new Array();for(var k=0;k<l.length;k++){var g=l[k].parentNode;j[g.rowIndex]=g;}for(var k=j.length;k>=0;k--){if(j[k]){FCKTableHandler.DeleteRows(j[k]);}}return;}var h=FCKTools.GetElementAscensor(i,"TABLE");if(h.rows.length==1){FCKTableHandler.DeleteTable(h);return;}i.parentNode.removeChild(i);};FCKTableHandler.DeleteTable=function(b){if(!b){b=FCKSelection.GetSelectedElement();if(!b||b.tagName!="TABLE"){b=FCKSelection.MoveToAncestorNode("TABLE");}}if(!b){return;}FCKSelection.SelectNode(b);FCKSelection.Collapse();if(b.parentNode.childNodes.length==1){b.parentNode.parentNode.removeChild(b.parentNode);}else{b.parentNode.removeChild(b);}};FCKTableHandler.InsertColumn=function(m){var n=null;var p=this.GetSelectedCells();if(p&&p.length){n=p[m?0:(p.length-1)];}if(!n){return;}var i=FCKTools.GetElementAscensor(n,"TABLE");var k=n.cellIndex;for(var l=0;l<i.rows.length;l++){var j=i.rows[l];if(j.cells.length<(k+1)){continue;}n=j.cells[k].cloneNode(false);if(FCKBrowserInfo.IsGeckoLike){FCKTools.AppendBogusBr(n);}var o=j.cells[k];j.insertBefore(n,(m?o:o.nextSibling));}};FCKTableHandler.DeleteColumns=function(k){if(!k){var l=FCKTableHandler.GetSelectedCells();for(var j=l.length;j>=0;j--){if(l[j]){FCKTableHandler.DeleteColumns(l[j]);}}return;}if(!k){return;}var g=FCKTools.GetElementAscensor(k,"TABLE");var i=k.cellIndex;for(var j=g.rows.length-1;j>=0;j--){var h=g.rows[j];if(i==0&&h.cells.length==1){FCKTableHandler.DeleteRows(h);continue;}if(h.cells[i]){h.removeChild(h.cells[i]);}}};FCKTableHandler.InsertCell=function(g,i){var j=null;var f=this.GetSelectedCells();if(f&&f.length){j=f[i?0:(f.length-1)];}if(!j){return null;}var h=FCK.EditorDocument.createElement("TD");if(FCKBrowserInfo.IsGeckoLike){FCKTools.AppendBogusBr(h);}if(!i&&j.cellIndex==j.parentNode.cells.length-1){j.parentNode.appendChild(h);}else{j.parentNode.insertBefore(h,i?j:j.nextSibling);}return h;};FCKTableHandler.DeleteCell=function(b){if(b.parentNode.cells.length==1){FCKTableHandler.DeleteRows(b.parentNode);return;}b.parentNode.removeChild(b);};FCKTableHandler.DeleteCells=function(){var d=FCKTableHandler.GetSelectedCells();for(var c=d.length-1;c>=0;c--){FCKTableHandler.DeleteCell(d[c]);}};FCKTableHandler._MarkCells=function(d,e){for(var f=0;f<d.length;f++){d[f][e]=true;}};FCKTableHandler._UnmarkCells=function(d,e){for(var f=0;f<d.length;f++){FCKDomTools.ClearElementJSProperty(d[f],e);}};FCKTableHandler._ReplaceCellsByMarker=function(h,f,g){for(var i=0;i<h.length;i++){for(var j=0;j<h[i].length;j++){if(h[i][j][f]){h[i][j]=g;}}}};FCKTableHandler._GetMarkerGeometry=function(q,r,o,m){var l=0;var i=0;var k=0;var n=0;for(var p=o;q[r][p]&&q[r][p][m];p++){l++;}for(var p=o-1;q[r][p]&&q[r][p][m];p--){l++;k++;}for(var p=r;q[p]&&q[p][o]&&q[p][o][m];p++){i++;}for(var p=r-1;q[p]&&q[p][o]&&q[p][o][m];p--){i++;n++;}return{"width":l,"height":i,"x":k,"y":n};};FCKTableHandler.CheckIsSelectionRectangular=function(){var i=FCKTableHandler.GetSelectedCells();if(i.length<1){return false;}for(var o=0;o<i.length;o++){if(i[o].parentNode.parentNode!=i[0].parentNode.parentNode){return false;}}this._MarkCells(i,"_CellSelected");var q=this._CreateTableMap(i[0]);var r=i[0].parentNode.rowIndex;var p=this._GetCellIndexSpan(q,r,i[0]);var l=this._GetMarkerGeometry(q,r,p,"_CellSelected");var g=p-l.x;var m=r-l.y;if(l.width>=l.height){for(p=g;p<g+l.width;p++){r=m+(p-g)%l.height;if(!q[r]||!q[r][p]){this._UnmarkCells(i,"_CellSelected");return false;}var n=this._GetMarkerGeometry(q,r,p,"_CellSelected");if(n.width!=l.width||n.height!=l.height){this._UnmarkCells(i,"_CellSelected");return false;}}}else{for(r=m;r<m+l.height;r++){p=g+(r-m)%l.width;if(!q[r]||!q[r][p]){this._UnmarkCells(i,"_CellSelected");return false;}var n=this._GetMarkerGeometry(q,r,p,"_CellSelected");if(n.width!=l.width||n.height!=l.height){this._UnmarkCells(i,"_CellSelected");return false;}}}this._UnmarkCells(i,"_CellSelected");return true;};FCKTableHandler.MergeCells=function(){var j=this.GetSelectedCells();if(j.length<2){return;}var z=j[0];var x=this._CreateTableMap(z);var A=z.parentNode.rowIndex;var s=this._GetCellIndexSpan(x,A,z);this._MarkCells(j,"_SelectedCells");var B=this._GetMarkerGeometry(x,A,s,"_SelectedCells");var i=s-B.x;var r=A-B.y;var u=FCKTools.GetElementDocument(z).createDocumentFragment();for(var t=0;t<B.height;t++){var y=0;for(var v=0;v<B.width;v++){var q=x[r+t][i+v];while(q.childNodes.length>0){var w=q.removeChild(q.firstChild);if(w.nodeType!=1||(w.getAttribute("type",2)!="_moz"&&w.getAttribute("_moz_dirty")!=null)){u.appendChild(w);y++;}}}if(y>0){u.appendChild(FCK.EditorDocument.createElement("br"));}}this._ReplaceCellsByMarker(x,"_SelectedCells",z);this._UnmarkCells(j,"_SelectedCells");this._InstallTableMap(x,z.parentNode.parentNode.parentNode);z.appendChild(u);if(FCKBrowserInfo.IsGeckoLike&&(!z.firstChild)){FCKTools.AppendBogusBr(z);}this._MoveCaretToCell(z,false);};FCKTableHandler.MergeRight=function(){var i=this.GetMergeRightTarget();if(i==null){return;}var j=i.refCell;var h=i.tableMap;var g=i.nextCell;var f=FCK.EditorDocument.createDocumentFragment();while(g&&g.childNodes&&g.childNodes.length>0){f.appendChild(g.removeChild(g.firstChild));}g.parentNode.removeChild(g);j.appendChild(f);this._MarkCells([g],"_Replace");this._ReplaceCellsByMarker(h,"_Replace",j);this._InstallTableMap(h,j.parentNode.parentNode.parentNode);this._MoveCaretToCell(j,false);};FCKTableHandler.MergeDown=function(){var i=this.GetMergeDownTarget();if(i==null){return;}var j=i.refCell;var h=i.tableMap;var g=i.nextCell;var f=FCKTools.GetElementDocument(j).createDocumentFragment();while(g&&g.childNodes&&g.childNodes.length>0){f.appendChild(g.removeChild(g.firstChild));}if(f.firstChild){f.insertBefore(FCK.EditorDocument.createElement("br"),f.firstChild);}j.appendChild(f);this._MarkCells([g],"_Replace");this._ReplaceCellsByMarker(h,"_Replace",j);this._InstallTableMap(h,j.parentNode.parentNode.parentNode);this._MoveCaretToCell(j,false);};FCKTableHandler.HorizontalSplitCell=function(){var F=FCKTableHandler.GetSelectedCells();if(F.length!=1){return;}var C=F[0];var A=this._CreateTableMap(C);var D=C.parentNode.rowIndex;var w=FCKTableHandler._GetCellIndexSpan(A,D,C);var r=isNaN(C.colSpan)?1:C.colSpan;if(r>1){var i=Math.ceil(r/2);var v=FCK.EditorDocument.createElement(C.nodeName);if(FCKBrowserInfo.IsGeckoLike){FCKTools.AppendBogusBr(v);}var t=w+i;var B=w+r;var u=isNaN(C.rowSpan)?1:C.rowSpan;for(var E=D;E<D+u;E++){for(var x=t;x<B;x++){A[E][x]=v;}}}else{var z=[];for(var x=0;x<A.length;x++){var j=A[x].slice(0,w);if(A[x].length<=w){z.push(j);continue;}if(A[x][w]==C){j.push(C);j.push(FCK.EditorDocument.createElement(C.nodeName));if(FCKBrowserInfo.IsGeckoLike){FCKTools.AppendBogusBr(j[j.length-1]);}}else{j.push(A[x][w]);j.push(A[x][w]);}for(var y=w+1;y<A[x].length;y++){j.push(A[x][y]);}z.push(j);}A=z;}this._InstallTableMap(A,C.parentNode.parentNode.parentNode);};FCKTableHandler.VerticalSplitCell=function(){var s=FCKTableHandler.GetSelectedCells();if(s.length!=1){return;}var w=s[0];var F=this._CreateTableMap(w);var C=w.parentNode.rowIndex;var x=FCKTableHandler._GetCellIndexSpan(F,C,w);var z=isNaN(w.colSpan)?1:w.colSpan;var v=w.rowSpan;if(isNaN(v)){v=1;}if(v>1){w.rowSpan=Math.ceil(v/2);var i=C+Math.ceil(v/2);var H=F[i];var G=null;for(var D=x+1;D<H.length;D++){if(H[D].parentNode.rowIndex==i){G=H[D];break;}}var E=FCK.EditorDocument.createElement(w.nodeName);E.rowSpan=Math.floor(v/2);if(z>1){E.colSpan=z;}if(FCKBrowserInfo.IsGeckoLike){FCKTools.AppendBogusBr(E);}w.parentNode.parentNode.parentNode.rows[i].insertBefore(E,G);}else{var u=w.parentNode.sectionRowIndex+1;var t=FCK.EditorDocument.createElement("tr");var A=w.parentNode.parentNode;if(A.rows.length>u){A.insertBefore(t,A.rows[u]);}else{A.appendChild(t);}for(var D=0;D<F[C].length;){var B=F[C][D].colSpan;if(isNaN(B)||B<1){B=1;}if(D==x){D+=B;continue;}var y=F[C][D].rowSpan;if(isNaN(y)){y=1;}F[C][D].rowSpan=y+1;D+=B;}var E=FCK.EditorDocument.createElement(w.nodeName);if(z>1){E.colSpan=z;}if(FCKBrowserInfo.IsGeckoLike){FCKTools.AppendBogusBr(E);}t.appendChild(E);}};FCKTableHandler._GetCellIndexSpan=function(h,i,g){if(h.length<i+1){return null;}var c=h[i];for(var j=0;j<c.length;j++){if(c[j]==g){return j;}}return null;};FCKTableHandler._GetCellLocation=function(g,f){for(var c=0;c<g.length;c++){for(var h=0;h<g[c].length;h++){if(g[c][h]==f){return[c,h];}}}return null;};FCKTableHandler._CreateTableMap=function(y){var c=(y.nodeName=="TABLE"?y:y.parentNode.parentNode.parentNode);var i=c.rows;var z=-1;var j=new Array();for(var u=0;u<i.length;u++){z++;if(!j[z]){j[z]=new Array();}var q=-1;for(var v=0;v<i[u].cells.length;v++){var r=i[u].cells[v];q++;while(j[z][q]){q++;}var w=isNaN(r.colSpan)?1:r.colSpan;var t=isNaN(r.rowSpan)?1:r.rowSpan;for(var x=0;x<t;x++){if(!j[z+x]){j[z+x]=new Array();}for(var s=0;s<w;s++){j[z+x][q+s]=i[u].cells[v];}}q+=w-1;}}return j;};FCKTableHandler._InstallTableMap=function(k,l){var m=FCKBrowserInfo.IsIE?"_fckrowspan":"rowSpan";for(var n=0;n<k.length;n++){for(var p=0;p<k[n].length;p++){var j=k[n][p];if(j.parentNode){j.parentNode.removeChild(j);}j.colSpan=j[m]=1;}}var o=0;for(var n=0;n<k.length;n++){for(var p=0;p<k[n].length;p++){var j=k[n][p];if(!j){continue;}if(p>o){o=p;}if(j._colScanned===true){continue;}if(k[n][p-1]==j){j.colSpan++;}if(k[n][p+1]!=j){j._colScanned=true;}}}for(var n=0;n<=o;n++){for(var p=0;p<k.length;p++){if(!k[p]){continue;}var j=k[p][n];if(!j||j._rowScanned===true){continue;}if(k[p-1]&&k[p-1][n]==j){j[m]++;}if(!k[p+1]||k[p+1][n]!=j){j._rowScanned=true;}}}for(var n=0;n<k.length;n++){for(var p=0;p<k[n].length;p++){var j=k[n][p];FCKDomTools.ClearElementJSProperty(j,"_colScanned");FCKDomTools.ClearElementJSProperty(j,"_rowScanned");}}for(var n=0;n<k.length;n++){var i=FCK.EditorDocument.createElement("tr");for(var p=0;p<k[n].length;){var j=k[n][p];if(k[n-1]&&k[n-1][p]==j){p+=j.colSpan;continue;}i.appendChild(j);if(m!="rowSpan"){j.rowSpan=j[m];j.removeAttribute(m);}p+=j.colSpan;if(j.colSpan==1){j.removeAttribute("colspan");}if(j.rowSpan==1){j.removeAttribute("rowspan");}}if(FCKBrowserInfo.IsIE){l.rows[n].replaceNode(i);}else{l.rows[n].innerHTML="";FCKDomTools.MoveChildren(i,l.rows[n]);}}};FCKTableHandler._MoveCaretToCell=function(f,d){var e=new FCKDomRange(FCK.EditorWindow);e.MoveToNodeContents(f);e.Collapse(d);e.Select();};FCKTableHandler.ClearRow=function(f){var e=f.cells;for(var d=0;d<e.length;d++){e[d].innerHTML="";if(FCKBrowserInfo.IsGeckoLike){FCKTools.AppendBogusBr(e[d]);}}};FCKTableHandler.GetMergeRightTarget=function(){var j=this.GetSelectedCells();if(j.length!=1){return null;}var p=j[0];var o=this._CreateTableMap(p);var q=p.parentNode.rowIndex;var m=this._GetCellIndexSpan(o,q,p);var l=m+(isNaN(p.colSpan)?1:p.colSpan);var k=o[q][l];if(!k){return null;}this._MarkCells([p,k],"_SizeTest");var n=this._GetMarkerGeometry(o,q,m,"_SizeTest");var r=this._GetMarkerGeometry(o,q,l,"_SizeTest");this._UnmarkCells([p,k],"_SizeTest");if(n.height!=r.height||n.y!=r.y){return null;}return{"refCell":p,"nextCell":k,"tableMap":o};};FCKTableHandler.GetMergeDownTarget=function(){var j=this.GetSelectedCells();if(j.length!=1){return null;}var p=j[0];var o=this._CreateTableMap(p);var q=p.parentNode.rowIndex;var l=this._GetCellIndexSpan(o,q,p);var n=q+(isNaN(p.rowSpan)?1:p.rowSpan);if(!o[n]){return null;}var k=o[n][l];if(!k){return null;}if(p.parentNode.parentNode!=k.parentNode.parentNode){return null;}this._MarkCells([p,k],"_SizeTest");var m=this._GetMarkerGeometry(o,q,l,"_SizeTest");var r=this._GetMarkerGeometry(o,n,l,"_SizeTest");this._UnmarkCells([p,k],"_SizeTest");if(m.width!=r.width||m.x!=r.x){return null;}return{"refCell":p,"nextCell":k,"tableMap":o};};