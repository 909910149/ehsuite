var FCKUndo=new Object();FCKUndo.SavedData=new Array();FCKUndo.CurrentIndex=-1;FCKUndo.TypesCount=0;FCKUndo.Changed=false;FCKUndo.MaxTypes=25;FCKUndo.Typing=false;FCKUndo.SaveLocked=false;FCKUndo._GetBookmark=function(){FCKSelection.Restore();var e=new FCKDomRange(FCK.EditorWindow);try{e.MoveToSelection();}catch(g){return null;}if(FCKBrowserInfo.IsIE){var h=e.CreateBookmark();var f=FCK.EditorDocument.body.innerHTML;e.MoveToBookmark(h);return[h,f];}return e.CreateBookmark2();};FCKUndo._SelectBookmark=function(d){if(!d){return;}var e=new FCKDomRange(FCK.EditorWindow);if(d instanceof Object){if(FCKBrowserInfo.IsIE){e.MoveToBookmark(d[0]);}else{e.MoveToBookmark2(d);}try{e.Select();}catch(f){e.MoveToPosition(FCK.EditorDocument.body,4);e.Select();}}};FCKUndo._CompareCursors=function(f,d){for(var e=0;e<Math.min(f.length,d.length);e++){if(f[e]<d[e]){return -1;}else{if(f[e]>d[e]){return 1;}}}if(f.length<d.length){return -1;}else{if(f.length>d.length){return 1;}}return 0;};FCKUndo._CheckIsBookmarksEqual=function(l,h){if(!(l&&h)){return false;}if(FCKBrowserInfo.IsIE){var i=l[1].search(l[0].StartId);var j=h[1].search(h[0].StartId);var k=l[1].search(l[0].EndId);var g=h[1].search(h[0].EndId);return i==j&&k==g;}else{return this._CompareCursors(l.Start,h.Start)==0&&this._CompareCursors(l.End,h.End)==0;}};FCKUndo.SaveUndoStep=function(){if(FCK.EditMode!=FCK_EDITMODE_WYSIWYG||this.SaveLocked){return;}if(this.SavedData.length){this.Changed=true;}var c=FCK.EditorDocument.body.innerHTML;var d=this._GetBookmark();this.SavedData=this.SavedData.slice(0,this.CurrentIndex+1);if(this.CurrentIndex>0&&c==this.SavedData[this.CurrentIndex][0]&&this._CheckIsBookmarksEqual(d,this.SavedData[this.CurrentIndex][1])){return;}else{if(this.CurrentIndex==0&&this.SavedData.length&&c==this.SavedData[0][0]){this.SavedData[0][1]=d;return;}}if(this.CurrentIndex+1>=FCKConfig.MaxUndoLevels){this.SavedData.shift();}else{this.CurrentIndex++;}this.SavedData[this.CurrentIndex]=[c,d];FCK.Events.FireEvent("OnSelectionChange");};FCKUndo.CheckUndoState=function(){return(this.Changed||this.CurrentIndex>0);};FCKUndo.CheckRedoState=function(){return(this.CurrentIndex<(this.SavedData.length-1));};FCKUndo.Undo=function(){if(this.CheckUndoState()){if(this.CurrentIndex==(this.SavedData.length-1)){this.SaveUndoStep();}this._ApplyUndoLevel(--this.CurrentIndex);FCK.Events.FireEvent("OnSelectionChange");}};FCKUndo.Redo=function(){if(this.CheckRedoState()){this._ApplyUndoLevel(++this.CurrentIndex);FCK.Events.FireEvent("OnSelectionChange");}};FCKUndo._ApplyUndoLevel=function(c){var d=this.SavedData[c];if(!d){return;}if(FCKBrowserInfo.IsIE){if(d[1]&&d[1][1]){FCK.SetInnerHtml(d[1][1]);}else{FCK.SetInnerHtml(d[0]);}}else{FCK.EditorDocument.body.innerHTML=d[0];}this._SelectBookmark(d[1]);this.TypesCount=0;this.Changed=false;this.Typing=false;};