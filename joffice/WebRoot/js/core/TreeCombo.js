Ext.ns("Ext.ux.form");Ext.ux.form.CheckTreeCombo=Ext.extend(Ext.form.TriggerField,{filterChars:3,getValueMethod:"getCheckedIds",handleHeight:6,listAlign:"tl-bl?",listClass:"",listHeight:200,minListWidth:70,resizable:false,selectOnFocus:true,shadow:"sides",treeConfig:{rootVisible:false,border:false,autoScroll:true,deepestOnly:true,loaded:false,root:{nodeType:"async",expanded:true,uiProvider:false},loader:{url:"request.php",preloadChildren:true}},value:[],clearFilter:function(){if(this.tree&&this.tree.filter){this.tree.filter.clear();}},collapse:function(){if(!this.isExpanded()){return;}this.list.hide();Ext.getDoc().un("mousedown",this.collapseIf,this);this.fireEvent("collapse",this);},collapseIf:function(b){if(!b.within(this.wrap)&&!b.within(this.list)){this.collapse();}},expand:function(){if(this.isExpanded()){return;}this.list.alignTo(this.wrap,this.listAlign);this.list.show();Ext.getDoc().on("mousedown",this.collapseIf,this);this.fireEvent("expand",this);},getCheckedIds:function(){if(this.tree){return this.tree.getValue();}else{return this.value;}},getEditor:function(f){var d=f.editor;Ext.apply(d,{});var e=new Ext.grid.GridEditor(new Ext.ux.form.CheckTreeCombo(d),{updateEl:false});e.on({startedit:{fn:function(b,a){if(this.field.tree){this.field.tree.filter.clear();Ext.each(this.field.tree.getRootNode().childNodes,function(c){c.collapse(true,false);});}this.field.setValue(this.record.get(this.field.idName));this.field.expand();}},complete:{fn:function(b,a,c){this.record.set(this.field.idName,this.field.getCheckedIds());}}});return e;},getValue:function(){return this[this.getValueMethod]();},getText:function(){if(this.tree){return this.tree.getText();}else{return this.value;}},initComponent:function(){if(this.loaderBaseParams){Ext.apply(this.treeConfig.loader,{baseParams:this.loaderBaseParams});}var b={tree:new Ext.ux.tree.CheckTreePanel(this.treeConfig)};b.tree.loader.on({load:{scope:this,fn:function(a,d){this.tree.loaded=true;this.setValue(this.value);}}});b.tree.on({checkchange:{scope:this,delay:20,fn:this.onCheckChange}});Ext.apply(this,Ext.apply(this.initialConfig,b));Ext.ux.form.CheckTreeCombo.superclass.initComponent.apply(this,arguments);this.addEvents("expand","collapse");},initList:function(){if(this.list){return;}var d="x-combo-list";this.list=new Ext.Layer({shadow:this.shadow,cls:[d,this.listClass].join(" "),constrain:false});var c=this.listWidth||Math.max(this.wrap.getWidth(),this.minListWidth);this.innerList=this.list.createChild({cls:d+"-inner"});this.setListSize(c,this.listHeight);if(this.resizable){this.resizer=new Ext.Resizable(this.list,{pinned:true,handles:"se"});this.resizer.on("resize",function(a,f,b){this.setListSize(f,b);},this);}},isExpanded:function(){return this.list&&this.list.isVisible();},onCheckChange:function(c,d){this.el.focus();this.el.dom.select();return;},onDestroy:function(){if(this.tree){this.tree.destroy();}if(this.list){this.list.destroy();}},onKeyUp:function(h,e){var g=this.getRawValue();if(h.ESC===h.getKey()||!g){this.clearFilter();this.setRawValue();}else{if(this.tree.filter){this.clearFilter();this.expand();var f=new RegExp(".*"+g+".*","i");this.tree.filter.filter(f,"text");}}},onRender:function(){Ext.ux.form.CheckTreeCombo.superclass.onRender.apply(this,arguments);(function(){this.initList();if(!this.tree.rendered){this.tree.render(this.innerList);this.tree.setHeight(this.innerList.getHeight()-this.list.getFrameWidth("tb"));}}.defer(1,this));this.el.on("keyup",this.onKeyUp,this,{buffer:180});},onTriggerClick:function(){if(this.disabled){return;}if(this.isExpanded()){this.collapse();this.el.focus();}else{this.expand();}},setListSize:function(e,f){var d=this.resizable?this.handleHeight:0;this.list.setSize(e,f);this.innerList.setSize(e-d-this.list.getFrameWidth("lr"),f-d);if(this.tree){this.tree.setHeight(f-this.list.getFrameWidth("tb")-d);}},setValue:function(){if(this.tree.loaded){this.value=this.tree.setValue.apply(this.tree,arguments);}else{this.value=this.tree.convertValue.apply(this.tree,arguments);}this.setRawValue();return this.value;},setRawValue:function(){if(this.el){var b=this.getText();Ext.ux.form.CheckTreeCombo.superclass.setRawValue.call(this,b);this.el.set({qtip:b});}},validateBlur:function(){return !this.list||!this.list.isVisible();}});