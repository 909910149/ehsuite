ArchivesDocHistoryWin=Ext.extend(Ext.Window,{searchPanel:null,gridPanel:null,store:null,buttons:null,constructor:function(b){Ext.applyIf(this,b);this.initUIComponents();ArchivesDocHistoryWin.superclass.constructor.call(this,{id:"ArchivesDocHistoryWin",iconCls:"menu-archive-history",title:"版本管理",layout:"border",modal:true,height:400,border:false,width:600,bottons:this.bottons,buttonAlign:"center",items:[this.gridPanel]});},initUIComponents:function(){this.store=new Ext.data.JsonStore({url:__ctxPath+"/archive/listDocHistory.do",root:"result",baseParams:{"Q_archivesDoc.docId_L_EQ":this.docId},totalProperty:"totalCounts",remoteSort:true,fields:[{name:"historyId",type:"int"},"archivesDoc","fileAttach","docName","path","version","updatetime","mender"]});this.store.setDefaultSort("historyId","desc");this.store.load({params:{start:0,limit:25}});var c=new Ext.grid.CheckboxSelectionModel({singleSelect:true});var d=new Ext.grid.ColumnModel({columns:[c,new Ext.grid.RowNumberer(),{header:"historyId",dataIndex:"historyId",hidden:true},{header:"所属附件",dataIndex:"fileAttach",renderer:function(a){return a.fileName;}},{header:"文档名称",dataIndex:"docName"},{header:"版本",dataIndex:"version"},{header:"路径",dataIndex:"path"},{header:"更新时间",dataIndex:"updatetime"},{header:"修改人",dataIndex:"mender"}],defaults:{sortable:true,menuDisabled:false,width:100}});this.gridPanel=new Ext.grid.GridPanel({id:"DocHistoryGrid",region:"center",stripeRows:true,store:this.store,trackMouseOver:true,disableSelection:false,loadMask:true,cm:d,sm:c,plugins:this.rowActions,viewConfig:{forceFit:true,autoFill:true,forceFit:true},bbar:new Ext.PagingToolbar({pageSize:25,store:this.store,displayInfo:true,displayMsg:"当前页记录索引{0}-{1}， 共{2}条记录",emptyMsg:"当前没有记录"})});this.gridPanel.addListener("rowdblclick",function(b,e,a){b.getSelectionModel().each(function(f){new DocHistoryForm(f.data.historyId).show();});});this.buttons=[{iconCls:"btn-archive-history",text:"直接覆盖",xtype:"button",handler:this.copy.createCallback(this.gridPanel,this),scope:this},{iconCls:"btn-archive-copy",text:"修改覆盖",xtype:"button",handler:this.modify.createCallback(this.gridPanel,this),scope:this},{iconCls:"btn-del",text:"关闭",xtype:"button",handler:this.colseWIn.createCallback(this),scope:this}];},search:function(b){if(b.searchPanel.getForm().isValid()){$search({searchPanel:b.searchPanel,gridPanel:b.gridPanel});}},createRecord:function(){new DocHistoryForm().show();},copy:function(f,e){var h=f.getSelectionModel().getSelections();var g=e.callback;Ext.Ajax.request({url:__ctxPath+"/archive/copyArchivesDoc.do",params:{historyId:h[0].data.historyId},scope:this,method:"post",success:function(a){var b=Ext.util.JSON.decode(a.responseText);g.call(this,b.data);e.close();Ext.ux.Toast.msg("操作信息","success");},failure:function(){Ext.ux.Toast.msg("操作信息","操作出错,请联系管理员");}});},colseWIn:function(b){b.close();},modify:function(t,o){var q=t.getSelectionModel().getSelections();if(q.length==0){Ext.Msg.alert("信息","请选择要查看的文档！");return;}var p=q[0];var k=p.data.path;var s=p.data.archivesDoc.docId;var m=Ext.getCmp("archiveDocGrid").getStore();var r=p.data.fileAttach.fileId;var n=Ext.getCmp("ArchivesDraftWin");var l=function(a){m.reload();o.close();};new ArchivesDocForm({docId:s,docPath:k,fileId:r,callback:l}).show();}});