Ext.ns("BorrowFileListView");BorrowFileListView=Ext.extend(Ext.Panel,{constructor:function(b){Ext.applyIf(this,b);this.initUIComponents();BorrowFileListView.superclass.constructor.call(this,{layout:"fit",border:true,items:[this.gridPanel],frame:false,listeners:{afterlayout:function(a){a.store.on("load",function(g,h){var f=[];for(i=0;i<h.length;i++){f.push(h[i].data);}a.pageingStore.loadData({"success":true,"totalProperty":f.length,"result":f});a.gridPanel.getBottomToolbar().moveFirst();});}}});},initUIComponents:function(){var d=[{name:"listId",type:"int"},"recordId","listType","archFond","afNo","afName","archRoll","rollNo","rolllName","rollFile","fileNo","fileName"];this.pageingStore=new Ext.ux.data.JsonPagingStore({root:"result",totalProperty:"totalCounts",remoteSort:false,idProperty:"listId",fields:d});this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:__ctxPath+"/arch/listBorrowFileList.do?sno="+new Date(),method:"GET"}),root:"result",reader:new Ext.data.JsonReader({root:"result",fields:d})});var f=new Ext.grid.CheckboxSelectionModel();var e=new Ext.grid.ColumnModel({columns:[f,new Ext.grid.RowNumberer(),{header:"listId",dataIndex:"listId",hidden:true},{header:"借阅单位",dataIndex:"listType"},{header:"全宗ID",dataIndex:"archFond",hidden:true,renderer:function(a){if(a){return a.archFondId;}}},{header:"全宗号",dataIndex:"archFond",renderer:function(a){if(a){return a.afNo;}}},{header:"全宗名",dataIndex:"archFond",renderer:function(a){if(a){return a.afName;}}},{header:"案卷ID",hidden:true,dataIndex:"archRoll",renderer:function(a){if(a){return a.rollId;}}},{header:"案卷号",dataIndex:"archRoll",renderer:function(a){if(a){return a.rollNo;}}},{header:"案卷名",dataIndex:"archRoll",renderer:function(a){if(a){return a.rolllName;}}},{header:"文件ID",hidden:true,dataIndex:"rollFile",renderer:function(a){if(a){return a.rollFileId;}}},{header:"文件号",dataIndex:"fileNo"},{header:"文件题名",dataIndex:"fileName"}],defaults:{sortable:true,menuDisabled:false}});this.topbar=new Ext.Toolbar({items:[{xtype:"tbtext",text:"借阅清单"},{xtype:"tbseparator"},{iconCls:"btn-add",text:"全宗",hidden:(this.returnStatus==1)?true:false,xtype:"button",scope:this,handler:this.createFond},{iconCls:"btn-add",text:"案卷",hidden:(this.returnStatus==1)?true:false,xtype:"button",scope:this,handler:this.createRoll},{iconCls:"btn-add",text:"文件",hidden:(this.returnStatus==1)?true:false,xtype:"button",scope:this,handler:this.createFile},{iconCls:"btn-del",text:"删除",hidden:(this.returnStatus==1)?true:false,xtype:"button",scope:this,handler:this.removeSelRs}]});this.gridPanel=new Ext.grid.GridPanel({frame:false,border:false,tbar:this.topbar,store:this.pageingStore,cm:e,sm:f,viewConfig:{forceFit:true,autoFill:true},bbar:new HT.PagingBar({store:this.pageingStore}),listeners:{}});},createFond:function(){var f=this.pageingStore;var e=this.gridPanel;var d=this.removeByIds;new SelectFondWindow({callBack:function(h){if(f.allData){var a=Array();for(i=0;i<h.length;i++){for(j=0;j<f.allData.items.length;j++){if(f.allData.items[j].data.archRoll&&f.allData.items[j].data.archFond&&h[i].data.archFondId==f.allData.items[j].data.archFond.archFondId&&f.allData.items[j].data.listType=="案卷"){if(f.allData.items[j].data.listId!=""&&f.allData.items[j].data.listId!=null){a.push(f.allData.items[j].data.listId);}f.removeAt(j);f.commitChanges();j--;Ext.ux.Toast.msg("操作信息","所选案卷重覆！");}}for(j=0;j<f.allData.items.length;j++){if(f.allData.items[j].data.rollFile&&f.allData.items[j].data.archFond&&h[i].data.archFondId==f.allData.items[j].data.archFond.archFondId&&f.allData.items[j].data.listType=="文件"){if(f.allData.items[j].data.listId!=""&&f.allData.items[j].data.listId!=null){a.push(f.allData.items[j].data.listId);}f.removeAt(j);f.commitChanges();j--;Ext.ux.Toast.msg("操作信息","所选文件重覆！");}}for(j=0;j<f.allData.items.length;j++){if(f.allData.items[j].data.archFond&&h[i].data.archFondId==f.allData.items[j].data.archFond.archFondId&&f.allData.items[j].data.listType=="全宗"){h.splice(i,1);i--;Ext.ux.Toast.msg("操作信息","所选全宗重覆！");break;}}}f.commitChanges();if(a.length>0){d(a);}}for(i=0;i<h.length;i++){var b=new f.recordType();b.data={};b.data.listType="全宗";var c={};Ext.apply(c,{archFondId:h[i].data.archFondId,afNo:h[i].data.afNo,afName:h[i].data.afName});Ext.apply(b.data,{archFond:c});b.data.afNo=h[i].data.afNo;b.data.afName=h[i].data.afName;f.add(b);}f.commitChanges();e.getBottomToolbar().moveFirst();e.getView().refresh();e.doLayout(true,true);}}).show();},createRoll:function(){var f=this.pageingStore;var e=this.gridPanel;var d=this.removeByIds;new SelectRollWindow({callBack:function(l){if(f.allData){var b=Array();for(i=0;i<l.length;i++){for(j=0;j<f.allData.items.length;j++){if(f.allData.items[j].data.rollFile&&f.allData.items[j].data.archRoll&&l[i].data.rollId==f.allData.items[j].data.archRoll.rollId&&f.allData.items[j].data.listType=="文件"){if(f.allData.items[j].data.listId!=""&&f.allData.items[j].data.listId!=null){b.push(f.allData.items[j].data.listId);}f.removeAt(j);f.commitChanges();j--;Ext.ux.Toast.msg("操作信息","所选文件重覆！");}}for(j=0;j<f.allData.items.length;j++){if(f.allData.items[j].data.archRoll&&l[i].data.rollId==f.allData.items[j].data.archRoll.rollId&&f.allData.items[j].data.listType=="案卷"){l.splice(i,1);i--;Ext.ux.Toast.msg("操作信息","所选案卷重覆！");break;}}for(j=0;j<f.allData.items.length;j++){if(f.allData.items[j].data.archFond&&l[i].data.archFond.archFondId==f.allData.items[j].data.archFond.archFondId&&f.allData.items[j].data.listType=="全宗"){l.splice(i,1);i--;Ext.ux.Toast.msg("操作信息","所选案卷重覆！");break;}}}f.commitChanges();if(b.length>0){d(b);}}for(i=0;i<l.length;i++){var c=new f.recordType();c.data={};c.data.listType="案卷";var k={};Ext.apply(k,{archFondId:l[i].data.archFond.archFondId,afNo:l[i].data.archFond.afNo,afName:l[i].data.archFond.afName});Ext.apply(c.data,{archFond:k});c.data.afNo=l[i].data.archFond.afNo;c.data.afName=l[i].data.archFond.afName;var a={};Ext.apply(a,{rollId:l[i].data.rollId,rollNo:l[i].data.rollNo,rolllName:l[i].data.rollNo});Ext.apply(c.data,{archRoll:a});c.data.rollNo=l[i].data.rollNo;c.data.rolllName=l[i].data.rollNo;f.add(c);}f.commitChanges();e.getBottomToolbar().moveFirst();e.getView().refresh();e.doLayout(true,true);}}).show();},createFile:function(){var c=this.pageingStore;var d=this.gridPanel;new SelectFileWindow({callBack:function(l){if(c.allData){for(i=0;i<l.length;i++){for(j=0;j<c.allData.items.length;j++){if(c.allData.items[j].data.rollFile&&l[i].data.rollFileId==c.allData.items[j].data.rollFile.rollFileId&&c.allData.items[j].data.listType=="文件"){l.splice(i,1);i--;Ext.ux.Toast.msg("操作信息","所选文件重覆！");break;}}for(j=0;j<c.allData.items.length;j++){if(c.allData.items[j].data.archFond&&l[i].data.archRoll.archFond.archFondId==c.allData.items[j].data.archFond.archFondId&&c.allData.items[j].data.listType=="全宗"){l.splice(i,1);i--;Ext.ux.Toast.msg("操作信息","所选案卷重覆！");break;}}for(j=0;j<c.allData.items.length;j++){if(c.allData.items[j].data.archRoll&&l[i].data.archRoll.rollId==c.allData.items[j].data.archRoll.rollId&&c.allData.items[j].data.listType=="案卷"){l.splice(i,1);i--;Ext.ux.Toast.msg("操作信息","所选案卷重覆！");break;}}}c.commitChanges();}for(i=0;i<l.length;i++){var h=new c.recordType();h.data={};h.data.listType="文件";if(l[i].data.archRoll){var a={};Ext.apply(a,{rollId:l[i].data.archRoll.rollId,rollNo:l[i].data.archRoll.rollNo,rolllName:l[i].data.archRoll.rolllName});Ext.apply(h.data,{archRoll:a});h.data.rollNo=l[i].data.archRoll.rollNo;h.data.rolllName=l[i].data.archRoll.rolllName;if(l[i].data.archRoll.archFond){var k={};Ext.apply(k,{archFondId:l[i].data.archRoll.archFond.archFondId,afNo:l[i].data.archRoll.archFond.afNo,afName:l[i].data.archRoll.archFond.afName});Ext.apply(h.data,{archFond:k});h.data.afNo=l[i].data.archRoll.archFond.afNo;h.data.afName=l[i].data.archRoll.archFond.afName;}}var b={};Ext.apply(b,{rollFileId:l[i].data.rollFileId});Ext.apply(h.data,{rollFile:b});h.data.fileNo=l[i].data.fileNo;h.data.fileName=l[i].data.fileName;c.add(h);}c.commitChanges();d.getBottomToolbar().moveFirst();d.getView().refresh();d.doLayout(true,true);}}).show();},removeByIds:function(b){Ext.Ajax.request({url:__ctxPath+"/arch/multiDelBorrowFileList.do",params:{ids:b},method:"POST",success:function(a,d){Ext.ux.Toast.msg("操作信息","成功删除该明细！");},failure:function(a,d){Ext.ux.Toast.msg("操作信息","操作出错，请联系管理员！");}});},removeSelRs:function(){Ext.Msg.confirm("信息确认","您确认要删除所选记录吗？",function(m){if(m=="yes"){var n=this.gridPanel;var k=n.getStore();var h=n.getSelectionModel().getSelections();if(h.length==0){Ext.ux.Toast.msg("信息","请选择要删除的记录！");return;}var l=Array();for(var g=0;g<h.length;g++){if(h[g].data.listId!=""&&h[g].data.listId!=null){l.push(h[g].data.listId);k.remove(h[g]);}else{k.remove(h[g]);}}if(l.length>0){this.removeByIds(l);}n.getBottomToolbar().moveFirst();}},this);}});