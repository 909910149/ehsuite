Ext.ns("MailView");var MailView=function(){};MailView.prototype.getView=function(){return new Ext.Panel({id:"MailView",title:"[收件箱]",border:false,layout:"border",items:[new Ext.FormPanel({height:40,region:"north",frame:false,id:"MailSearchForm",layout:"hbox",layoutConfig:{padding:"5",align:"middle"},defaults:{xtype:"label",margins:{top:0,right:4,bottom:4,left:4}},items:[{text:"查询条件:"},{text:"邮件标题"},{width:140,xtype:"textfield",name:"Q_mail.subject_S_LK"},{text:"发件人"},{width:80,xtype:"textfield",name:"Q_mail.sender_S_LK"},{text:"收件人"},{width:80,xtype:"textfield",name:"Q_appUser.fullname_S_LK"},{xtype:"button",text:"查询",iconCls:"search",handler:function(){var d=Ext.getCmp("MailSearchForm");var c=Ext.getCmp("MailGrid");if(d.getForm().isValid()){$search({searchPanel:d,gridPanel:c});}}}]}),this.setup()]});};MailView.prototype.setFolderId=function(b){this.folderId=b;MailView.folderId=b;};MailView.prototype.getFolderId=function(){return this.folderId;};MailView.prototype.setup=function(){return this.grid();};MailView.prototype.grid=function(){var h=new Ext.ux.grid.RowExpander({tpl:new Ext.Template('<div style="padding:5px 5px 5px 62px;"><b>内容摘要:</b> {content}</div>')});var i=new Ext.grid.CheckboxSelectionModel();var g=new Ext.grid.ColumnModel({columns:[i,new Ext.grid.RowNumberer(),h,{header:"mailId",dataIndex:"mailId",hidden:true},{header:"优先级",dataIndex:"importantFlag",width:55,renderer:function(c,d,l,a,e){var b="";if(c==2){b+='<img title="重要" src="'+__ctxPath+'/images/flag/mail/important.png"/>';}else{if(c==3){b+='<img title="非常重要" src="'+__ctxPath+'/images/flag/mail/veryImportant.png"/>';}else{b+='<img title="一般" src="'+__ctxPath+'/images/flag/mail/common.png"/>';}}return b;}},{header:"阅读",dataIndex:"mailStatus",width:40,renderer:function(c,d,l,a,e){var b="";if(c!=0){if(l.data.readFlag==0){b+='<img title="未读" src="'+__ctxPath+'/images/flag/mail/mail.png"/>';}else{b+='<img title="已读" src="'+__ctxPath+'/images/flag/mail/mail_open.png"/>';}}else{b+='<img title="草稿" src="'+__ctxPath+'/images/flag/mail/mail_draft.png"/>';}return b;}},{header:"附件",dataIndex:"fileIds",width:40,renderer:function(c,d,l,a,e){var b="";if(c!=""){b+='<img title="附件" src="'+__ctxPath+'/images/flag/attachment.png"/>';}return b;}},{header:"回复",dataIndex:"replyFlag",width:40,renderer:function(c,d,l,a,e){var b="";if(c==1){b+='<img title="已回复" src="'+__ctxPath+'/images/flag/mail/replyed.png" style="background: white;"/>';}return b;}},{header:"邮件主题",dataIndex:"subject",width:150},{header:"发件人",dataIndex:"sender",width:80},{header:"收件人",dataIndex:"recipientNames",width:80,renderer:function(a){if(a!=""){return a;}else{return"(收信人未写)";}}},{header:"发信时间",width:80,dataIndex:"sendTime",renderer:function(a){return a.substring(0,10);}},{header:"管理",dataIndex:"mailId",width:60,renderer:function(c,d,q,e,a){var t=MailView.folderId;var r=c;var b=q.data.boxId;var s=q.data.mailStatus;var p='<button title="删除" value=" " class="btn-del" onclick="MailView.remove('+b+","+t+')">&nbsp</button>';p+='&nbsp;<button title="查看" value=" " class="btn-mail_edit" onclick="MailView.edit('+r+","+b+","+t+","+s+","+e+')">&nbsp</button>';return p;}}],defaults:{sortable:true,menuDisabled:false,width:100}});var f=this.store();f.load({params:{start:0,limit:25}});var j=new Ext.grid.GridPanel({id:"MailGrid",border:false,region:"center",tbar:this.topbar(),store:f,plugins:h,trackMouseOver:true,disableSelection:false,loadMask:true,stripeRows:true,cm:g,sm:i,viewConfig:{forceFit:true,autoFill:true,forceFit:true},bbar:new HT.PagingBar({store:f})});j.addListener("rowdblclick",function(c,a,b){c.getSelectionModel().each(function(d){var e=MailView.folderId;MailView.edit(d.data.mailId,d.data.boxId,e,d.data.mailStatus,a);});});return j;};MailView.prototype.store=function(){var b=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:__ctxPath+"/communicate/listMail.do"}),reader:new Ext.data.JsonReader({root:"result",totalProperty:"totalCounts",id:"id",fields:[{name:"boxId",type:"int"},{name:"mailId",type:"int"},{name:"delFlag",type:"int"},{name:"readFlag",type:"int"},{name:"replyFlag",type:"int"},"importantFlag","mailStatus","sendTime","fileIds","subject","recipientNames","content","sender"]}),remoteSort:true});b.setDefaultSort("boxId","desc");return b;};MailView.prototype.topbar=function(){var b=new Ext.Toolbar({id:"MailFootBar",height:30,bodyStyle:"text-align:left",items:[{iconCls:"btn-mail_remove",text:"删除",xtype:"button",handler:function(){var h=Ext.getCmp("MailGrid");var a=h.getSelectionModel().getSelections();if(a.length==0){Ext.ux.Toast.msg("信息","请选择要删除的记录！");return;}var g=Array();for(var i=0;i<a.length;i++){g.push(a[i].data.boxId);}var j=MailView.folderId;MailView.remove(g,j);}},{iconCls:"btn-mail_move",text:"移至",handler:function(){var g=Ext.getCmp("MailGrid");var a=g.getSelectionModel().getSelections();if(a.length==0){Ext.ux.Toast.msg("信息","请选择要移动的邮件！");return;}var f=Array();for(var h=0;h<a.length;h++){f.push(a[h].data.boxId);}MailView.moveTo(f);}},{iconCls:"btn-mail_refresh",text:"刷新",handler:function(){Ext.getCmp("MailGrid").getStore().reload({params:{start:0,limit:25}});}}]});return b;};MailView.remove=function(h,f){if(f==null||f=="undefined"){f=1;}var e=Ext.getCmp("MailGrid");var g="";if(f==4){g="删除箱的记录一旦删除,将不可恢复!";}Ext.Msg.confirm("信息确认",g+"您确认要删除该记录吗？",function(b){if(b=="yes"){Ext.Ajax.request({url:__ctxPath+"/communicate/multiDelMail.do",params:{ids:h,folderId:f},method:"post",success:function(){Ext.ux.Toast.msg("信息提示","成功删除所选记录！");e.getStore().reload({params:{start:0,limit:25}});}});var c=Ext.getCmp("MailCenterView");c.remove("ShowMailDetail");var a=Ext.getCmp("MailView");a.show();c.doLayout();}});};MailView.edit=function(s,l,v,r,o){var q=new MailView.centerViewToolbar(s,l,v,o);if(r==0){var t=Ext.getCmp("centerTabPanel");var u=Ext.getCmp("MailForm");if(u==null){u=new MailForm(s,l,"draft");t.add(u);t.activate(u);}else{t.remove(u);u=new MailForm(s,l,"draft");t.add(u);t.activate(u);}}else{var n=Ext.getCmp("MailCenterView");var m=Ext.getCmp("MailView");m.hide();var p=new Ext.Panel({id:"ShowMailDetail",title:"[邮件信息]",border:false,tbar:q,autoLoad:{url:__ctxPath+"/communicate/getMail.do?",params:{mailId:s,boxId:l},method:"Post"}});n.add(p);n.doLayout();}};MailView.centerViewToolbar=function(f,i,g,h){var j=new Ext.Toolbar({height:30,defaultType:"button",bodyStyle:"text-align:left",items:[{iconCls:"btn-mail_back",text:"返回",handler:function(){var b=Ext.getCmp("MailCenterView");b.remove("ShowMailDetail");var a=Ext.getCmp("MailView");a.show();b.doLayout();}},{iconCls:"btn-mail_reply",text:"回复",handler:function(){var b=Ext.getCmp("centerTabPanel");var a=Ext.getCmp("MailForm");if(a==null){a=new MailForm(f,i,"reply");b.add(a);b.activate(a);}else{b.remove(a);a=new MailForm(f,i,"reply");b.add(a);b.activate(a);}}},{iconCls:"btn-mail_resend",text:"转发",handler:function(){var b=Ext.getCmp("centerTabPanel");var a=Ext.getCmp("MailForm");if(a==null){a=new MailForm(f,i,"forward");b.add(a);b.activate(a);}else{b.remove(a);a=new MailForm(f,i,"forward");b.add(a);b.activate(a);}}},{iconCls:"btn-mail_remove",text:"删除",handler:function(){MailView.remove(i,g);}},{iconCls:"btn-mail_move",text:"移至",handler:function(){MailView.moveTo(i);}},"->",{iconCls:"btn-up",text:"较旧一封",handler:function(){var c=document.getElementById("__haveNextMailFlag");if(c!=null&&c.value!="endPre"){var b=curUserInfo.userId;var a=document.getElementById("__curBoxId").value;Ext.getCmp("ShowMailDetail").load({url:__ctxPath+"/communicate/getMail.do?",params:{boxId:a,opt:"_pre",folderId:g},method:"Post"});}else{Ext.ux.Toast.msg("提示信息","这里已经是第一封邮件了");}}},{iconCls:"btn-last",text:"较新一封",handler:function(){var c=document.getElementById("__haveNextMailFlag");if(c!=null&&c.value!="endNext"){var b=curUserInfo.userId;var a=document.getElementById("__curBoxId").value;Ext.getCmp("ShowMailDetail").load({url:__ctxPath+"/communicate/getMail.do?",params:{boxId:a,opt:"_next",folderId:g},method:"Post"});}else{Ext.ux.Toast.msg("提示信息","这里已经是最后一封邮件了");}}}]});return j;};MailView.moveTo=function(f){var d=new MailView.moveFormPanel(f);var e=new Ext.Window({x:350,y:100,width:340,height:300,title:"移动邮件",iconCls:"btn-mail_move",modal:true,buttonAlign:"center",plain:true,layout:"fit",border:false,bodyStyle:"padding:5px;",items:[d],buttons:[{text:"确定移动",iconCls:"btn-mail_move",handler:function(){var b=Ext.getCmp("folderId");if(b==""&&b!=null&&b!="undefined"){Ext.ux.Toast.msg("操作信息","请先选择文件夹");}else{var a=Ext.getCmp("moveFolderForm");a.getForm().submit({waitMsg:"正在提交用户信息",success:function(j,c){Ext.ux.Toast.msg("操作信息","移动成功！");e.close();var l=Ext.getCmp("MailCenterView");l.remove("ShowMailDetail");var k=Ext.getCmp("MailView");Ext.getCmp("MailGrid").getStore().reload({params:{start:0,limit:25}});k.show();l.doLayout();},failure:function(h,c){Ext.ux.Toast.msg("提示信息",c.result.msg);}});}}},{text:"取消",iconCls:"btn-del",handler:function(){e.close();}}]});e.show();};MailView.moveFormPanel=function(d){var f=new Ext.tree.TreePanel({title:"请选择文件夹",loader:new Ext.tree.TreeLoader({url:__ctxPath+"/communicate/listMailFolder.do"}),root:new Ext.tree.AsyncTreeNode({expanded:true}),rootVisible:false,listeners:{"click":function(a){if(a!=null&&a.id!=0){Ext.getCmp("dispalyFolderName").setValue(a.text);Ext.getCmp("folderId").setValue(a.id);}}}});var e=new Ext.FormPanel({url:__ctxPath+"/communicate/moveMail.do",layout:"table",id:"moveFolderForm",frame:true,defaultType:"textfield",layoutConfig:{columns:1},defaults:{width:296},items:[{xtype:"label",text:"移至:"},{id:"dispalyFolderName",readOnly:true},{xtype:"hidden",id:"folderId",name:"folderId"},{id:"boxIds",name:"boxIds",xtype:"hidden",value:d},{xtype:"panel",items:[f]}]});return e;};