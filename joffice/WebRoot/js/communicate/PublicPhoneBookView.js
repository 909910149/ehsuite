Ext.DataView.DragSelector=function(y){y=y||{};var v,w,t;var A,u,s=new Ext.lib.Region(0,0,0,0);var C=y.dragSafe===true;this.init=function(a){v=a;v.on("render",p);};function r(){A=[];v.all.each(function(a){A[A.length]=a.getRegion();});u=v.el.getRegion();}function z(){return false;}function x(a){return !C||a.target==v.el.dom;}function q(a){v.on("containerclick",z,v,{single:true});if(!w){w=v.el.createChild({cls:"x-view-selector"});}else{if(w.dom.parentNode!==v.el.dom){v.el.dom.appendChild(w.dom);}w.setDisplayed("block");}r();v.clearSelections();}function B(h){var g=t.startXY;var a=t.getXY();var e=Math.min(g[0],a[0]);var f=Math.min(g[1],a[1]);var c=Math.abs(g[0]-a[0]);var j=Math.abs(g[1]-a[1]);s.left=e;s.top=f;s.right=e+c;s.bottom=f+j;s.constrainTo(u);w.setRegion(s);for(var k=0,i=A.length;k<i;k++){var d=A[k];var b=s.intersect(d);if(b&&!d.selected){d.selected=true;v.select(k,true);}else{if(!b&&d.selected){d.selected=false;v.deselect(k);}}}}function D(a){if(!Ext.isIE){v.un("containerclick",z,v);}if(w){w.setDisplayed(false);}}function p(a){t=new Ext.dd.DragTracker({onBeforeStart:x,onStart:q,onDrag:B,onEnd:D});t.initEl(a.el);}};Ext.ns("PublicPhoneBookView");PublicPhoneBookView=Ext.extend(Ext.Panel,{treePanel:null,phoneBookView:null,selectedNode:null,dataView:null,searchPanel:null,store:null,phoneBookPanel:null,constructor:function(b){Ext.applyIf(this,b);this.initUI();PublicPhoneBookView.superclass.constructor.call(this,{title:"公共通讯薄",iconCls:"menu-personal-phoneBook",layout:"border",id:"PublicPhoneBookView",height:800,items:[this.treePanel,this.phoneBookView]});},initUI:function(){this.toolbar=new Ext.Toolbar({items:[{xtype:"button",iconCls:"btn-refresh",text:"刷新",scope:this,handler:function(){this.treePanel.root.reload();}},{xtype:"button",text:"展开",iconCls:"btn-expand",scope:this,handler:function(){this.treePanel.expandAll();}},{xtype:"button",text:"收起",scope:this,iconCls:"btn-collapse",handler:function(){this.treePanel.collapseAll();}}]});this.treePanel=new Ext.tree.TreePanel({region:"west",id:"leftPublicBookPanel",title:"通讯簿分类",collapsible:true,split:true,width:160,height:800,tbar:this.toolbar,loader:new Ext.tree.TreeLoader({url:__ctxPath+"/communicate/listPhoneGroup.do?isPublic=true"}),root:new Ext.tree.AsyncTreeNode({expanded:true}),rootVisible:false,listeners:{scope:this,"click":this.clickNode}});this.treePanel.on("contextmenu",this.contextmenu,this);this.searchPanel=new Ext.FormPanel({height:40,region:"north",frame:false,border:false,layout:"hbox",layoutConfig:{padding:"5",align:"middle"},defaults:{xtype:"label",margins:{top:0,right:4,bottom:4,left:4}},items:[{text:"请输入查询条件:"},{text:"姓名"},{xtype:"textfield",name:"Q_fullname_S_LK"},{text:"称谓"},{xtype:"textfield",name:"Q_title_S_LK",xtype:"combo",anchor:"95%",mode:"local",triggerAction:"all",store:["先生","女士"]},{xtype:"button",text:"查询",iconCls:"search",handler:this.search.createCallback(this)},{xtype:"hidden",name:"Q_phoneGroup.isPublic_SN_EQ",value:1}]});this.store=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:__ctxPath+"/communicate/listPhoneBook.do"}),baseParams:{"Q_phoneGroup.isPublic_SN_EQ":1},reader:new Ext.data.JsonReader({root:"result",totalProperty:"totalCounts",id:"id",fields:[{name:"phoneId",type:"int"},"fullname","title","birthday","nickName","duty","spouse","childs","companyName","companyAddress","companyPhone","companyFax","homeAddress","homeZip","mobile","phone","email","qqNumber","msn","note","userId","groupId","isShared"]}),remoteSort:true});this.store.setDefaultSort("phoneId","desc");this.store.load({params:{start:0,limit:15}});this.dataView=new Ext.DataView({store:this.store,tpl:new Ext.XTemplate('<tpl for=".">','<div class="thumb-wrap" id="{phoneId}">',"<span><font>姓名&nbsp;：</font>{fullname}</span>","<span><font>手机&nbsp;：</font>{mobile}</span>","<span><font>电话&nbsp;：</font>{phone}</span>","<span><font>Email：</font>{email}</span>","<span><font>QQ&nbsp;&nbsp;&nbsp;：</font>{qqNumber}</span>","<span><font>MSN&nbsp;&nbsp;：</font>{msn}</span>","</div>","</tpl>"),autoScroll:true,multiSelect:true,overClass:"x-view-over",itemSelector:"div.thumb-wrap",emptyText:"目前尚无记录",plugins:[new Ext.DataView.DragSelector()],listeners:{"dblclick":{fn:this.editRecord.createCallback(this),scope:this},"contextmenu":{fn:this.showMenu,scope:this}}});this.toolbar=new Ext.Toolbar({height:28,bodyStyle:"text-align:left",items:[{iconCls:"btn-add",xtype:"button",text:"添加公共联系人",handler:this.createRecord},{iconCls:"btn-del",xtype:"button",text:"删除公共联系人",handler:this.deleteRecord.createCallback(this)}]});this.phoneBookPanel=new Ext.Panel({region:"center",tbar:this.toolbar,layout:"fit",items:this.dataView,bbar:new Ext.PagingToolbar({pageSize:15,store:this.store,displayInfo:true,displayMsg:"当前显示从{0}至{1}， 共{2}条记录",emptyMsg:"当前没有记录"})});this.phoneBookView=new Ext.Panel({title:"联系人列表",region:"center",layout:"border",items:[this.searchPanel,this.phoneBookPanel]});},clickNode:function(f){if(f!=null){var d=this.phoneBookView;if(f.id==0){d.setTitle("所有联系人");}else{d.setTitle(f.text+"组列表");}var e=this.dataView.getStore();e.url=__ctxPath+"/communicate/listPhoneBook.do";e.baseParams={"Q_phoneGroup.groupId_L_EQ":f.id>0?f.id:"","Q_phoneGroup.isPublic_SN_EQ":1};e.reload({params:{start:0,limit:15}});}},contextmenu:function(e,d){var f=new Ext.menu.Menu({items:[{text:"新建组",scope:this,iconCls:"btn-add",handler:this.createNode},{text:"修改组",scope:this,iconCls:"btn-edit",handler:this.editNode},{text:"删除组",scope:this,iconCls:"btn-delete",handler:this.deleteNode}]});this.selectedNode=new Ext.tree.TreeNode({id:e.id,text:e.text});f.showAt(d.getXY());},createNode:function(){new PublicPhoneGroupForm().show();},editNode:function(){var b=this.selectedNode.id;if(b>0){new PublicPhoneGroupForm({groupId:b}).show();}else{Ext.MessageBox.show({title:"操作信息",msg:"该处不能被修改",buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});}},deleteNode:function(){var d=this.selectedNode.id;var f=this.treePanel;var e=this.phoneBookView;Ext.Ajax.request({url:__ctxPath+"/communicate/countPhoneGroup.do",params:{"Q_phoneGroup.groupId_L_EQ":d},method:"post",success:function(c,a){var b=Ext.util.JSON.decode(c.responseText).count;Ext.Msg.confirm("删除操作","组里还有"+b+"个联系人，你确定删除目录组吗?",function(h){if(h=="yes"){Ext.Ajax.request({url:__ctxPath+"/communicate/multiDelPhoneGroup.do",params:{ids:d},method:"post",success:function(l,g){Ext.ux.Toast.msg("操作信息","成功删除目录！");f.root.reload();var k=e.dataView.getStore();k.reload({params:{start:0,limit:15}});},failure:function(j,g){Ext.MessageBox.show({title:"操作信息",msg:"信息保存出错，请联系管理员！",buttons:Ext.MessageBox.OK,icon:"ext-mb-error"});}});}});},failure:function(b,a){}});},upMove:function(){var b=this.selectedNode.id;this.moveTO(this.treePanel,b,1);},downMove:function(){var b=this.selectedNode.id;this.moveTO(this.treePanel,b,2);},topMove:function(){var b=this.selectedNode.id;this.moveTO(this.treePanel,b,3);},underMove:function(){var b=this.selectedNode.id;this.moveTO(this.treePanel,b,4);},moveTO:function(d,e,f){Ext.Ajax.request({url:__ctxPath+"/communicate/movePhoneGroup.do",params:{groupId:e,optId:f},method:"post",success:function(b,a){d.root.reload();},failure:function(b,a){}});},search:function(j){var g=j.searchPanel;if(g.getForm().isValid()){var f=j.dataView.getStore();var h=Ext.Ajax.serializeForm(g.getForm().getEl());var i=Ext.urlDecode(h);i.start=0;i.limit=15;f.baseParams=i;j.phoneBookPanel.getBottomToolbar().moveFirst();}},showMenu:function(i,n,l,j){var e=i.getSelectedNodes();if(e.length<2){i.all.each(function(a){i.deselect(a);});i.select(n,true);}e=i.getSelectedNodes();if(e!=""&&e!=null&&e!="undefined"){var m=new Array();if(e.length==1){m.push({text:"修改",scope:this,iconCls:"btn-edit",handler:this.editRecord.createCallback(this)});}m.push({text:"删除",scope:this,iconCls:"btn-delete",handler:this.deleteRecord.createCallback(this)});var k=new Ext.menu.Menu({items:m});k.showAt(j.getXY());}},createRecord:function(){new PhoneBookForm({isPublic:true}).show();},editRecord:function(d){var e=d.dataView.getSelectedNodes();if(e!=""&&e!=null&&e!="undefined"){var f=e[0].id;new PhoneBookForm({phoneId:f,isPublic:true}).show();}},deleteRecord:function(j){var f=j.dataView.getSelectedNodes();var g=j.dataView.getStore();if(f!=""&&f!=null&&f!="undefined"){var h=new Array();for(var i=0;i<f.length;i++){h.push(f[i].id);}Ext.Msg.confirm("信息确认","您确认要删除该记录吗？",function(a){if(a=="yes"){Ext.Ajax.request({url:__ctxPath+"/communicate/multiDelPhoneBook.do",params:{ids:h},method:"post",success:function(){Ext.ux.Toast.msg("信息提示","成功删除所选记录！");g.reload({params:{start:0,limit:15}});}});}});}else{Ext.ux.Toast.msg("信息提示","请选择删除记录！");}}});