Ext.ns("OutMailView");var OutMailView=function(){};OutMailView.prototype.getView=function(){return new Ext.Panel({id:"OutMailView",title:"[收件箱]",autoScroll:true,border:false,layout:"border",items:[new Ext.FormPanel({id:"OutMailSearchForm",height:40,region:"north",frame:false,layout:"column",layoutConfig:{align:"middle"},bodyStyle:"padding:10px 10px 10px 10px",defaults:{xtype:"label"},items:[{text:"查询条件:"},{text:"邮件标题"},{width:80,xtype:"textfield",name:"Q_title_S_LK"},{text:"发件人"},{width:80,xtype:"textfield",name:"Q_senderName_S_LK"},{text:"收件人"},{width:80,xtype:"textfield",name:"Q_receiverNames_S_LK"},{xtype:"hidden",id:"Q_outMailFolder.folderId_L_EQ",name:"Q_outMailFolder.folderId_L_EQ"},{xtype:"button",text:"查询",iconCls:"search",handler:function(){var d=Ext.getCmp("OutMailSearchForm");var c=Ext.getCmp("OutMailGrid");if(d.getForm().isValid()){d.getForm().submit({waitMsg:"正在提交查询",url:__ctxPath+"/communicate/listOutMail_.do",params:{folderId:Ext.getCmp("OutMailSearchForm").getForm().findField("Q_outMailFolder.folderId_L_EQ").getValue()},success:function(b,a){var f=Ext.util.JSON.decode(a.response.responseText);c.getStore().loadData(f);}});}}}]}),this.setup()]});};OutMailView.prototype.setFolderId=function(b){this.folderId=b;OutMailView.folderId=b;};OutMailView.prototype.getFolderId=function(){return this.folderId;};OutMailView.prototype.setup=function(){return this.grid();};OutMailView.prototype.grid=function(){var h=new Ext.ux.grid.RowExpander({tpl:new Ext.Template('<div style="padding:5px 5px 5px 62px;"><b>内容摘要:</b> {content}</div>')});var i=new Ext.grid.CheckboxSelectionModel();var g=new Ext.grid.ColumnModel({columns:[i,new Ext.grid.RowNumberer(),h,{header:"mailId",dataIndex:"mailId",hidden:true},{header:"阅读",dataIndex:"readFlag",width:40,renderer:function(c,d,l,a,e){var b="";if(c!=0){if(l.data.readFlag==0){b+='<img title="未读" src="'+__ctxPath+'/images/flag/mail/mail.png"/>';}else{b+='<img title="已读" src="'+__ctxPath+'/images/flag/mail/mail_open.png"/>';}}else{b+='<img title="草稿" src="'+__ctxPath+'/images/flag/mail/mail_draft.png"/>';}return b;}},{header:"附件",dataIndex:"fileIds",width:40,renderer:function(c,d,l,a,e){var b="";if(c!=""&&c!="null"){b+='<img title="附件" src="'+__ctxPath+'/images/flag/attachment.png"/>';}return b;}},{header:"回复",dataIndex:"replyFlag",width:40,renderer:function(c,d,l,a,e){var b="";if(c==1){b+='<img title="已回复" src="'+__ctxPath+'/images/flag/mail/replyed.png" style="background: white;"/>';}return b;}},{header:"邮件主题",dataIndex:"title",width:150},{header:"发件人",dataIndex:"senderName",width:80},{header:"收件人",dataIndex:"receiverNames",width:80,renderer:function(a){if(a!=""){return a;}else{return"(收信人未写)";}}},{header:"发信时间",width:80,dataIndex:"mailDate",renderer:function(a){return a.substring(0,10);}},{header:"管理",dataIndex:"mailId",width:60,renderer:function(b,c,o,d,a){var r=OutMailView.folderId;var p=b;var q=o.data.mailId;var e='<button title="删除" value=" " class="btn-del" onclick="OutMailView.remove('+q+","+r+')">&nbsp</button>';e+='&nbsp;<button title="查看" value=" " class="btn-mail_edit" onclick="OutMailView.edit('+p+","+r+","+d+')">&nbsp</button>';return e;}}],defaults:{sortable:true,menuDisabled:false}});var f=this.store();f.load({params:{isFetch:null,start:0,limit:25}});var j=new Ext.grid.GridPanel({id:"OutMailGrid",region:"center",tbar:this.topbar(),store:f,plugins:h,trackMouseOver:true,disableSelection:false,loadMask:true,stripeRows:true,cm:g,sm:i,viewConfig:{forceFit:true,autoFill:true,forceFit:true},bbar:new Ext.PagingToolbar({pageSize:25,displayInfo:true,displayMsg:"当前显示从{0}至{1}， 共{2}条记录",emptyMsg:"当前没有记录",store:f})});j.addListener("rowdblclick",function(c,a,b){c.getSelectionModel().each(function(d){var e=OutMailView.folderId;OutMailView.edit(d.data.mailId,e,a);});});return j;};OutMailView.prototype.store=function(){var b=new Ext.data.Store({proxy:new Ext.data.HttpProxy({url:__ctxPath+"/communicate/listOutMail_.do"}),reader:new Ext.data.JsonReader({root:"result",totalProperty:"totalCounts",id:"id",fields:[{name:"mailId",type:"int"},{name:"readFlag",type:"int"},{name:"replyFlag",type:"int"},"mailDate","fileIds","title","content","senderName","receiverNames","senderAddresses"]}),remoteSort:true});b.setDefaultSort("mailId","desc");return b;};OutMailView.prototype.topbar=function(){var b=new Ext.Toolbar({id:"OutMailFootBar",height:30,bodyStyle:"text-align:left",items:[{iconCls:"btn-mail_remove",text:"删除",xtype:"button",handler:function(){var h=Ext.getCmp("OutMailGrid");var a=h.getSelectionModel().getSelections();if(a.length==0){Ext.ux.Toast.msg("信息","请选择要删除的记录！");return;}var g=Array();for(var i=0;i<a.length;i++){g.push(a[i].data.mailId);}var j=OutMailView.folderId;OutMailView.remove(g,j);}},{iconCls:"btn-mail_move",text:"移至",handler:function(){var g=Ext.getCmp("OutMailGrid");var a=g.getSelectionModel().getSelections();if(a.length==0){Ext.ux.Toast.msg("信息","请选择要移动的邮件！");return;}var f=Array();for(var h=0;h<a.length;h++){f.push(a[h].data.mailId);}OutMailView.moveTo(f);}},{iconCls:"btn-mail_refresh",text:"刷新",handler:function(){Ext.getCmp("OutMailGrid").getStore().reload({params:{isFetch:null,start:0,limit:25}});}}]});return b;};OutMailView.remove=function(h,f){if(f==null||f==undefined){f=1;}var e=Ext.getCmp("OutMailGrid");var g="";if(f==4){g="删除箱的记录一旦删除,将不可恢复!";}Ext.Msg.confirm("信息确认",g+"您确认要删除该记录吗？",function(b){if(b=="yes"){Ext.Ajax.request({url:__ctxPath+"/communicate/multiDelOutMail_.do",params:{ids:h,folderId:f},method:"post",success:function(){Ext.ux.Toast.msg("信息提示","成功删除所选记录！");e.getStore().reload({params:{isFetch:null,start:0,limit:25}});}});var c=Ext.getCmp("OutMailCenterView");c.remove("ShowOutMailDetail");var a=Ext.getCmp("OutMailView");a.show();c.doLayout();}});};OutMailView.edit=function(o,r,l){var n=new OutMailView.centerViewToolbar(o,r,l);if(r==3){var q=Ext.getCmp("centerTabPanel");var p=Ext.getCmp("OutMailForm");if(p==null){p=new OutMailForm(o,"draft");q.add(p);q.activate(p);}else{q.remove(p);p=new OutMailForm(o,"draft");q.add(p);q.activate(p);}}else{var k=Ext.getCmp("OutMailCenterView");var j=Ext.getCmp("OutMailView");j.hide();var m=new Ext.Panel({id:"ShowOutMailDetail",title:"[邮件信息]",border:false,tbar:n,autoLoad:{url:__ctxPath+"/communicate/getOutMail_.do?",params:{mailId:o},method:"Post"}});k.add(m);k.doLayout();}};OutMailView.centerViewToolbar=function(e,f,g){var h=new Ext.Toolbar({height:30,defaultType:"button",bodyStyle:"text-align:left",items:[{iconCls:"btn-mail_back",text:"返回",handler:function(){var b=Ext.getCmp("OutMailCenterView");b.remove("ShowOutMailDetail");var a=Ext.getCmp("OutMailView");a.show();b.doLayout();}},{iconCls:"btn-mail_reply",text:"回复",handler:function(){var a=Ext.getCmp("centerTabPanel");var b=Ext.getCmp("OutMailForm");if(b==null){b=new OutMailForm(e,"reply");a.add(b);a.activate(b);}else{a.remove(b);b=new OutMailForm(e,"reply");a.add(b);a.activate(b);}}},{iconCls:"btn-mail_resend",text:"转发",handler:function(){var a=Ext.getCmp("centerTabPanel");var b=Ext.getCmp("OutMailForm");if(b==null){b=new OutMailForm(e,"forward");a.add(b);a.activate(b);}else{a.remove(b);b=new OutMailForm(e,"forward");a.add(b);a.activate(b);}}},{iconCls:"btn-mail_remove",text:"删除",handler:function(){OutMailView.remove(e,f);}},{iconCls:"btn-mail_move",text:"移至",handler:function(){OutMailView.moveTo(e);}},"->",{iconCls:"btn-up",text:"较旧一封",handler:function(){var b=document.getElementById("__haveNextOutMailFlag");if(b!=null&&b.value!="endPre"){var a=curUserInfo.userId;var c=document.getElementById("__curOutMailId").value;Ext.getCmp("ShowOutMailDetail").load({url:__ctxPath+"/communicate/getOutMail_.do?",params:{mailId:c,opt:"_pre",folderId:f},method:"Post"});}else{Ext.ux.Toast.msg("提示信息","这里已经是第一封邮件了");}}},{iconCls:"btn-last",text:"较新一封",handler:function(){var b=document.getElementById("__haveNextOutMailFlag");if(b!=null&&b.value!="endNext"){var a=curUserInfo.userId;var c=document.getElementById("__curOutMailId").value;Ext.getCmp("ShowOutMailDetail").load({url:__ctxPath+"/communicate/getOutMail_.do?",params:{mailId:c,opt:"_next",folderId:f},method:"Post"});}else{Ext.ux.Toast.msg("提示信息","这里已经是最后一封邮件了");}}}]});return h;};OutMailView.moveTo=function(f){var d=new OutMailView.moveFormPanel(f);var e=new Ext.Window({x:350,y:100,width:340,height:300,autoHeight:true,title:"移动邮件",iconCls:"btn-mail_move",modal:true,buttonAlign:"center",plain:true,bodyStyle:"padding:5px;",items:[d],buttons:[{text:"确定移动",handler:function(){var b=Ext.getCmp("folderId");if(b==""||b==null||b==undefined){Ext.ux.Toast.msg("操作信息","请先选择文件夹");}else{var a=Ext.getCmp("moveFolderForm");a.getForm().submit({waitMsg:"正在提交用户信息",success:function(j,c){Ext.ux.Toast.msg("操作信息","移动成功！");e.close();var l=Ext.getCmp("OutMailCenterView");l.remove("ShowOutMailDetail");var k=Ext.getCmp("OutMailView");Ext.getCmp("OutMailGrid").getStore().reload({params:{isFetch:null,start:0,limit:25}});k.show();l.doLayout();},failure:function(h,c){Ext.ux.Toast.msg("提示信息",c.result.msg);}});}}},{text:"取消",handler:function(){e.close();}}]});e.show();};OutMailView.moveFormPanel=function(d){var f=new Ext.tree.TreePanel({title:"请选择文件夹",loader:new Ext.tree.TreeLoader({url:__ctxPath+"/communicate/listOutMailFolder_.do"}),root:new Ext.tree.AsyncTreeNode({expanded:true}),rootVisible:false,listeners:{"click":function(a){if(a!=null&&a.id!=0){Ext.getCmp("dispalyFolderName").setValue(a.text);Ext.getCmp("folderId").setValue(a.id);}}}});var e=new Ext.FormPanel({url:__ctxPath+"/communicate/moveOutMail_.do",layout:"table",id:"moveFolderForm",frame:true,defaultType:"textfield",layoutConfig:{columns:1},defaults:{width:296},items:[{xtype:"label",text:"移至:"},{id:"dispalyFolderName",readOnly:true},{xtype:"hidden",id:"folderId",name:"folderId"},{id:"outMailIds",name:"outMailIds",xtype:"hidden",value:d},{xtype:"panel",items:[f]}]});return e;};