var MailForm=function(d,f,e){return this.setup(d,f,e);};MailForm.prototype.setup=function(q,k,t){var m=this.initToolbar();var p=new copyFieldItems();var n=new Ext.data.JsonReader({root:"data"},[{name:"mail.recipientIDs",mapping:"recipientIDs"},{name:"mail.copyToIDs",mapping:"copyToIDs"},{name:"mail.mailStatus",mapping:"mailStatus"},{name:"mail.fileIds",mapping:"fileIds"},{name:"mail.mailId",mapping:"mailId"},{name:"mail.recipientNames",mapping:"recipientNames"},{name:"mail.subject",mapping:"subject"},{name:"mailImportantFlag",mapping:"importantFlag"},{name:"mail.filenames",mapping:"filenames"},{name:"mail.content",mapping:"content"},{name:"mail.copyToNames",mapping:"copyToNames"}]);var s=new Ext.FormPanel({url:__ctxPath+"/communicate/saveMail.do",id:"mailFormPanel",border:false,autoHeight:true,reader:n,items:[{fieldLabel:"收件人ID列表用,分隔",name:"mail.recipientIDs",id:"mail.recipientIDs",xtype:"hidden"},{fieldLabel:"抄送人ID列表用,分开",name:"mail.copyToIDs",id:"mail.copyToIDs",xtype:"hidden"},{fieldLabel:"邮件状态",name:"mail.mailStatus",id:"mail.mailStatus",xtype:"hidden",value:1},{fieldLabel:"附件IDs",name:"mail.fileIds",xtype:"hidden",id:"mail.fileIds"},{fieldLabel:"BOXID",name:"boxId",xtype:"hidden",id:"mailBoxId"},{fieldLabel:"MailId",name:"mail.mailId",xtype:"hidden",id:"mail.mailId"},{fieldLabel:"操作",name:"replyBoxId",xtype:"hidden",id:"mail.replyBoxId"},{fieldLabel:"附件名称列表",name:"mail.filenames",xtype:"hidden",id:"mail.filenames"},{fieldLabel:"主题",xtype:"textfield",name:"mail.subject",id:"mail.subject",allowBlank:false,width:512,blankText:"邮件主题为必填"},{xtype:"compositefield",fieldLabel:"收件人",items:[{width:325,height:21,name:"mail.recipientNames",id:"mail.recipientNames",xtype:"textfield",allowBlank:false,blankText:"请选择收件人",readOnly:true},{xtype:"button",text:"选择收件人",iconCls:"btn-mail_recipient",handler:function(){UserSelector.getView(function(d,b){var a=Ext.getCmp("mail.recipientIDs");var c=Ext.getCmp("mail.recipientNames");a.setValue(d);c.setValue(b);}).show();}},{xtype:"button",text:"我要抄送",iconCls:"btn-mail_copy",handler:function(){var a=Ext.getCmp("copyField");a.show();}}]},{xtype:"container",id:"copyField",layout:"column",height:32,hidden:true,defaultType:"textfield",items:[p]},{xtype:"compositefield",fieldLabel:"优先级",items:[{width:430,fieldLabel:"邮件优先级",hiddenName:"mail.importantFlag",id:"mailImportantFlag",xtype:"combo",mode:"local",editable:false,value:"1",triggerAction:"all",store:[["1","一般"],["2","重要"],["3","非常重要"]]},{xtype:"checkbox",name:"sendMessage",boxLabel:"告诉他有信"}]},{xtype:"container",layout:"column",fieldLabel:"附件",items:[{columnWidth:0.85,border:false,layout:"form",items:[{xtype:"panel",height:50,name:"filenames.display",id:"filenames.display",items:"",autoScroll:true}]},{columnWidth:0.15,border:false,layout:"form",defaultType:"button",items:[{text:"上传附件",iconCls:"menu-attachment",handler:function(){var a=App.createUploadDialog({file_cat:"communication/innerMail",callback:uploadMailAttach});a.show();}},{text:"清除附件",iconCls:"reset",handler:function(){Ext.getCmp("mail.fileIds").setValue("");Ext.getCmp("mail.filenames").setValue("");Ext.getCmp("filenames.display").update();}}]}]},{fieldLabel:"内容",name:"mail.content",id:"mail.content",xtype:"fckeditor",height:300}]});if(q!=null&&q!="undefined"){var l=Ext.getCmp("mail.mailId");l.setValue(q);if(t=="draft"){s.getForm().load({deferredRender:false,url:__ctxPath+"/communicate/getMail.do",method:"post",params:{mailId:q,folderId:3,boxId:k},waitMsg:"正在载入数据...",success:function(h,f){var a=Ext.getCmp("mail.copyToIDs");if(a.getValue()!=""){var g=Ext.getCmp("copyField");g.show();}var c=Ext.getCmp("mail.filenames").getValue();if(c!=""){var b=Ext.getCmp("filenames.display");var j=Ext.getCmp("placeholder");if(j!=null){j.hide();}var i=c.split(",");var d=Ext.getCmp("mail.fileIds").getValue().split(",");var v="";for(var e=0;e<i.length;e++){v+='<span><a href="#" onclick="FileAttachDetail.show('+d[e]+')">'+i[e]+'</a> <img class="img-delete" src="'+__ctxPath+'/images/system/delete.gif" onclick="deleteAttach(this,'+d[e]+')"/>&nbsp;|&nbsp;</span>';}Ext.DomHelper.append(b.body,v);}},failure:function(b,a){}});}else{if(t=="reply"){s.getForm().load({deferredRender:false,url:__ctxPath+"/communicate/optMail.do",method:"post",params:{mailId:q,boxId:k,opt:"回复"},waitMsg:"正在载入数据...",success:function(b,a){Ext.getCmp("mail.replyBoxId").setValue(k);},failure:function(b,a){}});}else{if(t=="forward"){s.getForm().load({deferredRender:false,url:__ctxPath+"/communicate/optMail.do",method:"post",params:{mailId:q,opt:"转发"},waitMsg:"正在载入数据...",success:function(b,a){},failure:function(b,a){}});}}}}if(k!=null&&k!="undefined"){var o=Ext.getCmp("mailBoxId");o.setValue(k);}var r=new Ext.Panel({title:"发送邮件",iconCls:"menu-mail_send",autoScroll:true,tbar:m,id:"MailForm",layout:"hbox",margins:"0 0 6 0",layoutConfig:{padding:"5",pack:"center",align:"middle"},defaults:{margins:"0 5 0 0"},items:[s]});return r;};MailForm.prototype.initToolbar=function(){var b=new Ext.Toolbar({height:30,items:[{text:"立即发送",iconCls:"btn-mail_send",handler:function(){var d=Ext.getCmp("mailFormPanel");var a=Ext.getCmp("mail.mailStatus");if(d.getForm().isValid()){a.setValue(1);d.getForm().submit({waitMsg:"正在发送邮件,请稍候...",success:function(f,c){Ext.Msg.confirm("操作信息","邮件发送成功！继续发邮件?",function(e){if(e=="yes"){d.getForm().reset();}else{var h=Ext.getCmp("centerTabPanel");h.remove("MailForm");}});},failure:function(f,c){Ext.ux.Toast.msg("错误信息",c.result.msg);}});}}},{text:"存草稿",iconCls:"btn-mail_save",handler:function(){var d=Ext.getCmp("mail.mailStatus");d.setValue(0);var a=Ext.getCmp("mailFormPanel");if(a.getForm().isValid()){a.getForm().submit({waitMsg:"正在保存草稿,请稍候...",success:function(f,c){Ext.Msg.confirm("操作信息","草稿保存成功！继续发邮件?",function(e){if(e=="yes"){f.getForm().reset();}else{var h=Ext.getCmp("centerTabPanel");h.remove("MailForm");}});},failure:function(f,c){Ext.ux.Toast.msg("错误信息",c.result.msg);}});}}},{text:"重置",iconCls:"reset",handler:function(){var a=Ext.getCmp("MailFormPanel");a.getForm().reset();}},{text:"取消",iconCls:"btn-mail_remove",handler:function(){var a=Ext.getCmp("centerTabPanel");a.remove("MailForm");}}]});return b;};function copyFieldItems(){var b=[{xtype:"label",text:"抄送人:",style:"padding-left:0px;padding-top:3px;",width:105},{width:330,fieldLabel:"抄送人姓名列表",name:"mail.copyToNames",id:"mail.copyToNames",readOnly:true},{xtype:"button",text:"选择抄送人",style:"padding-left:5px;",iconCls:"btn-mail_recipient",handler:function(){UserSelector.getView(function(f,h){var g=Ext.getCmp("mail.copyToIDs");var a=Ext.getCmp("mail.copyToNames");g.setValue(f);a.setValue(h);}).show();}},{xtype:"button",text:"取消抄送",style:"padding-left:5px;",iconCls:"btn-delete_copy",handler:function(){var a=Ext.getCmp("copyField");var d=Ext.getCmp("mailFormPanel");d.getForm().findField("mail.copyToIDs").setValue("");d.getForm().findField("mail.copyToNames").setValue("");a.hide();}}];return b;}function uploadMailAttach(p){var k="";var i=Ext.getCmp("mail.fileIds");var r=i.getValue();if(r!=null&&r!=""){r+=",";}var o=Ext.getCmp("mail.filenames");var m=o.getValue();if(m!=null&&r!=""){m+=",";}var n=Ext.getCmp("filenames.display");var l=Ext.getCmp("placeholder");if(l!=null){l.hide();}for(var q=0;q<p.length;q++){r+=p[q].fileId;m+=p[q].fileName;if(q<p.length-1){r+=",";m+=",";}k+='<span><a href="#" onclick="FileAttachDetail.show('+p[q].fileId+')">'+p[q].fileName+'</a> <img class="img-delete" src="'+__ctxPath+'/images/system/delete.gif" onclick="deleteAttach(this,'+p[q].fileId+')"/>&nbsp;|&nbsp;</span>';}i.setValue(r);o.setValue(m);Ext.DomHelper.append(n.body,k);}function deleteAttach(j,h){var l=Ext.getCmp("mail.fileIds").getValue();var m=Ext.getCmp("mail.filenames").getValue();var i="";var n="";if(l.indexOf(",")<0){Ext.getCmp("mail.fileIds").setValue("");}else{l=l.replace(","+h,"").replace(h+",","");Ext.getCmp("mail.fileIds").setValue(l);}Ext.get(j.parentNode).remove();if(Ext.getCmp("mail.fileIds").getValue()==""){Ext.getCmp("placeholder").show();}var k=Ext.getCmp("mail.mailId").getValue();if(k!=null&&k!=""&&k!="undefined"){Ext.Ajax.request({url:__ctxPath+"/communicate/attachMail.do",method:"post",params:{mailId:k,fileId:h,fileIds:i,filenames:n},success:function(){}});}else{Ext.Ajax.request({url:__ctxPath+"/system/multiDelFileAttach.do",params:{ids:h},method:"post",success:function(){Ext.ux.Toast.msg("信息提示","成功删除所选记录！");}});}}