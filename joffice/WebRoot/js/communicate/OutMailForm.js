var OutMailForm=function(c,d){return this.setup(c,d);};OutMailForm.prototype.setup=function(k,l){var j=this.initToolbar();var g=new copyFieldItems();var h=new Ext.FormPanel({url:__ctxPath+"/communicate/saveOutMail_.do",title:"发送邮件",iconCls:"menu-mail_send",layout:"form",id:"OutMailForm",tbar:j,timeout:120000,border:false,formId:"OutMailFormId",labelWidth:60,style:"padding-bottom:25px;",reader:new Ext.data.JsonReader({root:"result"},[{name:"mailId",mapping:"mailId"},{name:"outMail.title",mapping:"title"},{name:"content",mapping:"content"},{name:"senderName",mapping:"senderName"},{name:"receiverAddresses",mapping:"receiverAddresses"},,{name:"receiverNames",mapping:"receiverNames"},{name:"senderAddresses",mapping:"senderAddresses"},{name:"cCNames",mapping:"cCNames"},{name:"cCAddresses",mapping:"cCAddresses"},{name:"mailDate",mapping:"mailDate"},{name:"fileIds",mapping:"fileIds"},{name:"fileNames",mapping:"fileNames"},{name:"readFlag",mapping:"readFlag"},{name:"replyFlag",mapping:"replyFlag"},{name:"folderId",mapping:"folderid"},{name:"userId",mapping:"userId"},{name:"userName",mapping:"userName"}]),items:[{xtype:"panel",layout:"form",border:false,style:"padding-left:10%;padding-top:20px;",defaultType:"textfield",labelWidth:60,width:650,items:[{fieldLabel:"发送人地址",name:"outMail.senderAddresses",xtype:"hidden",id:"senderAddresses"},{fieldLabel:"发送人名称",name:"outMail.senderName",xtype:"hidden",id:"senderName"},{fieldLabel:"接受人址",name:"outMail.receiverAddresses",xtype:"hidden",id:"receiverAddresses"},{fieldLabel:"抄送人地址",name:"outMail.cCAddresses",value:"",xtype:"hidden",id:"cCAddresses"},{fieldLabel:"操作",name:"opt",xtype:"hidden",value:l,id:"opt"},{fieldLabel:"附件IDs",name:"outMail.fileIds",xtype:"hidden",value:"",id:"fileIds"},{fieldLabel:"MailId",name:"outMail.mailId",xtype:"hidden",id:"mailId"},{fieldLabel:"已回复",name:"outMail.replyFlag",xtype:"hidden",id:"replyFlag"},{fieldLabel:"附件名称列表",name:"outMail.fileNames",xtype:"hidden",id:"fileNames"},{xtype:"container",border:false,layout:"column",height:26,bodyStyle:"padding-top:20px;",defaultType:"textfield",items:[{xtype:"label",text:"收件人:",style:"padding-left:0px;padding-top:3px;",width:65},{width:353,fieldLabel:"收件人姓名列表",name:"outMail.receiverNames",id:"receiverNames",allowBlank:false,blankText:"请选择收件人",readOnly:false},{xtype:"button",text:"选择收件人",iconCls:"btn-mail_recipient",handler:function(){EMailSelector.getView(function(a){var b=Ext.getCmp("receiverNames");b.setValue(a);}).show();}},{xtype:"button",text:"我要抄送",iconCls:"btn-mail_copy",handler:function(){var a=Ext.getCmp("ccField");a.show();}}]},{xtype:"container",id:"ccField",layout:"column",style:"padding-left:0px;",height:26,hidden:true,defaultType:"textfield",items:[g]},{width:503,fieldLabel:"主题",name:"outMail.title",allowBlank:false,blankText:"邮件主题为必填"},{xtype:"container",layout:"column",height:50,border:false,fieldLabel:"附件",items:[{columnWidth:0.75,layout:"form",border:false,items:[{id:"outMailFileNames.display",name:"outMailFileNames.display",xtype:"panel",items:"",height:50,autoScroll:true,border:true}]},{columnWidth:0.25,layout:"form",border:false,defaultType:"button",items:[{text:"上传附件",iconCls:"menu-attachment",handler:function(){var a=App.createUploadDialog({file_cat:"communication/outMail",callback:outMailUploadMailAttach});a.show("queryBtn");}},{text:"清除附件",iconCls:"reset",handler:function(){Ext.getCmp("fileIds").setValue("");Ext.getCmp("fileNames").setValue("");Ext.getCmp("outMailFileNames.display").update();}}]}]},{fieldLabel:"内容",name:"outMail.content",id:"content",xtype:"htmleditor",height:280}]}]});if(k!=null&&k!=""&&k!=undefined){var i=Ext.getCmp("mailId");i.setValue(k);if(l=="draft"){h.getForm().load({deferredRender:false,url:__ctxPath+"/communicate/getOutMail_.do",method:"post",params:{mailId:k,folderId:3},waitMsg:"正在载入数据...",success:function(z,y){var a=Ext.getCmp("cCNames");if(a.value=="null"){a.value="";}if(a.value!=null&&a.value!=""){var F=Ext.getCmp("ccField");F.show();}var f=Ext.getCmp("fileNames").value;if(f!=""){var G=Ext.getCmp("outMailFileNames.display");var e=Ext.getCmp("outmail_placeholder");if(e!=null){e.hide();}var D=f.split(",");var b=Ext.getCmp("fileIds").value.split(",");var E="";for(var c=0;c<D.length;c++){E+='<span><a href="#" onclick="FileAttachDetail.show('+b[c]+')">'+D[c]+'</a> <img class="img-delete" src="'+__ctxPath+'/images/system/delete.gif" onclick="deleteAttach(this,'+b[c]+')"/>&nbsp;|&nbsp;</span>';}Ext.DomHelper.append(G.body,E);}var d=y.result.data;var H=d.receiverAddresses;var B=d.receiverNames;var C=getStrToEmail(H,B);z.findField("receiverNames").setValue(C);var A=d.cCAddresses;var a=d.cCNames;var I=getStrToEmail(A,a);Ext.getCmp("cCNames").setValue(I);},failure:function(b,a){}});}else{if(l=="reply"){h.getForm().load({deferredRender:false,url:__ctxPath+"/communicate/optOutMail_.do",method:"post",params:{mailId:k,opt:"回复"},waitMsg:"正在载入数据...",success:function(z,y){Ext.getCmp("mailId").setValue(k);var a=Ext.getCmp("cCNames");if(a.value!=null&&a.value!=""){var F=Ext.getCmp("ccField");F.show();}var f=Ext.getCmp("fileNames").value;if(f!=""){var G=Ext.getCmp("outMailFileNames.display");var e=Ext.getCmp("outmail_placeholder");if(e!=null){e.hide();}var D=f.split(",");var b=Ext.getCmp("fileIds").value.split(",");var E="";for(var c=0;c<D.length;c++){E+='<span><a href="#" onclick="FileAttachDetail.show('+b[c]+')">'+D[c]+'</a> <img class="img-delete" src="'+__ctxPath+'/images/system/delete.gif" onclick="deleteAttach(this,'+b[c]+')"/>&nbsp;|&nbsp;</span>';}Ext.DomHelper.append(G.body,E);}var d=y.result.data;var A=d.cCAddresses;var a=d.cCNames;var H=getStrToEmail(A,a);Ext.getCmp("cCNames").setValue(H);var I=d.senderAddresses;var B=d.senderName;var C=getStrToEmail(I,B);z.findField("receiverNames").setValue(C);},failure:function(b,a){}});}else{if(l=="forward"){h.getForm().load({deferredRender:false,url:__ctxPath+"/communicate/optOutMail_.do",method:"post",params:{mailId:k,opt:"转发"},waitMsg:"正在载入数据...",success:function(w,v){Ext.getCmp("mailId").setValue(k);var e=Ext.getCmp("cCNames");if(e.value!=null&&e.value!=""){var c=Ext.getCmp("ccField");c.show();}var u=Ext.getCmp("fileNames").value;if(u!=""){var d=Ext.getCmp("outMailFileNames.display");var t=Ext.getCmp("outmail_placeholder");if(t!=null){t.hide();}var a=u.split(",");var f=Ext.getCmp("fileIds").value.split(",");var b="";for(var s=0;s<a.length;s++){b+='<span><a href="#" onclick="FileAttachDetail.show('+f[s]+')">'+a[s]+'</a> <img class="img-delete" src="'+__ctxPath+'/images/system/delete.gif" onclick="deleteAttach(this,'+f[s]+')"/>&nbsp;|&nbsp;</span>';}Ext.DomHelper.append(d.body,b);}w.findField("receiverNames").setValue("");},failure:function(b,a){}});}}}}return h;};OutMailForm.prototype.initToolbar=function(){var b=new Ext.Toolbar({width:"100%",height:30,items:[{text:"立即发送",iconCls:"btn-mail_send",handler:function(){var a=Ext.getCmp("OutMailForm");a.getForm().submit({waitMsg:"正在发送邮件,请稍候...",timeout:120000,success:function(f,e){Ext.Msg.confirm("操作信息","邮件发送成功！继续发邮件?",function(c){if(c=="yes"){var h=Ext.getCmp("OutMailForm");h.getForm().reset();}else{var d=Ext.getCmp("centerTabPanel");d.remove("OutMailForm");}});},failure:function(f,e){if(e.result!=null&&e.result!=undefined){Ext.ux.Toast.msg("错误信息",e.result.msg);}}});}},{text:"存草稿",iconCls:"btn-mail_save",handler:function(){var a=Ext.getCmp("OutMailForm");a.getForm().findField("opt").setValue("attach");a.getForm().submit({waitMsg:"正在保存草稿,请稍候...",success:function(f,e){Ext.Msg.confirm("操作信息","草稿保存成功！继续发邮件?",function(c){if(c=="yes"){var h=Ext.getCmp("OutMailForm");h.getForm().reset();}else{var d=Ext.getCmp("centerTabPanel");d.remove("OutMailForm");}});},failure:function(f,e){if(e.result!=null&&e.result!=undefined){Ext.ux.Toast.msg("错误信息",e.result.msg);}}});}},{text:"重置",iconCls:"reset",handler:function(){var a=Ext.getCmp("OutMailForm");a.getForm().reset();}},{text:"取消",iconCls:"btn-mail_remove",handler:function(){var a=Ext.getCmp("centerTabPanel");a.remove("OutMailForm");}}]});return b;};function copyFieldItems(){var b=[{xtype:"label",text:"抄送人:",style:"padding-left:0px;padding-top:3px;",width:61},{width:350,fieldLabel:"抄送人姓名列表",name:"outMail.cCNames",value:"",id:"cCNames",emptyText:"",readOnly:false},{xtype:"button",text:"选择抄送人",iconCls:"btn-mail_recipient",handler:function(){EMailSelector.getView(function(a){var d=Ext.getCmp("cCNames");d.setValue(a);}).show();}},{xtype:"button",text:"取消抄送",iconCls:"btn-delete_copy",handler:function(){var d=Ext.getCmp("ccField");var a=Ext.getCmp("OutMailForm");Ext.getCmp("cCNames").setValue("");a.getForm().findField("cCAddresses").setValue("");d.hide();}}];return b;}function outMailUploadMailAttach(n){var k="";var i=Ext.getCmp("fileIds");var r=i.value;if(r!=null&&r!=""){r+=",";}var q=Ext.getCmp("fileNames");var l=q.value;if(l!=null&&l!=""){l+=",";}var m=Ext.getCmp("outMailFileNames.display");var p=Ext.getCmp("outmail_placeholder");if(p!=null){p.hide();}for(var o=0;o<n.length;o++){r+=n[o].fileId;l+=n[o].fileName;if(o<n.length-1){r+=",";l+=",";}k+='<span><a href="#" onclick="FileAttachDetail.show('+n[o].fileId+')">'+n[o].fileName+'</a> <img class="img-delete" src="'+__ctxPath+'/images/system/delete.gif" onclick="deleteAttach(this,'+n[o].fileId+')"/>&nbsp;|&nbsp;</span>';}i.setValue(r);q.setValue(l);Ext.DomHelper.append(m.body,k);}function deleteAttach(j,n){var l=Ext.getCmp("fileIds").value;var m=Ext.getCmp("fileNames").value;var h="";var i="";if(l.indexOf(",")<0){Ext.getCmp("fileIds").setValue("");}else{l=l.replace(","+n,"").replace(n+",","");Ext.getCmp("fileIds").setValue(l);}Ext.get(j.parentNode).remove();if(Ext.getCmp("fileIds").value==""){Ext.getCmp("outmail_placeholder").show();}display.doLayout(true);var k=Ext.getCmp("mailId").value;if(k!=null&&k!=""&&k!=undefined){Ext.Ajax.request({url:__ctxPath+"/communicate/attachOutMail_.do",method:"post",params:{mailId:k,fileId:n,fileIds:h,fileNames:i},success:function(){}});}else{Ext.Ajax.request({url:__ctxPath+"/system/multiDelFileAttach.do",params:{ids:n},method:"post",success:function(){Ext.ux.Toast.msg("信息提示","成功删除所选记录！");}});}}function getStrToEmail(l,j){var k="";if(l==null||l=="null"){l="";}if(j==null||j=="null"){j="";}if(l.length>1){var a=l.split(",");var h=j.split(",");if(a!=null&&a.length>0){if(h!=null&&h.length>0){for(var i=0;i<a.length;i++){if(h.length>=i){k+=""+h[i].replace('"',"")+""+"<"+a[i]+">"+";";}else{k+=""+a[i]+""+"<"+a[i]+">"+";";}}}else{for(var i=0;i<a.length;i++){k+=""+a[i]+""+"<"+a[i]+">"+";";}}}}return k;}