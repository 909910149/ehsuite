Ext.ns("Ext.ux.form");Ext.ux.form.MultiSelect=Ext.extend(Ext.form.Field,{ddReorder:false,appendOnly:false,width:100,height:100,displayField:0,valueField:1,allowBlank:true,minSelections:0,maxSelections:Number.MAX_VALUE,blankText:Ext.form.TextField.prototype.blankText,minSelectionsText:"Minimum {0} item(s) required",maxSelectionsText:"Maximum {0} item(s) allowed",delimiter:",",defaultAutoCreate:{tag:"div"},initComponent:function(){Ext.ux.form.MultiSelect.superclass.initComponent.call(this);if(Ext.isArray(this.store)){if(Ext.isArray(this.store[0])){this.store=new Ext.data.ArrayStore({fields:["value","text"],data:this.store});this.valueField="value";}else{this.store=new Ext.data.ArrayStore({fields:["text"],data:this.store,expandData:true});this.valueField="text";}this.displayField="text";}else{this.store=Ext.StoreMgr.lookup(this.store);}this.addEvents({"dblclick":true,"click":true,"change":true,"drop":true});},onRender:function(h,e){Ext.ux.form.MultiSelect.superclass.onRender.call(this,h,e);var f=this.fs=new Ext.form.FieldSet({renderTo:this.el,title:this.legend,height:this.height,autoScroll:true,width:this.width,style:"padding:0;",tbar:this.tbar});f.body.addClass("ux-mselect");this.view=new Ext.ListView({multiSelect:true,store:this.store,columns:[{header:"Value",width:1,dataIndex:this.displayField}],hideHeaders:true});f.add(this.view);this.view.on("click",this.onViewClick,this);this.view.on("beforeclick",this.onViewBeforeClick,this);this.view.on("dblclick",this.onViewDblClick,this);this.hiddenName=this.name||Ext.id();var g={tag:"input",type:"hidden",value:"",name:this.hiddenName};this.hiddenField=this.el.createChild(g);this.hiddenField.dom.disabled=this.hiddenName!=this.name;f.doLayout();},afterRender:function(){Ext.ux.form.MultiSelect.superclass.afterRender.call(this);if(this.ddReorder&&!this.dragGroup&&!this.dropGroup){this.dragGroup=this.dropGroup="MultiselectDD-"+Ext.id();}if(this.draggable||this.dragGroup){this.dragZone=new Ext.ux.form.MultiSelect.DragZone(this,{ddGroup:this.dragGroup});}if(this.droppable||this.dropGroup){this.dropZone=new Ext.ux.form.MultiSelect.DropZone(this,{ddGroup:this.dropGroup});}},onViewClick:function(h,f,e,g){this.fireEvent("change",this,this.getValue(),this.hiddenField.dom.value);this.hiddenField.dom.value=this.getValue();this.fireEvent("click",this,g);this.validate();},onViewBeforeClick:function(h,f,e,g){if(this.disabled){return false;}},onViewDblClick:function(h,f,e,g){return this.fireEvent("dblclick",h,f,e,g);},getValue:function(f){var g=[];var h=this.view.getSelectedIndexes();if(h.length==0){return"";}for(var e=0;e<h.length;e++){g.push(this.store.getAt(h[e]).get((f!=null)?f:this.valueField));}return g.join(this.delimiter);},setValue:function(f){var e;var g=[];this.view.clearSelections();this.hiddenField.dom.value="";if(!f||(f=="")){return;}if(!Ext.isArray(f)){f=f.split(this.delimiter);}for(var h=0;h<f.length;h++){e=this.view.store.indexOf(this.view.store.query(this.valueField,new RegExp("^"+f[h]+"$","i")).itemAt(0));g.push(e);}this.view.select(g);this.hiddenField.dom.value=this.getValue();this.validate();},reset:function(){this.setValue("");},getRawValue:function(d){var c=this.getValue(d);if(c.length){c=c.split(this.delimiter);}else{c=[];}return c;},setRawValue:function(b){setValue(b);},validateValue:function(b){if(b.length<1){if(this.allowBlank){this.clearInvalid();return true;}else{this.markInvalid(this.blankText);return false;}}if(b.length<this.minSelections){this.markInvalid(String.format(this.minSelectionsText,this.minSelections));return false;}if(b.length>this.maxSelections){this.markInvalid(String.format(this.maxSelectionsText,this.maxSelections));return false;}return true;},disable:function(){this.disabled=true;this.hiddenField.dom.disabled=true;this.fs.disable();},enable:function(){this.disabled=false;this.hiddenField.dom.disabled=false;this.fs.enable();},destroy:function(){Ext.destroy(this.fs,this.dragZone,this.dropZone);Ext.ux.form.MultiSelect.superclass.destroy.call(this);}});Ext.reg("multiselect",Ext.ux.form.MultiSelect);Ext.ux.Multiselect=Ext.ux.form.MultiSelect;Ext.ux.form.MultiSelect.DragZone=function(g,h){this.ms=g;this.view=g.view;var e=h.ddGroup||"MultiselectDD";var f;if(Ext.isArray(e)){f=e.shift();}else{f=e;e=null;}Ext.ux.form.MultiSelect.DragZone.superclass.constructor.call(this,this.ms.fs.body,{containerScroll:true,ddGroup:f});this.setDraggable(e);};Ext.extend(Ext.ux.form.MultiSelect.DragZone,Ext.dd.DragZone,{onInitDrag:function(e,f){var d=Ext.get(this.dragData.ddel.cloneNode(true));this.proxy.update(d.dom);d.setWidth(d.child("em").getWidth());this.onStartDrag(e,f);return true;},collectSelection:function(c){c.repairXY=Ext.fly(this.view.getSelectedNodes()[0]).getXY();var d=0;this.view.store.each(function(b){if(this.view.isSelected(d)){var a=this.view.getNode(d);var f=a.cloneNode(true);f.id=Ext.id();c.ddel.appendChild(f);c.records.push(this.view.store.getAt(d));c.viewNodes.push(a);}d++;},this);},onEndDrag:function(e,d){var f=Ext.get(this.dragData.ddel);if(f&&f.hasClass("multi-proxy")){f.remove();}},getDragData:function(i){var j=this.view.findItemFromChild(i.getTarget());if(j){if(!this.view.isSelected(j)&&!i.ctrlKey&&!i.shiftKey){this.view.select(j);this.ms.setValue(this.ms.getValue());}if(this.view.getSelectionCount()==0||i.ctrlKey||i.shiftKey){return false;}var e={sourceView:this.view,viewNodes:[],records:[]};if(this.view.getSelectionCount()==1){var g=this.view.getSelectedIndexes()[0];var h=this.view.getNode(g);e.viewNodes.push(e.ddel=h);e.records.push(this.view.store.getAt(g));e.repairXY=Ext.fly(h).getXY();}else{e.ddel=document.createElement("div");e.ddel.className="multi-proxy";this.collectSelection(e);}return e;}return false;},getRepairXY:function(b){return this.dragData.repairXY;},setDraggable:function(b){if(!b){return;}if(Ext.isArray(b)){Ext.each(b,this.setDraggable,this);return;}this.addToGroup(b);}});Ext.ux.form.MultiSelect.DropZone=function(g,h){this.ms=g;this.view=g.view;var e=h.ddGroup||"MultiselectDD";var f;if(Ext.isArray(e)){f=e.shift();}else{f=e;e=null;}Ext.ux.form.MultiSelect.DropZone.superclass.constructor.call(this,this.ms.fs.body,{containerScroll:true,ddGroup:f});this.setDroppable(e);};Ext.extend(Ext.ux.form.MultiSelect.DropZone,Ext.dd.DropZone,{getTargetFromEvent:function(c){var d=c.getTarget();return d;},getDropPoint:function(l,c,n){if(c==this.ms.fs.body.dom){return"below";}var m=Ext.lib.Dom.getY(c),b=m+c.offsetHeight;var e=m+(b-m)/2;var k=Ext.lib.Event.getPageY(l);if(k<=e){return"above";}else{return"below";}},isValidDropPoint:function(d,g,f){if(!f.viewNodes||(f.viewNodes.length!=1)){return true;}var h=f.viewNodes[0];if(h==g){return false;}if((d=="below")&&(g.nextSibling==h)){return false;}if((d=="above")&&(g.previousSibling==h)){return false;}return true;},onNodeEnter:function(g,f,h,e){return false;},onNodeOver:function(j,i,k,m){var e=this.dropNotAllowed;var l=this.getDropPoint(k,j,i);if(this.isValidDropPoint(l,j,m)){if(this.ms.appendOnly){return"x-tree-drop-ok-below";}if(l){var n;if(l=="above"){e=j.previousSibling?"x-tree-drop-ok-between":"x-tree-drop-ok-above";n="x-view-drag-insert-above";}else{e=j.nextSibling?"x-tree-drop-ok-between":"x-tree-drop-ok-below";n="x-view-drag-insert-below";}if(this.lastInsertClass!=n){Ext.fly(j).replaceClass(this.lastInsertClass,n);this.lastInsertClass=n;}}}return e;},onNodeOut:function(g,f,h,e){this.removeDropIndicators(g);},onNodeDrop:function(q,i,l,n){if(this.ms.fireEvent("drop",this,q,i,l,n)===false){return false;}var e=this.getDropPoint(l,q,i);if(q!=this.ms.fs.body.dom){q=this.view.findItemFromChild(q);}if(this.ms.appendOnly){insertAt=this.view.store.getCount();}else{insertAt=q==this.ms.fs.body.dom?this.view.store.getCount()-1:this.view.indexOf(q);if(e=="below"){insertAt++;}}var p=false;if(n.sourceView==this.view){if(e=="below"){if(n.viewNodes[0]==q){n.viewNodes.shift();}}else{if(n.viewNodes[n.viewNodes.length-1]==q){n.viewNodes.pop();}}if(!n.viewNodes.length){return false;}if(insertAt>this.view.store.indexOf(n.records[0])){p="down";insertAt--;}}for(var m=0;m<n.records.length;m++){var r=n.records[m];if(n.sourceView){n.sourceView.store.remove(r);}this.view.store.insert(p=="down"?insertAt:insertAt++,r);var o=this.view.store.sortInfo;if(o){this.view.store.sort(o.field,o.direction);}}return true;},removeDropIndicators:function(b){if(b){Ext.fly(b).removeClass(["x-view-drag-insert-above","x-view-drag-insert-left","x-view-drag-insert-right","x-view-drag-insert-below"]);this.lastInsertClass="_noclass";}},setDroppable:function(b){if(!b){return;}if(Ext.isArray(b)){Ext.each(b,this.setDroppable,this);return;}this.addToGroup(b);}});