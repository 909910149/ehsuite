Ext.ns("Ext.ux.grid");Ext.ux.grid.GroupSummary=Ext.extend(Ext.util.Observable,{constructor:function(b){Ext.apply(this,b);Ext.ux.grid.GroupSummary.superclass.constructor.call(this);},init:function(c){this.grid=c;var d=this.view=c.getView();d.doGroupEnd=this.doGroupEnd.createDelegate(this);d.afterMethod("onColumnWidthUpdated",this.doWidth,this);d.afterMethod("onAllColumnWidthsUpdated",this.doAllWidths,this);d.afterMethod("onColumnHiddenUpdated",this.doHidden,this);d.afterMethod("onUpdate",this.doUpdate,this);d.afterMethod("onRemove",this.doRemove,this);if(!this.rowTpl){this.rowTpl=new Ext.Template('<div class="x-grid3-summary-row" style="{tstyle}">','<table class="x-grid3-summary-table" border="0" cellspacing="0" cellpadding="0" style="{tstyle}">',"<tbody><tr>{cells}</tr></tbody>","</table></div>");this.rowTpl.disableFormats=true;}this.rowTpl.compile();if(!this.cellTpl){this.cellTpl=new Ext.Template('<td class="x-grid3-col x-grid3-cell x-grid3-td-{id} {css}" style="{style}">','<div class="x-grid3-cell-inner x-grid3-col-{id}" unselectable="on">{value}</div>',"</td>");this.cellTpl.disableFormats=true;}this.cellTpl.compile();},toggleSummaries:function(c){var d=this.grid.getGridEl();if(d){if(c===undefined){c=d.hasClass("x-grid-hide-summary");}d[c?"removeClass":"addClass"]("x-grid-hide-summary");}},renderSummary:function(r,n){n=n||this.view.getColumnData();var m=this.grid.getColumnModel().config,q=[],i,t={},s,c=n.length-1;for(var p=0,o=n.length;p<o;p++){i=n[p];s=m[p];t.id=i.id;t.style=i.style;t.css=p==0?"x-grid3-cell-first ":(p==c?"x-grid3-cell-last ":"");if(s.summaryType||s.summaryRenderer){t.value=(s.summaryRenderer||i.renderer)(r.data[i.name],t,r);}else{t.value="";}if(t.value==undefined||t.value===""){t.value="&#160;";}q[q.length]=this.cellTpl.apply(t);}return this.rowTpl.apply({tstyle:"width:"+this.view.getTotalWidth()+";",cells:q.join("")});},calculate:function(t,o){var q={},v,i,j=this.grid.getColumnModel().config,u;for(var s=0,c=t.length;s<c;s++){v=t[s];for(var r=0,p=o.length;r<p;r++){i=o[r];u=j[r];if(u.summaryType){q[i.name]=Ext.ux.grid.GroupSummary.Calculations[u.summaryType](q[i.name]||0,v,i.name,q);}}}return q;},doGroupEnd:function(h,k,g,i,l){var j=this.calculate(k.rs,g);h.push("</div>",this.renderSummary({data:j},g),"</div>");},doWidth:function(l,h,m){var n=this.view.getGroups(),j;for(var k=0,i=n.length;k<i;k++){j=n[k].childNodes[2];j.style.width=m;j.firstChild.style.width=m;j.firstChild.rows[0].childNodes[l].style.width=h;}},doAllWidths:function(l,o){var r=this.view.getGroups(),i,j,n=l.length;for(var p=0,m=r.length;p<m;p++){i=r[p].childNodes[2];i.style.width=o;i.firstChild.style.width=o;j=i.firstChild.rows[0].childNodes;for(var q=0;q<n;q++){j[q].style.width=l[q];}}},doHidden:function(o,l,p){var i=this.view.getGroups(),m,k=l?"none":"";for(var n=0,j=i.length;n<j;n++){m=i[n].childNodes[2];m.style.width=p;m.firstChild.style.width=p;m.firstChild.rows[0].childNodes[o].style.display=k;}},refreshSummary:function(b){return this.refreshSummaryById(this.view.getGroupId(b));},getSummaryNode:function(d){var c=Ext.fly(d,"_gsummary");if(c){return c.down(".x-grid3-summary-row",true);}return null;},refreshSummaryById:function(m){var k=Ext.getDom(m);if(!k){return false;}var g=[];this.grid.getStore().each(function(a){if(a._groupId==m){g[g.length]=a;}});var n=this.view.getColumnData(),j=this.calculate(g,n),i=this.renderSummary({data:j},n),l=this.getSummaryNode(m);if(l){k.removeChild(l);}Ext.DomHelper.append(k,i);return true;},doUpdate:function(c,d){this.refreshSummaryById(d._groupId);},doRemove:function(g,f,e,h){if(!h){this.refreshSummaryById(f._groupId);}},showSummaryMsg:function(f,g){var e=this.view.getGroupId(f),h=this.getSummaryNode(e);if(h){h.innerHTML='<div class="x-grid3-summary-msg">'+g+"</div>";}}});Ext.grid.GroupSummary=Ext.ux.grid.GroupSummary;Ext.ux.grid.GroupSummary.Calculations={"sum":function(d,e,f){return d+(e.data[f]||0);},"count":function(e,f,g,h){return h[g+"count"]?++h[g+"count"]:(h[g+"count"]=1);},"max":function(j,f,h,i){var j=f.data[h];var g=i[h+"max"]===undefined?(i[h+"max"]=j):i[h+"max"];return j>g?(i[h+"max"]=j):g;},"min":function(f,g,h,i){var f=g.data[h];var j=i[h+"min"]===undefined?(i[h+"min"]=f):i[h+"min"];return f<j?(i[h+"min"]=f):j;},"average":function(c,h,j,k){var i=k[j+"count"]?++k[j+"count"]:(k[j+"count"]=1);var l=(k[j+"total"]=((k[j+"total"]||0)+(h.data[j]||0)));return l===0?0:l/i;}};Ext.grid.GroupSummary.Calculations=Ext.ux.grid.GroupSummary.Calculations;Ext.ux.grid.HybridSummary=Ext.extend(Ext.ux.grid.GroupSummary,{calculate:function(f,i){var g=this.view.getGroupField(),j=f[0].data[g],h=this.getSummaryData(j);return h||Ext.ux.grid.HybridSummary.superclass.calculate.call(this,f,i);},updateSummaryData:function(f,g,h){var e=this.grid.getStore().reader.jsonData;if(!e.summaryData){e.summaryData={};}e.summaryData[f]=g;if(!h){this.refreshSummary(f);}},getSummaryData:function(d){var c=this.grid.getStore().reader.jsonData;if(c&&c.summaryData){return c.summaryData[d];}return null;}});Ext.grid.HybridSummary=Ext.ux.grid.HybridSummary;