Ext.ns("Ext.ux.grid");Ext.ux.grid.LockingGridView=Ext.extend(Ext.grid.GridView,{lockText:"Lock",unlockText:"Unlock",rowBorderWidth:1,lockedBorderWidth:1,syncHeights:false,initTemplates:function(){var b=this.templates||{};if(!b.master){b.master=new Ext.Template('<div class="x-grid3" hidefocus="true">','<div class="x-grid3-locked">','<div class="x-grid3-header"><div class="x-grid3-header-inner"><div class="x-grid3-header-offset" style="{lstyle}">{lockedHeader}</div></div><div class="x-clear"></div></div>','<div class="x-grid3-scroller"><div class="x-grid3-body" style="{lstyle}">{lockedBody}</div><div class="x-grid3-scroll-spacer"></div></div>',"</div>",'<div class="x-grid3-viewport x-grid3-unlocked">','<div class="x-grid3-header"><div class="x-grid3-header-inner"><div class="x-grid3-header-offset" style="{ostyle}">{header}</div></div><div class="x-clear"></div></div>','<div class="x-grid3-scroller"><div class="x-grid3-body" style="{bstyle}">{body}</div><a href="#" class="x-grid3-focus" tabIndex="-1"></a></div>',"</div>",'<div class="x-grid3-resize-marker">&#160;</div>','<div class="x-grid3-resize-proxy">&#160;</div>',"</div>");}this.templates=b;Ext.ux.grid.LockingGridView.superclass.initTemplates.call(this);},getEditorParent:function(b){return this.el.dom;},initElements:function(){var f=Ext.Element;var d=this.grid.getGridEl().dom.firstChild;var e=d.childNodes;this.el=new f(d);this.lockedWrap=new f(e[0]);this.lockedHd=new f(this.lockedWrap.dom.firstChild);this.lockedInnerHd=this.lockedHd.dom.firstChild;this.lockedScroller=new f(this.lockedWrap.dom.childNodes[1]);this.lockedBody=new f(this.lockedScroller.dom.firstChild);this.mainWrap=new f(e[1]);this.mainHd=new f(this.mainWrap.dom.firstChild);if(this.grid.hideHeaders){this.lockedHd.setDisplayed(false);this.mainHd.setDisplayed(false);}this.innerHd=this.mainHd.dom.firstChild;this.scroller=new f(this.mainWrap.dom.childNodes[1]);if(this.forceFit){this.scroller.setStyle("overflow-x","hidden");}this.mainBody=new f(this.scroller.dom.firstChild);this.focusEl=new f(this.scroller.dom.childNodes[1]);this.focusEl.swallowEvent("click",true);this.resizeMarker=new f(e[2]);this.resizeProxy=new f(e[3]);},getLockedRows:function(){return this.hasRows()?this.lockedBody.dom.childNodes:[];},getLockedRow:function(b){return this.getLockedRows()[b];},getCell:function(f,e){var d=this.cm.getLockedCount();if(e<d){return this.getLockedRow(f).getElementsByTagName("td")[e];}return Ext.ux.grid.LockingGridView.superclass.getCell.call(this,f,e-d);},getHeaderCell:function(d){var c=this.cm.getLockedCount();if(d<c){return this.lockedHd.dom.getElementsByTagName("td")[d];}return Ext.ux.grid.LockingGridView.superclass.getHeaderCell.call(this,d-c);},addRowClass:function(f,e){var d=this.getLockedRow(f);if(d){this.fly(d).addClass(e);}Ext.ux.grid.LockingGridView.superclass.addRowClass.call(this,f,e);},removeRowClass:function(f,e){var d=this.getLockedRow(f);if(d){this.fly(d).removeClass(e);}Ext.ux.grid.LockingGridView.superclass.removeRowClass.call(this,f,e);},removeRow:function(b){Ext.removeNode(this.getLockedRow(b));Ext.ux.grid.LockingGridView.superclass.removeRow.call(this,b);},removeRows:function(h,f){var e=this.lockedBody.dom;for(var g=h;g<=f;g++){Ext.removeNode(e.childNodes[h]);}Ext.ux.grid.LockingGridView.superclass.removeRows.call(this,h,f);},syncScroll:function(d){var c=this.scroller.dom;this.lockedScroller.dom.scrollTop=c.scrollTop;Ext.ux.grid.LockingGridView.superclass.syncScroll.call(this,d);},updateSortIcon:function(n,h){var j=this.sortClasses,m=this.lockedHd.select("td").removeClass(j),k=this.mainHd.select("td").removeClass(j),l=this.cm.getLockedCount(),i=j[h=="DESC"?1:0];if(n<l){m.item(n).addClass(i);}else{k.item(n-l).addClass(i);}},updateAllColumnWidths:function(){var t=this.getTotalWidth(),j=this.cm.getColumnCount(),y=this.getLockedWidth(),w=this.cm.getLockedCount(),r=[],s,v;this.updateLockedWidth();for(v=0;v<j;v++){r[v]=this.getColumnWidth(v);var u=this.getHeaderCell(v);u.style.width=r[v];}var z=this.getLockedRows(),p=this.getRows(),i,q,x;for(v=0,s=p.length;v<s;v++){i=z[v];i.style.width=y;if(i.firstChild){i.firstChild.style.width=y;q=i.firstChild.rows[0];for(x=0;x<w;x++){q.childNodes[x].style.width=r[x];}}i=p[v];i.style.width=t;if(i.firstChild){i.firstChild.style.width=t;q=i.firstChild.rows[0];for(x=w;x<j;x++){q.childNodes[x-w].style.width=r[x];}}}this.onAllColumnWidthsUpdated(r,t);this.syncHeaderHeight();},updateColumnWidth:function(t,v){var i=this.getColumnWidth(t),s=this.cm.getLockedCount(),n,u,o,c;this.updateLockedWidth();if(t<s){n=this.getLockedRows();u=this.getLockedWidth();o=t;}else{n=this.getRows();u=this.getTotalWidth();o=t-s;}var q=this.getHeaderCell(t);q.style.width=i;for(var r=0,p=n.length;r<p;r++){c=n[r];c.style.width=u;if(c.firstChild){c.firstChild.style.width=u;c.firstChild.rows[0].childNodes[o].style.width=i;}}this.onColumnWidthUpdated(t,i,this.getTotalWidth());this.syncHeaderHeight();},updateColumnHidden:function(u,q){var t=this.cm.getLockedCount(),i,v,n,c,o=q?"none":"";this.updateLockedWidth();if(u<t){i=this.getLockedRows();v=this.getLockedWidth();n=u;}else{i=this.getRows();v=this.getTotalWidth();n=u-t;}var r=this.getHeaderCell(u);r.style.display=o;for(var s=0,p=i.length;s<p;s++){c=i[s];c.style.width=v;if(c.firstChild){c.firstChild.style.width=v;c.firstChild.rows[0].childNodes[n].style.display=o;}}this.onColumnHiddenUpdated(u,q,this.getTotalWidth());delete this.lastViewWidth;this.layout();},doRender:function(S,P,F,X,G,j){var V=this.templates,T=V.cell,R=V.row,N=G-1,U="width:"+this.getTotalWidth()+";",W="width:"+this.getLockedWidth()+";",L=[],H=[],r,Q,K,E={},O={},J;for(var p=0,c=P.length;p<c;p++){J=P[p];r=[];Q=[];var M=(p+X);for(var i=0;i<G;i++){K=S[i];E.id=K.id;E.css=(i===0?"x-grid3-cell-first ":(i==N?"x-grid3-cell-last ":""))+(this.cm.config[i].cellCls?" "+this.cm.config[i].cellCls:"");E.attr=E.cellAttr="";E.value=K.renderer(J.data[K.name],E,J,M,i,F);E.style=K.style;if(Ext.isEmpty(E.value)){E.value="&#160;";}if(this.markDirty&&J.dirty&&Ext.isDefined(J.modified[K.name])){E.css+=" x-grid3-dirty-cell";}if(K.locked){Q[Q.length]=T.apply(E);}else{r[r.length]=T.apply(E);}}var I=[];if(j&&((M+1)%2===0)){I[0]="x-grid3-row-alt";}if(J.dirty){I[1]=" x-grid3-dirty-row";}O.cols=G;if(this.getRowClass){I[2]=this.getRowClass(J,M,O,F);}O.alt=I.join(" ");O.cells=r.join("");O.tstyle=U;L[L.length]=R.apply(O);O.cells=Q.join("");O.tstyle=W;H[H.length]=R.apply(O);}return[L.join(""),H.join("")];},processRows:function(o,r){if(!this.ds||this.ds.getCount()<1){return;}var i=this.getRows(),t=this.getLockedRows(),n,p;r=r||!this.grid.stripeRows;o=o||0;for(var v=0,u=i.length;v<u;++v){n=i[v];p=t[v];n.rowIndex=v;p.rowIndex=v;if(!r){n.className=n.className.replace(this.rowClsRe," ");p.className=p.className.replace(this.rowClsRe," ");if((v+1)%2===0){n.className+=" x-grid3-row-alt";p.className+=" x-grid3-row-alt";}}if(this.syncHeights){var w=Ext.get(n),x=Ext.get(p),q=w.getHeight(),s=x.getHeight();if(q>s){x.setHeight(q);}else{if(s>q){w.setHeight(s);}}}}if(o===0){Ext.fly(i[0]).addClass(this.firstRowCls);Ext.fly(t[0]).addClass(this.firstRowCls);}Ext.fly(i[i.length-1]).addClass(this.lastRowCls);Ext.fly(t[t.length-1]).addClass(this.lastRowCls);},afterRender:function(){if(!this.ds||!this.cm){return;}var b=this.renderRows()||["&#160;","&#160;"];this.mainBody.dom.innerHTML=b[0];this.lockedBody.dom.innerHTML=b[1];this.processRows(0,true);if(this.deferEmptyText!==true){this.applyEmptyText();}},renderUI:function(){var g=this.renderHeaders();var f=this.templates.body.apply({rows:"&#160;"});var e=this.templates.master.apply({body:f,header:g[0],ostyle:"width:"+this.getOffsetWidth()+";",bstyle:"width:"+this.getTotalWidth()+";",lockedBody:f,lockedHeader:g[1],lstyle:"width:"+this.getLockedWidth()+";"});var h=this.grid;h.getGridEl().dom.innerHTML=e;this.initElements();Ext.fly(this.innerHd).on("click",this.handleHdDown,this);Ext.fly(this.lockedInnerHd).on("click",this.handleHdDown,this);this.mainHd.on({scope:this,mouseover:this.handleHdOver,mouseout:this.handleHdOut,mousemove:this.handleHdMove});this.lockedHd.on({scope:this,mouseover:this.handleHdOver,mouseout:this.handleHdOut,mousemove:this.handleHdMove});this.scroller.on("scroll",this.syncScroll,this);if(h.enableColumnResize!==false){this.splitZone=new Ext.grid.GridView.SplitDragZone(h,this.mainHd.dom);this.splitZone.setOuterHandleElId(Ext.id(this.lockedHd.dom));this.splitZone.setOuterHandleElId(Ext.id(this.mainHd.dom));}if(h.enableColumnMove){this.columnDrag=new Ext.grid.GridView.ColumnDragZone(h,this.innerHd);this.columnDrag.setOuterHandleElId(Ext.id(this.lockedInnerHd));this.columnDrag.setOuterHandleElId(Ext.id(this.innerHd));this.columnDrop=new Ext.grid.HeaderDropZone(h,this.mainHd.dom);}if(h.enableHdMenu!==false){this.hmenu=new Ext.menu.Menu({id:h.id+"-hctx"});this.hmenu.add({itemId:"asc",text:this.sortAscText,cls:"xg-hmenu-sort-asc"},{itemId:"desc",text:this.sortDescText,cls:"xg-hmenu-sort-desc"});if(this.grid.enableColLock!==false){this.hmenu.add("-",{itemId:"lock",text:this.lockText,cls:"xg-hmenu-lock"},{itemId:"unlock",text:this.unlockText,cls:"xg-hmenu-unlock"});}if(h.enableColumnHide!==false){this.colMenu=new Ext.menu.Menu({id:h.id+"-hcols-menu"});this.colMenu.on({scope:this,beforeshow:this.beforeColMenuShow,itemclick:this.handleHdMenuClick});this.hmenu.add("-",{itemId:"columns",hideOnClick:false,text:this.columnsText,menu:this.colMenu,iconCls:"x-cols-icon"});}this.hmenu.on("itemclick",this.handleHdMenuClick,this);}if(h.trackMouseOver){this.mainBody.on({scope:this,mouseover:this.onRowOver,mouseout:this.onRowOut});this.lockedBody.on({scope:this,mouseover:this.onRowOver,mouseout:this.onRowOut});}if(h.enableDragDrop||h.enableDrag){this.dragZone=new Ext.grid.GridDragZone(h,{ddGroup:h.ddGroup||"GridDD"});}this.updateHeaderSortState();},layout:function(){if(!this.mainBody){return;}var l=this.grid;var i=l.getGridEl();var g=i.getSize(true);var c=g.width;if(!l.hideHeaders&&(c<20||g.height<20)){return;}this.syncHeaderHeight();if(l.autoHeight){this.scroller.dom.style.overflow="visible";this.lockedScroller.dom.style.overflow="visible";if(Ext.isWebKit){this.scroller.dom.style.position="static";this.lockedScroller.dom.style.position="static";}}else{this.el.setSize(g.width,g.height);var j=this.mainHd.getHeight();var k=g.height-(j);}this.updateLockedWidth();if(this.forceFit){if(this.lastViewWidth!=c){this.fitColumns(false,false);this.lastViewWidth=c;}}else{this.autoExpand();this.syncHeaderScroll();}this.onLayout(c,k);},getOffsetWidth:function(){return(this.cm.getTotalWidth()-this.cm.getTotalLockedWidth()+this.getScrollOffset())+"px";},renderHeaders:function(){var k=this.cm,m=this.templates,o=m.hcell,q=[],l=[],r={},n=k.getColumnCount(),i=n-1;for(var p=0;p<n;p++){r.id=k.getColumnId(p);r.value=k.getColumnHeader(p)||"";r.style=this.getColumnStyle(p,true);r.tooltip=this.getColumnTooltip(p);r.css=(p===0?"x-grid3-cell-first ":(p==i?"x-grid3-cell-last ":""))+(k.config[p].headerCls?" "+k.config[p].headerCls:"");if(k.config[p].align=="right"){r.istyle="padding-right:16px";}else{delete r.istyle;}if(k.isLocked(p)){l[l.length]=o.apply(r);}else{q[q.length]=o.apply(r);}}return[m.header.apply({cells:q.join(""),tstyle:"width:"+this.getTotalWidth()+";"}),m.header.apply({cells:l.join(""),tstyle:"width:"+this.getLockedWidth()+";"})];},updateHeaders:function(){var c=this.renderHeaders();this.innerHd.firstChild.innerHTML=c[0];this.innerHd.firstChild.style.width=this.getOffsetWidth();this.innerHd.firstChild.firstChild.style.width=this.getTotalWidth();this.lockedInnerHd.firstChild.innerHTML=c[1];var d=this.getLockedWidth();this.lockedInnerHd.firstChild.style.width=d;this.lockedInnerHd.firstChild.firstChild.style.width=d;},getResolvedXY:function(e){if(!e){return null;}var f=e.cell,c=e.row;return f?Ext.fly(f).getXY():[this.scroller.getX(),Ext.fly(c).getY()];},syncFocusEl:function(f,e,d){Ext.ux.grid.LockingGridView.superclass.syncFocusEl.call(this,f,e,e<this.cm.getLockedCount()?false:d);},ensureVisible:function(f,e,d){return Ext.ux.grid.LockingGridView.superclass.ensureVisible.call(this,f,e,e<this.cm.getLockedCount()?false:d);},insertRows:function(i,j,m,k){var n=i.getCount()-1;if(!k&&j===0&&m>=n){this.refresh();}else{if(!k){this.fireEvent("beforerowsinserted",this,j,m);}var h=this.renderRows(j,m),l=this.getRow(j);if(l){if(j===0){this.removeRowClass(0,this.firstRowCls);}Ext.DomHelper.insertHtml("beforeBegin",l,h[0]);l=this.getLockedRow(j);Ext.DomHelper.insertHtml("beforeBegin",l,h[1]);}else{this.removeRowClass(n-1,this.lastRowCls);Ext.DomHelper.insertHtml("beforeEnd",this.mainBody.dom,h[0]);Ext.DomHelper.insertHtml("beforeEnd",this.lockedBody.dom,h[1]);}if(!k){this.fireEvent("rowsinserted",this,j,m);this.processRows(j);}else{if(j===0||j>=n){this.addRowClass(j,j===0?this.firstRowCls:this.lastRowCls);}}}this.syncFocusEl(j);},getColumnStyle:function(f,h){var e=!h?this.cm.config[f].cellStyle||this.cm.config[f].css||"":this.cm.config[f].headerStyle||"";e+="width:"+this.getColumnWidth(f)+";";if(this.cm.isHidden(f)){e+="display:none;";}var g=this.cm.config[f].align;if(g){e+="text-align:"+g+";";}return e;},getLockedWidth:function(){return this.cm.getTotalLockedWidth()+"px";},getTotalWidth:function(){return(this.cm.getTotalWidth()-this.cm.getTotalLockedWidth())+"px";},getColumnData:function(){var i=[],g=this.cm,h=g.getColumnCount();for(var j=0;j<h;j++){var f=g.getDataIndex(j);i[j]={name:(!Ext.isDefined(f)?this.ds.fields.get(j).name:f),renderer:g.getRenderer(j),id:g.getColumnId(j),style:this.getColumnStyle(j),locked:g.isLocked(j)};}return i;},renderBody:function(){var b=this.renderRows()||["&#160;","&#160;"];return[this.templates.body.apply({rows:b[0]}),this.templates.body.apply({rows:b[1]})];},refreshRow:function(d){Ext.ux.grid.LockingGridView.superclass.refreshRow.call(this,d);var c=Ext.isNumber(d)?d:this.ds.indexOf(d);this.getLockedRow(c).rowIndex=c;},refresh:function(c){this.fireEvent("beforerefresh",this);this.grid.stopEditing(true);var d=this.renderBody();this.mainBody.update(d[0]).setWidth(this.getTotalWidth());this.lockedBody.update(d[1]).setWidth(this.getLockedWidth());if(c===true){this.updateHeaders();this.updateHeaderSortState();}this.processRows(0,true);this.layout();this.applyEmptyText();this.fireEvent("refresh",this);},onDenyColumnLock:function(){},initData:function(c,d){if(this.cm){this.cm.un("columnlockchange",this.onColumnLock,this);}Ext.ux.grid.LockingGridView.superclass.initData.call(this,c,d);if(this.cm){this.cm.on("columnlockchange",this.onColumnLock,this);}},onColumnLock:function(){this.refresh(true);},handleHdMenuClick:function(i){var f=this.hdCtxIndex,g=this.cm,h=i.getItemId(),j=g.getLockedCount();switch(h){case"lock":if(g.getColumnCount(true)<=j+1){this.onDenyColumnLock();return;}if(j!=f){g.setLocked(f,true,true);g.moveColumn(f,j);this.grid.fireEvent("columnmove",f,j);}else{g.setLocked(f,true);}break;case"unlock":if(j-1!=f){g.setLocked(f,false,true);g.moveColumn(f,j-1);this.grid.fireEvent("columnmove",f,j-1);}else{g.setLocked(f,false);}break;default:return Ext.ux.grid.LockingGridView.superclass.handleHdMenuClick.call(this,i);}return true;},handleHdDown:function(i,k){Ext.ux.grid.LockingGridView.superclass.handleHdDown.call(this,i,k);if(this.grid.enableColLock!==false){if(Ext.fly(k).hasClass("x-grid3-hd-btn")){var j=this.findHeaderCell(k),l=this.getCellIndex(j),e=this.hmenu.items,h=this.cm;e.get("lock").setDisabled(h.isLocked(l));e.get("unlock").setDisabled(!h.isLocked(l));}}},syncHeaderHeight:function(){this.innerHd.firstChild.firstChild.style.height="auto";this.lockedInnerHd.firstChild.firstChild.style.height="auto";var f=this.innerHd.firstChild.firstChild.offsetHeight,d=this.lockedInnerHd.firstChild.firstChild.offsetHeight,e=(d>f?d:f)+"px";this.innerHd.firstChild.firstChild.style.height=e;this.lockedInnerHd.firstChild.firstChild.style.height=e;},updateLockedWidth:function(){var l=this.cm.getTotalLockedWidth(),j=this.cm.getTotalWidth()-l,p=this.grid.getGridEl().getSize(true),i=Ext.isBorderBox?0:this.lockedBorderWidth,o=Ext.isBorderBox?0:this.rowBorderWidth,n=(p.width-l-i-o)+"px",m=this.getScrollOffset();if(!this.grid.autoHeight){var k=(p.height-this.mainHd.getHeight())+"px";this.lockedScroller.dom.style.height=k;this.scroller.dom.style.height=k;}this.lockedWrap.dom.style.width=(l+o)+"px";this.scroller.dom.style.width=n;this.mainWrap.dom.style.left=(l+i+o)+"px";if(this.innerHd){this.lockedInnerHd.firstChild.style.width=l+"px";this.lockedInnerHd.firstChild.firstChild.style.width=l+"px";this.innerHd.style.width=n;this.innerHd.firstChild.style.width=(j+o+m)+"px";this.innerHd.firstChild.firstChild.style.width=j+"px";}if(this.mainBody){this.lockedBody.dom.style.width=(l+o)+"px";this.mainBody.dom.style.width=(j+o)+"px";}}});Ext.ux.grid.LockingColumnModel=Ext.extend(Ext.grid.ColumnModel,{isLocked:function(b){return this.config[b].locked===true;},setLocked:function(d,f,e){if(this.isLocked(d)==f){return;}this.config[d].locked=f;if(!e){this.fireEvent("columnlockchange",this,d,f);}},getTotalLockedWidth:function(){var d=0;for(var f=0,e=this.config.length;f<e;f++){if(this.isLocked(f)&&!this.isHidden(f)){d+=this.getColumnWidth(f);}}return d;},getLockedCount:function(){for(var c=0,d=this.config.length;c<d;c++){if(!this.isLocked(c)){return c;}}},moveColumn:function(c,d){if(c<d&&this.isLocked(c)&&!this.isLocked(d)){this.setLocked(c,false,true);}else{if(c>d&&!this.isLocked(c)&&this.isLocked(d)){this.setLocked(c,true,true);}}Ext.ux.grid.LockingColumnModel.superclass.moveColumn.apply(this,arguments);}});