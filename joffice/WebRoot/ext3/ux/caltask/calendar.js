Ext.namespace("e2cs.dateParts");e2cs.dateParts={YEAR:0,MONTH:1,DAY:2,HOUR:3,MINUTE:4,SECOND:5,MILLISECOND:6,QUARTER:7,WEEK:8,WEEKDAY:9};Ext.ECalendar=Ext.extend(Ext.Panel,{id:"e-calendar",title:"Calendar",mytitle:"",html:null,showCal_tbar:true,showRefreshbtn:true,refreshAction:"view",currentView:"month",currentdate:new Date(),dateSelector:false,dateSelectorIcon:"",dateformat:"d-m-Y",fieldsRefer:{id:"",subject:"",description:"",color:"",startdate:"",enddate:"",priority:"",parent:"",html:"",isHoliday:"",alldaytask:"",location:""},tipmaxLength:100,rendertaskonHolidays:false,storeOrderby:"",storeOrder:"ASC",tplTaskTip:new Ext.XTemplate("<tpl for=\".\">{location}{starxl}{startval}<br>{endxl}{endval}<hr color='#003366' noshade/>{details}</tpl>"),tplTaskZoom:new Ext.XTemplate('<tpl for=".">','<div class="ecal-show-basetasktpl-div">任务:{subject}<br />',"地点:{location}<br />","开始1:{startdate}<br />结束:{enddate}<br>描述:<br>{description}</div>","</tpl>"),iconRefresh:"",iconAddTask:"",monitorBrowserresize:false,iconToday:"",mview:null,iconMonthView:"",wview:null,iconWeekView:"",dview:null,iconDayView:"",sview:null,iconSchedView:"",store:null,pickerStartDay:0,viewmonth:null,viewday:null,viewweek:null,viewscheduler:null,viewready:false,loadMask:true,customMaskText:"",calendarMask:null,initComponent:function(){this.addEvents("onRefresh","onReload","beforeChangeView","onChangeView","beforeChangeDate","afterChangeDate","beforeContextMenuTask","customMenuAction","taskAdd","taskDblClick","beforeTaskMove","TaskMoved","beforeTaskDelete","onTaskDelete","afterTaskDelete","beforeTaskEdit","onTaskEdit","afterTaskEdit");if(this.html!=null){this.html=null;}toolspanel=[];this.btnrefresh={id:"refresh",tooltip:"刷新"};if(this.showRefreshbtn){toolspanel.push(this.btnrefresh);}this.btn_today={id:this.id+"-btn_settoday",cls:"x-btn-text-icon",text:e2cs.cal_locale.todayLabel,icon:this.iconToday,tooltip:e2cs.cal_locale.todayToolTip};this.btn_monthviewchange={id:this.id+"-btn_monthview",cls:"x-btn-icon",text:"",icon:this.iconMonthView,tooltip:e2cs.cal_locale.tooltipMonthView};this.btn_weekviewchange={id:this.id+"-btn_weekview",cls:"x-btn-icon",text:"",icon:this.iconWeekView,tooltip:e2cs.cal_locale.tooltipWeekView};this.btn_dayviewchange={id:this.id+"-btn_dayview",cls:"x-btn-icon",text:"",icon:this.iconDayView,tooltip:e2cs.cal_locale.tooltipDayView};this.btn_schedviewchange={id:this.id+"-btn_sched_view",cls:"x-btn-icon",text:"",icon:this.iconSchedView,tooltip:e2cs.cal_locale.tooltipSchedView};this.btn_refresh={id:this.id+"-btn_refresh",cls:"x-btn-icon",text:"",icon:this.iconRefresh,tooltip:"刷新"};this.btn_addTask={id:this.id+"-btn_addTask",cls:"x-btn-icon",text:"",icon:this.iconAddTask,tooltip:"添加日程"};if(this.showCal_tbar){this.tbar_calendar=new Ext.Toolbar({id:this.id+"-cmscalendartoolbar",autoWidth:true,autoHeight:false,items:[this.btn_today,"-",this.btn_monthviewchange,this.btn_weekviewchange,this.btn_dayviewchange,this.btn_schedviewchange,"-",this.btn_refresh,this.btn_addTask]});}else{this.tbar_calendar=null;}this.selector_dateMenu=new Ext.menu.DateMenu({defaultAlign:"tr-br",subMenuAlign:""});if(this.width){var_autoWidth=false;}else{var_autoWidth=true;}if(this.height){var_autoHeight=false;}else{var_autoHeight=true;}Ext.apply(this,{header:this.header,headerAsText:true,title:this.title+this.mytitle,border:true,width:this.width,height:this.height,monitorResize:true,autoShow:true,autoWidth:var_autoWidth,autoHeight:var_autoHeight,autoScroll:false,html:this.html,tools:toolspanel,tbar:this.tbar_calendar,loadMask:this.loadMask});Ext.ECalendar.superclass.initComponent.call(this);if(this.mview){this.viewmonth=this.getViewMonth();this.viewmonth.init(this,this.currentdate);}if(this.dview){this.viewday=this.getViewDay();this.viewday.init(this,this.currentdate);}if(this.wview){this.viewweek=this.getViewWeek();this.viewweek.init(this,this.currentdate);}if(this.sview){this.viewscheduler=this.getViewShedule();this.viewscheduler.init(this,this.currentdate);}},onResize:function(){Ext.ECalendar.superclass.onResize.apply(this,arguments);this.doLayout();if(this.viewready){if(this.currentView=="month"){this.viewmonth.render();}if(this.currentView=="week"){this.viewweek.render();}if(this.currentView=="day"){this.viewday.render();}if(this.currentView=="schedule"){this.viewscheduler.render();}}},onRender:function(){Ext.ECalendar.superclass.onRender.apply(this,arguments);},afterRender:function(){Ext.ECalendar.superclass.afterRender.call(this);if(this.loadMask){if(this.store==null&&this.store==undefined){}else{if(this.customMaskText==""){var j=e2cs.cal_locale.loadmaskText;}else{var j=this.customMaskText;}this.calendarMask=new Ext.LoadMask(Ext.get(this.id),{msg:j});}}if(this.storeOrderby==""){}else{this.store.sort(this.storeOrderby,this.storeOrder);}if(this.showCal_tbar){var l=this.topToolbar.items.items[0];l.setHandler(this.setCurrentDate,this);var p=this.topToolbar.items.items[2];var i=this.topToolbar.items.items[3];var m=this.topToolbar.items.items[4];var n=this.topToolbar.items.items[5];var k=this.topToolbar.items.items[7];var o=this.topToolbar.items.items[8];if(!this.mview){p.setVisible(false);}else{p.setVisible(true);}if(!this.dview){m.setVisible(false);}else{m.setVisible(true);}if(!this.wview){i.setVisible(false);}else{i.setVisible(true);}if(!this.sview){n.setVisible(false);}else{n.setVisible(true);}p.addListener("click",function(){this.changeView("month");},this);m.addListener("click",function(){this.changeView("day");},this);i.addListener("click",function(){this.changeView("week");},this);n.addListener("click",function(){this.changeView("schedule");},this);k.addListener("click",function(){this.fireEvent("onReload",this);},this);o.addListener("click",function(){this.fireEvent("taskAdd",this);},this);}if(this.header&&this.tools.refresh){if(this.refreshAction=="view"){this.tools.refresh.addListener("click",this.refreshCalendarView,this);}else{this.tools.refresh.addListener("click",function(){this.store.reload();},this);}}if(this.dateSelector&&this.showCal_tbar){this.selector_dateMenu.picker.startDay=this.pickerStartDay;this.selector_dateMenu.picker.todayText=e2cs.cal_locale.todayLabel;this.selector_dateMenu.picker.todayTip=e2cs.cal_locale.todayToolTip;this.selector_dateMenu.picker.monthNames=e2cs.cal_locale.monthtitles;this.selector_dateMenu.picker.dayNames=e2cs.cal_locale.daytitles;this.selector_dateMenu.picker.setValue(this.currentdate);this.selector_dateMenu.addListener("select",this.selectdatefromSelector,this);this.btn_selector={id:this.id+"-btn_dateselector",cls:"x-btn-text-icon",text:e2cs.cal_locale.dateSelectorText,icon:this.dateSelectorIcon,tooltip:e2cs.cal_locale.dateSelectorTooltip,menu:this.selector_dateMenu};this.tbar_calendar.addButton(this.btn_selector);}if(this.ownerCt==undefined){if(this.currentView=="month"){this.viewmonth.render();}if(this.currentView=="week"){this.viewweek.render();}if(this.currentView=="day"){this.viewday.render();}if(this.currentView=="schedule"){this.viewscheduler.render();}}else{if(this.currentView=="month"){this.viewmonth.render();}if(this.currentView=="week"){this.viewweek.render();}if(this.currentView=="day"){this.viewday.render();}if(this.currentView=="schedule"){this.viewscheduler.render();}}this.doLayout();this.viewready=true;tmpobj=this;if(this.monitorBrowserResize){Ext.EventManager.onWindowResize(function(){tmpobj.refreshCalendarView();});}},refreshCalendarView:function(b){if(this.rendered){if(this.storeOrderby==""){}else{this.store.sort(this.storeOrderby,this.storeOrder);}if(this.currentView=="month"){this.viewmonth.render();}if(this.currentView=="week"){this.viewweek.render();}if(this.currentView=="day"){this.viewday.render();}if(this.currentView=="schedule"){this.viewscheduler.render();}this.doLayout();this.fireEvent("onRefresh",this);}},setNewDate:function(b){if(this.fireEvent("beforeChangeDate",b,this)==false){this.selector_dateMenu.picker.setValue(this.currentdate);return false;}if(this.storeOrderby==""){}else{this.store.sort(this.storeOrderby,this.storeOrder);}this.currentdate=new Date(b);this.selector_dateMenu.picker.setValue(this.currentdate);if(this.currentView=="month"){this.viewmonth.render();}if(this.currentView=="week"){this.viewweek.render();}if(this.currentView=="day"){this.viewday.render();}if(this.currentView=="schedule"){this.viewscheduler.render();}this.doLayout();this.fireEvent("afterChangeDate",this.currentdate,this);},setCurrentDate:function(){this.setNewDate(Date());},changeView:function(h,e){var g=h;var f=this.currentView;if(g==f){return false;}if(this.fireEvent("beforeChangeView",g,this.currentView,this)==false){return false;}if(h=="month"){if(this.viewmonth==null||this.viewmonth==undefined){return false;}else{this.currentView="month";this.viewmonth.render();}}else{if(h=="week"){if(this.viewweek==null||this.viewweek==undefined){return false;}else{this.currentView="week";this.viewweek.render();}}else{if(h=="day"){if(this.viewday==null||this.viewday==undefined){return false;}else{this.currentView="day";this.viewday.render();}}else{if(h=="schedule"){if(this.viewscheduler==null||this.viewscheduler==undefined){return false;}else{this.currentView="schedule";this.viewscheduler.render();}}else{return false;}}}}this.fireEvent("onChangeView",g,f,this);},selectdatefromSelector:function(c,d){this.setNewDate(d);},getCurrentDate:function(){return this.currentdate;},getViewMonth:function(){if(!this.viewmonth){this.viewmonth=new Ext.ECalendar.monthview(this.mview);}return this.viewmonth;},getViewDay:function(){if(!this.viewday){this.viewday=new Ext.ECalendar.dayview(this.dview);}return this.viewday;},getViewWeek:function(){if(!this.viewweek){this.viewweek=new Ext.ECalendar.weekview(this.wview);}return this.viewweek;},getViewShedule:function(){if(!this.viewscheduler){this.viewscheduler=new Ext.ECalendar.scheduleview(this.sview);}return this.viewscheduler;},getCalendarMonth:function(){return(this.currentdate.getMonth()+1);},getCalendarYear:function(){return(this.currentdate.getFullYear());},getCalendarDay:function(){return(this.currentdate.getUTCDate());},getCalendarWeekDay:function(b){if(b=="str"){return Date.dayNames[this.currentdate.getDay()];}else{return(this.currentdate.getDay());}},getRangeofMonth:function(w){var A=new Date(dateval);var r=A.getFirstDayOfMonth()-this.startDay;var s=A.getDaysInMonth();if(A.getMonth()==1){if((A.getFullYear()%4==0&&A.getFullYear()%100!=0)||A.getFullYear()%400==0){s=29;}}if(r<0){r=7+(r);}var t=new Date((dateval.getMonth()+1)+"/1/"+dateval.getFullYear()).add(Date.DAY,(r*-1));var v=r;startmonthdate=new Date(A.format("m")+"/01/"+A.format("Y"));for(var u=0;u<s;u++){if(v>=7){v=0;}var z=new Date(startmonthdate).add(Date.DAY,u);v+=1;}var o=new Date((dateval.getMonth()+1)+"/1/"+dateval.getFullYear()).add(Date.DAY,(s));var y=o.getDay();if(v<7){var p=0;for(var x=v;x<7;x++){p=p+1;var B=new Date(z).add(Date.DAY,p);}}var q=[t,B];return q;},getDateRangeOfWeekByDate:function(i,j){var f=new Date(j).getDay();if(i==1){f=((f==0)?6:f-1);var h=new Date(j.add(Date.DAY,-f).format("m/d/Y")+" 00:00:00");var g=new Date(j.add(Date.DAY,-f+6).format("m/d/Y")+" 23:59:59");}else{if(i==0){if(f==0){var h=new Date(j.add(Date.DAY,0).format("m/d/Y")+" 00:00:00");var g=new Date(j.add(Date.DAY,6).format("m/d/Y")+" 23:59:59");}else{var h=new Date(j.add(Date.DAY,-(f)).format("m/d/Y")+" 00:00:00");var g=new Date(h.add(Date.DAY,6).format("m/d/Y")+" 23:59:59");}}else{if(f==6){var h=new Date(j.add(Date.DAY,0).format("m/d/Y")+" 00:00:00");var g=new Date(j.add(Date.DAY,6).format("m/d/Y")+" 23:59:59");}else{var h=new Date(j.add(Date.DAY,-(f+1)).format("m/d/Y")+" 00:00:00");var g=new Date(h.add(Date.DAY,6).format("m/d/Y")+" 23:59:59");}}}return[h,g];},getDateRangeOfWeek:function(weekNo){var d1=new Date();numOfdaysPastSinceLastMonday=eval(d1.getDay()-1);d1.setDate(d1.getDate()-numOfdaysPastSinceLastMonday);var weekNoToday=d1.getWeekOfYear();var weeksInTheFuture=eval(weekNo-weekNoToday);d1.setDate(d1.getDate()+eval(7*weeksInTheFuture));var rangeIsFrom=new Date((d1.getMonth()+1)+"/"+d1.getDate()+"/"+d1.getFullYear());d1.setDate(d1.getDate()+6);var rangeIsTo=new Date((d1.getMonth()+1)+"/"+d1.getDate()+"/"+d1.getFullYear());return[rangeIsFrom,rangeIsTo];},dateDiff:function(date1,date2,interv){if(typeof date1=="number"){date1=new Date(date1);}if(typeof date2=="number"){date2=new Date(date2);}if(date1.format("m/d/Y H:i:s")==date2.format("m/d/Y H:i:s")){return 0;}var yeaDiff=date2.getFullYear()-date1.getFullYear();var monDiff=(date2.getMonth()-date1.getMonth())+(yeaDiff*12);var msDiff=date2.getTime()-date1.getTime();var secDiff=msDiff/1000;var minDiff=secDiff/60;var houDiff=minDiff/60;var dayDiff=houDiff/24;var weeDiff=dayDiff/7;var delta=0;with(e2cs.dateParts){switch(interv){case YEAR:delta=yeaDiff;break;case QUARTER:var m1=date1.getMonth();var m2=date2.getMonth();var q1=Math.floor(m1/3)+1;var q2=Math.floor(m2/3)+1;q2+=(yeaDiff*4);delta=q2-q1;break;case MONTH:delta=monDiff;break;case WEEK:delta=parseInt(weeDiff);break;case DAY:delta=dayDiff;break;case WEEKDAY:var days=Math.round(dayDiff);var weeks=parseInt(days/7);var mod=days%7;if(mod==0){days=weeks*5;}else{var adj=0;var aDay=date1.getDay();var bDay=date2.getDay();weeks=parseInt(days/7);mod=days%7;var dtMark=new Date(date1);dtMark.setDate(dtMark.getDate()+(weeks*7));var dayMark=dtMark.getDay();if(dayDiff>0){switch(true){case aDay==6:adj=-1;break;case aDay==0:adj=0;break;case bDay==6:adj=-1;break;case bDay==0:adj=-2;break;case (dayMark+mod)>5:adj=-2;break;default:break;}}else{if(dayDiff<0){switch(true){case aDay==6:adj=0;break;case aDay==0:adj=1;break;case bDay==6:adj=2;break;case bDay==0:adj=1;break;case (dayMark+mod)<0:adj=2;break;default:break;}}}days+=adj;days-=(weeks*2);}delta=days;break;case HOUR:delta=houDiff;break;case MINUTE:delta=minDiff;break;case SECOND:delta=secDiff;break;case MILLISECOND:delta=msDiff;break;default:break;}}return Math.round(delta);}});Ext.reg("e2cs_calendar",Ext.ECalendar);