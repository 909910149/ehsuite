Ext.ux.tree.TreeGrid=Ext.extend(Ext.tree.TreePanel,{rootVisible:false,useArrows:true,lines:false,borderWidth:Ext.isBorderBox?0:2,cls:"x-treegrid",columnResize:true,enableSort:true,reserveScrollOffset:true,enableHdMenu:true,columnsText:"Columns",initComponent:function(){if(!this.root){this.root=new Ext.tree.AsyncTreeNode({text:"Root"});}var d=this.loader;if(!d){d=new Ext.ux.tree.TreeGridLoader({dataUrl:this.dataUrl,requestMethod:this.requestMethod,store:this.store});}else{if(Ext.isObject(d)&&!d.load){d=new Ext.ux.tree.TreeGridLoader(d);}else{if(d){d.createNode=function(a){if(!a.uiProvider){a.uiProvider=Ext.ux.tree.TreeGridNodeUI;}return Ext.tree.TreeLoader.prototype.createNode.call(this,a);};}}}this.loader=d;Ext.ux.tree.TreeGrid.superclass.initComponent.call(this);this.initColumns();if(this.enableSort){this.treeGridSorter=new Ext.ux.tree.TreeGridSorter(this,this.enableSort);}if(this.columnResize){this.colResizer=new Ext.tree.ColumnResizer(this.columnResize);this.colResizer.init(this);}var c=this.columns;if(!this.internalTpl){this.internalTpl=new Ext.XTemplate('<div class="x-grid3-header">','<div class="x-treegrid-header-inner">','<div class="x-grid3-header-offset">','<table cellspacing="0" cellpadding="0" border="0"><colgroup><tpl for="columns"><col /></tpl></colgroup>','<thead><tr class="x-grid3-hd-row">','<tpl for="columns">','<td class="x-grid3-hd x-grid3-cell x-treegrid-hd" style="text-align: {align};" id="',this.id,'-xlhd-{#}">','<div class="x-grid3-hd-inner x-treegrid-hd-inner" unselectable="on">',this.enableHdMenu?'<a class="x-grid3-hd-btn" href="#"></a>':"",'{header}<img class="x-grid3-sort-icon" src="',Ext.BLANK_IMAGE_URL,'" />',"</div>","</td></tpl>","</tr></thead>","</div></table>","</div></div>","</div>",'<div class="x-treegrid-root-node">','<table class="x-treegrid-root-table" cellpadding="0" cellspacing="0" style="table-layout: fixed;"></table>',"</div>");}if(!this.colgroupTpl){this.colgroupTpl=new Ext.XTemplate('<colgroup><tpl for="columns"><col style="width: {width}px"/></tpl></colgroup>');}},initColumns:function(){var i=this.columns,g=i.length,j=[],c,h;for(c=0;c<g;c++){h=i[c];if(!h.isColumn){h.xtype=h.xtype?(/^tg/.test(h.xtype)?h.xtype:"tg"+h.xtype):"tgcolumn";h=Ext.create(h);}h.init(this);j.push(h);if(this.enableSort!==false&&h.sortable!==false){h.sortable=true;this.enableSort=true;}}this.columns=j;},onRender:function(){Ext.tree.TreePanel.superclass.onRender.apply(this,arguments);this.el.addClass("x-treegrid");this.outerCt=this.body.createChild({cls:"x-tree-root-ct x-treegrid-ct "+(this.useArrows?"x-tree-arrows":this.lines?"x-tree-lines":"x-tree-no-lines")});this.internalTpl.overwrite(this.outerCt,{columns:this.columns});this.mainHd=Ext.get(this.outerCt.dom.firstChild);this.innerHd=Ext.get(this.mainHd.dom.firstChild);this.innerBody=Ext.get(this.outerCt.dom.lastChild);this.innerCt=Ext.get(this.innerBody.dom.firstChild);this.colgroupTpl.insertFirst(this.innerCt,{columns:this.columns});if(this.hideHeaders){this.header.dom.style.display="none";}else{if(this.enableHdMenu!==false){this.hmenu=new Ext.menu.Menu({id:this.id+"-hctx"});if(this.enableColumnHide!==false){this.colMenu=new Ext.menu.Menu({id:this.id+"-hcols-menu"});this.colMenu.on({scope:this,beforeshow:this.beforeColMenuShow,itemclick:this.handleHdMenuClick});this.hmenu.add({itemId:"columns",hideOnClick:false,text:this.columnsText,menu:this.colMenu,iconCls:"x-cols-icon"});}this.hmenu.on("itemclick",this.handleHdMenuClick,this);}}},setRootNode:function(b){b.attributes.uiProvider=Ext.ux.tree.TreeGridRootNodeUI;b=Ext.ux.tree.TreeGrid.superclass.setRootNode.call(this,b);if(this.innerCt){this.colgroupTpl.insertFirst(this.innerCt,{columns:this.columns});}return b;},clearInnerCt:function(){if(Ext.isIE){var b=this.innerCt.dom;while(b.firstChild){b.removeChild(b.firstChild);}}else{Ext.ux.tree.TreeGrid.superclass.clearInnerCt.call(this);}},initEvents:function(){Ext.ux.tree.TreeGrid.superclass.initEvents.apply(this,arguments);this.mon(this.innerBody,"scroll",this.syncScroll,this);this.mon(this.innerHd,"click",this.handleHdDown,this);this.mon(this.mainHd,{scope:this,mouseover:this.handleHdOver,mouseout:this.handleHdOut});},onResize:function(g,l){Ext.ux.tree.TreeGrid.superclass.onResize.apply(this,arguments);var j=this.innerBody.dom;var i=this.innerHd.dom;if(!j){return;}if(Ext.isNumber(l)){j.style.height=this.body.getHeight(true)-i.offsetHeight+"px";}if(Ext.isNumber(g)){var h=Ext.num(this.scrollOffset,Ext.getScrollBarWidth());if(this.reserveScrollOffset||((j.offsetWidth-j.clientWidth)>10)){this.setScrollOffset(h);}else{var k=this;setTimeout(function(){k.setScrollOffset(j.offsetWidth-j.clientWidth>10?h:0);},10);}}},updateColumnWidths:function(){var i=this.columns,c=i.length,r=this.outerCt.query("colgroup"),g=r.length,j,o,p,q;for(p=0;p<c;p++){j=i[p];for(q=0;q<g;q++){o=r[q];o.childNodes[p].style.width=(j.hidden?0:j.width)+"px";}}for(p=0,r=this.innerHd.query("td"),len=r.length;p<len;p++){j=Ext.fly(r[p]);if(i[p]&&i[p].hidden){j.addClass("x-treegrid-hd-hidden");}else{j.removeClass("x-treegrid-hd-hidden");}}var n=this.getTotalColumnWidth();Ext.fly(this.innerHd.dom.firstChild).setWidth(n+(this.scrollOffset||0));this.outerCt.select("table").setWidth(n);this.syncHeaderScroll();},getVisibleColumns:function(){var h=[],g=this.columns,f=g.length,e;for(e=0;e<f;e++){if(!g[e].hidden){h.push(g[e]);}}return h;},getTotalColumnWidth:function(){var g=0;for(var e=0,h=this.getVisibleColumns(),f=h.length;e<f;e++){g+=h[e].width;}return g;},setScrollOffset:function(b){this.scrollOffset=b;this.updateColumnWidths();},handleHdDown:function(l,o){var m=l.getTarget(".x-treegrid-hd");if(m&&Ext.fly(o).hasClass("x-grid3-hd-btn")){var c=this.hmenu.items,n=this.columns,e=this.findHeaderIndex(m),k=n[e],p=k.sortable;l.stopEvent();Ext.fly(m).addClass("x-grid3-hd-menu-open");this.hdCtxIndex=e;this.fireEvent("headerbuttonclick",c,k,m,e);this.hmenu.on("hide",function(){Ext.fly(m).removeClass("x-grid3-hd-menu-open");},this,{single:true});this.hmenu.show(o,"tl-bl?");}else{if(m){var e=this.findHeaderIndex(m);this.fireEvent("headerclick",this.columns[e],m,e);}}},handleHdOver:function(g,f){var h=g.getTarget(".x-treegrid-hd");if(h&&!this.headersDisabled){index=this.findHeaderIndex(h);this.activeHdRef=f;this.activeHdIndex=index;var e=Ext.get(h);this.activeHdRegion=e.getRegion();e.addClass("x-grid3-hd-over");this.activeHdBtn=e.child(".x-grid3-hd-btn");if(this.activeHdBtn){this.activeHdBtn.dom.style.height=(h.firstChild.offsetHeight-1)+"px";}}},handleHdOut:function(f,e){var d=f.getTarget(".x-treegrid-hd");if(d&&(!Ext.isIE||!f.within(d,true))){this.activeHdRef=null;Ext.fly(d).removeClass("x-grid3-hd-over");d.style.cursor="";}},findHeaderIndex:function(h){h=h.dom||h;var c=h.parentNode.childNodes;for(var f=0,g;g=c[f];f++){if(g==h){return f;}}return -1;},beforeColMenuShow:function(){var h=this.columns,c=h.length,f,g;this.colMenu.removeAll();for(f=1;f<c;f++){g=h[f];if(g.hideable!==false){this.colMenu.add(new Ext.menu.CheckItem({itemId:"col-"+f,text:g.header,checked:!g.hidden,hideOnClick:false,disabled:g.hideable===false}));}}},handleHdMenuClick:function(d){var e=this.hdCtxIndex,f=d.getItemId();if(this.fireEvent("headermenuclick",this.columns[e],f,e)!==false){e=f.substr(4);if(e>0&&this.columns[e]){this.setColumnVisible(e,!d.checked);}}return true;},setColumnVisible:function(d,c){this.columns[d].hidden=!c;this.updateColumnWidths();},scrollToTop:function(){this.innerBody.dom.scrollTop=0;this.innerBody.dom.scrollLeft=0;},syncScroll:function(){this.syncHeaderScroll();var b=this.innerBody.dom;this.fireEvent("bodyscroll",b.scrollLeft,b.scrollTop);},syncHeaderScroll:function(){var b=this.innerBody.dom;this.innerHd.dom.scrollLeft=b.scrollLeft;this.innerHd.dom.scrollLeft=b.scrollLeft;},registerNode:function(b){Ext.ux.tree.TreeGrid.superclass.registerNode.call(this,b);if(!b.uiProvider&&!b.isRoot&&!b.ui.isTreeGridNodeUI){b.ui=new Ext.ux.tree.TreeGridNodeUI(b);}}});Ext.reg("treegrid",Ext.ux.tree.TreeGrid);