Ext.ux.Portal=Ext.extend(Ext.Panel,{layout:"column",autoScroll:true,cls:"x-portal",defaultType:"portalcolumn",initComponent:function(){Ext.ux.Portal.superclass.initComponent.call(this);this.addEvents({validatedrop:true,beforedragover:true,dragover:true,beforedrop:true,drop:true});},initEvents:function(){Ext.ux.Portal.superclass.initEvents.call(this);this.dd=new Ext.ux.Portal.DropZone(this,this.dropConfig);},beforeDestroy:function(){if(this.dd){this.dd.unreg();}Ext.ux.Portal.superclass.beforeDestroy.call(this);}});Ext.reg("portal",Ext.ux.Portal);Ext.ux.Portal.DropZone=function(d,c){this.portal=d;Ext.dd.ScrollManager.register(d.body);Ext.ux.Portal.DropZone.superclass.constructor.call(this,d.bwrap.dom,c);d.body.ddScrollConfig=this.ddScrollConfig;};Ext.extend(Ext.ux.Portal.DropZone,Ext.dd.DropTarget,{ddScrollConfig:{vthresh:50,hthresh:-1,animate:true,increment:200},createEvent:function(e,k,l,c,i,j){return{portal:this.portal,panel:l.panel,columnIndex:c,column:i,position:j,data:l,source:e,rawEvent:k,status:this.dropAllowed};},notifyOver:function(e,p,c){var I=p.getXY(),L=this.portal,B=e.proxy;if(!this.grid){this.grid=this.getGrid();}var K=L.body.dom.clientWidth;if(!this.lastCW){this.lastCW=K;}else{if(this.lastCW!=K){this.lastCW=K;L.doLayout();this.grid=this.getGrid();}}var J=0,D=this.grid.columnX,C=false;for(var x=D.length;J<x;J++){if(I[0]<(D[J].x+D[J].w)){C=true;break;}}if(!C){J--;}var z,E=false,G=0,h=L.items.itemAt(J),A=h.items.items,F=false;for(var x=A.length;G<x;G++){z=A[G];var y=z.el.getHeight();if(y===0){F=true;}else{if((z.el.getY()+(y/2))>I[1]){E=true;break;}}}G=(E&&z?G:h.items.getCount())+(F?-1:0);var H=this.createEvent(e,p,c,J,h,G);if(L.fireEvent("validatedrop",H)!==false&&L.fireEvent("beforedragover",H)!==false){B.getProxy().setWidth("auto");if(z){B.moveProxy(z.el.dom.parentNode,E?z.el.dom:null);}else{B.moveProxy(h.el.dom,null);}this.lastPos={c:h,col:J,p:F||(E&&z)?G:false};this.scrollPos=L.body.getScroll();L.fireEvent("dragover",H);return H.status;}else{return H.status;}},notifyOut:function(){delete this.grid;},notifyDrop:function(d,o,p){delete this.grid;if(!this.lastPos){return;}var m=this.lastPos.c,q=this.lastPos.col,e=this.lastPos.p;var r=this.createEvent(d,o,p,q,m,e!==false?e:m.items.getCount());if(this.portal.fireEvent("validatedrop",r)!==false&&this.portal.fireEvent("beforedrop",r)!==false){d.proxy.getProxy().remove();d.panel.el.dom.parentNode.removeChild(d.panel.el.dom);if(e!==false){if(m==d.panel.ownerCt&&(m.items.items.indexOf(d.panel)<=e)){e++;}m.insert(e,d.panel);}else{m.add(d.panel);}m.doLayout();this.portal.fireEvent("drop",r);var c=this.scrollPos.top;if(c){var n=this.portal.body.dom;setTimeout(function(){n.scrollTop=c;},10);}}delete this.lastPos;},getGrid:function(){var b=this.portal.bwrap.getBox();b.columnX=[];this.portal.items.each(function(a){b.columnX.push({x:a.el.getX(),w:a.el.getWidth()});});return b;},unreg:function(){Ext.ux.Portal.DropZone.superclass.unreg.call(this);}});