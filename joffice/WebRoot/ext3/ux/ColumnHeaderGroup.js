Ext.ns("Ext.ux.grid");Ext.ux.grid.ColumnHeaderGroup=Ext.extend(Ext.util.Observable,{constructor:function(b){this.config=b;},init:function(b){Ext.applyIf(b.colModel,this.config);Ext.apply(b.getView(),this.viewConfig);},viewConfig:{initTemplates:function(){this.constructor.prototype.initTemplates.apply(this,arguments);var b=this.templates||{};if(!b.gcell){b.gcell=new Ext.XTemplate('<td class="x-grid3-hd x-grid3-gcell x-grid3-td-{id} ux-grid-hd-group-row-{row} {cls}" style="{style}">','<div {tooltip} class="x-grid3-hd-inner x-grid3-hd-{id}" unselectable="on" style="{istyle}">',this.grid.enableHdMenu?'<a class="x-grid3-hd-btn" href="#"></a>':"","{value}</div></td>");}this.templates=b;this.hrowRe=new RegExp("ux-grid-hd-group-row-(\\d+)","");},renderHeaders:function(){var w=this.templates,A=[],t=this.cm,i=t.rows,v="width:"+this.getTotalWidth()+";";for(var q=0,u=i.length;q<u;q++){var D=i[q],r=[];for(var y=0,z=0,x=D.length;y<x;y++){var s=D[y];s.colspan=s.colspan||1;var C=this.getColumnId(s.dataIndex?t.findColumnIndex(s.dataIndex):z),B=Ext.ux.grid.ColumnHeaderGroup.prototype.getGroupStyle.call(this,s,z);r[y]=w.gcell.apply({cls:"ux-grid-hd-group-cell",id:C,row:q,style:"width:"+B.width+";"+(B.hidden?"display:none;":"")+(s.align?"text-align:"+s.align+";":""),tooltip:s.tooltip?(Ext.QuickTips.isEnabled()?"ext:qtip":"title")+'="'+s.tooltip+'"':"",istyle:s.align=="right"?"padding-right:16px":"",btn:this.grid.enableHdMenu&&s.header,value:s.header||"&nbsp;"});z+=s.colspan;}A[q]=w.header.apply({tstyle:v,cells:r.join("")});}A.push(this.constructor.prototype.renderHeaders.apply(this,arguments));return A.join("");},onColumnWidthUpdated:function(){this.constructor.prototype.onColumnWidthUpdated.apply(this,arguments);Ext.ux.grid.ColumnHeaderGroup.prototype.updateGroupStyles.call(this);},onAllColumnWidthsUpdated:function(){this.constructor.prototype.onAllColumnWidthsUpdated.apply(this,arguments);Ext.ux.grid.ColumnHeaderGroup.prototype.updateGroupStyles.call(this);},onColumnHiddenUpdated:function(){this.constructor.prototype.onColumnHiddenUpdated.apply(this,arguments);Ext.ux.grid.ColumnHeaderGroup.prototype.updateGroupStyles.call(this);},getHeaderCell:function(b){return this.mainHd.query(this.cellSelector)[b];},findHeaderCell:function(b){return b?this.fly(b).findParent("td.x-grid3-hd",this.cellSelectorDepth):false;},findHeaderIndex:function(c){var d=this.findHeaderCell(c);return d?this.getCellIndex(d):false;},updateSortIcon:function(e,f){var g=this.sortClasses,h=this.mainHd.select(this.cellSelector).removeClass(g);h.item(e).addClass(g[f=="DESC"?1:0]);},handleHdDown:function(j,m){var l=Ext.get(m);if(l.hasClass("x-grid3-hd-btn")){j.stopEvent();var k=this.findHeaderCell(m);Ext.fly(k).addClass("x-grid3-hd-menu-open");var n=this.getCellIndex(k);this.hdCtxIndex=n;var e=this.hmenu.items,i=this.cm;e.get("asc").setDisabled(!i.isSortable(n));e.get("desc").setDisabled(!i.isSortable(n));this.hmenu.on("hide",function(){Ext.fly(k).removeClass("x-grid3-hd-menu-open");},this,{single:true});this.hmenu.show(m,"tl-bl?");}else{if(l.hasClass("ux-grid-hd-group-cell")||Ext.fly(m).up(".ux-grid-hd-group-cell")){j.stopEvent();}}},handleHdMove:function(l,o){var m=this.findHeaderCell(this.activeHdRef);if(m&&!this.headersDisabled&&!Ext.fly(m).hasClass("ux-grid-hd-group-cell")){var e=this.splitHandleWidth||5,n=this.activeHdRegion,j=l.getPageX(),p=m.style,k="";if(this.grid.enableColumnResize!==false){if(j-n.left<=e&&this.cm.isResizable(this.activeHdIndex-1)){k=Ext.isAir?"move":Ext.isWebKit?"e-resize":"col-resize";}else{if(n.right-j<=(!this.activeHdBtn?e:2)&&this.cm.isResizable(this.activeHdIndex)){k=Ext.isAir?"move":Ext.isWebKit?"w-resize":"col-resize";}}}p.cursor=k;}},handleHdOver:function(g,f){var h=this.findHeaderCell(f);if(h&&!this.headersDisabled){this.activeHdRef=f;this.activeHdIndex=this.getCellIndex(h);var e=this.fly(h);this.activeHdRegion=e.getRegion();if(!(this.cm.isMenuDisabled(this.activeHdIndex)||e.hasClass("ux-grid-hd-group-cell"))){e.addClass("x-grid3-hd-over");this.activeHdBtn=e.child(".x-grid3-hd-btn");if(this.activeHdBtn){this.activeHdBtn.dom.style.height=(h.firstChild.offsetHeight-1)+"px";}}}},handleHdOut:function(f,e){var d=this.findHeaderCell(e);if(d&&(!Ext.isIE||!f.within(d,true))){this.activeHdRef=null;this.fly(d).removeClass("x-grid3-hd-over");d.style.cursor="";}},handleHdMenuClick:function(i){var w=this.hdCtxIndex,t=this.cm,D=this.ds,F=i.getItemId();switch(F){case"asc":D.sort(t.getDataIndex(w),"ASC");break;case"desc":D.sort(t.getDataIndex(w),"DESC");break;default:if(F.substr(0,5)=="group"){var z=F.split("-"),H=parseInt(z[1],10),C=parseInt(z[2],10),G=this.cm.rows[H],r,B=0;for(var z=0,x=G.length;z<x;z++){r=G[z];if(C>=B&&C<B+r.colspan){break;}B+=r.colspan;}if(i.checked){var v=t.getColumnsBy(this.isHideableColumn,this).length;for(var z=B,x=B+r.colspan;z<x;z++){if(!t.isHidden(z)){v--;}}if(v<1){this.onDenyColumnHide();return false;}}for(var z=B,x=B+r.colspan;z<x;z++){if(t.config[z].fixed!==true&&t.config[z].hideable!==false){t.setHidden(z,i.checked);}}}else{w=t.getIndexById(F.substr(4));if(w!=-1){if(i.checked&&t.getColumnsBy(this.isHideableColumn,this).length<=1){this.onDenyColumnHide();return false;}t.setHidden(w,i.checked);}}i.checked=!i.checked;if(i.menu){var y=function(a){a.items.each(function(b){if(!b.disabled){b.setChecked(i.checked,false);if(b.menu){y(b.menu);}}});};y(i.menu);}var A=i,E;while(A=A.parentMenu){if(!A.parentMenu||!(E=A.parentMenu.items.get(A.getItemId()))||!E.setChecked){break;}var u=A.items.findIndexBy(function(a){return a.checked;})>=0;E.setChecked(u,true);}i.checked=!i.checked;}return true;},beforeColMenuShow:function(){var J=this.cm,I=this.cm.rows;this.colMenu.removeAll();for(var N=0,F=J.getColumnCount();N<F;N++){var P=this.colMenu,c=J.getColumnHeader(N),G=[];if(J.config[N].fixed!==true&&J.config[N].hideable!==false){for(var M=0,A=I.length;M<A;M++){var E=I[M],K,C=0;for(var z=0,y=E.length;z<y;z++){K=E[z];if(N>=C&&N<C+K.colspan){break;}C+=K.colspan;}if(K&&K.header){if(J.hierarchicalColMenu){var D="group-"+M+"-"+C;var r=P.items.item(D);var H=r?r.menu:null;if(!H){H=new Ext.menu.Menu({itemId:D});H.on("itemclick",this.handleHdMenuClick,this);var L=false,O=true;for(var i=C,B=C+K.colspan;i<B;i++){if(!J.isHidden(i)){L=true;}if(J.config[i].hideable!==false){O=false;}}P.add({itemId:D,text:K.header,menu:H,hideOnClick:false,checked:L,disabled:O});}P=H;}else{G.push(K.header);}}}G.push(c);P.add(new Ext.menu.CheckItem({itemId:"col-"+J.getColumnId(N),text:G.join(" "),checked:!J.isHidden(N),hideOnClick:false,disabled:J.config[N].hideable===false}));}}},renderUI:function(){this.constructor.prototype.renderUI.apply(this,arguments);Ext.apply(this.columnDrop,Ext.ux.grid.ColumnHeaderGroup.prototype.columnDropConfig);Ext.apply(this.splitZone,Ext.ux.grid.ColumnHeaderGroup.prototype.splitZoneConfig);}},splitZoneConfig:{allowHeaderDrag:function(b){return !b.getTarget(null,null,true).hasClass("ux-grid-hd-group-cell");}},columnDropConfig:{getTargetFromEvent:function(c){var d=Ext.lib.Event.getTarget(c);return this.view.findHeaderCell(d);},positionIndicator:function(e,h,i){var j=Ext.ux.grid.ColumnHeaderGroup.prototype.getDragDropData.call(this,e,h,i);if(j===false){return false;}var g=j.px+this.proxyOffsets[0];this.proxyTop.setLeftTop(g,j.r.top+this.proxyOffsets[1]);this.proxyTop.show();this.proxyBottom.setLeftTop(g,j.r.bottom);this.proxyBottom.show();return j.pt;},onNodeDrop:function(L,J,i,G){var n=G.header;if(n!=L){var e=Ext.ux.grid.ColumnHeaderGroup.prototype.getDragDropData.call(this,n,L,i);if(e===false){return false;}var P=this.grid.colModel,c=e.oldIndex<e.newIndex,O=P.rows;for(var R=e.row,K=O.length;R<K;R++){var N=O[R],r=N.length,H=0,I=1,F=r;for(var E=0,M=0;E<r;E++){var Q=N[E];if(e.oldIndex>=M&&e.oldIndex<M+Q.colspan){H=E;}if(e.oldIndex+e.colspan-1>=M&&e.oldIndex+e.colspan-1<M+Q.colspan){I=E-H+1;}if(e.newIndex>=M&&e.newIndex<M+Q.colspan){F=E;}M+=Q.colspan;}var h=N.splice(H,I);O[R]=N.splice(0,F-(c?I:0)).concat(h).concat(N);}for(var d=0;d<e.colspan;d++){var S=e.oldIndex+(c?0:d),T=e.newIndex+(c?-1:d);P.moveColumn(S,T);this.grid.fireEvent("columnmove",S,T);}return true;}return false;}},getGroupStyle:function(j,n){var l=0,k=true;for(var m=n,i=n+j.colspan;m<i;m++){if(!this.cm.isHidden(m)){var h=this.cm.getColumnWidth(m);if(typeof h=="number"){l+=h;}k=false;}}return{width:(Ext.isBorderBox||(Ext.isWebKit&&!Ext.isSafari2)?l:Math.max(l-this.borderWidth,0))+"px",hidden:k};},updateGroupStyles:function(s){var n=this.mainHd.query(".x-grid3-header-offset > table"),p=this.getTotalWidth(),i=this.cm.rows;for(var l=0;l<n.length;l++){n[l].style.width=p;if(l<i.length){var m=n[l].firstChild.firstChild.childNodes;for(var q=0,r=0;q<m.length;q++){var o=i[l][q];if((typeof s!="number")||(s>=r&&s<r+o.colspan)){var t=Ext.ux.grid.ColumnHeaderGroup.prototype.getGroupStyle.call(this,o,r);m[q].style.width=t.width;m[q].style.display=t.hidden?"none":"";}r+=o.colspan;}}}},getGroupRowIndex:function(c){if(c){var d=c.className.match(this.hrowRe);if(d&&d[1]){return parseInt(d[1],10);}}return this.cm.rows.length;},getGroupSpan:function(j,n){if(j<0){return{col:0,colspan:this.cm.getColumnCount()};}var l=this.cm.rows[j];if(l){for(var m=0,h=0,i=l.length;m<i;m++){var k=l[m];if(n>=h&&n<h+k.colspan){return{col:h,colspan:k.colspan};}h+=k.colspan;}return{col:h,colspan:0};}return{col:n,colspan:1};},getDragDropData:function(x,y,w){if(x.parentNode!=y.parentNode){return false;}var r=this.grid.colModel,t=Ext.lib.Event.getPageX(w),B=Ext.lib.Dom.getRegion(y.firstChild),s,e;if((B.right-t)<=(B.right-B.left)/2){s=B.right+this.view.borderWidth;e="after";}else{s=B.left;e="before";}var u=this.view.getCellIndex(x),n=this.view.getCellIndex(y);if(r.isFixed(n)){return false;}var h=Ext.ux.grid.ColumnHeaderGroup.prototype.getGroupRowIndex.call(this.view,x),A=Ext.ux.grid.ColumnHeaderGroup.prototype.getGroupSpan.call(this.view,h,u),z=Ext.ux.grid.ColumnHeaderGroup.prototype.getGroupSpan.call(this.view,h,n),u=A.col;n=z.col+(e=="after"?z.colspan:0);if(n>=A.col&&n<=A.col+A.colspan){return false;}var v=Ext.ux.grid.ColumnHeaderGroup.prototype.getGroupSpan.call(this.view,h-1,u);if(n<v.col||n>v.col+v.colspan){return false;}return{r:B,px:s,pt:e,row:h,oldIndex:u,newIndex:n,colspan:A.colspan};}});