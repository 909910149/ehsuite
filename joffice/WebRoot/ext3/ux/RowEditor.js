Ext.ns("Ext.ux.grid");Ext.ux.grid.RowEditor=Ext.extend(Ext.Panel,{floating:true,shadow:false,layout:"hbox",cls:"x-small-editor",buttonAlign:"center",baseCls:"x-row-editor",elements:"header,footer,body",frameWidth:5,buttonPad:3,clicksToEdit:"auto",monitorValid:true,focusDelay:250,errorSummary:true,saveText:"Save",cancelText:"Cancel",commitChangesText:"You need to commit or cancel your changes",errorText:"Errors",defaults:{normalWidth:true},initComponent:function(){Ext.ux.grid.RowEditor.superclass.initComponent.call(this);this.addEvents("beforeedit","canceledit","validateedit","afteredit");},init:function(b){this.grid=b;this.ownerCt=b;if(this.clicksToEdit===2){b.on("rowdblclick",this.onRowDblClick,this);}else{b.on("rowclick",this.onRowClick,this);if(Ext.isIE){b.on("rowdblclick",this.onRowDblClick,this);}}b.getStore().on("remove",function(){this.stopEditing(false);},this);b.on({scope:this,keydown:this.onGridKey,columnresize:this.verifyLayout,columnmove:this.refreshFields,reconfigure:this.refreshFields,beforedestroy:this.beforedestroy,destroy:this.destroy,bodyscroll:{buffer:250,fn:this.positionButtons}});b.getColumnModel().on("hiddenchange",this.verifyLayout,this,{delay:1});b.getView().on("refresh",this.stopEditing.createDelegate(this,[]));},beforedestroy:function(){this.grid.getStore().un("remove",this.onStoreRemove,this);this.stopEditing(false);Ext.destroy(this.btns);},refreshFields:function(){this.initFields();this.verifyLayout();},isDirty:function(){var b;this.items.each(function(a){if(String(this.values[a.id])!==String(a.getValue())){b=true;return false;}},this);return b;},startEditing:function(s,f){if(this.editing&&this.isDirty()){this.showTooltip(this.commitChangesText);return;}if(Ext.isObject(s)){s=this.grid.getStore().indexOf(s);}if(this.fireEvent("beforeedit",this,s)!==false){this.editing=true;var v=this.grid,r=v.getView(),g=r.getRow(s),x=v.store.getAt(s);this.record=x;this.rowIndex=s;this.values={};if(!this.rendered){this.render(r.getEditorParent());}var q=Ext.fly(g).getWidth();this.setSize(q);if(!this.initialized){this.initFields();}var i=v.getColumnModel(),w=this.items.items,t,z;for(var y=0,u=i.getColumnCount();y<u;y++){z=this.preEditValue(x,i.getDataIndex(y));t=w[y];t.setValue(z);this.values[t.id]=Ext.isEmpty(z)?"":z;}this.verifyLayout(true);if(!this.isVisible()){this.setPagePosition(Ext.fly(g).getXY());}else{this.el.setXY(Ext.fly(g).getXY(),{duration:0.15});}if(!this.isVisible()){this.show().doLayout();}if(f!==false){this.doFocus.defer(this.focusDelay,this);}}},stopEditing:function(i){this.editing=false;if(!this.isVisible()){return;}if(i===false||!this.isValid()){this.hide();this.fireEvent("canceledit",this,i===false);return;}var p={},u=this.record,o=false,m=this.grid.colModel,r=this.items.items;for(var s=0,q=m.getColumnCount();s<q;s++){if(!m.isHidden(s)){var t=m.getDataIndex(s);if(!Ext.isEmpty(t)){var v=u.data[t],n=this.postEditValue(r[s].getValue(),v,u,t);if(String(v)!==String(n)){p[t]=n;o=true;}}}}if(o&&this.fireEvent("validateedit",this,p,u,this.rowIndex)!==false){u.beginEdit();Ext.iterate(p,function(b,a){u.set(b,a);});u.endEdit();this.fireEvent("afteredit",this,p,u,this.rowIndex);}this.hide();},verifyLayout:function(l){if(this.el&&(this.isVisible()||l===true)){var j=this.grid.getView().getRow(this.rowIndex);this.setSize(Ext.fly(j).getWidth(),Ext.isIE?Ext.fly(j).getHeight()+9:undefined);var n=this.grid.colModel,h=this.items.items;for(var m=0,i=n.getColumnCount();m<i;m++){if(!n.isHidden(m)){var k=0;if(m===(i-1)){k+=3;}else{k+=1;}h[m].show();h[m].setWidth(n.getColumnWidth(m)-k);}else{h[m].hide();}}this.doLayout();this.positionButtons();}},slideHide:function(){this.hide();},initFields:function(){var c=this.grid.getColumnModel(),j=Ext.layout.ContainerLayout.prototype.parseMargins;this.removeAll(false);for(var k=0,h=c.getColumnCount();k<h;k++){var i=c.getColumnAt(k),l=i.getEditor();if(!l){l=i.displayEditor||new Ext.form.DisplayField();}else{l=l.field;}if(k==0){l.margins=j("0 1 2 1");}else{if(k==h-1){l.margins=j("0 0 2 1");}else{l.margins=j("0 1 2");}}l.setWidth(c.getColumnWidth(k));l.column=i;if(l.ownerCt!==this){l.on("focus",this.ensureVisible,this);l.on("specialkey",this.onKey,this);}this.insert(k,l);}this.initialized=true;},onKey:function(d,c){if(c.getKey()===c.ENTER){this.stopEditing(true);c.stopPropagation();}},onGridKey:function(f){if(f.getKey()===f.ENTER&&!this.isVisible()){var d=this.grid.getSelectionModel().getSelected();if(d){var e=this.grid.store.indexOf(d);this.startEditing(e);f.stopPropagation();}}},ensureVisible:function(b){if(this.isVisible()){this.grid.getView().ensureVisible(this.rowIndex,this.grid.colModel.getIndexById(b.column.id),true);}},onRowClick:function(e,g,h){if(this.clicksToEdit=="auto"){var f=this.lastClickIndex;this.lastClickIndex=g;if(f!=g&&!this.isVisible()){return;}}this.startEditing(g,false);this.doFocus.defer(this.focusDelay,this,[h.getPoint()]);},onRowDblClick:function(e,f,d){this.startEditing(f,false);this.doFocus.defer(this.focusDelay,this,[d.getPoint()]);},onRender:function(){Ext.ux.grid.RowEditor.superclass.onRender.apply(this,arguments);this.el.swallowEvent(["keydown","keyup","keypress"]);this.btns=new Ext.Panel({baseCls:"x-plain",cls:"x-btns",elements:"body",layout:"table",width:(this.minButtonWidth*2)+(this.frameWidth*2)+(this.buttonPad*4),items:[{ref:"saveBtn",itemId:"saveBtn",xtype:"button",text:this.saveText,width:this.minButtonWidth,handler:this.stopEditing.createDelegate(this,[true])},{xtype:"button",text:this.cancelText,width:this.minButtonWidth,handler:this.stopEditing.createDelegate(this,[false])}]});this.btns.render(this.bwrap);},afterRender:function(){Ext.ux.grid.RowEditor.superclass.afterRender.apply(this,arguments);this.positionButtons();if(this.monitorValid){this.startMonitoring();}},onShow:function(){if(this.monitorValid){this.startMonitoring();}Ext.ux.grid.RowEditor.superclass.onShow.apply(this,arguments);},onHide:function(){Ext.ux.grid.RowEditor.superclass.onHide.apply(this,arguments);this.stopMonitoring();this.grid.getView().focusRow(this.rowIndex);},positionButtons:function(){if(this.btns){var j=this.grid,k=this.el.dom.clientHeight,g=j.getView(),h=g.scroller.dom.scrollLeft,i=this.btns.getWidth(),l=Math.min(j.getWidth(),j.getColumnModel().getTotalWidth());this.btns.el.shift({left:(l/2)-(i/2)+h,top:k-2,stopFx:true,duration:0.2});}},preEditValue:function(e,f){var d=e.data[f];return this.autoEncode&&typeof d==="string"?Ext.util.Format.htmlDecode(d):d;},postEditValue:function(h,f,e,g){return this.autoEncode&&typeof h=="string"?Ext.util.Format.htmlEncode(h):h;},doFocus:function(k){if(this.isVisible()){var m=0,c=this.grid.getColumnModel(),j,n;if(k){m=this.getTargetColumnIndex(k);}for(var l=m||0,i=c.getColumnCount();l<i;l++){j=c.getColumnAt(l);n=j.getEditor();if(!j.hidden&&n){n.field.focus();break;}}}},getTargetColumnIndex:function(c){var r=this.grid,i=r.view,l=c.left,n=r.colModel.config,q=0,p=false;for(var o=n.length,m;m=n[q];q++){if(!m.hidden){if(Ext.fly(i.getHeaderCell(q)).getRegion().right>=l){p=q;break;}}}return p;},startMonitoring:function(){if(!this.bound&&this.monitorValid){this.bound=true;Ext.TaskMgr.start({run:this.bindHandler,interval:this.monitorPoll||200,scope:this});}},stopMonitoring:function(){this.bound=false;if(this.tooltip){this.tooltip.hide();}},isValid:function(){var b=true;this.items.each(function(a){if(!a.isValid(true)){b=false;return false;}});return b;},bindHandler:function(){if(!this.bound){return false;}var b=this.isValid();if(!b&&this.errorSummary){this.showTooltip(this.getErrorText().join(""));}this.btns.saveBtn.setDisabled(!b);this.fireEvent("validation",this,b);},showTooltip:function(i){var l=this.tooltip;if(!l){l=this.tooltip=new Ext.ToolTip({maxWidth:600,cls:"errorTip",width:300,title:this.errorText,autoHide:false,anchor:"left",anchorToTarget:true,mouseOffset:[40,0]});}var g=this.grid.getView(),j=parseInt(this.el.dom.style.top,10),h=g.scroller.dom.scrollTop,k=this.el.getHeight();if(j+k>=h){l.initTarget(this.items.last().getEl());if(!l.rendered){l.show();l.hide();}l.body.update(i);l.doAutoWidth(20);l.show();}else{if(l.rendered){l.hide();}}},getErrorText:function(){var b=["<ul>"];this.items.each(function(a){if(!a.isValid(true)){b.push("<li>",a.getActiveError(),"</li>");}});b.push("</ul>");return b;}});Ext.preg("roweditor",Ext.ux.grid.RowEditor);